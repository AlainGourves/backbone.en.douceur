<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta http-equiv="Content-Style-Type" content="text/css" />
  <meta name="generator" content="pandoc" />
  <title></title>
  <style type="text/css">
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; }
code > span.dt { color: #902000; }
code > span.dv { color: #40a070; }
code > span.bn { color: #40a070; }
code > span.fl { color: #40a070; }
code > span.ch { color: #4070a0; }
code > span.st { color: #4070a0; }
code > span.co { color: #60a0b0; font-style: italic; }
code > span.ot { color: #007020; }
code > span.al { color: #ff0000; font-weight: bold; }
code > span.fu { color: #06287e; }
code > span.er { color: #ff0000; font-weight: bold; }
  </style>
  <link rel="stylesheet" href="style.css" type="text/css" />
</head>
<body>
<div id="TOC">
<ul>
<li><a href="#préambule-remerciements"><span class="toc-section-number">1</span> Préambule &amp; Remerciements</a><ul>
<li><a href="#avertissement"><span class="toc-section-number">1.1</span> Avertissement</a></li>
</ul></li>
<li><a href="#présentation-de-backbone-rappels-mvc"><span class="toc-section-number">2</span> Présentation de Backbone &amp; rappels MVC</a><ul>
<li><a href="#backbone-webapps-mvc"><span class="toc-section-number">2.1</span> Backbone ? Webapps ? MVC ?</a><ul>
<li><a href="#quest-ce-quune-webapp"><span class="toc-section-number">2.1.1</span> Qu’est-ce qu’une “Webapp” ?</a></li>
<li><a href="#petit-rappel-mvc"><span class="toc-section-number">2.1.2</span> Petit rappel : MVC ?</a></li>
</ul></li>
<li><a href="#backbone-mvc"><span class="toc-section-number">2.2</span> Backbone &amp; MVC</a></li>
<li><a href="#pourquoi-jai-choisi-backbone"><span class="toc-section-number">2.3</span> Pourquoi j’ai choisi Backbone ?</a></li>
</ul></li>
<li><a href="#tout-de-suite-les-mains-dans-le-cambouis"><span class="toc-section-number">3</span> Tout de suite “les mains dans le cambouis”</a><ul>
<li><a href="#prérequis-les-dépendances-de-backbone"><span class="toc-section-number">3.1</span> Prérequis : les dépendances de Backbone</a></li>
<li><a href="#outils-de-développement"><span class="toc-section-number">3.2</span> Outils de développement</a><ul>
<li><a href="#ide-editeur"><span class="toc-section-number">3.2.1</span> IDE (Editeur)</a></li>
<li><a href="#navigateur"><span class="toc-section-number">3.2.2</span> Navigateur</a></li>
</ul></li>
<li><a href="#initialisation-de-notre-projet-de-travail"><span class="toc-section-number">3.3</span> Initialisation de notre projet de travail</a><ul>
<li><a href="#installation"><span class="toc-section-number">3.3.1</span> Installation</a></li>
<li><a href="#préparons-notre-page-html"><span class="toc-section-number">3.3.2</span> Préparons notre page HTML</a></li>
</ul></li>
<li><a href="#jouons-avec-jquery"><span class="toc-section-number">3.4</span> Jouons avec jQuery</a><ul>
<li><a href="#jouons-avec-notre-page-en-mode-commande"><span class="toc-section-number">3.4.1</span> &quot;Jouons&quot; avec notre page en mode commande</a><ul>
<li><a href="#saisissons-nos-1ères-commandes"><span class="toc-section-number">3.4.1.1</span> Saisissons nos 1ères commandes :</a></li>
<li><a href="#modifions-laspect-de-notre-page-dynamiquement"><span class="toc-section-number">3.4.1.2</span> Modifions l’aspect de notre page dynamiquement :</a></li>
<li><a href="#allons-plus-loin"><span class="toc-section-number">3.4.1.3</span> Allons plus loin …</a></li>
</ul></li>
<li><a href="#les-évènements"><span class="toc-section-number">3.4.2</span> Les évènements</a></li>
<li><a href="#quelques-bonnes-pratiques"><span class="toc-section-number">3.4.3</span> Quelques bonnes pratiques</a><ul>
<li><a href="#pensez-performances"><span class="toc-section-number">3.4.3.1</span> Pensez performances :</a></li>
<li><a href="#soyez-sûr-que-les-éléments-de-votre-page-sont-tous-chargés"><span class="toc-section-number">3.4.3.2</span> Soyez sûr que les éléments de votre page sont tous chargés :</a></li>
</ul></li>
</ul></li>
<li><a href="#jouons-avec-underscore"><span class="toc-section-number">3.5</span> Jouons avec Underscore</a><ul>
<li><a href="#quelques-exemples-dutilisations"><span class="toc-section-number">3.5.1</span> Quelques exemples d'utilisations</a><ul>
<li><a href="#tableaux-et-collections"><span class="toc-section-number">3.5.1.1</span> Tableaux et Collections :</a></li>
<li><a href="#templating"><span class="toc-section-number">3.5.1.2</span> Templating :</a></li>
</ul></li>
</ul></li>
</ul></li>
<li><a href="#er-contact-avec-backbone"><span class="toc-section-number">4</span> 1er contact … avec Backbone</a><ul>
<li><a href="#ère-application-backbone"><span class="toc-section-number">4.1</span> 1ère application Backbone</a><ul>
<li><a href="#préparons-notre-page"><span class="toc-section-number">4.1.1</span> Préparons notre page</a></li>
</ul></li>
<li><a href="#le-modèle-article"><span class="toc-section-number">4.2</span> Le Modèle “Article”</a></li>
<li><a href="#la-collection-darticles"><span class="toc-section-number">4.3</span> La Collection d’Articles</a></li>
<li><a href="#vue-et-template"><span class="toc-section-number">4.4</span> Vue et Template</a><ul>
<li><a href="#quavons-nous-fait"><span class="toc-section-number">4.4.1</span> Qu’avons-nous fait ?</a></li>
</ul></li>
<li><a href="#un-dernier-tour-de-magie-pour-clôturer-le-chapitre-dinitiation-binding"><span class="toc-section-number">4.5</span> Un dernier tour de magie pour clôturer le chapitre d’initiation : “binding”</a><ul>
<li><a href="#que-venons-nous-de-faire"><span class="toc-section-number">4.5.1</span> Que venons-nous de faire ?</a></li>
<li><a href="#oh-la-vilaine-erreur"><span class="toc-section-number">4.5.2</span> Oh la vilaine erreur !!!</a></li>
</ul></li>
<li><a href="#code-final-de-lexemple"><span class="toc-section-number">4.6</span> Code final de l'exemple</a></li>
</ul></li>
<li><a href="#le-modèle-objet-de-backbone"><span class="toc-section-number">5</span> Le modèle objet de Backbone</a><ul>
<li><a href="#un-petit-tour-dans-le-code"><span class="toc-section-number">5.1</span> Un petit tour dans le code</a></li>
<li><a href="#ère-classe"><span class="toc-section-number">5.2</span> 1ère &quot;classe&quot;</a><ul>
<li><a href="#un-constructeur"><span class="toc-section-number">5.2.1</span> Un constructeur</a></li>
<li><a href="#des-propriétés"><span class="toc-section-number">5.2.2</span> Des propriétés</a></li>
<li><a href="#des-méthodes"><span class="toc-section-number">5.2.3</span> Des méthodes</a></li>
<li><a href="#des-membres-statiques"><span class="toc-section-number">5.2.4</span> Des membres statiques</a></li>
</ul></li>
<li><a href="#sans-héritage-point-de-salut"><span class="toc-section-number">5.3</span> Sans héritage point de salut ! … ?</a></li>
<li><a href="#surcharge-super"><span class="toc-section-number">5.4</span> Surcharge &amp; super</a></li>
<li><a href="#conclusion"><span class="toc-section-number">5.5</span> Conclusion</a></li>
</ul></li>
<li><a href="#il-nous-faut-un-serveur"><span class="toc-section-number">6</span> Il nous faut un serveur !</a><ul>
<li><a href="#principes-http-get-post-put-delete"><span class="toc-section-number">6.1</span> Principes http : GET, POST, PUT, DELETE</a></li>
<li><a href="#installations"><span class="toc-section-number">6.2</span> Installation(s)</a><ul>
<li><a href="#installer-node.js"><span class="toc-section-number">6.2.1</span> Installer Node.js</a></li>
<li><a href="#installer-express.js"><span class="toc-section-number">6.2.2</span> Installer Express.js</a></li>
<li><a href="#installer-nstore"><span class="toc-section-number">6.2.3</span> Installer nStore</a></li>
</ul></li>
<li><a href="#codons-notre-application-serveur"><span class="toc-section-number">6.3</span> Codons notre application serveur</a><ul>
<li><a href="#ressources-statiques"><span class="toc-section-number">6.3.1</span> Ressources statiques</a></li>
<li><a href="#ressources-dynamiques"><span class="toc-section-number">6.3.2</span> Ressources dynamiques</a></li>
</ul></li>
<li><a href="#testons-notre-application-serveur"><span class="toc-section-number">6.4</span> Testons notre application serveur</a><ul>
<li><a href="#ajoutons-un-enregistrement"><span class="toc-section-number">6.4.1</span> Ajoutons un enregistrement</a></li>
<li><a href="#obtenir-tous-les-enregistrements"><span class="toc-section-number">6.4.2</span> Obtenir tous les enregistrements</a></li>
<li><a href="#retrouver-un-enregistrement-particulier-par-sa-clé"><span class="toc-section-number">6.4.3</span> Retrouver un enregistrement particulier (par sa clé)</a></li>
<li><a href="#mettre-à-jour-un-enregistrement"><span class="toc-section-number">6.4.4</span> Mettre à jour un enregistrement</a></li>
<li><a href="#faire-une-requête"><span class="toc-section-number">6.4.5</span> Faire une requête</a></li>
<li><a href="#supprimer-un-enregistrement"><span class="toc-section-number">6.4.6</span> Supprimer un enregistrement</a></li>
</ul></li>
</ul></li>
<li><a href="#les-modèles-et-les-collections-en-détail"><span class="toc-section-number">7</span> Les modèles et les collections en détail</a><ul>
<li><a href="#fonctionnement-général"><span class="toc-section-number">7.1</span> Fonctionnement général</a></li>
<li><a href="#modèles"><span class="toc-section-number">7.2</span> Modèles</a><ul>
<li><a href="#définition-du-modèle"><span class="toc-section-number">7.2.1</span> Définition du modèle</a></li>
<li><a href="#getters-et-setters"><span class="toc-section-number">7.2.2</span> Getters et Setters</a></li>
<li><a href="#structure-dun-modèle"><span class="toc-section-number">7.2.3</span> Structure d'un modèle</a></li>
<li><a href="#méthodes-crud-du-modèle"><span class="toc-section-number">7.2.4</span> Méthodes “CRUD” du modèle</a><ul>
<li><a href="#méthodes-save-création-mise-à-jour"><span class="toc-section-number">7.2.4.1</span> Méthodes save() : création &amp; mise à jour<br /></a></li>
<li><a href="#méthode-fetch-retrouver-un-modèle"><span class="toc-section-number">7.2.4.2</span> Méthode fetch() : retrouver un modèle<br /></a></li>
<li><a href="#méthode-destroy-supprimer-un-modèle-du-serveur"><span class="toc-section-number">7.2.4.3</span> Méthode destroy() : supprimer un modèle du serveur<br /></a></li>
</ul></li>
<li><a href="#evénements"><span class="toc-section-number">7.2.5</span> Evénements</a></li>
<li><a href="#constructeur-initialize"><span class="toc-section-number">7.2.6</span> Constructeur : initialize</a></li>
<li><a href="#augmenter-le-modèle-ajouter-des-valeurs-par-défaut-et-des-méthodes-au-modèle"><span class="toc-section-number">7.2.7</span> “Augmenter” le modèle : ajouter des valeurs par défaut et des méthodes au modèle</a></li>
<li><a href="#comment-détecter-quun-modèle-a-été-changé-par-quelquun-dautre"><span class="toc-section-number">7.2.8</span> Comment détecter qu’un modèle a été changé par quelqu’un d’autre ?</a></li>
</ul></li>
<li><a href="#collections"><span class="toc-section-number">7.3</span> Collections</a><ul>
<li><a href="#comment-ajouter-des-modèles-à-une-collection"><span class="toc-section-number">7.3.1</span> Comment ajouter des modèles à une collection</a></li>
<li><a href="#parcourir-les-modèles-dune-collection"><span class="toc-section-number">7.3.2</span> Parcourir les modèles d’une collection</a></li>
<li><a href="#filtrer-les-modèles-dune-collection"><span class="toc-section-number">7.3.3</span> Filtrer les modèles d’une collection</a></li>
<li><a href="#trouver-le-1er-modèle-dune-collection-correspondant-à-un-critère"><span class="toc-section-number">7.3.4</span> Trouver le 1er modèle d’une collection correspondant à un critère</a></li>
<li><a href="#autres-méthodes-de-la-collection"><span class="toc-section-number">7.3.5</span> Autres méthodes de la collection</a></li>
</ul></li>
<li><a href="#les-collections-parlent-au-serveur"><span class="toc-section-number">7.4</span> Les collections “parlent” au serveur</a><ul>
<li><a href="#charger-les-données"><span class="toc-section-number">7.4.1</span> Charger les données</a></li>
<li><a href="#requêtes"><span class="toc-section-number">7.4.2</span> Requêtes</a></li>
</ul></li>
<li><a href="#evénements-1"><span class="toc-section-number">7.5</span> Evénements</a></li>
</ul></li>
<li><a href="#vues-templating"><span class="toc-section-number">8</span> Vues &amp; Templating</a><ul>
<li><a href="#préparons-le-terrain"><span class="toc-section-number">8.1</span> Préparons le terrain</a><ul>
<li><a href="#création-et-sauvegarde-des-modèles"><span class="toc-section-number">8.1.1</span> Création et sauvegarde des modèles</a></li>
</ul></li>
<li><a href="#ère-vue"><span class="toc-section-number">8.2</span> 1ère vue</a><ul>
<li><a href="#explications-utilisation"><span class="toc-section-number">8.2.1</span> Explications &amp; utilisation</a></li>
</ul></li>
<li><a href="#maintenant-un-peu-de-magie-..."><span class="toc-section-number">8.3</span> Maintenant, un peu de magie ...</a><ul>
<li><a href="#sabonner-aux-événements"><span class="toc-section-number">8.3.1</span> S'abonner aux événements</a></li>
<li><a href="#sabonner-à-dautres-évènements-modèles"><span class="toc-section-number">8.3.2</span> S’abonner à d’autres évènements (modèles)</a></li>
<li><a href="#amélioration-finalisation-du-code"><span class="toc-section-number">8.3.3</span> Amélioration &amp; Finalisation du code</a></li>
</ul></li>
<li><a href="#utilisation-du-templating-...-1ère-fois"><span class="toc-section-number">8.4</span> Utilisation du templating ... 1ère fois</a><ul>
<li><a href="#définition-de-notre-1er-template"><span class="toc-section-number">8.4.1</span> Définition de notre 1er template</a></li>
</ul></li>
<li><a href="#sous-vues"><span class="toc-section-number">8.5</span> Sous-vue(s)</a><ul>
<li><a href="#réorganisation-du-code-html"><span class="toc-section-number">8.5.1</span> Réorganisation du code html</a></li>
<li><a href="#création-modification-des-vues"><span class="toc-section-number">8.5.2</span> Création &amp; Modification des vues</a></li>
<li><a href="#un-dernier-petit-réglage-tri-des-collections"><span class="toc-section-number">8.5.3</span> Un dernier petit réglage : tri des collections</a></li>
</ul></li>
<li><a href="#utilisation-dautres-moteurs-de-template"><span class="toc-section-number">8.6</span> Utilisation d’autre(s) moteur(s) de template</a><ul>
<li><a href="#redéfinissons-donc-nos-templates"><span class="toc-section-number">8.6.1</span> Redéfinissons donc nos templates</a></li>
</ul></li>
<li><a href="#gestion-des-événements-dans-les-vues"><span class="toc-section-number">8.7</span> Gestion des événements dans les vues</a></li>
<li><a href="#authentification-côté-serveur-les-utilisateurs"><span class="toc-section-number">8.8</span> Authentification (côté serveur) : les utilisateurs</a><ul>
<li><a href="#sauthentifier-se-déconnecter"><span class="toc-section-number">8.8.1</span> S’authentifier – Se déconnecter</a></li>
</ul></li>
<li><a href="#authentification-côté-client"><span class="toc-section-number">8.9</span> Authentification (côté client)</a><ul>
<li><a href="#formulaire-dauthentification"><span class="toc-section-number">8.9.1</span> Formulaire d’authentification</a></li>
<li><a href="#lobjet-backbone.view-login.view"><span class="toc-section-number">8.9.2</span> L’objet Backbone.View : Login.View</a></li>
<li><a href="#ajoutons-une-gestion-des-évènements"><span class="toc-section-number">8.9.3</span> Ajoutons une gestion des évènements</a></li>
<li><a href="#vérification"><span class="toc-section-number">8.9.4</span> Vérification</a></li>
</ul></li>
</ul></li>
<li><a href="#le-routeur"><span class="toc-section-number">9</span> Le Routeur</a><ul>
<li><a href="#modifions-notre-vue"><span class="toc-section-number">9.1</span> Modifions notre vue</a></li>
<li><a href="#création-du-routeur"><span class="toc-section-number">9.2</span> Création du routeur</a></li>
</ul></li>
<li><a href="#organiser-son-code"><span class="toc-section-number">10</span> Organiser son code</a><ul>
<li><a href="#a-lancienne"><span class="toc-section-number">10.1</span> &quot;A l'ancienne&quot;</a><ul>
<li><a href="#namespace"><span class="toc-section-number">10.1.1</span> Namespace</a></li>
<li><a href="#modules"><span class="toc-section-number">10.1.2</span> Modules</a></li>
<li><a href="#au-final-nous-aurons-..."><span class="toc-section-number">10.1.3</span> Au final, nous aurons ...</a></li>
</ul></li>
<li><a href="#méthode-hype-comme-les-vrais"><span class="toc-section-number">10.2</span> Méthode “hype”, comme les vrais</a><ul>
<li><a href="#préparation"><span class="toc-section-number">10.2.1</span> Préparation</a></li>
</ul></li>
</ul></li>
<li><a href="#securisation"><span class="toc-section-number">11</span> Securisation</a><ul>
<li><a href="#il-nous-faut-un-écran-dadministration"><span class="toc-section-number">11.1</span> Il nous faut un &quot;écran d’administration&quot;</a><ul>
<li><a href="#création-dadminview"><span class="toc-section-number">11.1.1</span> Création d'AdminView</a></li>
<li><a href="#modification-de-loginview"><span class="toc-section-number">11.1.2</span> Modification de LoginView</a></li>
</ul></li>
<li><a href="#sécurisation-côté-serveur"><span class="toc-section-number">11.2</span> Sécurisation côté serveur</a><ul>
<li><a href="#sécurisation-des-routes"><span class="toc-section-number">11.2.1</span> Sécurisation des routes</a></li>
<li><a href="#eh-bien-testons-maintenant"><span class="toc-section-number">11.2.2</span> Eh bien testons, maintenant</a></li>
</ul></li>
</ul></li>
<li><a href="#backbone.sync"><span class="toc-section-number">12</span> Backbone.sync()</a></li>
<li><a href="#backbone-3-coffeescript"><span class="toc-section-number">13</span> Backbone &lt;3 Coffeescript</a><ul>
<li><a href="#coffeescript-quest-ce-que-cest"><span class="toc-section-number">13.1</span> Coffeescript qu’est-ce que c’est ?</a></li>
<li><a href="#un-code-plus-lisible"><span class="toc-section-number">13.2</span> Un code plus lisible ?</a><ul>
<li><a href="#les-fonctions"><span class="toc-section-number">13.2.1</span> Les fonctions</a></li>
<li><a href="#interopérabilité"><span class="toc-section-number">13.2.2</span> Interopérabilité</a></li>
<li><a href="#interpolation-et-chaînes-de-caractères"><span class="toc-section-number">13.2.3</span> Interpolation et Chaînes de caractères</a></li>
<li><a href="#jouez-un-peu-avec-les-tableaux"><span class="toc-section-number">13.2.4</span> Jouez un peu avec les tableaux</a></li>
</ul></li>
<li><a href="#et-enfin-et-surtout-les-classes"><span class="toc-section-number">13.3</span> Et enfin (et surtout ?) les classes</a><ul>
<li><a href="#notre-1ère-classe"><span class="toc-section-number">13.3.1</span> Notre 1ère classe</a></li>
<li><a href="#propriétés-valeurs-par-défaut"><span class="toc-section-number">13.3.2</span> Propriétés &amp; valeurs par défaut</a></li>
<li><a href="#comme-en-java-composition-association-encapsulation"><span class="toc-section-number">13.3.3</span> Comme en Java : Composition, Association, Encapsulation</a></li>
<li><a href="#comme-en-java-les-membres-statiques"><span class="toc-section-number">13.3.4</span> Comme en Java : les membres statiques</a></li>
<li><a href="#mais-aussi-comme-en-java-lhéritage"><span class="toc-section-number">13.3.5</span> Mais aussi (comme en Java) : l’héritage !</a></li>
</ul></li>
<li><a href="#jaime-je-naime-pas"><span class="toc-section-number">13.4</span> J’aime / Je n’aime pas</a></li>
<li><a href="#ré-écriture-de-notre-blog-soutiller"><span class="toc-section-number">13.5</span> Ré-écriture de notre blog ?! S'outiller</a><ul>
<li><a href="#installation-de-coffeescript"><span class="toc-section-number">13.5.1</span> Installation de Coffeescript</a></li>
<li><a href="#industrialisation-de-la-transpilation"><span class="toc-section-number">13.5.2</span> “Industrialisation” de la transpilation</a></li>
</ul></li>
<li><a href="#ré-écriture-traductions"><span class="toc-section-number">13.6</span> Ré-écriture / Traductions</a><ul>
<li><a href="#blog.coffee"><span class="toc-section-number">13.6.1</span> Blog.coffee</a></li>
<li><a href="#main.coffee"><span class="toc-section-number">13.6.2</span> main.coffee</a></li>
<li><a href="#post.coffee"><span class="toc-section-number">13.6.3</span> post.coffee</a></li>
<li><a href="#adminview.coffee"><span class="toc-section-number">13.6.4</span> AdminView.coffee</a></li>
<li><a href="#loginview.coffee"><span class="toc-section-number">13.6.5</span> LoginView.coffee</a></li>
<li><a href="#postslistview.coffee"><span class="toc-section-number">13.6.6</span> PostsListView.coffee</a></li>
<li><a href="#postview.coffee"><span class="toc-section-number">13.6.7</span> PostView.coffee</a></li>
<li><a href="#sidebarview.coffee"><span class="toc-section-number">13.6.8</span> SidebarView.coffee</a></li>
<li><a href="#mainview.coffee"><span class="toc-section-number">13.6.9</span> MainView.coffee</a></li>
<li><a href="#routes.coffee"><span class="toc-section-number">13.6.10</span> routes.coffee</a></li>
<li><a href="#transpilons"><span class="toc-section-number">13.6.11</span> Transpilons</a></li>
<li><a href="#conclusions"><span class="toc-section-number">13.6.12</span> Conclusion(s)</a></li>
</ul></li>
</ul></li>
<li><a href="#autres-frameworks-mvc"><span class="toc-section-number">14</span> Autres Frameworks MVC</a><ul>
<li><a href="#canjs"><span class="toc-section-number">14.1</span> CanJS</a><ul>
<li><a href="#mise-en-oeuvre-rapide"><span class="toc-section-number">14.1.1</span> Mise en oeuvre rapide</a></li>
<li><a href="#conclusion-sur-canjs"><span class="toc-section-number">14.1.2</span> Conclusion sur CanJS</a></li>
</ul></li>
<li><a href="#spine"><span class="toc-section-number">14.2</span> Spine</a><ul>
<li><a href="#mise-en-oeuvre-rapide-1"><span class="toc-section-number">14.2.1</span> Mise en oeuvre rapide</a></li>
<li><a href="#conclusion-sur-spine"><span class="toc-section-number">14.2.2</span> Conclusion sur Spine</a></li>
</ul></li>
<li><a href="#knockout"><span class="toc-section-number">14.3</span> Knockout</a><ul>
<li><a href="#mise-en-oeuvre-très-très-rapide-...-mais-suffisante"><span class="toc-section-number">14.3.1</span> Mise en oeuvre très très rapide ... Mais suffisante</a></li>
<li><a href="#un-modèle-selon-knockout"><span class="toc-section-number">14.3.2</span> Un modèle selon Knockout</a></li>
<li><a href="#collections-1"><span class="toc-section-number">14.3.3</span> Collections ?</a></li>
<li><a href="#attachons-notre-modèle-à-des-vues"><span class="toc-section-number">14.3.4</span> Attachons notre modèle à des vues !</a></li>
<li><a href="#attachons-note-liste-de-messages-à-une-vue"><span class="toc-section-number">14.3.5</span> Attachons note liste de messages à une vue</a></li>
<li><a href="#code-définitif-de-notre-page-index.html"><span class="toc-section-number">14.3.6</span> Code définitif de notre page index.html</a></li>
<li><a href="#démonstration"><span class="toc-section-number">14.3.7</span> Démonstration !!!</a></li>
<li><a href="#conclusion-1"><span class="toc-section-number">14.3.8</span> Conclusion</a></li>
</ul></li>
<li><a href="#encore-dautres-frameworks-mvc-javascript"><span class="toc-section-number">14.4</span> Encore d’autres frameworks MVC (javascript)</a></li>
<li><a href="#conclusion-2"><span class="toc-section-number">14.5</span> Conclusion</a></li>
</ul></li>
<li><a href="#backbone-et-typescript"><span class="toc-section-number">15</span> Backbone et Typescript</a></li>
<li><a href="#ressources-backbone"><span class="toc-section-number">16</span> Ressources Backbone</a></li>
<li><a href="#resthub-backbone-stack"><span class="toc-section-number">17</span> RestHub Backbone Stack</a></li>
</ul>
</div>
<h1 id="préambule-remerciements"><a href="#TOC"><span class="header-section-number">1</span> Préambule &amp; Remerciements</a></h1>
<p>J'ai eu la prétention d'écrire un livre, et sur Backbone en plus ! En fait il n'existe peu de littérature française spécialisée sur des frameworks, qui plus est des framework javascript, alors que nos amis anglo-saxons écrivent sur Dart, Coffeescript, Backbone, etc. ... Au départ ce &quot;bouquin&quot; est un projet un peu fou, puisque j'ai même contacté les éditions Eyrolles (quand je vous disais que j'étais prétentieux ;) ). Et ils ont été d'accord ! Alors vous vous demandez pourquoi, finalement je publie ça de manière open source ?</p>
<p>Eh bien, écrire un livre est un travail de longue haleine, qui doit se faire dans la durée. D'un autre côté, les technologies, tout particulièrement ce qui gravite autour de javascript, progressent et changent à une allure vertigineuse. Mon constat est que, si je veux écrire tout ce que j'ai en tête, cela ne finira jamais, ou bien le contenu n'aura plus d'intérêt (obsolète) et qu'il me semble plus approprié de livrer déjà ce que j'ai &quot;gratté&quot; et de transformer ce livre en projet open-source.</p>
<p>Ainsi, ceux qui souhaite se mettre à Backbone, peuvent commencer dès maintenant (même si on ne m'a pas attendu, j'imagine qu'un peu de documentation en français devrait faire des heureux). Pour les autres s'ils souhaitent compléter, corriger, modifier, discuter, je me tiens à leur disposition. C'est pour cela que j'ai publié le contenu sur Github = ainsi vous avez l'opportunité de faire des pull-requests (proposer des modifications) sur le contenu, ou créer des issues pour donner votre avis.</p>
<p>Je vous attends, j'espère que cela vous sera utile. Je m'adresse à tous les publics (les plus forts n'apprendront rien, mais peuvent contribuer). Ceux qui connaissent déjà Backbone peuvent directement passer au chapitre 04.</p>
<p>Je tiens à remercier très fortement et tout particulièrement, pour leur écoute, leurs conseils et leur relecture :</p>
<ul>
<li>Muriel SHANSEIFAN (Éditions Eyrolles - Responsable éditoriales du secteur informatique)</li>
<li>Laurène GIBAUD (Éditions Eyrolles - Secteur Informatique)</li>
</ul>
<p>Remerciements aussi pour :</p>
<ul>
<li><a href="https://github.com/ehsavoie">ehsavoie</a> : 1ère pull request ;)</li>
<li><a href="https://github.com/lodennan">lodennan</a></li>
<li><a href="https://github.com/cbonnissent">cbonnissent</a> : format epub</li>
<li><a href="https://github.com/loicdescotte">loicdescotte</a> : relecture</li>
</ul>
<h2 id="avertissement"><a href="#TOC"><span class="header-section-number">1.1</span> Avertissement</a></h2>
<p>Cet ouvrage est destiné à être purement éducatif. donc dès fois le code n'est pas fait dans les &quot;règles de l'art&quot;, mais plutôt avec une &quot;vision&quot; pédagogique. Désolé donc pour les puristes, mais à priori vous n'êtes pas la cible ;). Cependant, je serais ravi de pouvoir inclure vos remarques et bonnes pratiques sous forme de notes dans chacun des chapitres. Donc à vos pull-requests !</p>
<h1 id="présentation-de-backbone-rappels-mvc"><a href="#TOC"><span class="header-section-number">2</span> Présentation de Backbone &amp; rappels MVC</a></h1>
<blockquote>
<p><em>Sommaire</em></p>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li><em>A quoi sert Backbone.js ?</em></li>
<li><em>Qu’est-ce qu’une « Webapp » ?</em></li>
<li><em>Petit rappel à propos de MVC</em></li>
</ul>
</blockquote>
</blockquote>
<blockquote>
<p><em>Où nous allons voir pourquoi Backbone existe et quels sont les grands principes qu’il met en œuvre.</em></p>
</blockquote>
<p>Ce chapitre est très court, il présente les origines de Backbone.js, le pourquoi de son utilisation, et enfin un rappel sur le patron de conception Modèle-Vue-Contrôleur, essentiel pour la bonne compréhension du framework.</p>
<h2 id="backbone-webapps-mvc"><a href="#TOC"><span class="header-section-number">2.1</span> Backbone ? Webapps ? MVC ?</a></h2>
<p>Backbone est un framework javascript dédié à la création de <strong>Webapps</strong> en mode <strong>&quot;Single Page Application&quot;</strong>. Il implémente le pattern MVC (L'acronyme signifie : Model View Controller / Modèle Vue Contrôleur) mais, et c'est là qu'est la nouveauté, côté client, plus précisément au sein de votre navigateur. Il reproduit les mécanismes des frameworks MVC côté serveur tels Ruby on Rails, CakePHP, Play!&gt;Framework, ASP.Net MVC (avec Razor), ... Backbone a été écrit par Jeremy Ashkenas (le papa de Coffeescript et de Underscore) à l’origine pour ses propres besoin lors du développement du site DocumentCloud (<a href="http://www.documentcloud.org/home">http://www.documentcloud.org/home</a>). Son idée était de créer un framework qui permette de structurer ses développements en s’appuyant justement sur MVC. Mais avant toute chose, faisons quelques petits rappels (ou découvertes ?).</p>
<h3 id="quest-ce-quune-webapp"><a href="#TOC"><span class="header-section-number">2.1.1</span> Qu’est-ce qu’une “Webapp” ?</a></h3>
<p>Une “Webapp” n’a pas la même vocation qu’un site web même si les technologies mises en œuvre sont les mêmes. Elle a une réelle valeur applicative (gestion de catalogue produits, utilitaires, clients mails, agenda, etc. …) contrairement au site web qui le plus souvent est un medium de communication (journaux, blogs, etc. …). Assez rapidement, les technologies web ont été détournées pour tenter de remplacer les applications de gestion “client-riche” classique. Imaginez, le rêve des DSI : plus de déploiement, tout se passe dans le navigateur. Cependant, c’était sans compter les utilisateurs. Je me souviens avoir vu une gestion de catalogue il y a une dizaine d’années, en ASP 3 ou à chaque création d’article, il fallait attendre que toute la liste des articles se recharge. Ce qui avant en mode texte (sous dos) prenait 1 minute, venait de prendre 3 à 5 minutes dans la vue : 3 à 5 fois plus de temps ! Bravo la productivité ! Ensuite les technologies se sont cherchées longtemps pour tenter de remédier à ce problème : apparition des applets java, des ActiveX et là on commençait à retomber dans les travers de déploiements compliqués. Puis il y eu Flash, Flex et Silverlight, pas mal du tout il faut l’avouer, mais parallèlement le moteur javascript avait évolué, les navigateurs aussi et avec l’avènement du triptyque HTML5 – CSS3 – Javascript, un nouveau concept est apparu : la “Single Page Application” (probablement boosté par les mobiles et les tablettes … et Steve Jobs refusant que Flash/Air/Flex &amp; Java s’installent sur l’iPhone &amp; l’iPad). Mais qu’est donc une “Single Page Application” ? Il existe moult définitions, je vais donc vous donner la mienne, ensuite ce sera à vous de vous construire votre vision de “l’application web monopage”.</p>
<p>Une &quot;Single Page Application est une application web qui embarque tous les éléments nécessaires à son fonctionnement dans une seule page HTML. Les scripts javascript liés seront chargés en même temps. Ensuite l’application web chargera les ressources nécessaires (généralement des données, des images …) à la demande en utilisant Ajax évitant ainsi tout rechargement de page et procurant une expérience utilisateur proche de celle que nous connaissions en mode “client-serveur”, voire meilleure dans certains cas. Ces webapps nouvelle génération peuvent aussi fonctionner offline en profitant des possibilités des derniers navigateurs (localstorage).</p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> <em>: ce qui est amusant, c’est que dès 1999 ou 2000, Microsoft avait déjà introduit cette possibilité avec Internet Explorer 4 qui intégrait une applet Java (si si !) qui permettait de faire du Remote Protocol Call d’une page html vers le serveur sans recharger la page et en s’abonnant en javascript à l’évènement de retour (à vérifier, c’est loin, tout ça). Mais ce fut éclipsé par l’apparente simplicité de mise en œuvre des ActiveX (Flash était alors utilisé principalement pour de l’animation, mais permettait aussi ce genre d’artifice).</em></p>
</blockquote>
</blockquote>
<p>Tout ça c’est bien beau, mais vous savez comme moi qu’un code HTML+JS (+CSS) peut rapidement devenir un plat de spaghettis impossible à maintenir, pour les autres mais pour vous aussi (retournez dans votre code 6 mois plus tard ;)). Il faut donc s’astreindre à des règles et s’équiper des bons outils afin de se faciliter la tâche, ne pas avoir à réinventer la poudre à chaque fois et pouvoir coder des applications robustes facilement modifiables (faciles à corriger, faciles à faire évoluer). Et si en plus vous pouvez vous faire plaisir …</p>
<p>C’est de ce constat qu’est parti Jeremy Ashkenas, et c’est en mettant en pratique les préceptes depuis longtemps éprouvés de MVC qu’il a conçu Backbone, pour répondre à une problématique existante, ce qui le rend d’autant plus légitime. Rafraîchissons donc un peu notre mémoire à propos de MVC.</p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> <em>: pour les lecteurs qui ne connaitraient pas ce concept, ne refermez pas le livre tout de suite, vous verrez avec les exemples pratiques que le concept est simple et facilement assimilable. Donc si les quelques paragraphes théoriques qui suivent vous semblent obscurs, je vous promets que dans quelques chapitres vous aurez tout compris.</em></p>
</blockquote>
</blockquote>
<h3 id="petit-rappel-mvc"><a href="#TOC"><span class="header-section-number">2.1.2</span> Petit rappel : MVC ?</a></h3>
<p>MVC un pattern (modèle) de programmation utilisé pour développer des applications de manière structurée et organisée. Le pattern MVC, comme tous les patterns, cadre votre façon de développer. Son objectif particulier est de séparer les responsabilités de vos &quot;bouts&quot; de codes en les regroupant selon 3 rôles (responsabilités), donc le modèle, la vue et le contrôleur. Détaillons-les :</p>
<ul>
<li><strong>la vue</strong> : c'est l'IHM (Interface Homme-Machine), ce qui va apparaitre à l'écran de l'utilisateur. Elle va recevoir des infos du contrôleur (&quot;affiche moi ça !&quot;), elle va envoyer des infos au contrôleur (&quot;on m'a cliquée dessus, il me faut la liste des clients&quot;)</li>
<li><strong>le contrôleur</strong> : c'est lui donc qui reçoit des infos de la vue, qui va aller récupérer des données métiers chez le modèle (&quot;j'ai besoin pour la vue de la liste des clients&quot;), et va les renvoyer à la vue et éventuellement appliquer des traitements à ces données avant de les renvoyer.</li>
<li><strong>le modèle</strong> : c'est votre objet client, fournisseur, utilisateur, ... avec toute la mécanique qui sert à les sauvegarder, les retrouver, modifier, supprimer ...</li>
</ul>
<blockquote>
<blockquote>
<p><strong>AVERTISSEMENT 1</strong> <em>: C’est la lisibilité qui importe. Il peut y avoir des interprétations différentes du modèle MVC quant aux responsabilités de ses composants. Par exemple, est-ce le modèle qui se sauvegarde lui-même ou est-ce un contrôleur qui se chargera de la persistance ? Peu importe (ce sont des querelles de chapelle), gardons juste à l'esprit qu'il y a trois grands modes de classement de nos objets et que l'important c'est d'avoir un code propre, structuré et maintenable (Dans 6 mois, vous devez être capables de relire votre code).</em></p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p><strong>AVERTISSEMENT 2</strong> <em>: La difficulté n’est plus de mise. A l'attention des réfugiés de STRUTS. Mon &quot;1er contact&quot; avec MVC a été avec STRUTS. J'ai trouvé l'expérience peu concluante (expérience développeur désastreuse) et je suis retourné faire de l'ASP.Net &quot;à la souris&quot; (c'était avant 2005). Si certains d'entre vous se sont éloignés de la technique et ont des velléités de s'y remettre mais sont effrayés par MVC, je les rassure tout de suite, les développeurs nous ont enfin &quot;concoctés&quot; des frameworks simples et faciles à mettre en œuvre tels :</em></p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li><em>ASP.Net MVC avec le moteur de template Razor</em></li>
<li><em>Play!&gt;Framework</em></li>
<li><em>Express.js (avec nodeJS)</em></li>
<li><em>Et beaucoup d'autres</em></li>
</ul>
</blockquote>
</blockquote>
<p><em>Backbone.js respecte ce principe. Donc n'ayez pas peur, cela va être facile ;)</em></p>
<p>L'interprétation de MVC par Backbone est un peu particulière et les développeurs Java, .Net, PHP, Ruby, Python etc. pourraient être surpris. Mais, passons donc à quelques explications.</p>
<h2 id="backbone-mvc"><a href="#TOC"><span class="header-section-number">2.2</span> Backbone &amp; MVC</a></h2>
<p>Backbone &quot;embarque&quot; plusieurs composants qui vont nous permettre d'organiser notre webapp selon les &quot;préceptes&quot; MVC et simplifier les communications avec le serveur (avec le code applicatif côté serveur).</p>
<p>Voyons l'interprétation que fait Backbone du modèle MVC :</p>
<ul>
<li>Le composant <strong>Modèle</strong> (selon Backbone : <code>Backbone.Model</code>) représente les données qui vont interagir avec votre code &quot;backend&quot; (côté serveur) via des requêtes Ajax. Ce sont eux qui auront la responsabilité de la logique métier et de la validations des données.</li>
<li>Le composant <strong>Vue</strong> (selon Backbone : <code>Backbone.View</code>) n'est pas complètement une vue au sens où on l'entend habituellement (couche présentation). Dans le cas qui nous intéresse, la &quot;vraie&quot; vue est un fragment de code &quot;natif&quot; HTML dans la page web qui s'affiche dans le navigateur (il y a donc plusieurs vues dans une même page). Et <code>Backbone.View</code> est en fait un <strong>Contrôleur de vues</strong> (1) (vous verrez, ce sera plus facile à appréhender en le codant) qui va ordonnancer les évènements et interactions au sein de la page web.</li>
</ul>
<blockquote>
<blockquote>
<p><em>(1) : c'est une interprétation très personnelle, c'est discutable, je reste à votre disposition</em></p>
</blockquote>
</blockquote>
<p>Pour résumer, avec un parallèle avec du MVC dit &quot;classique&quot;, nous avons :</p>
<ul>
<li>Modèle : <code>Backbone.Model</code></li>
<li>Vue : le code HTML</li>
<li>Contrôleur (de vues) : <code>Backbone.View</code></li>
</ul>
<p><strong>Mais ce n'est pas fini !</strong> Backbone apporte 3 composants supplémentaires :</p>
<ul>
<li>Le composant <strong>Routeur</strong> : <code>Backbone.Router</code>, qui écoute/surveille les changements d'URL (dans la barre d'url du navigateur, lors d'un clic sur un lien, ...) et qui fait le lien avec les <code>Backbone.Model(s)</code> et les <code>Backbone.View(s)</code>.</li>
<li>Le composant <strong>Collection</strong> : <code>Backbone.Collection</code>, des collections de modèles avec des méthodes pour &quot;travailler&quot; avec ceux-ci (each, filter, map, ...)</li>
<li>et enfin le petit dernier, mais non des moindres, Le composant de <strong>Synchronisation</strong> <code>Backbone.sync</code>, que l'on pourrait comparer à une couche middleware, qui va permettre à nos modèles de communiquer avec le serveur. C'est <code>Backbone.sync</code> qui va faire les requêtes Ajax au serveur et &quot;remonter&quot; les résultats aux modèles.</li>
</ul>
<p><img src="RSRC/01_01_MVC.png" alt="Figure 1-1. MVC Vision &quot;Back-End&quot;" /> </p>
<p><strong><em>Figure 1-1. MVC Vision &quot;Back-End&quot;</em></strong></p>
<p><img src="RSRC/01_02_MVC.png" alt="Figure 1-2. MVC Vision &quot;Front-End&quot;" /> </p>
<p><strong><em>Figure 1-2. MVC Vision &quot;Front-End&quot;</em></strong></p>
<h2 id="pourquoi-jai-choisi-backbone"><a href="#TOC"><span class="header-section-number">2.3</span> Pourquoi j’ai choisi Backbone ?</a></h2>
<pre><code>//TODO:</code></pre>
<p>Tout ceci vous paraît bien théorique ? Alors passons tout de suite à la pratique.</p>
<h1 id="tout-de-suite-les-mains-dans-le-cambouis"><a href="#TOC"><span class="header-section-number">3</span> Tout de suite “les mains dans le cambouis”</a></h1>
<blockquote>
<p><em>Sommaire</em></p>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li><em>Les prérequis &amp; IDE pour faire fonctionner Backbone</em></li>
<li><em>jQuery en 15 minutes</em></li>
<li><em>Underscore.js en 10 minutes</em></li>
</ul>
</blockquote>
</blockquote>
<blockquote>
<p><em>Où nous allons lister les éléments nécessaires pour installer Backbone et commencer à développer avec.</em></p>
</blockquote>
<p>Le plus frustrant lorsque l'on débute la lecture d'un ouvrage informatique dans l'optique de s'auto former c'est que l'on est obligé de lire de nombreux chapitres avant de pouvoir commencer à s'y mettre. Je vais donc tenter de vous faire faire un 1er tour de Backbone.js en 20 minutes pour que vous en saisissiez rapidement la &quot;substantifique moelle&quot;. Mais avant d’utiliser Backbone, quelques prérequis sont nécessaires.  </p>
<h2 id="prérequis-les-dépendances-de-backbone"><a href="#TOC"><span class="header-section-number">3.1</span> Prérequis : les dépendances de Backbone</a></h2>
<p>Backbone a besoin au minimum de deux autres frameworks javascript pour fonctionner :</p>
<ul>
<li><strong>Underscore.js</strong> par le créateur de Backbone. Underscore est un ensemble d'outils qui permettent d'étendre javascript et qui vont vous faciliter la vie dans la gestion des Collections, Arrays, Objects, ... mais aussi vous permettre de faire du templating (nous verrons ce que c'est plus loin). Le gros avantage d'Underscore; c'est qu'il fonctionne quel que soit votre navigateur (comme Backbone). Underscore est une dépendance de Backbone, il est donc indispensable.</li>
<li><strong>jQuery</strong>, qui est un framework dédié à la manipulation des éléments de votre page HTML (on parlera du DOM, Document Object Model) mais aussi aux appels de type Ajax (nécessaire pour &quot;discuter&quot; avec le serveur). On peut dire que jQuery est un DSL (Domain Specific Language) pour le DOM. jQuery n'est pas indispensable pour faire fonctionner Backbone, mais il va grandement nous faciliter la vie dans la création de nos Webapps et va nous garantir le fonctionnement de notre code quel que soit le navigateur.</li>
</ul>
<p>Nous verrons dans quelques chapitres qu'il est tout à fait possible de &quot;marier&quot; d'autres frameworks javascript à Backbone pour :</p>
<ul>
<li>faire du templating (certains peuvent trouver la fonctionnalité de template d'Underscore limitée)</li>
<li>gérer la persistance locale (localstorage du navigateur)</li>
<li>...</li>
</ul>
<blockquote>
<blockquote>
<p><strong>Remarque :</strong> <em>Il est possible d'utiliser Zepto.js à la place de jQuery, Zepto fonctionne à l'identique de jQuery mais il est dédié principalement aux navigateurs mobiles et est beaucoup plus léger que jQuery (avantageux sur un mobile), cependant vous n'avez plus la garantie que votre code fonctionne dans d'autres navigateurs (Zepto &quot;marchera&quot; très bien sous Chrome, Safari et Firefox).</em></p>
</blockquote>
</blockquote>
<h2 id="outils-de-développement"><a href="#TOC"><span class="header-section-number">3.2</span> Outils de développement</a></h2>
<h3 id="ide-editeur"><a href="#TOC"><span class="header-section-number">3.2.1</span> IDE (Editeur)</a></h3>
<p>Pour coder choisissez l'éditeur de code avec lequel vous vous sentez le plus à l'aise. Ils ont tous leurs spécificités, ils sont gratuits, open-source ou payants. Certains &quot;puristes&quot; utilisent même Vim ou Emacs. Je vous en livre ici quelques-uns que j'ai trouvé agréables à utiliser si vous n'avez pas déjà fait votre choix :</p>
<ul>
<li>Mon préféré mais payant : WebStorm de chez JetBrains, il possède des fonctionnalités de refactoring très utiles (existe sous Windows, Linux et OSX)</li>
<li>Dans le même esprit et gratuit : Netbeans, il propose un éditeur HTML/Javascript très pertinent quant à la qualité de votre code (existe sous Windows, Linux et OSX)</li>
<li>Textmate (payant) un éditeur de texte avec colorisation syntaxique, un classique sous OSX</li>
<li>SublimeText (payant) un peu l'équivalent de Textmate mais toutes plateformes</li>
<li>Un bon compromis est KomodoEdit dans sa version communauté (donc non payant) et qui lui aussi fonctionne sur toutes les plateformes.</li>
<li>Aptana fourni aussi un bon IDE dédié Javascript sur une base Eclipse, mais je trouve qu'il propose finalement trop de fonctionnalités (comme Eclipse), et personnellement je m’y perds.</li>
</ul>
<p>Vous voyez, il y en a pour tous les goûts. En ce qui me concerne j'utilise essentiellement WebStorm ou SublimeText.</p>
<h3 id="navigateur"><a href="#TOC"><span class="header-section-number">3.2.2</span> Navigateur</a></h3>
<p>Le navigateur le plus agréable, selon moi, à utiliser pour faire du développement Web est certainement Chrome (C'est un avis très personnel, donc amis utilisateurs de Firefox ne m'en veuillez pas). En effet Chrome propose une console d'administration particulièrement puissante. C'est ce que je vais utiliser, rien ne vous empêche d'utiliser votre navigateur préféré. Par contre, que cela ne vous dispense pas d'aller tester régulièrement votre code sous d'autres navigateurs.</p>
<h2 id="initialisation-de-notre-projet-de-travail"><a href="#TOC"><span class="header-section-number">3.3</span> Initialisation de notre projet de travail</a></h2>
<p>Maintenant que nous sommes “outillés” (un éditeur de code et un navigateur) nous allons pouvoir initialiser notre environnement de développement.</p>
<h3 id="installation"><a href="#TOC"><span class="header-section-number">3.3.1</span> Installation</a></h3>
<ul>
<li>Créer un répertoire de travail <code>backbone001</code></li>
<li>Créer ensuite un sous-répertoire <code>libs</code> avec un sous-répertoire <code>vendors</code></li>
</ul>
<p>Nous copierons les frameworks javascript dans <code>vendors</code>.</p>
<ul>
<li>Téléchargez <strong>Backbone</strong> : <a href="http://documentcloud.github.com/backbone/">http://documentcloud.github.com/backbone/</a></li>
<li>Téléchargez <strong>Underscore</strong> : <a href="http://documentcloud.github.com/underscore/">http://documentcloud.github.com/underscore/</a></li>
</ul>
<blockquote>
<blockquote>
<p><strong>CONSEIL</strong> <em>: Utilisez les version non minifiées des fichiers. Il est toujours intéressant de pouvoir lire le code source des frameworks lorsqu'ils sont bien documentés, ce qui est le cas de Backbone et Underscore, n'hésitez pas à aller mettre le nez dedans, c'est instructif et ces 2 frameworks sont très lisibles, même pour des débutants.</em></p>
</blockquote>
</blockquote>
<ul>
<li>Téléchargez <strong>jQuery</strong> : <a href="http://jquery.com/">http://jquery.com/</a></li>
</ul>
<p>Nous allons aussi récupérer le framework css <strong>TwitterBootstrap</strong> qui nous permettra de faire de &quot;jolies&quot; pages sans effort. Ce n'est pas du tout obligatoire, mais c'est toujours plus satisfaisant d'avoir une belle page d'exemple. : <a href="http://twitter.github.com/bootstrap/">http://twitter.github.com/bootstrap/</a>. Téléchargez <code>bootstrap.zip</code>, &quot;dé-zippez&quot; le fichier et copiez le répertoire <code>bootstrap</code> dans votre répertoire <code>vendors</code>.</p>
<h3 id="préparons-notre-page-html"><a href="#TOC"><span class="header-section-number">3.3.2</span> Préparons notre page HTML</a></h3>
<p>A la racine de votre répertoire de travail, créez une page index.html avec le code suivant :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
    <span class="kw">&lt;html&gt;</span>
    <span class="kw">&lt;head&gt;</span>
        <span class="kw">&lt;meta</span><span class="ot"> http-equiv=</span><span class="st">&quot;Content-Type&quot;</span><span class="ot"> content=</span><span class="st">&quot;text/html; charset=utf-8&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;title&gt;</span>Backbone<span class="kw">&lt;/title&gt;</span>

        <span class="co">&lt;!-- === Styles Twitter Bootstrap --&gt;</span>
        <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">&quot;libs/vendors/bootstrap/css/bootstrap.css&quot;</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">&quot;libs/vendors/bootstrap/css/bootstrap-responsive.css&quot;</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;/head&gt;</span>

    <span class="co">&lt;!-- === ici votre IHM === --&gt;</span>
    <span class="kw">&lt;body&gt;</span>


    <span class="kw">&lt;/body&gt;</span>
    <span class="co">&lt;!-- === Références aux Frameworks === --&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/jquery-1.7.2.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/underscore.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/backbone.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>

    <span class="co">&lt;!-- === ici votre code applicatif === --&gt;</span>
    <span class="kw">&lt;script&gt;</span>

    <span class="kw">&lt;/script&gt;</span>
    <span class="kw">&lt;/html&gt;</span></code></pre>
<p>A ce niveau, vous devriez avoir un squelette de projet fonctionnel avec l'arborescence suivante :</p>
<p><img src="RSRC/02_01_ARBO.png" alt="Arborecsence" /><br /></p>
<p>Les deux paragraphes qui suivent ne sont que pour ceux d'entre vous qui ne connaissent ni <strong>jQuery</strong> ni <strong>Underscore</strong>. Ces paragraphes n'ont pas la prétention de vous apprendre ces outils, mais vous donneront les bases nécessaires pour vous en servir, pour comprendre leur utilité et pour vous donner envie d'aller plus loin. Les autres (ceux qui connaissent déjà), passez directement au <strong>§ &quot;1er contact … avec Backbone&quot;</strong>.</p>
<h2 id="jouons-avec-jquery"><a href="#TOC"><span class="header-section-number">3.4</span> Jouons avec jQuery</a></h2>
<p>JQuery est un framework javascript initialement crée par John Resig qui vous permet de prendre le contrôle de votre page HTML. Voyons tout de suite comment nous en servir. Dans notre toute nouvelle page <code>index.html</code>, préparons un peu notre bac à sable et saisissons le code suivant :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
    <span class="kw">&lt;html&gt;</span>
    <span class="kw">&lt;head&gt;</span>
        <span class="kw">&lt;meta</span><span class="ot"> http-equiv=</span><span class="st">&quot;Content-Type&quot;</span><span class="ot"> content=</span><span class="st">&quot;text/html; charset=utf-8&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;title&gt;</span>Backbone<span class="kw">&lt;/title&gt;</span>

        <span class="co">&lt;!-- === Styles Twitter Bootstrap --&gt;</span>
        <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">&quot;libs/vendors/bootstrap/css/bootstrap.css&quot;</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="kw">&gt;</span>

        <span class="co">&lt;!-- === à insérer entre les 2 &lt;link&gt; === --&gt;</span>
        <span class="kw">&lt;style&gt;</span>
            body <span class="kw">{</span>
                <span class="kw">padding-top:</span> <span class="dt">60px</span><span class="kw">;</span> 
                <span class="co">/* </span>60<span class="co">px pour mettre un peu d</span>&#39;<span class="co">espace entre la barre de titre et le contenu */</span>
                <span class="kw">padding-bottom:</span> <span class="dt">40px</span><span class="kw">;</span>
            <span class="kw">}</span>
        <span class="kw">&lt;/style&gt;</span>

        <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">&quot;libs/vendors/bootstrap/css/bootstrap-responsive.css&quot;</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="kw">&gt;</span>

    <span class="kw">&lt;/head&gt;</span>

    <span class="co">&lt;!-- === ici votre IHM === --&gt;</span>
    <span class="kw">&lt;body&gt;</span>
        <span class="co">&lt;!--</span>
<span class="co">           les classe css &quot;navbar navbar-fixed-top&quot;, &quot;navbar-inner&quot;, &quot;container&quot;, </span>
<span class="co">           &quot;brand&quot;, &quot;hero-unit&quot;</span>
<span class="co">           viennent de la feuille de style &quot;twitter bootstrap &quot;</span>
<span class="co">        --&gt;</span>
        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar navbar-fixed-top&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-inner&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;</span>
                    <span class="kw">&lt;a</span><span class="ot"> class=</span><span class="st">&quot;brand&quot;</span><span class="kw">&gt;</span>Mon Blog<span class="kw">&lt;/a&gt;</span>
                <span class="kw">&lt;/div&gt;</span>
            <span class="kw">&lt;/div&gt;</span>
        <span class="kw">&lt;/div&gt;</span>

        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;</span>

            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;hero-unit&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;h1&gt;</span>Backbone rocks !!!<span class="kw">&lt;/h1&gt;</span>
                <span class="kw">&lt;p&gt;</span>
                    &quot;Ma vie mon oeuvre&quot;
                <span class="kw">&lt;/p&gt;</span>
            <span class="kw">&lt;/div&gt;</span>

            <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;articles_box&quot;</span><span class="kw">&gt;</span>

                <span class="kw">&lt;h1</span><span class="ot"> id=</span><span class="st">&quot;current_articles_title&quot;</span><span class="kw">&gt;</span>les articles du blogs<span class="kw">&lt;/h1&gt;</span>

                <span class="kw">&lt;ul</span><span class="ot"> id=</span><span class="st">&quot;current_articles_list&quot;</span><span class="kw">&gt;</span>
                    <span class="kw">&lt;li&gt;</span>Backbone et les modèles<span class="kw">&lt;/li&gt;</span>
                    <span class="kw">&lt;li&gt;</span>Backbone et les vues<span class="kw">&lt;/li&gt;</span>
                    <span class="kw">&lt;li&gt;</span>Backbone : mais y a-t-il vraiment un contrôleur dans l&#39;avion ?<span class="kw">&lt;/li&gt;</span>
                <span class="kw">&lt;/ul&gt;</span>

                <span class="kw">&lt;h1</span><span class="ot"> id=</span><span class="st">&quot;next_articles_title&quot;</span><span class="kw">&gt;</span>les articles à venir<span class="kw">&lt;/h1&gt;</span>

                <span class="kw">&lt;ul</span><span class="ot"> id=</span><span class="st">&quot;next_articles_list&quot;</span><span class="kw">&gt;</span>
                    <span class="kw">&lt;li&gt;</span>Backbone et le localstorage<span class="kw">&lt;/li&gt;</span>
                    <span class="kw">&lt;li&gt;</span>Backbone.sync : comment ça marche<span class="kw">&lt;/li&gt;</span>
                <span class="kw">&lt;/ul&gt;</span>

            <span class="kw">&lt;/div&gt;</span>
        <span class="kw">&lt;/div&gt;</span>

    <span class="kw">&lt;/body&gt;</span>
    <span class="co">&lt;!-- === Références aux Frameworks === --&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/jquery-1.7.2.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/underscore.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/backbone.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>

    <span class="co">&lt;!-- === ici votre code applicatif === --&gt;</span>
    <span class="kw">&lt;script&gt;</span>

    <span class="kw">&lt;/script&gt;</span>
    <span class="kw">&lt;/html&gt;</span></code></pre>
<p>Une fois votre page terminée, sauvegardez là et ouvrez là dans votre navigateur préféré (qui je le rappelle, pour des raisons purement pédagogique est Chrome) :</p>
<p><img src="RSRC/02_02_PAGE.png" alt="Page" /><br /> Notez au passage la qualité graphique de votre page ;), tout ça sans trop d'efforts, grâce à TwitterBootstrap.</p>
<h3 id="jouons-avec-notre-page-en-mode-commande"><a href="#TOC"><span class="header-section-number">3.4.1</span> &quot;Jouons&quot; avec notre page en mode commande</a></h3>
<p>Dans un premier temps, ouvrez la console de Chrome (ou Safari) : faite un clic droit sur la page et sélectionner &quot;Inspect Element&quot; (ou &quot;Inspecter l'élément). Pour les aficionados de Firefox : utilisez les menus : Tools/Web Developer/Web Console. Vous devriez obtenir ceci (cliquez sur le bouton &quot;Console&quot; si nécessaire :</p>
<p><img src="RSRC/02_03_CONSOLE.png" alt="Console" /><br /></p>
<h4 id="saisissons-nos-1ères-commandes"><a href="#TOC"><span class="header-section-number">3.4.1.1</span> Saisissons nos 1ères commandes :</a></h4>
<p>Je voudrais la liste de mes titres <code>&lt;H1&gt;</code> : dans la console, saisir : <code>$('h1')</code>, validez, et vous obtenez un tableau (Array au sens javascript) des nodes html de type <code>&lt;H1&gt;</code> présentes dans votre page html :</p>
<p><img src="RSRC/02_04_JQUERY.png" alt="jQuery" /><br /></p>
<p>Je voudrais le texte du titre <code>&lt;H1&gt;</code> dont l'id est <code>&quot;current_articles_title&quot;</code> : dans la console, saisir : <code>$('#current_articles_title').text()</code>. L'identifiant étant unique, en fait le type de la node est peu important :</p>
<p><img src="RSRC/02_05_JQUERY.png" alt="jQuery" /><br /></p>
<p>Mais comment dois-je faire pour avoir le texte du premier <code>&lt;H1&gt;</code> de ma page, il n'a pas d'id ?!?. Tout simplement, en utilisant la commande suivante : <code>$('h1').first().text()</code> :</p>
<p><img src="RSRC/02_06_JQUERY.png" alt="jQuery" /><br /></p>
<h4 id="modifions-laspect-de-notre-page-dynamiquement"><a href="#TOC"><span class="header-section-number">3.4.1.2</span> Modifions l’aspect de notre page dynamiquement :</a></h4>
<p>Les commandes sont toujours à saisir dans la console du navigateur. Je voudrais :</p>
<ul>
<li>changer le titre de mon blog : <code>$('h1').first().text(&quot;Backbone c'est top !&quot;)</code>, attention pensez bien au <code>first()</code> sinon vous allez changer tous les textes de tous les <code>H1</code> de la page.</li>
<li>récupérer le code HTML de la &quot;boîte de titre&quot; (le div avec la classe css : <code>class=&quot;hero-unit&quot;</code>) : <code>$('[class=&quot;hero-unit&quot;]').html()</code>, notez bien que <code>$('[class=&quot;hero-unit&quot;]').text()</code> ne retourne pas le même résultat. On peut aussi écrire ceci plus simplement : <code>$('.hero-unit').html()</code> : le <code>&quot;.&quot;</code> correspond à une classe css, comme le <code>&quot;#&quot;</code> permet de rechercher un élément par son id.</li>
<li><p>changer les couleurs de police et de fond de tous les tags H1 :</p>
<p><code>$('h1').css(&quot;color&quot;,&quot;white&quot;).css(&quot;background-color&quot;,&quot;black&quot;)</code>, vous voyez que vous pouvez faire des appels chaînés, mais une autre possibilité serait la suivante :</p>
<pre><code>    $(&#39;h1&#39;).css({color:&quot;yellow&quot;, backgroundColor:&quot;green&quot;})</code></pre></li>
</ul>
<p><img src="RSRC/02_07_JQUERY.png" alt="jQuery" /><br /></p>
<p><img src="RSRC/02_08_JQUERY.png" alt="jQuery" /><br /></p>
<h4 id="allons-plus-loin"><a href="#TOC"><span class="header-section-number">3.4.1.3</span> Allons plus loin …</a></h4>
<p>Je voudrais :</p>
<ul>
<li>la valeur de l'id de la deuxième liste (<code>UL</code>) : <code>$('ul').eq(1).attr(&quot;id&quot;)</code>, je cherche la liste d'index 1 (le 1er élément possède l'index 0).</li>
<li>parcourir les lignes (<code>LI</code>) de la liste dont l'id est <code>&quot;next_articles_list&quot;</code> et obtenir leur texte : <code>$('#next_articles_list').find('li').each(function (index) { console.log( $(this).text() ); })</code></li>
<li><p>ajouter une nouvelle ligne à la 2ème liste :</p>
<pre><code>$(&#39;&lt;li&gt;Templating et Backbone&lt;/li&gt;&#39;).appendTo(&#39;#next_articles_list&#39;)</code></pre></li>
<li>cacher la 1ère liste : <code>$('#current_articles_list').hide()</code></li>
<li>l'afficher à nouveau : <code>$('#current_articles_list').show()</code></li>
<li>la cacher à nouveau, mais &quot;doucement&quot; : <code>$('#current_articles_list').hide('slow')</code></li>
<li><p>l'afficher à nouveau, mais &quot;rapidement&quot; : <code>$('#current_articles_list').show('fast')</code></p></li>
</ul>
<p><img src="RSRC/02_09_JQUERY.png" alt="jQuery" /><br /></p>
<h3 id="les-évènements"><a href="#TOC"><span class="header-section-number">3.4.2</span> Les évènements</a></h3>
<pre><code>//À traiter ...</code></pre>
<h3 id="quelques-bonnes-pratiques"><a href="#TOC"><span class="header-section-number">3.4.3</span> Quelques bonnes pratiques</a></h3>
<h4 id="pensez-performances"><a href="#TOC"><span class="header-section-number">3.4.3.1</span> Pensez performances :</a></h4>
<p>Si vous devez utiliser plusieurs fois le même élément de votre page : par exemple <code>$('#current_articles_list')</code>, sachez qu'à chaque fois jQuery &quot;interroge&quot; le DOM. Pour des raisons de performances, il est conseillé d'affecter le résultat de la sélection à une variable que vous réutiliserez ensuite. De cette manière, le DOM n'est interrogé qu'une seule fois. Vous pouvez tester ceci dans la console :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> currArtList = $(<span class="ch">&#39;#current_articles_list&#39;</span>); 
    <span class="kw">currArtList</span>.<span class="fu">hide</span>(<span class="ch">&#39;slow&#39;</span>); 
    <span class="kw">currArtList</span>.<span class="fu">show</span>(<span class="ch">&#39;fast&#39;</span>);</code></pre>
<h4 id="soyez-sûr-que-les-éléments-de-votre-page-sont-tous-chargés"><a href="#TOC"><span class="header-section-number">3.4.3.2</span> Soyez sûr que les éléments de votre page sont tous chargés :</a></h4>
<p>Il est intéressant (indispensable) d'avoir la garantie que son code javascript n'est exécuté qu'une seule fois la page HTML chargée dans son entièreté, surtout si ce code accède à des éléments du DOM. jQuery a une fonction pour ça : <code>$(document).ready(handler)</code> ou encore plus court : <code>$(handler)</code> où <code>handler</code> est une fonction. Mettez ce code dans la balise <code>&lt;script&gt;</code> de votre page <code>index.html</code> :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;est-ce que le DOM est chargé ??? &quot;</span>, $(<span class="ch">&#39;#current_articles_list&#39;</span>)); 
    $(<span class="kw">function</span> (){ 
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;je suis sûr que le DOM est chargé &quot;</span>, $(<span class="ch">&#39;#current_articles_list&#39;</span>)); 
    });</code></pre>
<p>Puis ouvrez la page dans votre navigateur et activez la console :</p>
<p><img src="RSRC/02_10_JQUERY.png" alt="jQuery" /><br /></p>
<p>Il semble que tous les éléments soient chargés correctement avec ou sans l’utilisation de la méthode <code>ready()</code> de jQuery. Vous avez du remarquer que j'avais déplacé mon code javascript et les références aux autres code javascript &quot;en bas de ma page&quot;. Maintenant, déplacez <code>&lt;script src=&quot;libs/vendors/jquery-1.7.2.js&quot;&gt;&lt;/script&gt;</code> et le code source que nous avons écrit au niveau du header (balise <code>&lt;head&gt;</code>) de la page, ce qui est plus &quot;classique&quot; et rechargez la page :</p>
<p><img src="RSRC/02_11_JQUERY.png" alt="jQuery" /><br /></p>
<p>Et là on voit bien qu'au 1er appel <code>$('#current_articles_list')</code> jQuery ne trouve rien, puis une fois le DOM chargé, jQuery trouve la liste. J'ai mis mes codes en bas de page, pour des raisons de performances et c'est pour ça que cela &quot;semblait&quot; fonctionner même à l'extérieur de <code>$(document).ready(handler)</code>, les éléments se chargeant plus rapidement, mais ça ne garantit rien, tout particulièrement lorsque votre page n’est plus en local. Donc n'oubliez jamais d'exécuter votre code au bon moment grâce à <code>$(document).ready(handler)</code>, ... Et remettez quand même votre code en bas de page ;).</p>
<p>Vous venez de voir une infime partie des possibilités de jQuery, mais cela vous donne déjà un aperçu et vous permet de commencer à jouer avec et aller plus loin. jQuery permet aussi de faire des requêtes AJAX (http) vers des serveurs web, mais nous verrons cela un peu plus tard.</p>
<pre><code>//TODO: traiter la notion d’id versus la notion de name</code></pre>
<h2 id="jouons-avec-underscore"><a href="#TOC"><span class="header-section-number">3.5</span> Jouons avec Underscore</a></h2>
<p>Underscore est un framework javascript (par le créateur de Backbone) qui apporte de nombreuses fonctionnalités pour faire des traitements sur des tableaux de valeurs (Array) , des collections (tableaux d'objet). Certaines de ces fonctionnalités existent en javascript, mais uniquement dans sa dernière version, alors qu'avec Underscore vous aurez la garantie qu'elles s'exécutent sur tous les navigateurs. Mais Underscore, ce sont aussi des fonctionnalités autour des fonctions et des objets (là aussi, le framework vous procure les possibilités de la dernière version de javascript quel que soit votre navigateur ... ou presque, je n'ai pas testé sous IE6) et autres utilitaires, tels le templating. Je vous engage à aller sur le site, la documentation est particulièrement bien faite.</p>
<h3 id="quelques-exemples-dutilisations"><a href="#TOC"><span class="header-section-number">3.5.1</span> Quelques exemples d'utilisations</a></h3>
<p>Backbone utilise et encapsule de nombreuses fonctionnalités d'Underscore (Collection, modèle objet, ...) donc vous n'aurez pas forcément l'obligation d'utiliser Underscore directement. Je vous livre cependant quelques exemples, car cette puissante librairie peut vous aider sur d'autres projets pas forcément dédiés Backbone. Pour les tester, nous continuons avec la console de notre navigateur (toujours avec notre page index.html).</p>
<h4 id="tableaux-et-collections"><a href="#TOC"><span class="header-section-number">3.5.1.1</span> Tableaux et Collections :</a></h4>
<p>Commencez par saisir ceci :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> buddies = [],
        bob = { <span class="dt">name </span>: <span class="st">&quot;Bob Morane&quot;</span>, <span class="dt">age </span>: <span class="dv">32</span> },
        sam = { <span class="dt">name </span>: <span class="st">&quot;Sammy&quot;</span>, <span class="dt">age </span>: <span class="dv">43</span> },
        tom = { <span class="dt">name </span>: <span class="st">&quot;Tommy&quot;</span>, <span class="dt">age </span>: <span class="dv">25</span> };
    <span class="kw">buddies</span>.<span class="fu">push</span>(bob, sam, tom);</code></pre>
<p>Nous avons donc un tableau de 3 objets :</p>
<p><img src="RSRC/02_12_UNDERSCORE.png" alt="Underscore" /><br /></p>
<p>Je souhaite maintenant parcourir le tableau d’objets et afficher les informations de chacun d’eux. Pour cela utilisez la commande <code>each()</code> de la manière suivante :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">_</span>.<span class="fu">each</span>(buddies, <span class="kw">function</span> (buddy) { 
        <span class="kw">console</span>.<span class="fu">log</span> (<span class="kw">buddy</span>.<span class="fu">name</span>, <span class="kw">buddy</span>.<span class="fu">age</span>); 
    });</code></pre>
<p>Et vous obtiendrez ceci :</p>
<p><img src="RSRC/02_13_UNDERSCORE.png" alt="Underscore" /><br /></p>
<p>Je voudrais maintenant les “buddies” dont l’âge est inférieur à 43 ans. Nous allons utiliser la commande <code>filter()</code> :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">_</span>.<span class="fu">filter</span>(buddies, <span class="kw">function</span> (filteredBuddies) { 
        <span class="kw">return</span> <span class="kw">filteredBuddies</span>.<span class="fu">age</span> &lt; <span class="dv">43</span>; 
    });</code></pre>
<p>Et nous obtenons bien :</p>
<p><img src="RSRC/02_14_UNDERSCORE.png" alt="Underscore" /><br /></p>
<h4 id="templating"><a href="#TOC"><span class="header-section-number">3.5.1.2</span> Templating :</a></h4>
<p>Je vous en parle maintenant, car ce &quot;bijou&quot; va nous servir très rapidement. Je voudrais générer une liste au sens HTML (<code>&lt;ul&gt;&lt;li&gt;&lt;/li&gt;&lt;/ul&gt;</code>) à partir de mon tableau d'objets buddies. Nous allons donc créer une variable “template” (un peu comme une page JSP ou ASP) :</p>
<pre><code>var templateList =
&quot;&lt;ul&gt; &lt;% _.each(buddies, function (buddy) { %&gt;\
&lt;li&gt;&lt;%= buddy.name %&gt; : &lt;%= buddy.age %&gt; &lt;/li&gt;\
&lt;% }); %&gt;\
&lt;/ul&gt;&quot;;</code></pre>
<p>Que nous utiliserons de cette façon (nous passons à la méthode le template et les données):</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">_</span>.<span class="fu">template</span>(templateList, buddies);</code></pre>
<p>Pour le résultat suivant :</p>
<p><img src="RSRC/02_15_UNDERSCORE.png" alt="Underscore" /><br /></p>
<p>Voilà, nous avons fait un rapide tour d’horizon des éléments qui nous seront nécessaires par la suite. Nous pouvons enfin commencer.</p>
<h1 id="er-contact-avec-backbone"><a href="#TOC"><span class="header-section-number">4</span> 1er contact … avec Backbone</a></h1>
<blockquote>
<p><em>Sommaire</em></p>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li><em>Premier modèle</em></li>
<li><em>Première collection</em></li>
<li><em>Première vue &amp; premier template</em></li>
</ul>
</blockquote>
</blockquote>
<blockquote>
<p><em>Nous allons faire un premier exemple Backbone pas à pas, même sans connaître le framework. Cela va permettre de « désacraliser » la bête et de mettre un peu de liant avec tout ce que nous avons vu précédemment. Puis nous passerons dans le détail tous les composants de Backbone dans les chapitres qui suivront.</em></p>
</blockquote>
<p>Voilà, il est temps de s'y mettre. L'application que nous allons réaliser avec Backbone tout au long de cet ouvrage va être un Blog, auquel nous ajouterons au fur et à mesure des fonctionnalités pour finalement le transformer en CMS (Content Management System). Je vous l'accorde ce n'est pas très original, mais cela répond à des problématiques classiques (récurrentes ?) dans notre vie &quot;d'informaticien&quot; et cela a le mérite d'avoir un aspect pratique et utile. Notre point de départ va être un blog que nous agrémenterons de fonctionnalités au fil des chapitres.</p>
<h2 id="ère-application-backbone"><a href="#TOC"><span class="header-section-number">4.1</span> 1ère application Backbone</a></h2>
<p>Nous allons faire ici un exemple très rapide, sans forcément entrer dans le détail ni mettre en œuvre les bonnes pratiques d'organisation de code. Cet exercice est là pour démontrer la simplicité d'utilisation, et le code devrait être suffisamment simple pour se passer d'explications. Donc, &quot;pas de panique !&quot;, laissez-vous guider, dans <strong>15 minutes</strong> vous aurez une 1ère ébauche.</p>
<h3 id="préparons-notre-page"><a href="#TOC"><span class="header-section-number">4.1.1</span> Préparons notre page</a></h3>
<p>Nous allons utiliser notre même page <code>index.html</code>, mais faisons un peu de ménage à l'intérieur avant de commencer :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
    <span class="kw">&lt;html&gt;</span>
    <span class="kw">&lt;head&gt;</span>
        <span class="kw">&lt;meta</span><span class="ot"> http-equiv=</span><span class="st">&quot;Content-Type&quot;</span><span class="ot"> content=</span><span class="st">&quot;text/html; charset=utf-8&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;title&gt;</span>Backbone<span class="kw">&lt;/title&gt;</span>
        <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">&quot;libs/vendors/bootstrap/css/bootstrap.css&quot;</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="kw">&gt;</span>

        <span class="kw">&lt;style&gt;</span>
            body <span class="kw">{</span>
                <span class="kw">padding-top:</span> <span class="dt">60px</span><span class="kw">;</span> 
                <span class="kw">padding-bottom:</span> <span class="dt">40px</span><span class="kw">;</span>
            <span class="kw">}</span>
        <span class="kw">&lt;/style&gt;</span>

        <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">&quot;libs/vendors/bootstrap/css/bootstrap-responsive.css&quot;</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="kw">&gt;</span>

    <span class="kw">&lt;/head&gt;</span>

    <span class="kw">&lt;body&gt;</span>
        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar navbar-fixed-top&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-inner&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;</span>
                    <span class="kw">&lt;a</span><span class="ot"> class=</span><span class="st">&quot;brand&quot;</span><span class="kw">&gt;</span>Mon Blog<span class="kw">&lt;/a&gt;</span>
                <span class="kw">&lt;/div&gt;</span>
            <span class="kw">&lt;/div&gt;</span>
        <span class="kw">&lt;/div&gt;</span>

        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;</span>

            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;hero-unit&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;h1&gt;</span>Backbone rocks !!!<span class="kw">&lt;/h1&gt;</span>
            <span class="kw">&lt;/div&gt;</span>


        <span class="kw">&lt;/div&gt;</span>

    <span class="kw">&lt;/body&gt;</span>
    <span class="co">&lt;!-- === Références aux Frameworks === --&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/jquery-1.7.2.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/underscore.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/backbone.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>

    <span class="kw">&lt;script&gt;</span>
        $(<span class="kw">function</span> (){

        });
    <span class="kw">&lt;/script&gt;</span>
    <span class="kw">&lt;/html&gt;</span></code></pre>
<p>L'essentiel de notre travail va se passer dans la balise <code>&lt;script&gt;&lt;/script&gt;</code> en bas de page. De quoi avons-nous besoin dans un blog ?</p>
<ul>
<li>Des articles : un ensemble d'articles (ou &quot;posts&quot;), généralement écrits par une seule personne (le blog est personnel, c'est en lui donnant des fonctionnalités multi-utilisateurs que nous nous dirigerons doucement vers un CMS).</li>
<li>Des commentaires : Il est de bon ton de permettre aux lecteurs du blog de pouvoir commenter les articles.</li>
</ul>
<p>Pour le moment nous allons nous concentrer uniquement sur les articles, notre objectif sera le suivant : &quot;Afficher une liste d'articles sur la page principale&quot;.</p>
<h2 id="le-modèle-article"><a href="#TOC"><span class="header-section-number">4.2</span> Le Modèle “Article”</a></h2>
<p>Dans la balise <code>&lt;script&gt;&lt;/script&gt;</code> saisissez le code suivant :</p>
<p><em>Définition d’un modèle Article :</em></p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;script&gt;</span>

        $(<span class="kw">function</span> (){
            <span class="co">//permettra d</span>&#39;<span class="co">accéder à nos variables en mode console</span>
            <span class="kw">window</span>.<span class="fu">blog</span> = {}; 

            <span class="co">/*</span>--- Modèle article ---<span class="co">*/</span>

            <span class="co">// une </span>&quot;<span class="co">sorte</span>&quot;<span class="co"> de classe Article</span>
            <span class="kw">blog</span>.<span class="fu">Article</span> = <span class="kw">Backbone.Model</span>.<span class="fu">extend</span>({
                <span class="co">//les valeurs par défaut d</span>&#39;<span class="co">un article</span>
                <span class="dt">defaults </span>: { 
                    <span class="dt">title </span>: <span class="st">&quot;titre</span> <span class="st">de</span> <span class="st">l</span>&#39;<span class="st">article&quot;</span>,
                    <span class="dt">content </span>: <span class="st">&quot;contenu</span> <span class="st">de</span> <span class="st">l</span>&#39;<span class="st">article&quot;</span>,
                    <span class="dt">publicationDate </span>: <span class="kw">new</span> <span class="kw">Date</span>()
                },
                <span class="co">// s</span>&#39;<span class="co">exécute à la création d</span>&#39;<span class="co">un article</span>
                <span class="dt">initialize </span>: <span class="kw">function</span> () { 
                    <span class="kw">console</span>.<span class="fu">log</span> (<span class="st">&quot;Création</span> <span class="st">d</span>&#39;<span class="st">un</span> <span class="st">nouvel</span> <span class="st">article&quot;</span>)
                }
            });

        });

    <span class="kw">&lt;/script&gt;</span></code></pre>
<p>Sauvegardez, relancez dans le navigateur, et allez dans la console :</p>
<ul>
<li>Pour créer un nouvel article : tapez la commande <code>myFirstArticle = new blog.Article()</code></li>
<li>Pour &quot;voir&quot; le titre de l'article : tapez la commande <code>myFirstArticle.get(&quot;title&quot;)</code></li>
<li>Pour &quot;voir&quot; le contenu de l'article : tapez la commande <code>myFirstArticle.get(&quot;content&quot;)</code></li>
<li>Pour changer le titre de l'article : tapez la commande <code>myFirstArticle.set(&quot;title&quot;,&quot;MON TITRE&quot;)</code> ou <code>myFirstArticle.set({title : &quot;MON TITRE&quot;})</code></li>
<li>Pour changer simultanément le titre et le contenu : tapez la commande <code>myFirstArticle.set({title : &quot;MON TITRE ...&quot;, content : &quot;blablabla&quot;})</code></li>
<li>Pour créer un article directement avec un titre et du contenu : tapez la commande <code>mySecondArticle = new blog.Article({title : &quot;MON AUTRE ARTICLE&quot;, content : &quot;lore ipsum ...&quot;})</code></li>
</ul>
<p><img src="RSRC/03_01_BB.png" alt="BB" /><br /></p>
<p>Vous venez donc de voir que nous avons défini le modèle article “un peu” comme une classe qui hériterait (<code>extend</code>) de la classe <code>Backbone.Model</code>, que nous lui avons défini des valeurs par défauts (<code>defaults</code>), et affecté une méthode d’initialisation (<code>initialize</code>). Et qu’il existe un système de getter et de setter un peu particulier (<code>model.get(property_name)</code>, <code>model.set(property_name, value)</code>), mais nous verrons ultérieurement dans le détail comment fonctionnent les modèles.</p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> <em>: le modèle de programmation de Javascript est bien orienté objet, mais n’est pas orienté “classe” comme peut l’être par exemple Java. Cela peut déstabiliser au départ, mais je vous engage à lire [REF VERS ARTICLE] à ce propos.</em></p>
</blockquote>
</blockquote>
<h2 id="la-collection-darticles"><a href="#TOC"><span class="header-section-number">4.3</span> La Collection d’Articles</a></h2>
<p>Nous allons maintenant définir une collection qui nous aidera à gérer nos articles. Donc, à la suite du modèle Article saisissez le code suivant :</p>
<p><em>Définition d’une collection d’articles :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="co">/*--- Collection d&#39;articles ---*/</span>

    <span class="kw">blog</span>.<span class="fu">ArticlesCollection</span> = <span class="kw">Backbone.Collection</span>.<span class="fu">extend</span>({
        <span class="dt">model </span>: <span class="kw">blog</span>.<span class="fu">Article</span>,
        <span class="dt">initialize </span>: <span class="kw">function</span> () {
            <span class="kw">console</span>.<span class="fu">log</span> (<span class="st">&quot;Création d&#39;une collection d&#39;articles&quot;</span>)
        }
    });</code></pre>
<blockquote>
<blockquote>
<p><strong>Notez</strong> <em>qu'il faut bien préciser le type de modèle adressé par la collection (on pourrait dire que la collection est typée).</em></p>
</blockquote>
</blockquote>
<p>Sauvegarder, relancer dans le navigateur, et retournez à nouveau dans la console et saisissez les commandes suivantes :</p>
<ul>
<li><p>Création de la collection :</p>
<pre><code>listeArticles = new blog.ArticlesCollection()</code></pre></li>
<li><p>Ajout d’articles à la collection :</p>
<pre><code>listeArticles.add(new blog.Article({ title : &quot;titre1&quot;, content : &quot;contenu1&quot; }))
listeArticles.add(new blog.Article({ title : &quot;titre2&quot;, content : &quot;contenu2&quot; }))
listeArticles.add(new blog.Article({ title : &quot;titre3&quot;, content : &quot;contenu3&quot; }))</code></pre></li>
</ul>
<p>Nous venons donc d'ajouter 3 articles à notre collection,</p>
<ul>
<li>Si vous tapez la commande <code>listeArticles.models</code> vous obtiendrez un tableau de modèles</li>
<li><p>Si vous souhaitez obtenir le titre du 2ème article de la collection, tapez :</p>
<p><code>listeArticles.models[1].get(&quot;title&quot;)</code></p></li>
<li><p>vous souhaitez parcourir les articles de la collection et afficher leur titre :</p>
<p><code>listeArticles.each(function(article){ console.log (article.get(&quot;title&quot;)); });</code></p></li>
</ul>
<blockquote>
<blockquote>
<p>Cela vous rappelle quelque chose ? Le <code>each</code> de Backbone est implémenté grâce à Underscore.</p>
</blockquote>
</blockquote>
<p><img src="RSRC/03_02_BB.png" alt="BB" /><br /></p>
<p><strong>Maintenant que nous avons de quoi gérer nos données, il est temps de les afficher dans notre page HTML.</strong></p>
<h2 id="vue-et-template"><a href="#TOC"><span class="header-section-number">4.4</span> Vue et Template</a></h2>
<p>Avant toute chose, allons ajouter dans notre code javascript (en bas de la page HTML) le bout de code qui va créer les articles et la collection d'articles pour nous éviter de tout re-saisir à chaque fois. Donc après le code de la collection, ajoutez ceci :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="co">/*--- bootstrap ---*/</span>
    <span class="kw">blog</span>.<span class="fu">listeArticles</span> = <span class="kw">new</span> <span class="kw">blog</span>.<span class="fu">ArticlesCollection</span>();

    <span class="kw">blog.listeArticles</span>.<span class="fu">add</span>(<span class="kw">new</span> <span class="kw">blog</span>.<span class="fu">Article</span>({ <span class="dt">title </span>: <span class="st">&quot;titre1&quot;</span>, <span class="dt">content </span>: <span class="st">&quot;contenu1&quot;</span> }));
    <span class="kw">blog.listeArticles</span>.<span class="fu">add</span>(<span class="kw">new</span> <span class="kw">blog</span>.<span class="fu">Article</span>({ <span class="dt">title </span>: <span class="st">&quot;titre2&quot;</span>, <span class="dt">content </span>: <span class="st">&quot;contenu2&quot;</span> }));
    <span class="kw">blog.listeArticles</span>.<span class="fu">add</span>(<span class="kw">new</span> <span class="kw">blog</span>.<span class="fu">Article</span>({ <span class="dt">title </span>: <span class="st">&quot;titre3&quot;</span>, <span class="dt">content </span>: <span class="st">&quot;contenu3&quot;</span> }));
    <span class="kw">blog.listeArticles</span>.<span class="fu">add</span>(<span class="kw">new</span> <span class="kw">blog</span>.<span class="fu">Article</span>({ <span class="dt">title </span>: <span class="st">&quot;titre4&quot;</span>, <span class="dt">content </span>: <span class="st">&quot;contenu4&quot;</span> }));
    <span class="kw">blog.listeArticles</span>.<span class="fu">add</span>(<span class="kw">new</span> <span class="kw">blog</span>.<span class="fu">Article</span>({ <span class="dt">title </span>: <span class="st">&quot;titre5&quot;</span>, <span class="dt">content </span>: <span class="st">&quot;contenu5&quot;</span> }));</code></pre>
<p>Ensuite dans le code html, ajoutons le template de notre vue et le div dans lequel les données seront affichées :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="er">&lt;</span>% _.each(articles, function(article) { %&gt;
    <span class="kw">&lt;h1&gt;</span><span class="er">&lt;</span>%= article.title %&gt;<span class="kw">&lt;/h1&gt;</span>
    <span class="kw">&lt;h6&gt;</span><span class="er">&lt;</span>%= article.publicationDate %&gt;<span class="kw">&lt;/h6&gt;</span>
    <span class="kw">&lt;p&gt;</span><span class="er">&lt;</span>%= article.content %&gt;<span class="kw">&lt;/p&gt;</span>
    <span class="er">&lt;</span>% }); %&gt;</code></pre>
<p>donc :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;body&gt;</span>

        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar navbar-fixed-top&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-inner&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;</span>
                    <span class="kw">&lt;a</span><span class="ot"> class=</span><span class="st">&quot;brand&quot;</span><span class="kw">&gt;</span>Mon Blog<span class="kw">&lt;/a&gt;</span>
                <span class="kw">&lt;/div&gt;</span>
            <span class="kw">&lt;/div&gt;</span>
        <span class="kw">&lt;/div&gt;</span>

        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;</span>

            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;hero-unit&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;h1&gt;</span>Backbone rocks !!!<span class="kw">&lt;/h1&gt;</span>
            <span class="kw">&lt;/div&gt;</span>

            <span class="co">&lt;!-- ìci notre template --&gt;</span>
            <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/template&quot;</span><span class="ot"> id=</span><span class="st">&quot;articles-collection-template&quot;</span><span class="kw">&gt;</span>

                &lt;% <span class="kw">_</span>.<span class="fu">each</span>(articles, <span class="kw">function</span>(article) { %&gt;
                &lt;h1&gt;&lt;%= <span class="kw">article</span>.<span class="fu">title</span> %&gt;&lt;/h1&gt;
                &lt;h6&gt;&lt;%= <span class="kw">article</span>.<span class="fu">publicationDate</span> %&gt;&lt;/h6&gt;
                &lt;p&gt;&lt;%= <span class="kw">article</span>.<span class="fu">content</span> %&gt;&lt;/p&gt;
                &lt;% }); %&gt;

            <span class="kw">&lt;/script&gt;</span>
            <span class="co">&lt;!-- les données seront affichées ici --&gt;</span>
            <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;articles-collection-container&quot;</span><span class="kw">&gt;&lt;/div&gt;</span>

        <span class="kw">&lt;/div&gt;</span>

    <span class="kw">&lt;/body&gt;</span></code></pre>
<p>Puis dans le code javascript, à la suite du code de la collection et avant le code de chargement des données (bootstrap), ajoutez le code de la vue Backbone :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="co">/*--- Vues ---*/</span>
    <span class="kw">blog</span>.<span class="fu">ArticlesView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
        <span class="dt">el </span>: $(<span class="st">&quot;#articles-collection-container&quot;</span>),

        <span class="dt">initialize </span>: <span class="kw">function</span> () {
            <span class="kw">this</span>.<span class="fu">template</span> = <span class="kw">_</span>.<span class="fu">template</span>($(<span class="st">&quot;#articles-collection-template&quot;</span>).<span class="fu">html</span>());
        },

        <span class="dt">render </span>: <span class="kw">function</span> () {
            <span class="kw">var</span> renderedContent = <span class="kw">this</span>.<span class="fu">template</span>({ <span class="dt">articles </span>: <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">toJSON</span>() });
            $(<span class="kw">this</span>.<span class="fu">el</span>).<span class="fu">html</span>(renderedContent);
            <span class="kw">return</span> <span class="kw">this</span>;
        }
    });</code></pre>
<h3 id="quavons-nous-fait"><a href="#TOC"><span class="header-section-number">4.4.1</span> Qu’avons-nous fait ?</a></h3>
<p>Eh bien, nous avons défini une vue avec :</p>
<ul>
<li><p>Une propriété <code>el</code> (pour élément) à laquelle on “attache” le <code>&lt;div&gt;</code> dont l’id est :</p>
<p><code>“articles-collection-container”</code>. C’est dans ce <code>&lt;div&gt;</code> que seront affichés les articles</p></li>
<li>Une méthode <code>initialize</code>, qui affecte une méthode <code>template()</code> à l’instance de la vue en lui précisant que nous utiliserons le modèle de code html définit dans le <code>&lt;div&gt;</code> dont l’id est <code>“articles-collection-template”</code></li>
<li><p>Une méthode <code>render</code>, qui va passer les données en paramètre à la méthode <code>template()</code> puis les afficher dans la page</p></li>
</ul>
<p>Sauvegarder, relancer dans le navigateur, et retournez encore dans la console pour saisir les commandes suivantes :</p>
<ul>
<li>Pour instancier une vue : <code>articlesView = new blog.ArticlesView({ collection : blog.listeArticles })</code> à laquelle nous passons la collection d’articles en paramètre</li>
<li>Pour afficher les données : <code>articlesView.render()</code></li>
</ul>
<p><strong>Et là la &quot;magie&quot; de Backbone s'opère, vos articles s'affichent instantanément dans votre page :</strong> :)</p>
<p><img src="RSRC/03_03_BB.png" alt="BB" /><br /></p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : Notez bien que la collection doit être transformée en chaîne JSON pour être interprétée dans le template ( <code>this.template({ articles : this.collection.toJSON() })</code> ) et que nous avons nommé le paramètre <code>articles</code> pour faire le lien avec le template ( <code>_.each(articles, function(article) {}</code> ).</p>
</blockquote>
</blockquote>
<h2 id="un-dernier-tour-de-magie-pour-clôturer-le-chapitre-dinitiation-binding"><a href="#TOC"><span class="header-section-number">4.5</span> Un dernier tour de magie pour clôturer le chapitre d’initiation : “binding”</a></h2>
<p>A la fin de la méthode <code>initialize</code> de la vue, ajoutez le code suivant :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="co">/*--- binding ---*/</span>
    <span class="kw">_</span>.<span class="fu">bindAll</span>(<span class="kw">this</span>, <span class="ch">&#39;render&#39;</span>);

    <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;change&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
    <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;add&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
    <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;remove&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
    <span class="co">/*---------------*/</span></code></pre>
<h3 id="que-venons-nous-de-faire"><a href="#TOC"><span class="header-section-number">4.5.1</span> Que venons-nous de faire ?</a></h3>
<p>Nous venons &quot;d'expliquer&quot; à Backbone, qu'à chaque changement dans la collection, la vue doit rafraîchir son contenu. <code>_.bindAll</code> est une méthode d'Underscore (<a href="http://documentcloud.github.com/underscore/#bind">http://documentcloud.github.com/underscore/#bind</a>) qui permet de conserver le contexte initial, c'est à dire : quel que soit &quot;l'endroit&quot; d'où l'on appelle la méthode <code>render</code>, ce sera bien l'instance de la vue (attachée à <code>this</code>) qui sera utilisée.</p>
<pre><code>//TODO: à expliquer plus simplement</code></pre>
<p>Une dernière fois, sauvegarder, relancer le navigateur, et retournez encore dans la console pour saisir les commandes suivantes :</p>
<ul>
<li>Création de la vue : <code>articlesView = new blog.ArticlesView({ collection : blog.listeArticles })</code></li>
<li>Afficher les données : <code>articlesView.render()</code></li>
<li>Ajouter un nouvel article à la collection : <code>blog.listeArticles.add(new blog.Article({title:&quot;Hello&quot;, content:&quot;Hello World&quot;}))</code></li>
</ul>
<p><strong>Et là, magique ! : L’affichage s'est actualisé tout seul :</strong></p>
<h3 id="oh-la-vilaine-erreur"><a href="#TOC"><span class="header-section-number">4.5.2</span> Oh la vilaine erreur !!!</a></h3>
<p>Si vous avez bien suivi, j'ai fait une grossière erreur (je l’ai laissé volontairement, car c'est une erreur que j'ai déjà faite, et il n'est donc pas impossible que d'autres la fassent), la date de publication ne change pas ! En effet, je l'affecte dans les valeurs par défaut qui ne sont &quot;settées&quot; qu'une seule et unique fois lors de la définition de la &quot;pseudo&quot; classe <code>Backbone.Model</code>. Il faut donc initialiser la date de publication lors de l'instanciation du modèle, et ce dans la méthode <code>initialize()</code>. Modifiez donc le code du modèle de la manière suivante :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="co">/*--- Modèle article ---*/</span>

    <span class="kw">blog</span>.<span class="fu">Article</span> = <span class="kw">Backbone.Model</span>.<span class="fu">extend</span>({ <span class="co">// une &quot;sorte&quot; de classe Article</span>
        <span class="dt">defaults </span>: { <span class="co">//les valeurs par défaut d&#39;un article</span>
            <span class="dt">title </span>: <span class="st">&quot;titre de l&#39;article&quot;</span>,
            <span class="dt">content </span>: <span class="st">&quot;contenu de l&#39;article&quot;</span>,
            <span class="co">//publicationDate : null</span>
        },
        <span class="dt">initialize </span>: <span class="kw">function</span> () { <span class="co">// s&#39;exécute à la création d&#39;un article</span>
            <span class="kw">console</span>.<span class="fu">log</span> (<span class="st">&quot;Création d&#39;un nouvel article&quot;</span>);
            <span class="kw">this</span>.<span class="fu">set</span>(<span class="st">&quot;publicationDate&quot;</span>,<span class="kw">new</span> <span class="kw">Date</span>());
        }
    });</code></pre>
<p>Refaites les manipulations précédentes, et là (si vous avez laissez suffisamment de temps entre la création des articles), vous pourrez noter que la date est bien mise à jour :</p>
<p><img src="RSRC/03_04_BB.png" alt="BB" /><br /> <img src="RSRC/03_05_BB.png" alt="BB" /><br /></p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : la propriété date n’existe plus dans les valeurs par défaut, elle est créée à l’instanciation du modèle lors de l’appel de <code>this.set(&quot;publicationDate&quot;,new Date())</code> dans la méthode <code>initialize</code>. De la même manière, vous pouvez créer à la volée des propriétés “à posteriori” pour les instances des modèles.</p>
</blockquote>
</blockquote>
<p><strong>Et voilà, l’initiation est terminée. Nous allons pouvoir passer “aux choses sérieuses” et découvrir jusqu’où nous pouvons “pousser” Backbone.</strong></p>
<h2 id="code-final-de-lexemple"><a href="#TOC"><span class="header-section-number">4.6</span> Code final de l'exemple</a></h2>
<p>Le code final de votre page devrait ressembler à ceci :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
    <span class="kw">&lt;html&gt;</span>
    <span class="kw">&lt;head&gt;</span>
        <span class="kw">&lt;meta</span><span class="ot"> http-equiv=</span><span class="st">&quot;Content-Type&quot;</span><span class="ot"> content=</span><span class="st">&quot;text/html; charset=utf-8&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;title&gt;</span>Backbone<span class="kw">&lt;/title&gt;</span>
        <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">&quot;libs/vendors/bootstrap/css/bootstrap.css&quot;</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;style&gt;</span>
            body <span class="kw">{</span>
                <span class="kw">padding-top:</span> <span class="dt">60px</span><span class="kw">;</span>
                <span class="kw">padding-bottom:</span> <span class="dt">40px</span><span class="kw">;</span>
            <span class="kw">}</span>
        <span class="kw">&lt;/style&gt;</span>
        <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">&quot;libs/vendors/bootstrap/css/bootstrap-responsive.css&quot;</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;/head&gt;</span>

    <span class="kw">&lt;body&gt;</span>

        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar navbar-fixed-top&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-inner&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;</span>
                    <span class="kw">&lt;a</span><span class="ot"> class=</span><span class="st">&quot;brand&quot;</span><span class="kw">&gt;</span>Mon Blog<span class="kw">&lt;/a&gt;</span>
                <span class="kw">&lt;/div&gt;</span>
            <span class="kw">&lt;/div&gt;</span>
        <span class="kw">&lt;/div&gt;</span>

        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;</span>

            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;hero-unit&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;h1&gt;</span>Backbone rocks !!!<span class="kw">&lt;/h1&gt;</span>
            <span class="kw">&lt;/div&gt;</span>

            <span class="co">&lt;!-- Template d&#39;affichage des articles --&gt;</span>
            <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/template&quot;</span><span class="ot"> id=</span><span class="st">&quot;articles-collection-template&quot;</span><span class="kw">&gt;</span>

                &lt;% <span class="kw">_</span>.<span class="fu">each</span>(articles, <span class="kw">function</span>(article) { %&gt;
                &lt;h1&gt;&lt;%= <span class="kw">article</span>.<span class="fu">title</span> %&gt;&lt;/h1&gt;
                &lt;h6&gt;&lt;%= <span class="kw">article</span>.<span class="fu">publicationDate</span> %&gt;&lt;/h6&gt;
                &lt;p&gt;&lt;%= <span class="kw">article</span>.<span class="fu">content</span> %&gt;&lt;/p&gt;
                &lt;% }); %&gt;

            <span class="kw">&lt;/script&gt;</span>
            <span class="co">&lt;!-- div où seront affichés les articles --&gt;</span>
            <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;articles-collection-container&quot;</span><span class="kw">&gt;&lt;/div&gt;</span>

        <span class="kw">&lt;/div&gt;</span>

    <span class="kw">&lt;/body&gt;</span>
    <span class="co">&lt;!-- === Frameworks === --&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/jquery-1.7.2.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="co">&lt;!--&lt;script src=&quot;libs/vendors/bootstrap/js/bootstrap.js&quot;&gt;&lt;/script&gt;--&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/underscore.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/backbone.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>

    <span class="co">&lt;!-- === code applicatif === --&gt;</span>
    <span class="kw">&lt;script&gt;</span>

        $(<span class="kw">function</span> (){
            <span class="kw">window</span>.<span class="fu">blog</span> = {};

            <span class="co">/*</span>--- Modèle article ---<span class="co">*/</span>

            <span class="kw">blog</span>.<span class="fu">Article</span> = <span class="kw">Backbone.Model</span>.<span class="fu">extend</span>({
                <span class="dt">defaults </span>: {
                    <span class="dt">title </span>: <span class="st">&quot;titre</span> <span class="st">de</span> <span class="st">l</span>&#39;<span class="st">article&quot;</span>,
                    <span class="dt">content </span>: <span class="st">&quot;contenu</span> <span class="st">de</span> <span class="st">l</span>&#39;<span class="st">article&quot;</span>,
                },
                <span class="dt">initialize </span>: <span class="kw">function</span> () {
                    <span class="kw">console</span>.<span class="fu">log</span> (<span class="st">&quot;Création</span> <span class="st">d</span>&#39;<span class="st">un</span> <span class="st">nouvel</span> <span class="st">article&quot;</span>);
                    <span class="kw">this</span>.<span class="fu">set</span>(<span class="st">&quot;publicationDate&quot;</span>,<span class="kw">new</span> <span class="kw">Date</span>());
                }
            });

            <span class="co">/*</span>--- Collection d&#39;articles ---<span class="co">*/</span>

            <span class="kw">blog</span>.<span class="fu">ArticlesCollection</span> = <span class="kw">Backbone.Collection</span>.<span class="fu">extend</span>({
                <span class="dt">model </span>: <span class="kw">blog</span>.<span class="fu">Article</span>,
                <span class="dt">initialize </span>: <span class="kw">function</span> () {
                    <span class="kw">console</span>.<span class="fu">log</span> (<span class="st">&quot;Création</span> <span class="st">d</span>&#39;<span class="st">une</span> <span class="st">collection</span> <span class="st">d</span>&#39;<span class="st">articles&quot;</span>)
                }
            });

            <span class="co">/*</span>--- Vues ---<span class="co">*/</span>
            <span class="kw">blog</span>.<span class="fu">ArticlesView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({

                <span class="dt">el </span>: $(<span class="st">&quot;</span>#<span class="st">articles</span>-<span class="st">collection</span>-<span class="st">container&quot;</span>),

                <span class="dt">initialize </span>: <span class="kw">function</span> () {
                    <span class="kw">this</span>.<span class="fu">template</span> = <span class="kw">_</span>.<span class="fu">template</span>($(<span class="st">&quot;</span>#<span class="st">articles</span>-<span class="st">collection</span>-<span class="st">template&quot;</span>).<span class="fu">html</span>());

                    <span class="co">/*</span>--- binding ---<span class="co">*/</span>
                    <span class="kw">_</span>.<span class="fu">bindAll</span>(<span class="kw">this</span>, <span class="ch">&#39;render&#39;</span>);

                    <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;change&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
                    <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;add&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
                    <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;remove&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
                    <span class="co">/*</span>---------------<span class="co">*/</span>
                },

                <span class="dt">render </span>: <span class="kw">function</span> () {
                    <span class="kw">var</span> renderedContent = <span class="kw">this</span>.<span class="fu">template</span>({ 
                        <span class="dt">articles </span>: <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">toJSON</span>() 
                    });
                    $(<span class="kw">this</span>.<span class="fu">el</span>).<span class="fu">html</span>(renderedContent);
                    <span class="kw">return</span> <span class="kw">this</span>;
                }
            });

            <span class="co">/*</span>--- bootstrap ---<span class="co">*/</span>
            <span class="kw">blog</span>.<span class="fu">listeArticles</span> = <span class="kw">new</span> <span class="kw">blog</span>.<span class="fu">ArticlesCollection</span>();

            <span class="kw">blog.listeArticles</span>.<span class="fu">add</span>(<span class="kw">new</span> <span class="kw">blog</span>.<span class="fu">Article</span>({ 
                <span class="dt">title </span>: <span class="st">&quot;titre1&quot;</span>, <span class="dt">content </span>: <span class="st">&quot;contenu1&quot;</span> 
            }));
            <span class="kw">blog.listeArticles</span>.<span class="fu">add</span>(<span class="kw">new</span> <span class="kw">blog</span>.<span class="fu">Article</span>({ 
                <span class="dt">title </span>: <span class="st">&quot;titre2&quot;</span>, <span class="dt">content </span>: <span class="st">&quot;contenu2&quot;</span> 
            }));
            <span class="kw">blog.listeArticles</span>.<span class="fu">add</span>(<span class="kw">new</span> <span class="kw">blog</span>.<span class="fu">Article</span>({ 
                <span class="dt">title </span>: <span class="st">&quot;titre3&quot;</span>, <span class="dt">content </span>: <span class="st">&quot;contenu3&quot;</span> 
            }));
            <span class="kw">blog.listeArticles</span>.<span class="fu">add</span>(<span class="kw">new</span> <span class="kw">blog</span>.<span class="fu">Article</span>({ 
                <span class="dt">title </span>: <span class="st">&quot;titre4&quot;</span>, <span class="dt">content </span>: <span class="st">&quot;contenu4&quot;</span> 
            }));
            <span class="kw">blog.listeArticles</span>.<span class="fu">add</span>(<span class="kw">new</span> <span class="kw">blog</span>.<span class="fu">Article</span>({ 
                <span class="dt">title </span>: <span class="st">&quot;titre5&quot;</span>, <span class="dt">content </span>: <span class="st">&quot;contenu5&quot;</span> 
            }));

        });
    <span class="kw">&lt;/script&gt;</span>
    <span class="kw">&lt;/html&gt;</span></code></pre>
<h1 id="le-modèle-objet-de-backbone"><a href="#TOC"><span class="header-section-number">5</span> Le modèle objet de Backbone</a></h1>
<blockquote>
<p><em>Sommaire</em></p>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li><em>Un petit tour dans le code</em></li>
<li><em>Une classe de base</em></li>
<li><em>Héritage</em></li>
</ul>
</blockquote>
</blockquote>
<blockquote>
<p><em>Ce qui est souvent déstabilisant pour le développeur Java (PHP, .Net, etc. ....) c’est le modèle objet de javascript qui diffère du classique modèle orienté « classes » que nous connaissons tous (normalement). De nombreux ouvrages, articles, … se sont attaqués au sujet, mais ce n’est pas l’objet de ce chapitre.</em></p>
</blockquote>
<p>Je vais vous présenter de quelle façon Backbone gère son « Orientation objet » et comment réutiliser cette fonctionnalité. L’objectifs et double : Mieux comprendre le fonctionnement de Backbone et vous donner un moyen de faire de l’objet en javascript sans être dépaysé (quelque chose qui ressemble dans sa logique, à ce que vous connaissez déjà).</p>
<h2 id="un-petit-tour-dans-le-code"><a href="#TOC"><span class="header-section-number">5.1</span> Un petit tour dans le code</a></h2>
<p>Si vous avez la curiosité d’aller lire le code de Backbone (je vous engage à le faire, le code est clair et simple et avec le temps très instructif), vous « tomberez » sur une ligne particulièrement intéressante (vers la fin du code source dans <code>backbone.js</code> pour ceux qui iront réellement lire le code) :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="co">// Set up inheritance for the model, collection, and view.</span>
    <span class="kw">Model</span>.<span class="fu">extend</span> = <span class="kw">Collection</span>.<span class="fu">extend</span> = <span class="kw">Router</span>.<span class="fu">extend</span> = <span class="kw">View</span>.<span class="fu">extend</span> = extend;</code></pre>
<p>Il existe une méthode (privée) <code>extend</code> dans Backbone qui permet à un objet d’hériter des membres d’un autre objet, par exemple, si j’écris:</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="co">/*--- Modèle article ---*/</span>

    <span class="co">// une &quot;sorte&quot; de classe Article</span>
    <span class="kw">var</span> Article = <span class="kw">Backbone.Model</span>.<span class="fu">extend</span>({

    });</code></pre>
<p>Je signifie que je crée une “sorte” de classe <code>Article</code> qui hérite des fonctionnalités de <code>Model</code>. De la même façon je pourrais ensuite définir une autre classe <code>ArticleSpecial</code> qui héritera de <code>Article</code> (et qui conservera les spécificités (membres de classe) de <code>Model</code>):</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> ArticleSpecial = <span class="kw">Article</span>.<span class="fu">extend</span>({

    });</code></pre>
<p>Je vous expliquais que la méthode <code>extend</code> était privée, Backbone ne l’expose pas directement, mais il est tout à fait possible d’y accéder par un des composants de Backbone, de la façon suivante :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Kind = <span class="kw">function</span>() {}; 
    <span class="kw">Kind</span>.<span class="fu">extend</span> = <span class="kw">Backbone.Model</span>.<span class="fu">extend</span>;    </code></pre>
<blockquote>
<blockquote>
<p><strong>Remarque 1</strong> : J’ai utilisé « Kind » pour ne pas utiliser « Class » ou « class » qui est un terme réservé pour les futures versions de javascript.</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p><strong>Remarque 2</strong> : Je vais utiliser du français dans mon code. Je sais c’est moche, promis j’essaye de ne plus le faire (à part dans les commentaires)</p>
</blockquote>
</blockquote>
<p>Nous pouvons donc maintenant écrire :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Personne = <span class="kw">Kind</span>.<span class="fu">extend</span>({ });</code></pre>
<h2 id="ère-classe"><a href="#TOC"><span class="header-section-number">5.2</span> 1ère &quot;classe&quot;</a></h2>
<p>Voyons donc ce que nous apporte le modèle objet de Backbone.</p>
<h3 id="un-constructeur"><a href="#TOC"><span class="header-section-number">5.2.1</span> Un constructeur</a></h3>
<p>La déclaration d’un constructeur se fait avec le mot clé <code>constructor</code> :</p>
<p><u>Utilisation de <code>Kind.extend()</code> et définition de <code>constructor()</code></u></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Personne = <span class="kw">Kind</span>.<span class="fu">extend</span>({
        <span class="dt">constructor </span>: <span class="kw">function</span> (){
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Bonjour, je suis le constructeur de Personne&quot;</span>);
        }
    });

    <span class="kw">var</span> bob = <span class="kw">new</span> Personne();</code></pre>
<p>Nous obtiendrons à l’éxécution :</p>
<pre><code>Bonjour, je suis le constructeur de Personne</code></pre>
<h3 id="des-propriétés"><a href="#TOC"><span class="header-section-number">5.2.2</span> Des propriétés</a></h3>
<p>Les propriétés se déclarent dans le constructeur (elles sont générées à l’exécution), et vous pouvez déclarer les valeurs par défaut à l’extérieur du constructeur :</p>
<p><u>Ajout de propriétés</u></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Personne = <span class="kw">Kind</span>.<span class="fu">extend</span>({
        <span class="dt">prenom </span>: <span class="st">&quot;John&quot;</span>,
        <span class="dt">nom </span>: <span class="st">&quot;Doe&quot;</span>,
        <span class="dt">constructor </span>: <span class="kw">function</span> (prenom, nom){
            <span class="kw">if</span>(prenom) <span class="kw">this</span>.<span class="fu">prenom</span> = prenom;
            <span class="kw">if</span>(nom) <span class="kw">this</span>.<span class="fu">nom</span> = nom;

            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Bonjour, je suis &quot;</span>, <span class="kw">this</span>.<span class="fu">prenom</span>, <span class="kw">this</span>.<span class="fu">nom</span>);
        }
    });

    <span class="kw">var</span> john = <span class="kw">new</span> Personne();
    <span class="kw">var</span> bob = <span class="kw">new</span> Personne(<span class="st">&quot;Bob&quot;</span>, <span class="st">&quot;Morane&quot;</span>);</code></pre>
<p>Nous obtiendrons à l’éxécution :</p>
<pre><code>Bonjour, je suis  John Doe
Bonjour, je suis  Bob Morane</code></pre>
<h3 id="des-méthodes"><a href="#TOC"><span class="header-section-number">5.2.3</span> Des méthodes</a></h3>
<p>Les méthodes se déclarent de la même façon que le constructeur, ajoutons une méthode <code>bonjour()</code> :</p>
<p><u>Ajout d’une méthode</u></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Personne = <span class="kw">Kind</span>.<span class="fu">extend</span>({
        <span class="dt">prenom </span>: <span class="st">&quot;John&quot;</span>,
        <span class="dt">nom </span>: <span class="st">&quot;Doe&quot;</span>,
        <span class="dt">constructor </span>: <span class="kw">function</span> (prenom, nom){
            <span class="kw">if</span>(prenom) <span class="kw">this</span>.<span class="fu">prenom</span> = prenom;
            <span class="kw">if</span>(nom) <span class="kw">this</span>.<span class="fu">nom</span> = nom;
        },
        <span class="dt">bonjour </span>: <span class="kw">function</span> () {
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Bonjour, je suis &quot;</span>, <span class="kw">this</span>.<span class="fu">prenom</span>, <span class="kw">this</span>.<span class="fu">nom</span>);
        }

    });

    <span class="kw">var</span> john = <span class="kw">new</span> Personne();
    <span class="kw">var</span> bob = <span class="kw">new</span> Personne(<span class="st">&quot;Bob&quot;</span>, <span class="st">&quot;Morane&quot;</span>);

    <span class="kw">john</span>.<span class="fu">bonjour</span>();
    <span class="kw">bob</span>.<span class="fu">bonjour</span>();</code></pre>
<p>Nous obtiendrons à l’éxécution :</p>
<pre><code>Bonjour, je suis  John Doe
Bonjour, je suis  Bob Morane</code></pre>
<h3 id="des-membres-statiques"><a href="#TOC"><span class="header-section-number">5.2.4</span> Des membres statiques</a></h3>
<p>La méthode <code>extend</code> accepte un deuxième paramètre qui permet de déclarer des membres statiques :</p>
<p><u>Ajout &amp; utilisation de membres statiques</u></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Personne = <span class="kw">Kind</span>.<span class="fu">extend</span>({
        <span class="dt">prenom </span>: <span class="st">&quot;John&quot;</span>,
        <span class="dt">nom </span>: <span class="st">&quot;Doe&quot;</span>,
        <span class="dt">constructor </span>: <span class="kw">function</span> (prenom, nom){
            <span class="kw">if</span>(prenom) <span class="kw">this</span>.<span class="fu">prenom</span> = prenom;
            <span class="kw">if</span>(nom) <span class="kw">this</span>.<span class="fu">nom</span> = nom;

            <span class="co">//Utilisation de la propriété statique</span>
            <span class="kw">Personne</span>.<span class="fu">compteur</span> += <span class="dv">1</span>;
        },
        <span class="dt">bonjour </span>: <span class="kw">function</span> () {
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Bonjour, je suis &quot;</span>, <span class="kw">this</span>.<span class="fu">prenom</span>, <span class="kw">this</span>.<span class="fu">nom</span>);
        }

    },{ <span class="co">//ici les membres statiques</span>
        <span class="dt">compteur </span>: <span class="dv">0</span>,
        <span class="dt">combien </span>: <span class="kw">function</span> () {
            <span class="kw">return</span> <span class="kw">Personne</span>.<span class="fu">compteur</span>;
        }
    });

    <span class="kw">var</span> john = <span class="kw">new</span> Personne();
    <span class="kw">var</span> bob = <span class="kw">new</span> Personne(<span class="st">&quot;Bob&quot;</span>, <span class="st">&quot;Morane&quot;</span>);

    <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Il y a &quot;</span>, <span class="kw">Personne</span>.<span class="fu">combien</span>(), <span class="st">&quot; personnes&quot;</span>);</code></pre>
<p>Nous avons donc une propriété statique <code>compteur</code> et une méthode statique <code>combien()</code>. Nous obtiendrons ceci à l’exécution :</p>
<pre><code>Il y a  2  personnes</code></pre>
<h2 id="sans-héritage-point-de-salut"><a href="#TOC"><span class="header-section-number">5.3</span> Sans héritage point de salut ! … ?</a></h2>
<p>Même s’il ne faut pas abuser de l’héritage en programmation objet (mais c’est un autre débat), il faut avouer que cela peut être pratique pour la structuration de notre code. Dès le départ, dans ce chapitre nous avons fait de l’héritage :</p>
<pre><code>var Personne = Kind.extend({ });</code></pre>
<p>Donc <code>Personne</code> hérite de <code>Kind</code>. Mais essayons un exemple plus complet pour bien appréhender les possibilités de Backbone. <code>Personne</code> héritant de <code>Kind</code> possède donc aussi une méthode <code>extend</code>, nous allons donc pouvoir créer une <code>Femme</code> et un <code>Homme</code> :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Homme = <span class="kw">Personne</span>.<span class="fu">extend</span>({
        <span class="dt">sexe </span>: <span class="st">&quot;male&quot;</span>
    });

    <span class="kw">var</span> Femme = <span class="kw">Personne</span>.<span class="fu">extend</span>({
        <span class="dt">prenom </span>: <span class="st">&quot;Jane&quot;</span>,
        <span class="dt">sexe </span>: <span class="st">&quot;femelle&quot;</span>
    });

    <span class="kw">var</span> jane = <span class="kw">new</span> Femme();
    <span class="kw">var</span> john = <span class="kw">new</span> Homme();

    <span class="kw">var</span> angelina = <span class="kw">new</span> Femme(<span class="st">&quot;Angelina&quot;</span>, <span class="st">&quot;Jolie&quot;</span>);
    <span class="kw">var</span> bob = <span class="kw">new</span> Homme(<span class="st">&quot;Bob&quot;</span>, <span class="st">&quot;Morane&quot;</span>);

    <span class="kw">jane</span>.<span class="fu">bonjour</span>();
    <span class="kw">john</span>.<span class="fu">bonjour</span>();

    <span class="kw">angelina</span>.<span class="fu">bonjour</span>();
    <span class="kw">bob</span>.<span class="fu">bonjour</span>();

    <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Il y a &quot;</span>, <span class="kw">Personne</span>.<span class="fu">combien</span>(), <span class="st">&quot; personnes&quot;</span>);</code></pre>
<p>A l’exécution nous obtiendrons ceci :</p>
<pre><code>Bonjour, je suis  Jane Doe
Bonjour, je suis  John Doe
Bonjour, je suis  Angelina Jolie
Bonjour, je suis  Bob Morane
Il y a  4  personnes</code></pre>
<p>Nous pouvons donc vérifier que l’on a bien hérité de la méthode <code>bonjour()</code>, du constructeur <code>constructor()</code> et de <code>nom</code> et <code>prenom</code> (ainsi que de leurs valeurs par défaut). Nous remarquons aussi que l’incrémentation des “personnes” continue puisque <code>Homme</code> et <code>Femme</code> héritent de <code>Personne</code>. Voyons maintenant, comment surcharger les méthodes du parent et continuer à appeler les méthodes du parent.</p>
<h2 id="surcharge-super"><a href="#TOC"><span class="header-section-number">5.4</span> Surcharge &amp; super</a></h2>
<p>Modifions le code des “pseudo classes” de la façon suivante :</p>
<p><u>Surcharge et utilisation de <code>super()</code></u></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Homme = <span class="kw">Personne</span>.<span class="fu">extend</span>({
        <span class="dt">sexe </span>: <span class="st">&quot;male&quot;</span>,
        <span class="co">//surcharge du constructeur</span>
        <span class="dt">constructor </span>: <span class="kw">function</span> (prenom, nom) {
            <span class="co">//appeler le constructeur de Personne</span>
            <span class="kw">Homme.__super__.constructor</span>.<span class="fu">call</span>(<span class="kw">this</span>, prenom, nom);
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Hello, je suis un &quot;</span>, <span class="kw">this</span>.<span class="fu">sexe</span>);
        },
        <span class="dt">bonjour </span>: <span class="kw">function</span> () {
            <span class="co">//appeler la methode bonjour() du parent</span>
            <span class="kw">Homme.__super__.bonjour</span>.<span class="fu">call</span>(<span class="kw">this</span>);
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Bonjour, je suis un garçon&quot;</span>);
        }
    });

    <span class="kw">var</span> Femme = <span class="kw">Personne</span>.<span class="fu">extend</span>({
        <span class="dt">prenom </span>: <span class="st">&quot;Jane&quot;</span>,
        <span class="dt">sexe </span>: <span class="st">&quot;femelle&quot;</span>,
        <span class="co">//surcharge du constructeur</span>
        <span class="dt">constructor </span>: <span class="kw">function</span> (prenom, nom) {
            <span class="co">//appeler le constructeur de Personne</span>
            <span class="kw">Femme.__super__.constructor</span>.<span class="fu">call</span>(<span class="kw">this</span>, prenom, nom);
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Hello, je suis une &quot;</span>, <span class="kw">this</span>.<span class="fu">sexe</span>);
        },
        <span class="dt">bonjour </span>: <span class="kw">function</span> () {
            <span class="co">//appeler la methode bonjour() du parent</span>
            <span class="kw">Femme.__super__.bonjour</span>.<span class="fu">call</span>(<span class="kw">this</span>);
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Bonjour, je suis une fille&quot;</span>);
        }
    });

    <span class="kw">var</span> angelina = <span class="kw">new</span> Femme(<span class="st">&quot;Angelina&quot;</span>, <span class="st">&quot;Jolie&quot;</span>);
    <span class="kw">var</span> bob = <span class="kw">new</span> Homme(<span class="st">&quot;Bob&quot;</span>, <span class="st">&quot;Morane&quot;</span>);

    <span class="kw">angelina</span>.<span class="fu">bonjour</span>();
    <span class="kw">bob</span>.<span class="fu">bonjour</span>();</code></pre>
<p>Nous avons surchargé les constructeurs pour pouvoir afficher un message au moment de l’instanciation et nous avons appelé le constructeur du parent pour continuer à permettre l’affectation de <code>nom</code> et <code>prenom</code>. Nous avons appliqué le même principe pour la méthode <code>bonjour()</code>. Donc l’appel d’une méthode du parent se fait de la manière suivante : <code>Nom_de_la_classe_courante.__super__.methode.call(this, paramètres)</code>.</p>
<p>A l’exécution nous obtiendrons donc :</p>
<pre><code>Hello, je suis une  femelle
Hello, je suis un  male
Bonjour, je suis  Angelina Jolie
Bonjour, je suis une fille
Bonjour, je suis  Bob Morane
Bonjour, je suis un garçon</code></pre>
<h2 id="conclusion"><a href="#TOC"><span class="header-section-number">5.5</span> Conclusion</a></h2>
<p>Nous venons de voir comment continuer à programmer objet sans trop boulverser vos habitudes (cela ne doit pas vous empêcher d’étudier le modèle objet de javascript plus en profondeur). Cela va vous permettre de mieux structurer votre code (et en javascript, c’est important) mais aussi vos idées, de comprendre le fonctionnement de Backbone, mais de pouvoir aussi écrire des extensions à Backbone plus facilement.</p>
<h1 id="il-nous-faut-un-serveur"><a href="#TOC"><span class="header-section-number">6</span> Il nous faut un serveur !</a></h1>
<blockquote>
<p><em>Sommaire</em></p>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li><em>Petit rappel sur les requêtes http</em></li>
<li><em>Installations des composants nécessaires</em></li>
<li><em>Construction et test de notre serveur d’application</em></li>
</ul>
</blockquote>
</blockquote>
<blockquote>
<p><em>Faisons un dernier détour avant de revenir à Backbone. Pour bien en comprendre le fonctionnement, nous allons nous mettre en situation réelle. Ne laissons pas notre future webapp toute seule. Généralement une application web comporte une partie serveur qui sert à distribuer des données vers l’IHM client (dans le navigateur). Pour que le tour de Backbone.js soit complet, il serait impensable de ne pas étudier les interaction avec un serveur (interrogation de données, ajax,...)</em></p>
</blockquote>
<p>Pour ce chapitre, je me suis longuement posé la question : « quelle technologie serveur utiliser ? ». PHP, Ruby, Java, .Net,... ? C’était aussi prendre le risque de vous désintéresser complètement. D’un autre côté, je souhaitais que vous puissiez rapidement entrer dans le vif du sujet. J’ai donc finalement choisi de vous faire utiliser Node.js puisque c’est aussi du Javascript et que sa mise en œuvre est rapide sans pour autant être obligé de connaître Node.js dans son ensemble. <strong>Objectif : disposer d’un serveur d’application fournissant des services JSON en moins d’une demi-heure !</strong></p>
<p>Nous aurons besoin de :</p>
<ul>
<li><strong>Node.js</strong> pour le serveur d’application</li>
<li><strong>Express.js</strong> qui vas nous permettre de construire notre application (gestion des routes, sessions, etc.)</li>
<li><strong>nStore</strong> : une petite base de données noSQL simulée avec un fichier texte (nous n’allons pas nous embêter à faire des requêtes SQL, et le noSQL est à la mode ;) )</li>
</ul>
<h2 id="principes-http-get-post-put-delete"><a href="#TOC"><span class="header-section-number">6.1</span> Principes http : GET, POST, PUT, DELETE</a></h2>
<p>Mon but est de faire une application web avec Node &amp; Express sur les principes REST (Representational State Transfer) qui permettra de faire des opérations de type <strong>CRUD</strong> avec les modèles BAckbone en utilisant des services basés sur le protocole http avec les verbes suivants :</p>
<ul>
<li><strong>C</strong>reate : POST</li>
<li><strong>R</strong>ead : GET</li>
<li><strong>U</strong>pdate : PUT</li>
<li><strong>D</strong>elete : DELETE</li>
</ul>
<p>Si cela vous paraît obscur, pas d'inquiétude, la partie pratique qui suit devrait vous éclairer. Mais je vous engage fortement à lire <a href="http://naholyr.fr/2011/08/ecrire-service-rest-nodejs-express-partie-1/">http://naholyr.fr/2011/08/ecrire-service-rest-nodejs-express-partie-1/</a> de <a href="https://twitter.com/naholyr">@naholyr</a>.</p>
<pre><code>//TODO: vois si ça nécessite d&#39;être développé</code></pre>
<h2 id="installations"><a href="#TOC"><span class="header-section-number">6.2</span> Installation(s)</a></h2>
<h3 id="installer-node.js"><a href="#TOC"><span class="header-section-number">6.2.1</span> Installer Node.js</a></h3>
<p>Tout d’abord, allez sur le site <a href="http://nodejs.org/">http://nodejs.org/</a>, si vous êtes sous OSX ou Windows, vous avez de la chance, il existe des installeurs tout prêts, si vous êtes sous Linux, les manipulations ne sont pas compliquées, je vous engage à lire ceci : <a href="https://github.com/joyent/node/wiki/Installing-Node.js-via-package-manager">https://github.com/joyent/node/wiki/Installing-Node.js-via-package-manager</a>. Une fois les installeurs utilisés (ou les manipulations Linux) vous disposerez de Node.js ainsi que du gestionnaire de packets NPM qui va nous permettre d’installer de nombreux modules pour Node.js.</p>
<h3 id="installer-express.js"><a href="#TOC"><span class="header-section-number">6.2.2</span> Installer Express.js</a></h3>
<p>Express.js est un framework qui se greffe sur Node.js et vous permet de réaliser rapidement des applications web, en vous apportant quelques facilités comme la gestion des routes, des sessions, etc. ...</p>
<p>Commençons à créer notre application serveur. Créez un répertoire <code>blog</code> sur votre disque dur. Quel que soit votre système d’exploitation, ouvrez une console ou un terminal et tapez les commandes suivante (et validez):</p>
<pre><code>cd blog
npm install express</code></pre>
<blockquote>
<blockquote>
<p><strong>Remarque 1</strong> : sous OSX ou linux vous devrez probablement passer en mode super utilisateur, faites donc précéder la commande par <code>sudo</code> : <code>sudo npm install express</code></p>
</blockquote>
</blockquote>
<p>Nous venons donc d'installer le module <strong>express</strong> dans notre répertoire <code>blog</code>.</p>
<blockquote>
<blockquote>
<p><strong>Remarque 2</strong> : il y a d'autres méthodes pour créer une application avec express, mais dans notre cas j'ai besoin du strict minimum.</p>
</blockquote>
</blockquote>
<h3 id="installer-nstore"><a href="#TOC"><span class="header-section-number">6.2.3</span> Installer nStore</a></h3>
<p>Nous aurons besoin d’un moyen de sauvegarde de nos données. Pour cela nous allons utiliser <strong>nStore</strong> qui est une sorte de base de données NoSQL clé/valeur pour node.js (il existe de nombreuses autre solutions telle MongoDB, CouchDB, des bases de donnée relationnelles,… mais ce n’est pas l’objet de cet ouvrage). Pour installer nStore (toujour dans le répertoire <code>blog</code>) tapez la commande suivante :</p>
<pre><code>npm install nstore</code></pre>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : vous pouvez noter maintenant la présence d’un répertoire <code>node_modules</code> dans <code>blog</code>, contenant lui-même deux sous répertoires <code>express</code> et <code>nstore</code>.</p>
</blockquote>
</blockquote>
<p>Voilà, nous avons tout ce qu'il faut pour commencer à créer notre application.</p>
<h2 id="codons-notre-application-serveur"><a href="#TOC"><span class="header-section-number">6.3</span> Codons notre application serveur</a></h2>
<p>Notre application se découpe en 2 parties :</p>
<ul>
<li>une partie statique, c'est là que viendra tout ce &quot;qui touche&quot; à Backbone</li>
<li>une partie dynamique, notre serveur, ce sera notre &quot;fournisseur&quot; de données</li>
</ul>
<h3 id="ressources-statiques"><a href="#TOC"><span class="header-section-number">6.3.1</span> Ressources statiques</a></h3>
<p>Tout d’abord vous devez créer un sous-répertoire <code>public</code>, où nous allons copier les ressources statiques de notre application. Pour cela, utilisez les fichiers dont nous nous sommes servis pour notre exemple de découverte, et copiez les fichiers ci-dessous dans le répertoire <code>public</code> :</p>
<ul>
<li><code>libs/vendors/backbone.js</code></li>
<li><code>libs/vendors/underscore.js</code></li>
<li><code>libs/vendors/jquery-1.7.2.js</code> <em>(ou une version plus récente)</em></li>
</ul>
<p>Et copiez aussi le répertoire <code>bootstrap</code> de notre exemple. Ensuite, préparez une page <code>index.html</code> dans le répertoire <code>public</code>, avec le code suivant :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
    <span class="kw">&lt;html&gt;</span>
    <span class="kw">&lt;head&gt;</span>
        <span class="kw">&lt;meta</span><span class="ot"> http-equiv=</span><span class="st">&quot;Content-Type&quot;</span><span class="ot"> content=</span><span class="st">&quot;text/html; charset=utf-8&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;title&gt;</span>Backbone<span class="kw">&lt;/title&gt;</span>
        <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">&quot;libs/vendors/bootstrap/css/bootstrap.css&quot;</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;style&gt;</span>
            body <span class="kw">{</span>
                <span class="kw">padding-top:</span> <span class="dt">60px</span><span class="kw">;</span>
                <span class="kw">padding-bottom:</span> <span class="dt">40px</span><span class="kw">;</span>
            <span class="kw">}</span>
        <span class="kw">&lt;/style&gt;</span>
        <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">&quot;libs/vendors/bootstrap/css/bootstrap-responsive.css&quot;</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;/head&gt;</span>

    <span class="kw">&lt;body&gt;</span>

        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar navbar-fixed-top&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-inner&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;</span>
                    <span class="kw">&lt;a</span><span class="ot"> class=</span><span class="st">&quot;brand&quot;</span><span class="kw">&gt;</span>Mon Blog<span class="kw">&lt;/a&gt;</span>
                <span class="kw">&lt;/div&gt;</span>
            <span class="kw">&lt;/div&gt;</span>
        <span class="kw">&lt;/div&gt;</span>

        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;hero-unit&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;h1&gt;</span>Backbone rocks !!!<span class="kw">&lt;/h1&gt;</span>
            <span class="kw">&lt;/div&gt;</span>

        <span class="kw">&lt;/div&gt;</span>

    <span class="kw">&lt;/body&gt;</span>
    <span class="co">&lt;!-- === Frameworks === --&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/jquery-1.7.2.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/underscore.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/backbone.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>

    <span class="co">&lt;!-- === code applicatif === --&gt;</span>
    <span class="kw">&lt;script&gt;</span>
    <span class="kw">&lt;/script&gt;</span>
    <span class="kw">&lt;/html&gt;</span></code></pre>
<h3 id="ressources-dynamiques"><a href="#TOC"><span class="header-section-number">6.3.2</span> Ressources dynamiques</a></h3>
<p>Toujours dans le répertoire <code>public</code>, créer un fichier <code>app.js</code> qui sera le programme principal de notre application et qui contiendra le code suivant :</p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : ce n’est pas grave si vous ne comprenez pas le code à ce stade, l’important c’est que cela fonctionne. Mais vous allez voir, à l’utilisation « tout s’éclaire ».</p>
</blockquote>
</blockquote>
<p>Rapidement, le code serveur comporte :</p>
<ul>
<li>l'intialisation de la base de données des posts et celle des users</li>
<li><p>6 routes :</p>
<ul>
<li><code>'/blogposts'</code> (<code>GET</code>) : pour récupérer tous les posts du blog</li>
<li><code>'/blogposts/query/:query'</code> (<code>GET</code>) : pour récupérer certains posts du blog</li>
<li><code>'/blogposts/:id'</code> (<code>GET</code>) : pour récupérer un post</li>
<li><code>'/blogposts</code> (<code>POST</code>) : pour créer un nouveau post</li>
<li><code>'/blogposts/:id'</code> (<code>PUT</code>) : pour modifier un post existant</li>
<li><code>'/blogposts/:id'</code> (<code>DELETE</code>) : pour supprimer un post</li>
</ul></li>
</ul>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="co">/*--------------------------------------------</span>
<span class="co">        Déclaration des librairies</span>
<span class="co">    --------------------------------------------*/</span>
    <span class="kw">var</span> express = require(<span class="ch">&#39;express&#39;</span>)
        , nStore = require(<span class="ch">&#39;nstore&#39;</span>)
        , app = <span class="kw">module</span>.<span class="fu">exports</span> = <span class="kw">express</span>.<span class="fu">createServer</span>();

    nStore = <span class="kw">nStore</span>.<span class="fu">extend</span>(require(<span class="ch">&#39;nstore/query&#39;</span>)());

    <span class="co">/*--------------------------------------------</span>
<span class="co">        Paramétrages de fonctionnement d&#39;Express</span>
<span class="co">    --------------------------------------------*/</span>
    <span class="kw">app</span>.<span class="fu">use</span>(<span class="kw">express</span>.<span class="fu">bodyParser</span>());
    <span class="kw">app</span>.<span class="fu">use</span>(<span class="kw">express</span>.<span class="fu">methodOverride</span>());
    <span class="kw">app</span>.<span class="fu">use</span>(<span class="kw">express</span>.<span class="fu">static</span>(__dirname + <span class="ch">&#39;/public&#39;</span>));
    <span class="kw">app</span>.<span class="fu">use</span>(<span class="kw">express</span>.<span class="fu">cookieParser</span>(<span class="ch">&#39;ilovebackbone&#39;</span>));
    <span class="kw">app</span>.<span class="fu">use</span>(<span class="kw">express</span>.<span class="fu">session</span>({ <span class="dt">secret</span>: <span class="st">&quot;ilovebackbone&quot;</span> }));

    <span class="co">/*--------------------------------------------</span>
<span class="co">        Définition des &quot;bases&quot; posts &amp; users</span>
<span class="co">    --------------------------------------------*/</span>
    <span class="kw">var</span> posts, users;

    posts = <span class="kw">nStore</span>.<span class="fu">new</span>(<span class="st">&quot;blog.db&quot;</span>, <span class="kw">function</span>() {
        users = <span class="kw">nStore</span>.<span class="fu">new</span>(<span class="st">&quot;users.db&quot;</span>, <span class="kw">function</span>() {
            <span class="co">/*</span>
<span class="co">                une fois les bases ouvertes, on passe</span>
<span class="co">                en attente de requête http (cf. code de</span>
<span class="co">                la fonction Routes())</span>
<span class="co">                Si les bases n&#39;existent pas,</span>
<span class="co">                elles sont crées automatiquement</span>
<span class="co">            */</span>
            Routes();
            <span class="kw">app</span>.<span class="fu">listen</span>(<span class="dv">3000</span>);
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="ch">&#39;Express app started on port 3000&#39;</span>);

        });
    });

    <span class="kw">function</span> Routes() {

        <span class="co">/*</span>
<span class="co">            Obtenir la liste de tous les posts lorsque</span>
<span class="co">            l&#39;on appelle http://localhost:3000/blogposts</span>
<span class="co">            en mode GET</span>
<span class="co">        */</span>
        <span class="kw">app</span>.<span class="fu">get</span>(<span class="ch">&#39;/blogposts&#39;</span>,<span class="kw">function</span>(req, res){
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;GET (ALL) : /blogposts&quot;</span>);
            <span class="kw">posts</span>.<span class="fu">all</span>(<span class="kw">function</span>(err, results) {

                <span class="kw">if</span>(err) { 
                    <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
                    <span class="kw">res</span>.<span class="fu">json</span>(err); 
                } <span class="kw">else</span> {
                    <span class="kw">var</span> posts = [];
                    <span class="kw">for</span>(<span class="kw">var</span> key <span class="kw">in</span> results) {
                        <span class="kw">var</span> post = results[key]; <span class="kw">post</span>.<span class="fu">id</span> = key;
                        <span class="kw">posts</span>.<span class="fu">push</span>(post);
                    }
                    <span class="kw">res</span>.<span class="fu">json</span>(posts);
                }
            });

        });

        <span class="co">/*</span>
<span class="co">            Obtenir la liste de tous les posts correspondant à un critère</span>
<span class="co">            lorsque l&#39;on appelle http://localhost:3000/blogposts/query/ en</span>
<span class="co">            mode GET avec une requête en paramètre</span>
<span class="co">            ex : query : { &quot;title&quot; : &quot;Mon 1er post&quot;} }</span>
<span class="co">        */</span>
        <span class="kw">app</span>.<span class="fu">get</span>(<span class="ch">&#39;/blogposts/query/:query&#39;</span>,<span class="kw">function</span>(req, res){
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;GET (QUERY) : /blogposts/query/&quot;</span>+<span class="kw">req.params</span>.<span class="fu">query</span>);

            <span class="kw">posts</span>.<span class="fu">find</span>(<span class="kw">JSON</span>.<span class="fu">parse</span>(<span class="kw">req.params</span>.<span class="fu">query</span>), <span class="kw">function</span>(err, results) {
                <span class="kw">if</span>(err) {
                    <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
                    <span class="kw">res</span>.<span class="fu">json</span>(err); 
                } <span class="kw">else</span> {
                    <span class="kw">var</span> posts = [];
                    <span class="kw">for</span>(<span class="kw">var</span> key <span class="kw">in</span> results) {
                        <span class="kw">var</span> post = results[key]; <span class="kw">post</span>.<span class="fu">id</span> = key;
                        <span class="kw">posts</span>.<span class="fu">push</span>(post);
                    }
                    <span class="kw">res</span>.<span class="fu">json</span>(posts);
                }
            });

        });

        <span class="co">/*</span>
<span class="co">            Retrouver un post par sa clé unique lorsque</span>
<span class="co">            l&#39;on appelle http://localhost:3000/blogposts/identifiant_du_post</span>
<span class="co">            en mode GET</span>
<span class="co">        */</span>

        <span class="kw">app</span>.<span class="fu">get</span>(<span class="ch">&#39;/blogposts/:id&#39;</span>, <span class="kw">function</span>(req, res){
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;GET : /blogposts/&quot;</span>+<span class="kw">req.params</span>.<span class="fu">id</span>);
            <span class="kw">posts</span>.<span class="fu">get</span>(<span class="kw">req.params</span>.<span class="fu">id</span>, <span class="kw">function</span>(err, post, key) {
                <span class="kw">if</span>(err) {
                    <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
                    <span class="kw">res</span>.<span class="fu">json</span>(err);

                } <span class="kw">else</span> {
                    <span class="kw">post</span>.<span class="fu">id</span> = key;
                    <span class="kw">res</span>.<span class="fu">json</span>(post);
                }
            });
        });

        <span class="co">/*</span>
<span class="co">            Créer un nouveau post lorsque</span>
<span class="co">            l&#39;on appelle http://localhost:3000/blogpost</span>
<span class="co">            avec en paramètre le post au format JSON</span>
<span class="co">            en mode POST</span>
<span class="co">        */</span>
        <span class="kw">app</span>.<span class="fu">post</span>(<span class="ch">&#39;/blogposts&#39;</span>,<span class="kw">function</span>(req, res){
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;POST CREATE &quot;</span>, <span class="kw">req</span>.<span class="fu">body</span>);

            <span class="kw">var</span> d = <span class="kw">new</span> <span class="kw">Date</span>(), model = <span class="kw">req</span>.<span class="fu">body</span>;
            <span class="kw">model</span>.<span class="fu">saveDate</span> = (<span class="kw">d</span>.<span class="fu">valueOf</span>());

            <span class="kw">posts</span>.<span class="fu">save</span>(null,model, <span class="kw">function</span> (err, key){
                <span class="kw">if</span>(err) { 
                    <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
                    <span class="kw">res</span>.<span class="fu">json</span>(err); 
                } <span class="kw">else</span> {
                    <span class="kw">model</span>.<span class="fu">id</span> = key;
                    <span class="kw">res</span>.<span class="fu">json</span>(model);
                }
            });
        });


        <span class="co">/*</span>
<span class="co">            Mettre à jour un post lorsque</span>
<span class="co">            l&#39;on appelle http://localhost:3000/blogpost</span>
<span class="co">            avec en paramètre le post au format JSON</span>
<span class="co">            en mode PUT</span>
<span class="co">        */</span>
        <span class="kw">app</span>.<span class="fu">put</span>(<span class="ch">&#39;/blogposts/:id&#39;</span>,<span class="kw">function</span>(req, res){
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;PUT UPDATE&quot;</span>, <span class="kw">req</span>.<span class="fu">body</span>, <span class="kw">req.params</span>.<span class="fu">id</span>);

            <span class="kw">var</span> d = <span class="kw">new</span> <span class="kw">Date</span>(), model = <span class="kw">req</span>.<span class="fu">body</span>;
            <span class="kw">model</span>.<span class="fu">saveDate</span> = (<span class="kw">d</span>.<span class="fu">valueOf</span>());

            <span class="kw">posts</span>.<span class="fu">save</span>(<span class="kw">req.params</span>.<span class="fu">id</span>,model, <span class="kw">function</span> (err, key){
                <span class="kw">if</span>(err) { 
                    <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
                    <span class="kw">res</span>.<span class="fu">json</span>(err); 
                } <span class="kw">else</span> { 
                    <span class="kw">res</span>.<span class="fu">json</span>(model);
                }
            });
        });

        <span class="co">/*</span>
<span class="co">            supprimer un post par sa clé unique lorsque</span>
<span class="co">            l&#39;on appelle http://localhost:3000/blogpost/identifiant_du_post</span>
<span class="co">            en mode DELETE</span>
<span class="co">        */</span>
        <span class="kw">app</span>.<span class="fu">delete</span>(<span class="ch">&#39;/blogposts/:id&#39;</span>,<span class="kw">function</span>(req, res){
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;DELETE : /delete/&quot;</span>+<span class="kw">req.params</span>.<span class="fu">id</span>);

            <span class="kw">posts</span>.<span class="fu">remove</span>(<span class="kw">req.params</span>.<span class="fu">id</span>, <span class="kw">function</span>(err){
                <span class="kw">if</span>(err) { 
                    <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
                    <span class="kw">res</span>.<span class="fu">json</span>(err); 
                } <span class="kw">else</span> { 
                    <span class="co">//petit correctif de contournement (bug ds nStore) : </span>
                    <span class="co">//ré-ouvrir la base lorsque la suppression a été faite</span>
                    posts = <span class="kw">nStore</span>.<span class="fu">new</span>(<span class="st">&quot;blog.db&quot;</span>, <span class="kw">function</span>() {
                        <span class="kw">res</span>.<span class="fu">json</span>(<span class="kw">req.params</span>.<span class="fu">id</span>);
                        <span class="co">//Le modèle est vide si on ne trouve rien</span>
                    });
                }
            });
        });
    }</code></pre>
<p>Maintenant, nous allons faire un dernier travail avant de revenir à Backbone : Nous allons vérifier que notre serveur d’application fonctionne. Pour le lancer : en mode console, allez dans le répertoire <code>blog</code> et lancez la commande <code>node app.js</code>.</p>
<blockquote>
<blockquote>
<p><strong>Astuce :</strong> plutôt que de devoir arrêter et relancer votre application à chaque modification, installez <strong>nodemon</strong> : <code>npm install -g nodemon</code>, dorénavant pour lancer votre application web, tapez <code>nodemon app.js</code> au lieu de <code>node app.js</code>, et elle se relancera toute seule à chaque fois que nodemon détectera un changement dans vos fichiers (au moment de la sauvegarde).</p>
</blockquote>
</blockquote>
<h2 id="testons-notre-application-serveur"><a href="#TOC"><span class="header-section-number">6.4</span> Testons notre application serveur</a></h2>
<p>Une fois notre application lancée, ouvrez un navigateur, appelez l’url <a href="http://localhost:3000">http://localhost:3000</a> et ouvrez la console de debug du navigateur. Et c'est parti pour les tests, où nous allons utiliser intensivement les fonctionnalité ajax de jQuery. Rappelez vous, nous l'avons inclus(e) dans notre projet, via notre page <code>index.html</code>, et au début de notre code dans <code>app.js</code>, nous avons la ligne suivante : <code>app.use(express.static(__dirname + '/public'));</code>, donc si à l'appel de <a href="http://localhost:3000">http://localhost:3000</a>, le serveur ne trouve pas de route <code>&quot;/&quot;</code>, il nous dirigera directement vers <code>index.html</code>.</p>
<h3 id="ajoutons-un-enregistrement"><a href="#TOC"><span class="header-section-number">6.4.1</span> Ajoutons un enregistrement</a></h3>
<p>Dans la console tapez ceci (et validez) :</p>
<p><em>Requête http de type POST :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    $.<span class="fu">ajax</span>({
        <span class="dt">type</span>:<span class="st">&quot;POST&quot;</span>,
        <span class="dt">url</span>:<span class="st">&quot;/blogposts&quot;</span>,
        <span class="dt">data </span>: { <span class="dt">title </span>: <span class="st">&quot;My 1st post&quot;</span>, <span class="dt">message </span>: <span class="st">&quot;Once upon a time ...&quot;</span> } ,
        <span class="dt">dataType </span>: <span class="ch">&#39;json&#39;</span>,
        <span class="dt">error</span>:<span class="kw">function</span>(err){ <span class="kw">console</span>.<span class="fu">log</span>(err); },
        <span class="dt">success</span>:<span class="kw">function</span>(dataFromServer) { <span class="kw">console</span>.<span class="fu">log</span>(dataFromServer); }
    })</code></pre>
<p>Vous venez donc de créer votre tout 1er post (vous avez appelé la route <code>'/blogposts'</code> de type <code>POST</code>), et vous devriez obtenir ceci dans la console du navigateur :</p>
<p><img src="RSRC/05_01_SERV.png" alt="BB" /><br /></p>
<p>Vous noterez que vous obtenez en retour le numéro de clé unique de votre enregistrement (généré par la base nStore) et aussi une date de sauvegarde. <strong>Renouvelez l’opération plusieurs fois pour ajouter plusieurs enregistrements</strong> <em>(si, si, faites le)</em>. De même dans le terminal, vous noterez l’apparition du message <code>POST CREATE</code>, nous avons donc bien appelé la “route” <code>/blogposts</code> de type <code>POST</code> :</p>
<p><img src="RSRC/05_02_SERV.png" alt="BB" /><br /></p>
<h3 id="obtenir-tous-les-enregistrements"><a href="#TOC"><span class="header-section-number">6.4.2</span> Obtenir tous les enregistrements</a></h3>
<p>Dans la console tapez ceci :</p>
<p><em>Requête http de type GET :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    $.<span class="fu">ajax</span>({<span class="dt">type</span>:<span class="st">&quot;GET&quot;</span>, <span class="dt">url</span>:<span class="st">&quot;/blogposts&quot;</span>,
        <span class="dt">error</span>:<span class="kw">function</span>(err){ <span class="kw">console</span>.<span class="fu">log</span>(err); },
        <span class="dt">success</span>:<span class="kw">function</span>(dataFromServer) { <span class="kw">console</span>.<span class="fu">log</span>(dataFromServer); }
    })</code></pre>
<p>Vous obtenez un tableau d’objets correspondant à nos enregistrements :</p>
<p><img src="RSRC/05_03_SERV.png" alt="BB" /><br /></p>
<p>De même dans le terminal, vous noterez l’apparition du message <code>GET (ALL)</code>, nous avons donc bien appelé la “route” <code>/blogposts</code> de type <code>GET</code> :</p>
<p><img src="RSRC/05_04_SERV.png" alt="BB" /><br /></p>
<h3 id="retrouver-un-enregistrement-particulier-par-sa-clé"><a href="#TOC"><span class="header-section-number">6.4.3</span> Retrouver un enregistrement particulier (par sa clé)</a></h3>
<p>Dans la console tapez ceci (vous remarquerez que j’utilise une des clés d’enregistrement):</p>
<p><em>Requête http de type GET :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    $.<span class="fu">ajax</span>({<span class="dt">type</span>:<span class="st">&quot;GET&quot;</span>, <span class="dt">url</span>:<span class="st">&quot;/blogposts/2o03macl&quot;</span>,
        <span class="dt">error</span>:<span class="kw">function</span>(err){ <span class="kw">console</span>.<span class="fu">log</span>(err); },
        <span class="dt">success</span>:<span class="kw">function</span>(dataFromServer) { <span class="kw">console</span>.<span class="fu">log</span>(dataFromServer); }
    })</code></pre>
<p>Vous obtenez :</p>
<p><img src="RSRC/05_05_SERV.png" alt="BB" /><br /></p>
<p>De même dans le terminal, vous obtiendrez le message <code>GET : /blogposts/2o03macl</code>, nous avons donc bien appelé la “route” <code>/blogposts</code> de type <code>GET</code> avec la clé du modèle en paramètre.</p>
<h3 id="mettre-à-jour-un-enregistrement"><a href="#TOC"><span class="header-section-number">6.4.4</span> Mettre à jour un enregistrement</a></h3>
<p>Dans la console tapez ceci :</p>
<p><em>Requête http de type PUT :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    $.<span class="fu">ajax</span>({
        <span class="dt">type</span>:<span class="st">&quot;PUT&quot;</span>,
        <span class="dt">url</span>:<span class="st">&quot;/blogposts/2o03macl&quot;</span>,
        <span class="dt">data </span>: { <span class="dt">title </span>: <span class="st">&quot;My 3rd post&quot;</span>, <span class="dt">message </span>: <span class="st">&quot;Red is really cute&quot;</span> },
        <span class="dt">dataType </span>: <span class="ch">&#39;json&#39;</span>,
        <span class="dt">error</span>:<span class="kw">function</span>(err){ <span class="kw">console</span>.<span class="fu">log</span>(err); },
        <span class="dt">success</span>:<span class="kw">function</span>(dataFromServer) { <span class="kw">console</span>.<span class="fu">log</span>(dataFromServer); }
    })</code></pre>
<p>Puis appelez à nouveau pour vérifier :</p>
<p><em>Requête http de type GET :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    $.<span class="fu">ajax</span>({<span class="dt">type</span>:<span class="st">&quot;GET&quot;</span>, <span class="dt">url</span>:<span class="st">&quot;/blogposts/2o03macl&quot;</span>,
        <span class="dt">error</span>:<span class="kw">function</span>(err){ <span class="kw">console</span>.<span class="fu">log</span>(err); },
        <span class="dt">success</span>:<span class="kw">function</span>(dataFromServer) { <span class="kw">console</span>.<span class="fu">log</span>(dataFromServer); }
    })</code></pre>
<p>La mise à jour a bien été prise en compte :</p>
<p><img src="RSRC/05_06_SERV.png" alt="BB" /><br /></p>
<p>De même, vous pouvez vérifier dans le terminal, l’apparition des messages correspondant à chacune de nos requêtes.</p>
<h3 id="faire-une-requête"><a href="#TOC"><span class="header-section-number">6.4.5</span> Faire une requête</a></h3>
<p>Dans la console tapez la commande &quot;ajax&quot; ci-dessous <em>(je veux les posts dont le titre est égal à “My 3rd post”)</em> :</p>
<p><em>Requête http de type GET :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    $.<span class="fu">ajax</span>({
        <span class="dt">type</span>:<span class="st">&quot;GET&quot;</span>,
        <span class="dt">url</span>:<span class="ch">&#39;/blogposts/query/{ &quot;title&quot; : &quot;My 3rd post&quot;}&#39;</span>,
        <span class="dt">error</span>:<span class="kw">function</span>(err){ <span class="kw">console</span>.<span class="fu">log</span>(err); },
        <span class="dt">success</span>:<span class="kw">function</span>(dataFromServer) { <span class="kw">console</span>.<span class="fu">log</span>(dataFromServer); }
    })</code></pre>
<p>Vous obtenez :</p>
<p><img src="RSRC/05_07_SERV.png" alt="BB" /><br /></p>
<p>Une fois de plus, vous pouvez vérifier dans le terminal, l’apparition du message <code>GET (QUERY)</code>, nous avons donc bien appelé la “route” <code>/blogposts</code> de type <code>GET</code> (avec les paramètres de requête en paramètres).</p>
<h3 id="supprimer-un-enregistrement"><a href="#TOC"><span class="header-section-number">6.4.6</span> Supprimer un enregistrement</a></h3>
<p>Supprimons l'enregistrement qui a la clé d'id égale à <code>2o03macl</code> <em>(chez vous c'est peut-être autre chose)</em>.Dans la console tapez ceci :</p>
<p><em>Requête http de type DELETE :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    $.<span class="fu">ajax</span>({
        <span class="dt">type</span>:<span class="st">&quot;DELETE&quot;</span>, 
        <span class="dt">url</span>:<span class="st">&quot;/blogposts/2o03macl&quot;</span>,
        <span class="dt">error</span>:<span class="kw">function</span>(err){ <span class="kw">console</span>.<span class="fu">log</span>(err); },
        <span class="dt">success</span>:<span class="kw">function</span>(dataFromServer) { <span class="kw">console</span>.<span class="fu">log</span>(dataFromServer); }
    })</code></pre>
<p>Puis recherchez à nouveau l’enregistrement :</p>
<p><em>Requête http de type GET :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    $.<span class="fu">ajax</span>({<span class="dt">type</span>:<span class="st">&quot;GET&quot;</span>, <span class="dt">url</span>:<span class="st">&quot;/blogposts/2o03macl&quot;</span>,
        <span class="dt">error</span>:<span class="kw">function</span>(err){ <span class="kw">console</span>.<span class="fu">log</span>(err); },
        <span class="dt">success</span>:<span class="kw">function</span>(dataFromServer) { <span class="kw">console</span>.<span class="fu">log</span>(dataFromServer); }
    })</code></pre>
<p>Vous obtenez un objet vide :</p>
<p><img src="RSRC/05_08_SERV.png" alt="BB" /><br /> De même dans le terminal, vous noterez l’apparition du message <code>DELETE</code> puis <code>GET</code>, nous avons donc bien appelé la “route” <code>/blogpost</code> de type <code>DELETE</code> (puis <code>GET</code>) avec la clé du modèle en paramètre. Puis un message d’erreur apparaît car le document (post) n’existe plus.</p>
<p>La base de notre application côté serveur est donc posée. Nous la ferons évoluer en fonction de nos besoins. <strong>Maintenant, passons aux choses sérieuses</strong> :-).</p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> <em>: Vous avez remarqué que l’url dans le cas de la création, la sauvegarde, et la suppression d’un modèle, ne changeait pas. Ce qui fait la distinction c’est le verbe http (GET, POST, PUT, DELETE).</em></p>
</blockquote>
</blockquote>
<h1 id="les-modèles-et-les-collections-en-détail"><a href="#TOC"><span class="header-section-number">7</span> Les modèles et les collections en détail</a></h1>
<blockquote>
<p><em>Sommaire</em></p>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li><em>Fonctionnement général</em></li>
<li><em>Les modèles</em></li>
<li><em>Les collections</em></li>
</ul>
</blockquote>
</blockquote>
<blockquote>
<p><em>Nous allons voir comment définir nos modèles, jouer avec, interagir avec le serveur. Nous allons étudier l’intérêt d’une collection de modèles. <strong>Attention, pas un gramme d’HTML</strong> (ou presque) dans ce chapitre, nous faisons tout en « mode commande », pour l’HTML il faudra patienter jusqu’au chapitre sur les Vues.</em></p>
</blockquote>
<p>Dans une application « de gestion », les modèles sont le cœur de l’application, ils représentent des concepts « informatisés » de la « vraie vie » : Les articles d’un catalogue, le client d’une entreprise, … Ils peuvent avoir des interactions entre eux : un client a plusieurs facture, la commande d’un fournisseur ; … Nous avons là 4 modèles : client, facture, fournisseur, commande … sans parler des articles de la facture et de la commande. D’ailleurs en parlant d’article, on pense catalogue, et dans notre cas le catalogue pourrait être une collection d’articles. Et tout cela doit être sauvegardé, doit pouvoir être retrouvé facilement, etc. … Mais voyons donc le fonctionnement intrinsèque des modèles et collections de Backbone.</p>
<h2 id="fonctionnement-général"><a href="#TOC"><span class="header-section-number">7.1</span> Fonctionnement général</a></h2>
<p>Un modèle Backbone (<code>Backbone.Model</code>) représente une entité unique (une instance du modèle), par exemple nous avons la définition du modèle « Client », et si Bob est un client, alors c’est une instance de client. En général, il est lié à une vue (un composant d’affichage) qui changera (modifiera son affichage) lorsque que le modèle changera. Mais les changements du modèle sont aussi synchronisés avec le serveur. La synchronisation avec le serveur se fait avec la méthode <code>Backbone.sync()</code>, à chaque fois qu’un modèle fait une opération « CRUD », <code>Backbone.sync()</code> est appelée pour « discuter » avec le serveur (pour le moment cela va fonctionner tout seul, mais nous reviendrons plus tard à Backbone.sync() pour comprendre son fonctionnement et même modifier celui-ci).</p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : l’acronyme CRUD signifie Create, Read, Update, Delete (Créer, Lire, Mettre à jour, Supprimer). Si vous faites le lien avec le chapitre précédent, lorsque nous allons sauvegarder un nouveau modèle, ce sera une création et une requête de type POST sera envoyée au serveur, dans le cas de la lecture ce sera une requête de type GET, PUT pour les mises à jour de modèles et enfin DELETE pour la suppression. Et c’est la méthode Backbone.sync() qui va se charger de faire la bonne requête au serveur en fonction de l’action du modèle.</p>
</blockquote>
</blockquote>
<p>La collection Backbone (<code>Backbone.Collection</code>) sert à stocker (en mémoire) un ensemble de modèles de même type. Elle permettra de les trier par exemple, les filtrer, etc. ... Elle aussi est généralement liée à une vue et permet de « récupérer » un ensemble de modèles en provenance du serveur. Là aussi, c’est <code>Backbone.sync()</code> qui s’occupe de faire le travail.</p>
<h2 id="modèles"><a href="#TOC"><span class="header-section-number">7.2</span> Modèles</a></h2>
<p>Si vous avez bien suivi les chapitres précédents vous devez disposer d’un squelette d’application et « client » et « serveur ». Nous allons donc, dans un premier temps définir notre modèle en javascript, puis nous le manipulerons directement dans la console du navigateur. Vous pouvez d’ores et déjà lancer la partie serveur avec la commande <code>node app.js</code> (ou <code>nodemon app.js</code>).</p>
<h3 id="définition-du-modèle"><a href="#TOC"><span class="header-section-number">7.2.1</span> Définition du modèle</a></h3>
<p>Ouvrez la page <code>index.html</code> du répertoire <code>public</code> et à l’intérieur de la fonction de chargement (<code>$(function(){})</code>) vous allez saisir le code de votre premier modèle :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    $(<span class="kw">function</span> (){

        <span class="kw">window</span>.<span class="fu">Post</span> = <span class="kw">Backbone.Model</span>.<span class="fu">extend</span>({
            <span class="dt">urlRoot </span>:<span class="st">&quot;/blogposts&quot;</span>

        });

    });</code></pre>
<p>Cela fait peu de code mais nous avons déjà une « mécanique utilisable » avec un grand nombre de possibilités. Nous avons donc un modèle <code>Post</code> pour lequel nous avons juste précisé l’url (<code>urlRoot</code>) à appeler (<code>par Backbone.sync</code>) lors d’actions/traitement de type « CRUD ». En effet un modèle « arrive » avec entre autres les méthodes suivantes : <code>save</code> (pour créer et sauvegarder), <code>fetch</code> (pour lire des données en provenance du serveur) et <code>destroy</code> (pour supprimer le modèle du serveur).</p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : j'ai préfixé <code>Post</code> par <code>window</code> pour y avoir accès en tant que variable globale (dans ma console par exemple).</p>
</blockquote>
</blockquote>
<p>Nous n’avons pas défini de « champs » comme on peut le faire en java, nous allons voir qu’il existe diverses manières de le faire.</p>
<p>Lancez votre navigateur et connectez-vous sur <a href="http://localhost:3000">http://localhost:3000</a> (la page <code>index.html</code>est chargée par défaut si on ne le précise pas) et ouvrez votre console (celle du navigateur).</p>
<p>Puis saisissez ceci dans la console (et validez) :</p>
<p><em>Nouvelle instance d'un modèle &quot;Post&quot; :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> message = <span class="kw">new</span> Post({
        <span class="dt">title </span>: <span class="st">&quot;Premier Message&quot;</span>,
        <span class="dt">message </span>: <span class="st">&quot;Apprendre Backbone, c&#39;est facile&quot;</span>,
        <span class="dt">author </span>: <span class="st">&quot;@K33G_ORG&quot;</span>
    });</code></pre>
<p>Nous avons maintenant une instance d’un modèle, jouons avec. Vous avez noté que la définition des champs du modèle (<code>title, message, author</code>) se fait à l’instanciation du modèle, personnellement je trouve ce la pratique et très lisible (un début programmation fonctionnelle), mais je comprends que cela puisse perturber (nous verrons comment faire autrement si vous le souhaitez).</p>
<blockquote>
<blockquote>
<p><strong>Remarque (importante)</strong> : la propriété <code>urlRoot</code> du modèle n’est utile que si l’on se « sert » d’un modèle hors d’une collection de modèles (le modèle est indépendant), sinon, si le modèle appartient à une collection est qu’il n’a pas de propriété urlRoot renseignée, il « utilise » la propriété <code>url</code> de la collection à laquelle il appartient.</p>
</blockquote>
</blockquote>
<h3 id="getters-et-setters"><a href="#TOC"><span class="header-section-number">7.2.2</span> Getters et Setters</a></h3>
<p>Pour lire ou modifier les valeurs des propriétés de notre message, le réflexe serait pour par exemple obtenir la valeur du titre de taper la commande <code>message.title</code>, et bien cela ne fonctionne pas ! Backbone a une mécanique différente, si vous souhaitez obtenir la valeur du titre il faudra taper la commande <code>message.get(&quot;title&quot;)</code> et pour la modifier <code>message.set(&quot;title&quot;, &quot;mon nouveau titre&quot;)</code> ou <code>message.set({title : &quot;mon nouveau titre&quot;})</code>, cette dernière notation permet de changer plusieurs propriétés en une seule passe. Cela peut surprendre mais cela a beaucoup d’avantages d’utiliser des méthodes plutôt qu’une simple affectation, on peut ainsi s’abonner aux changements des valeurs pour déclencher automatiquement un traitement (comme le rafraichissement d’une vue par exemple). Faites donc l’exercice dans la console :</p>
<p><img src="RSRC/06_01_MODS.png" alt="BB" /><br /></p>
<h3 id="structure-dun-modèle"><a href="#TOC"><span class="header-section-number">7.2.3</span> Structure d'un modèle</a></h3>
<p>Mais allons voir comment est structuré un modèle : dans la console, tapez <code>message</code> (notre instance de modèle <code>Post</code>) et déroulez la structure « child » (child pour instance de modèle) :</p>
<p><img src="RSRC/06_02_MODS.png" alt="BB" /><br /></p>
<p>Vous notez que les propriétés de notre modèle sont contenues dans un objet <code>attributes</code> (c’est pour cela que nous n’y avons pas accès directement et que l'on utilise <code>get</code> et <code>set</code>).</p>
<h3 id="méthodes-crud-du-modèle"><a href="#TOC"><span class="header-section-number">7.2.4</span> Méthodes “CRUD” du modèle</a></h3>
<h4 id="méthodes-save-création-mise-à-jour"><a href="#TOC"><span class="header-section-number">7.2.4.1</span> Méthodes save() : création &amp; mise à jour<br /></a></h4>
<p>Saisissez le code javascript ci-dessous dans la console du navigateur. Cela va déclancher une requête ajax vers le serveur pour sauvegarder votre modèle (instance de modèle). Si tout se passe bien, c’est la méthode <code>success()</code> qui est appelée.</p>
<p><em>Appel de la méthode save() du modèle :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">message</span>.<span class="fu">save</span>({},{
        <span class="dt">success </span>: <span class="kw">function</span>() {
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;message sauvegardé.&quot;</span>);
        },
        <span class="dt">error </span>: <span class="kw">function</span>() {
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;oupss&quot;</span>);
        }
    });</code></pre>
<p><img src="RSRC/06_03_MODS.png" alt="BB" /><br /></p>
<p>Vous pouvez noter au passage que côté serveur, c’est bien une méthode de type POST qui a été faite et qu’un modèle a été créé en base de données.</p>
<p><img src="RSRC/06_04_MODS.png" alt="BB" /><br /></p>
<p>Si dans la console du navigateur, vous saisissez <code>message</code> (notre modèle) et validez, vous aurez l’opportunité de pouvoir dérouler l’ensemble des membres (propriétés et méthodes) de message. Vous noterez l’apparition de la propriété <code>id</code>, avec une valeur (valeur unique qui a été affectée par le serveur).</p>
<p><img src="RSRC/06_05_MODS.png" alt="BB" /><br /> Modifions maintenant le modèle en cours et sauvegardons le :</p>
<p><em>Appel de la méthode save() du modèle :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">message</span>.<span class="fu">save</span>({
            <span class="dt">title </span>: <span class="st">&quot;=== PREMIER MESSAGE ===”,</span>
            <span class="dt">message </span>: <span class="st">&quot;Je m&#39;amuse avec Backbone.js&quot;</span>
        },{
            <span class="dt">success </span>: <span class="kw">function</span>() {
                <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;message sauvegardé.&quot;</span>);
            },
            <span class="dt">error </span>: <span class="kw">function</span>() {
                <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;oupss&quot;</span>);
            }
    });</code></pre>
<p>Ce qui est équivalent à ceci (nous avons juste utilisé un raccourci) :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">message</span>.<span class="fu">set</span>({
        <span class="dt">title </span>: <span class="st">&quot;=== PREMIER MESSAGE ===”,</span>
        <span class="dt">message </span>: <span class="st">&quot;Je m&#39;amuse avec Backbone.js&quot;</span>
    });

    <span class="kw">message</span>.<span class="fu">save</span>({},{
        <span class="dt">success </span>: <span class="kw">function</span>() {
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;message sauvegardé.&quot;</span>);
        },
        <span class="dt">error </span>: <span class="kw">function</span>() {
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;oupss&quot;</span>);
        }
    });</code></pre>
<p>Et vous obtiendrez :</p>
<p><img src="RSRC/06_06_MODS.png" alt="BB" /><br /></p>
<p>Cette fois ci, côté serveur, la requête ajax a été détectée comme une requête de type <code>PUT</code>, donc une requête de mise à jour du modèle.</p>
<p><img src="RSRC/06_07_MODS.png" alt="BB" /><br /></p>
<h4 id="méthode-fetch-retrouver-un-modèle"><a href="#TOC"><span class="header-section-number">7.2.4.2</span> Méthode fetch() : retrouver un modèle<br /></a></h4>
<p>Notez bien le numéro d’id affecté par le serveur (dans notre exemple : “17f0v3jv”, attention c’est une valeur aléatoire unique affectée par le serveur) et raffraichissez votre page dans le navigateur (le modèle <code>message</code> disparaît donc de la mémoire).</p>
<p>Créons maintenant une nouvelle fois un modèle avec simplement comme champ, un id prenant la valeur de la clé du modèle sauvegardé en base :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> message = <span class="kw">new</span> Post({<span class="dt">id</span>:<span class="st">&quot;17f0v3jv&quot;</span>});</code></pre>
<p>Puis appelons à nouveau la méthode <code>fetch()</code> du modèle :</p>
<p><em>Appel de la méthode fetch() pour charger les données du serveur :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">message</span>.<span class="fu">fetch</span>({
        <span class="dt">success </span>: <span class="kw">function</span>(model) {
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;message retrouvé.&quot;</span>);
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>), <span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;message&quot;</span>));
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="kw">message</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>), <span class="kw">message</span>.<span class="fu">get</span>(<span class="st">&quot;message&quot;</span>));
        },
        <span class="dt">error </span>: <span class="kw">function</span>() {
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;oupss&quot;</span>);
        }
    });</code></pre>
<p>Nous récupérons bien les données du modèle sauvegardé :</p>
<p><img src="RSRC/06_08_MODS.png" alt="BB" /><br /></p>
<p>Et côté serveur, on peut vérifier le message affiché dans le terminal : nous avons bien une requête de type <code>GET</code> avec en paramètre la clé unique (identifiant) du modèle.</p>
<h4 id="méthode-destroy-supprimer-un-modèle-du-serveur"><a href="#TOC"><span class="header-section-number">7.2.4.3</span> Méthode destroy() : supprimer un modèle du serveur<br /></a></h4>
<p>Le principe est le même que pour la méthode <code>fetch()</code>, à partir d’un modèle en cours d’utilisation ou un nouveau modèle créé avec un id existant, il suffit ensuite d’appeler la méthode <code>destroy()</code> du modèle pour le supprimer de la base de données :</p>
<p><em>Appel de la méthode destroy() :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> message = <span class="kw">new</span> Post({<span class="dt">id</span>:<span class="st">&quot;17f0v3jv&quot;</span>});
    <span class="kw">message</span>.<span class="fu">destroy</span>({<span class="dt">success</span>:<span class="kw">function</span>(){ <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;supprimé&quot;</span>);}})</code></pre>
<p><img src="RSRC/06_09_MODS.png" alt="BB" /><br /></p>
<p>Et côté serveur, nous avons bien une requête de type <code>DELETE</code> avec en paramètre la clé unique (identifiant) du modèle :</p>
<p><img src="RSRC/06_10_MODS.png" alt="BB" /><br /></p>
<h3 id="evénements"><a href="#TOC"><span class="header-section-number">7.2.5</span> Evénements</a></h3>
<p>Il est possible de “s’abonner” aux changements effectués sur un modèle grâce à la méthode <code>on()</code> (anciennement <code>bind()</code>) de l’instance du modèle :</p>
<p><em>Abonnement à un événement avec la méthode on() :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">message</span>.<span class="fu">on</span>(<span class="st">&quot;change&quot;</span>, <span class="kw">function</span>(){
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;quelque chose a changé&quot;</span>);
        <span class="kw">if</span> (<span class="kw">message</span>.<span class="fu">hasChanged</span>(<span class="st">&quot;title&quot;</span>)) {
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;vous avez changé le titre : &quot;</span>, <span class="kw">message</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>));
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;l&#39;ancien titre est : &quot;</span>,<span class="kw">message</span>.<span class="fu">previous</span>(<span class="st">&quot;title&quot;</span>));
        }

    });</code></pre>
<p>Nous venons de nous abonner aux changements de valeurs des champs de l’instance de modèle <code>message</code>. C’est à dire que nous serons notifiés dès qu’une valeur d’un champ de <code>message</code> est modifiée :</p>
<p><img src="RSRC/06_11_MODS.png" alt="BB" /><br /></p>
<p>Vous pouvez aussi &quot;écouter&quot; les changements spécifiques à un attribut bien particulier de cette façon :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">message</span>.<span class="fu">on</span>(<span class="st">&quot;change:message&quot;</span>, <span class="kw">function</span>(){
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;le message a changé :&quot;</span>, <span class="kw">this</span>.<span class="fu">get</span>(<span class="st">&quot;message&quot;</span>));
    })</code></pre>
<p><img src="RSRC/06_12_MODS.png" alt="BB" /><br /></p>
<p>On s’apperçoit que les abonnements se cumulent. Ce que nous venons de faire n’est par contre valable que pour une instance de modèle de type Post. Comment faire pour que cela soit valable pour tous les Posts ? En utilisant le constructeur du modèle, ou plus spécifiquement la méthode <code>initialize()</code> qui est appelée par le constructeur du modèle.</p>
<pre><code>//TODO: parler de off()</code></pre>
<h3 id="constructeur-initialize"><a href="#TOC"><span class="header-section-number">7.2.6</span> Constructeur : initialize</a></h3>
<p>Retournez modifier le code de notre modèle dans la page <code>index.html</code> du répertoire <code>public</code> :</p>
<p><em>Méthode initialize() et utilisation de on() :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">Post</span> = <span class="kw">Backbone.Model</span>.<span class="fu">extend</span>({
        <span class="dt">urlRoot </span>:<span class="st">&quot;/blogposts&quot;</span>,

        <span class="dt">initialize </span>: <span class="kw">function</span> () {
            <span class="kw">this</span>.<span class="fu">on</span>(<span class="st">&quot;change:message&quot;</span>, <span class="kw">function</span>(){
                <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;le message a changé :&quot;</span>, <span class="kw">this</span>.<span class="fu">get</span>(<span class="st">&quot;message&quot;</span>));
            });
            <span class="kw">this</span>.<span class="fu">on</span>(<span class="st">&quot;change:title&quot;</span>, <span class="kw">function</span>(){
                <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;le titre a changé :&quot;</span>, <span class="kw">this</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>));
            });
        }

    });</code></pre>
<p>Nous venons d’expliquer que pour chacun des modèles de type <code>Post</code>, si son titre ou son message change, alors nous sommes notifiés. Rechargez votre page, et rappelez par un <code>fetch</code> votre modèle (les données du serveur) :</p>
<p><img src="RSRC/06_13_MODS.png" alt="BB" /><br /></p>
<p>Mais vous pouvez essayer avec un nouveau Post :</p>
<p><img src="RSRC/06_14_MODS.png" alt="BB" /><br /></p>
<h3 id="augmenter-le-modèle-ajouter-des-valeurs-par-défaut-et-des-méthodes-au-modèle"><a href="#TOC"><span class="header-section-number">7.2.7</span> “Augmenter” le modèle : ajouter des valeurs par défaut et des méthodes au modèle</a></h3>
<p>Vous pouvez éprouver le besoin de coder de manière plus classique (à la java), nous allons en profiter pour ajouter des getters et des setters “à l’ancienne” ainsi que des valeurs par défaut au modèle :</p>
<p><em>Ajouts de propriétés et de méthodes au model :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">Post</span> = <span class="kw">Backbone.Model</span>.<span class="fu">extend</span>({
        <span class="dt">urlRoot </span>:<span class="st">&quot;/blogposts&quot;</span>,

        <span class="co">/* valeurs par défaut du modèle */</span>
        <span class="dt">defaults </span>: {
            <span class="dt">title </span>: <span class="st">&quot;???&quot;</span>,
            <span class="dt">message </span>: <span class="st">&quot;...&quot;</span>,
            <span class="dt">author </span>: <span class="st">&quot;John Doe&quot;</span>
        },

        <span class="dt">initialize </span>: <span class="kw">function</span> () {
            <span class="kw">this</span>.<span class="fu">on</span>(<span class="st">&quot;change:message&quot;</span>, <span class="kw">function</span>(){
                <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;le message a changé :&quot;</span>, <span class="kw">this</span>.<span class="fu">get</span>(<span class="st">&quot;message&quot;</span>));
            });
            <span class="kw">this</span>.<span class="fu">on</span>(<span class="st">&quot;change:title&quot;</span>, <span class="kw">function</span>(){
                <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;le titre a changé :&quot;</span>, <span class="kw">this</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>));
            });
        },

        <span class="co">/* les getters et les setters à l&#39;ancienne */</span>
        <span class="dt">getTitle </span>: <span class="kw">function</span> () {
            <span class="kw">return</span> <span class="kw">this</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>);
        },
        <span class="dt">setTitle </span>: <span class="kw">function</span> (value) {
            <span class="kw">this</span>.<span class="fu">set</span>(<span class="st">&quot;title&quot;</span>, value);
        },
        <span class="dt">getMessage </span>: <span class="kw">function</span> () {
            <span class="kw">return</span> <span class="kw">this</span>.<span class="fu">get</span>(<span class="st">&quot;message&quot;</span>);
        },
        <span class="dt">setMessage </span>: <span class="kw">function</span> (value) {
            <span class="kw">this</span>.<span class="fu">set</span>(<span class="st">&quot;message&quot;</span>, value);
        },
        <span class="dt">getAuthor </span>: <span class="kw">function</span> () {
            <span class="kw">return</span> <span class="kw">this</span>.<span class="fu">get</span>(<span class="st">&quot;author&quot;</span>);
        },
        <span class="dt">setAuthor </span>: <span class="kw">function</span> (value) {
            <span class="kw">this</span>.<span class="fu">set</span>(<span class="st">&quot;author&quot;</span>, value);
        }

    });</code></pre>
<p>Que nous pouvons utiliser de la manière suivante :</p>
<p><img src="RSRC/06_15_MODS.png" alt="BB" /><br /> ###Validation</p>
<pre><code>//TODO: à faire</code></pre>
<h3 id="comment-détecter-quun-modèle-a-été-changé-par-quelquun-dautre"><a href="#TOC"><span class="header-section-number">7.2.8</span> Comment détecter qu’un modèle a été changé par quelqu’un d’autre ?</a></h3>
<p>Dans la “rubrique trucs &amp; astuces”, il est possible de détecter un changement effectué côté serveur (cet exemple est à titre démonstratif et mérite d’être optimisé ou d’utiliser d’autres moyens tels les websockets par exemple).Tapez ceci dans la console de votre navigateur :</p>
<p><em>Appel de la méthode fetch() à intervalles réguliers :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> message = <span class="kw">new</span> Post({<span class="dt">id</span>:<span class="st">&quot;17f0v3jv&quot;</span>});

    setInterval(<span class="kw">function</span>(){
        <span class="kw">message</span>.<span class="fu">fetch</span>();
    },<span class="dv">1000</span>)</code></pre>
<p>Nous venons de créer un nouveau <code>Post</code>, en lui renseignant son id (car nous savons qu’il existe côté serveur) et demandons à javascript d’aller chercher les données toutes les 1000 millisecondes (donc toutes les 1 secondes).</p>
<p>Ensuite, ouvrez un autre navigateur (par exemple FireFox) et connectez-vous sur <a href="http://localhost:3000">http://localhost:3000</a>, puis dans la console de ce navigateur tapez ceci :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> message = <span class="kw">new</span> Post({<span class="dt">id</span>:<span class="st">&quot;17f0v3jv&quot;</span>});
    <span class="kw">message</span>.<span class="fu">set</span>({<span class="dt">title</span>:<span class="st">&quot;LE TITRE DU 1ER MESSAGE&quot;</span>});</code></pre>
<p>puis sauvegardez :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">message</span>.<span class="fu">save</span>()</code></pre>
<p>Et dans la console du précédent navigateur, vous allez voir s’afficher un message expliquant que le modèle a changé. La méthode <code>change()</code> que nous avons définie dans <code>initialize</code> est aussi appelée/déclenchée lorsque que Backbone détecte un changement (lors d’un <code>fetch()</code>) entre les données clientes et les données serveurs :</p>
<p><img src="RSRC/06_16_MODS.png" alt="BB" /><br /></p>
<p>Pour le moment nous avons fait le tour de l’essentiel du fonctionnement des modèles (je vous engage cependant à lire la documentation de Backbone (<a href="http://backbonejs.org/#Model">http://backbonejs.org/#Model</a>), pour en découvrir toutes les possibilités). Passons donc aux collections.</p>
<h2 id="collections"><a href="#TOC"><span class="header-section-number">7.3</span> Collections</a></h2>
<p>Changeons à nouveau le code de notre modèle dans notre page <code>index.html</code> :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">Post</span> = <span class="kw">Backbone.Model</span>.<span class="fu">extend</span>({
        <span class="dt">urlRoot </span>:<span class="st">&quot;/blogposts&quot;</span>

    });</code></pre>
<p>Puis définissons une collection : <code>Backbone.Collection</code></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">Posts</span> = <span class="kw">Backbone.Collection</span>.<span class="fu">extend</span>({
        <span class="dt">url </span>:<span class="st">&quot;/blogposts&quot;</span>,
        <span class="dt">model </span>: Post

    });</code></pre>
<p>Nous avons précisé une url pour les collections (c’est ce qui sera utilisé lorsque nous ferons des requêtes au serveur), et le type de modèle de la collection. Et rechargeons notre page, pour une nouvelle fois passer en mode commande (et donc ouvrir la console du navigateur).</p>
<h3 id="comment-ajouter-des-modèles-à-une-collection"><a href="#TOC"><span class="header-section-number">7.3.1</span> Comment ajouter des modèles à une collection</a></h3>
<p>Tout d’abord, il faut créer(instancier) une nouvelle collection :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> postsList = <span class="kw">new</span> Posts();</code></pre>
<p>Puis créer(instancier) 3 nouveaux modèles Post :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> post1 = <span class="kw">new</span> Post({<span class="dt">title</span>:<span class="st">&quot;Titre Post1&quot;</span>, <span class="dt">message</span>:<span class="st">&quot;message 1&quot;</span>})
    <span class="kw">var</span> post2 = <span class="kw">new</span> Post({<span class="dt">title</span>:<span class="st">&quot;Titre Post2&quot;</span>, <span class="dt">message</span>:<span class="st">&quot;message 2&quot;</span>})
    <span class="kw">var</span> post3 = <span class="kw">new</span> Post({<span class="dt">title</span>:<span class="st">&quot;Titre Post3&quot;</span>, <span class="dt">message</span>:<span class="st">&quot;message 3&quot;</span>})</code></pre>
<p>Que vous pouvez ajouter à la collection de cette manière :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsList</span>.<span class="fu">add</span>(post1)</code></pre>
<p>Ou de cette façon :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsList</span>.<span class="fu">add</span>([post2, post3])</code></pre>
<p>Il est possible de créer directement un modèle dans la collection de cette façon :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsList</span>.<span class="fu">add</span>(<span class="kw">new</span> Post({<span class="dt">title</span>:<span class="st">&quot;Titre Post4&quot;</span>, <span class="dt">message</span>:<span class="st">&quot;message 4&quot;</span>}))</code></pre>
<p>ou de cette manière :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsList</span>.<span class="fu">create</span>({<span class="dt">title</span>:<span class="st">&quot;Titre Post5&quot;</span>, <span class="dt">message</span>:<span class="st">&quot;message 5&quot;</span>})</code></pre>
<p>Et enfin, saisissez ceci :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsList</span>.<span class="fu">models</span></code></pre>
<p>Et vous obtenez un tableau des 5 modèles de la collection :</p>
<p><img src="RSRC/06_17_MODS.png" alt="BB" /><br /></p>
<p>Et vous pouvez accéder aux modèles et à leurs propriétés par exemple de cette façon-ci :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsList</span>.<span class="fu">models</span>[<span class="dv">0</span>].<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>)</code></pre>
<p>Ou bien de cette manière :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsList</span>.<span class="fu">at</span>(<span class="dv">0</span>).<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>)</code></pre>
<p><code>at()</code> utilise le numéro d’index du modèle dans la collection.</p>
<p>Ou bien comme ceci :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsList</span>.<span class="fu">get</span>(<span class="st">&quot;3chk57hl&quot;</span>).<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>)</code></pre>
<p><code>get()</code> utilise le numéro d’id affecté (par le serveur) au modèle lorsqu’il est sauvegardé.</p>
<p>Ou encore :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsList</span>.<span class="fu">getByCid</span>(<span class="st">&quot;c18&quot;</span>).<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>)</code></pre>
<p><code>getByCid()</code> utilise la propriété cid du modèle automatiquement affectée lorsqu’il est créé/instancié (new), cela peut être pratique pour les modèles qui ne sont pas encore sauvegardés et qui donc n’ont pas encore d’id.</p>
<h3 id="parcourir-les-modèles-dune-collection"><a href="#TOC"><span class="header-section-number">7.3.2</span> Parcourir les modèles d’une collection</a></h3>
<p>Les collections Backbone dispose d’une méthode <code>each()</code> (issue de la librairie Underscore.js) qui permet de parcourir chacun des éléments de la collection et de faire un traitement pour chacun de ces éléments. Par exemple, nous souhaitons afficher le titre de chacun des Posts de la collection, pour cela saisissez le code suivant dans la console :</p>
<p><em>Appel de la méthode each() :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsList</span>.<span class="fu">each</span>(<span class="kw">function</span>(post){
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>));
    })</code></pre>
<p>Vous obtiendrez le résultat suivant :</p>
<p><img src="RSRC/06_18_MODS.png" alt="BB" /><br /></p>
<h3 id="filtrer-les-modèles-dune-collection"><a href="#TOC"><span class="header-section-number">7.3.3</span> Filtrer les modèles d’une collection</a></h3>
<p>De la même façon que <code>each()</code> il existe une méthode <code>filter()</code> (toujours issue de Underscore.js) qui permet de retourner l’ensemble des modèles d’une collection répondant à un critère. Dans l’exemple ci-dessous je souhaite obtenir la liste des modèles dont le titre se termine par un chiffre supérieur à 3 :</p>
<p><em>Appel de la méthode filter() :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> somePosts = <span class="kw">postsList</span>.<span class="fu">filter</span>(<span class="kw">function</span>(post){
        <span class="kw">return</span> <span class="fu">parseInt</span>(<span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>)[<span class="dv">10</span>]) &gt; <span class="dv">3</span>;
    })</code></pre>
<p><img src="RSRC/06_19_MODS.png" alt="BB" /><br /></p>
<h3 id="trouver-le-1er-modèle-dune-collection-correspondant-à-un-critère"><a href="#TOC"><span class="header-section-number">7.3.4</span> Trouver le 1er modèle d’une collection correspondant à un critère</a></h3>
<p>La méthode <code>find()</code> fonctionne comme <code>filter()</code> mais retourne le premier élément correspondant aux critères de recherche :</p>
<p><em>Appel de la méthode find() :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> onePost = <span class="kw">postsList</span>.<span class="fu">find</span>(<span class="kw">function</span>(post){
        <span class="kw">return</span> <span class="fu">parseInt</span>(<span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>)[<span class="dv">10</span>]) &gt; <span class="dv">3</span>;
    })</code></pre>
<p><img src="RSRC/06_20_MODS.png" alt="BB" /><br /></p>
<h3 id="autres-méthodes-de-la-collection"><a href="#TOC"><span class="header-section-number">7.3.5</span> Autres méthodes de la collection</a></h3>
<pre><code>//TODO: à faire ... en attendant lisez la doc de Backbone (ou faites moi une PR ;) )</code></pre>
<h2 id="les-collections-parlent-au-serveur"><a href="#TOC"><span class="header-section-number">7.4</span> Les collections “parlent” au serveur</a></h2>
<p>Sauvegardons d’abord nos modèles (en utilisant <code>each()</code> pour aller plus vite) pour avoir un jeu d’essai de données en base côté serveur. Pour cela, tapez donc ceci dans votre console :</p>
<p><em>Sauvegarder tous les modèles :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsList</span>.<span class="fu">each</span>(<span class="kw">function</span>(post){
        <span class="kw">post</span>.<span class="fu">save</span>({},{
            <span class="dt">success </span>:  <span class="kw">function</span> (post) {
                <span class="kw">console</span>.<span class="fu">log</span>(<span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>),<span class="st">&quot; sauvegardé&quot;</span>);
            },
            <span class="dt">error </span>: <span class="kw">function</span> () { <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Oupss&quot;</span>); }
        });

    })</code></pre>
<p><img src="RSRC/06_21_MODS.png" alt="BB" /><br /></p>
<h3 id="charger-les-données"><a href="#TOC"><span class="header-section-number">7.4.1</span> Charger les données</a></h3>
<p>Maintenant nous souhaitons interroger le serveur pour qu’il nous fournisse l’ensemble des modèles de type Post. Rechargez la page pour être sûr de remettre toutes les variables en mémoire à zéro. Ensuite créez une nouvelle instance de collection de Post :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> postsList = <span class="kw">new</span> Posts();</code></pre>
<p>Et chargez celle-ci à partir des données du serveur :</p>
<p><em>Appel de la méthode fetch() :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsList</span>.<span class="fu">fetch</span>({
        <span class="dt">success </span>: <span class="kw">function</span> () {
            <span class="kw">postsList</span>.<span class="fu">each</span>(<span class="kw">function</span>(post){
                <span class="kw">console</span>.<span class="fu">log</span>(<span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>));
            })
        },
        <span class="dt">error </span>: <span class="kw">function</span> () {
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Oupss&quot;</span>);
        }
    })</code></pre>
<p>Nous avons donc bien une collection avec les modèles initialisés à partir des données du serveur :</p>
<p><img src="RSRC/06_22_MODS.png" alt="BB" /><br /></p>
<h3 id="requêtes"><a href="#TOC"><span class="header-section-number">7.4.2</span> Requêtes</a></h3>
<p>Lorsque nous avons créé notre application côté serveur, nous avions prévu de pouvoir requêter les données. Nous voudrions pouvoir faire ça à partir de la collection que nous avons créée. Pour cela il faudra pouvoir changer la propriété <code>url</code> de la collection. Modifions alors le code source de notre collection de la façon suivante (dnas la page <code>index.html</code>) :</p>
<p><em>Ajouter des méthodes à la collection :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">Posts</span> = <span class="kw">Backbone.Collection</span>.<span class="fu">extend</span>({
        <span class="dt">model </span>: Post,
        <span class="dt">all </span>: <span class="kw">function</span> () {
            <span class="kw">this</span>.<span class="fu">url</span> = <span class="st">&quot;/blogposts&quot;</span>;
            <span class="kw">return</span> <span class="kw">this</span>;
        },
        <span class="dt">query </span>: <span class="kw">function</span> (query) {
            <span class="kw">this</span>.<span class="fu">url</span> = <span class="st">&quot;/blogposts/query/&quot;</span>+query;
            <span class="kw">return</span> <span class="kw">this</span>;
        }

    });</code></pre>
<p>Rechargez ensuite la page, puis créez une nouvelle collection (dans la console du navigateur) :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> postsList = <span class="kw">new</span> Posts();</code></pre>
<p>puis faites une requête :</p>
<p><em>Ne charger que certains titres dans la collection :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsList</span>.<span class="fu">query</span>(<span class="ch">&#39;{&quot;title&quot; : &quot;Titre Post2&quot;}&#39;</span>)
        .<span class="fu">fetch</span>({
            <span class="dt">success</span>:<span class="kw">function</span>(result){
                <span class="kw">console</span>.<span class="fu">log</span>(result);
            }
    })</code></pre>
<p>Vous obtenez ceci :</p>
<p><img src="RSRC/06_23_MODS.png" alt="BB" /><br /></p>
<p>Ensuite si vous souhaitez charger tous les modèles (toujours dans la console de votre navigateur) :</p>
<p><em>Charger tous les modèles dans la collection :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsList</span>.<span class="fu">all</span>()
        .<span class="fu">fetch</span>({
            <span class="dt">success</span>:<span class="kw">function</span>(result){
                <span class="kw">console</span>.<span class="fu">log</span>(result);
            }
    })</code></pre>
<p><img src="RSRC/06_24_MODS.png" alt="BB" /><br /></p>
<blockquote>
<blockquote>
<p><strong>A Noter</strong> : il se trouve que les collections dans Backbone ont une méthode <code>url()</code> qui est appelée si la propriété <code>url</code> n’existe pas, cela peut être un autre moyen d’adresser la problématique de changement d’url. De même si les modèles ajoutés à une collection, n’ont pas de propriété <code>url</code> (ni <code>urlRoot</code>), ils héritent de celle de la collection (mais cela demande à revoir la politique de « routage » utilisée côté serveur ou de modifier <code>Backbone.sync()</code> qui construira les requêtes http en fonction du type d’objet faisant une requête (modèle ou collection)). Pour plus d’information sur le sujet, aller voir : <a href="http://backbonejs.org/#Model-url">http://backbonejs.org/#Model-url</a> ainsi que <a href="http://backbonejs.org/#Collection-url">http://backbonejs.org/#Collection-url</a>.</p>
</blockquote>
</blockquote>
<h2 id="evénements-1"><a href="#TOC"><span class="header-section-number">7.5</span> Evénements</a></h2>
<p>Comme pour les modèles, il est possible de s’abonner à des événements issus des collections. Nous souhaitons être notifié de tout changement dans un modèle de la collection. Saisissez donc ceci (dans la console) :</p>
<p><em>Affecter un événement à tous les modèles :</em></p>
<p>`<code>javascript     postsList.on('change', function (model) {         console.log(&quot;Changement : &quot;, model.get(&quot;title&quot;));     });</code></p>
<p>Puis :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsList</span>.<span class="fu">at</span>(<span class="dv">0</span>).<span class="fu">set</span>(<span class="st">&quot;title&quot;</span>,<span class="st">&quot;=== Titre Post 4 ===&quot;</span>)</code></pre>
<p>Vous obtenez ceci :</p>
<p><img src="RSRC/06_25_MODS.png" alt="BB" /><br /></p>
<p><strong>Il n’est donc plus obligatoire d’affecter un événement de façon individuelle aux modèles, tous les modèles appartenant à une collection héritent de l’événement (trigger) associé à celle-ci.</strong></p>
<p>Voilà nous en connaissons assez sur les modèles et les collections pour passer à la suite.</p>
<h1 id="vues-templating"><a href="#TOC"><span class="header-section-number">8</span> Vues &amp; Templating</a></h1>
<blockquote>
<p><em>Sommaire</em></p>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li><em>1ère vue</em></li>
<li><em>Mise à jour automatique de l’affichage</em></li>
<li><em>Sous-vues</em></li>
<li><em>Templating</em></li>
<li><em>évènements</em></li>
</ul>
</blockquote>
</blockquote>
<blockquote>
<p><em>Nous avons joué avec les données dans le chapitre précédent, nous allons maintenant voir comment les afficher dynamiquement dans notre page web.</em></p>
</blockquote>
<p>Le composant View de Backbone est peut-être celui qui génère le plus de polémiques. Est-ce vraiment une vue ? Ne serait-ce pas plutôt un contrôleur ? Il se trouve que dans une version plus ancienne de Backbone, le composant Controller existait, aujourd’hui il est le devenu le composant Router que nous verrons par la suite … Cependant, un routeur est-il réellement un contrôleur ?... Mais, rappelez-vous que l’on est dans un contexte client (navigateur) et que le concept MVC « classique » n’est pas forcément « portable » en l’état. L’essentiel est que cela fonctionne, et si les contrôleurs vous manquent à ce point, nous verrons comment en créer quelques chapitres plus loin.</p>
<h2 id="préparons-le-terrain"><a href="#TOC"><span class="header-section-number">8.1</span> Préparons le terrain</a></h2>
<p>Pour repartir sur de bonnes bases, nous allons supprimer la base de données avec laquelle nous avons déjà bien joué. Donc supprimez le fichier <code>blog.db</code> de la racine de votre application. Ensuite, modifiez le code javascript de la page <code>index.html</code> dans le répertoire <code>/public</code>, donc dans la partie <code>&lt;script&gt;&lt;/script&gt;</code>, pour instancier une collection : (on ajoute : <code>window.blogPosts = new Posts();</code>)</p>
<p><em>Instancier une collection :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    $(<span class="kw">function</span> (){

        <span class="kw">window</span>.<span class="fu">Post</span> = <span class="kw">Backbone.Model</span>.<span class="fu">extend</span>({
            <span class="dt">urlRoot </span>:<span class="st">&quot;/blogposts&quot;</span>

        });

        <span class="kw">window</span>.<span class="fu">Posts</span> = <span class="kw">Backbone.Collection</span>.<span class="fu">extend</span>({
            <span class="dt">model </span>: Post,
            <span class="dt">all </span>: <span class="kw">function</span> () {
                <span class="kw">this</span>.<span class="fu">url</span> = <span class="st">&quot;/blogposts&quot;</span>;
                <span class="kw">return</span> <span class="kw">this</span>;
            },
            <span class="dt">query </span>: <span class="kw">function</span> (query) {
                <span class="kw">this</span>.<span class="fu">url</span> = <span class="st">&quot;/blogposts/query/&quot;</span>+query;
                <span class="kw">return</span> <span class="kw">this</span>;
            }

        });

        <span class="kw">window</span>.<span class="fu">blogPosts</span> = <span class="kw">new</span> Posts();

    });</code></pre>
<p>Sauvegardez, puis relancez votre application (<code>node app.js ou nodemon app.js</code>), dans le navigateur accédez à la page principale (<a href="http://localhost:3000/">http://localhost:3000/</a>), pour enfin ouvrir la console de votre navigateur. Nous allons créer des modèles, que nous ajouterons à la collection blogposts.</p>
<h3 id="création-et-sauvegarde-des-modèles"><a href="#TOC"><span class="header-section-number">8.1.1</span> Création et sauvegarde des modèles</a></h3>
<p>Commencez par saisir ceci dans la console du navigateur :</p>
<p><em>Ajouter des modèles à la collection :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> messages = [
        <span class="st">&quot;Maecenas sed diam eget risus varius blandit sit amet non magna.&quot;</span>,
        <span class="st">&quot;Integer posuere erat a ante venenatis dapibus posuere velit aliquet.&quot;</span>,
        <span class="st">&quot;Donec id elit non mi porta gravida at eget metus.&quot;</span>,
        <span class="st">&quot;Lorem ipsum dolor sit amet, consectetur adipiscing elit.&quot;</span>,
        <span class="st">&quot;Cras mattis consectetur purus sit amet fermentum.&quot;</span>,
        <span class="st">&quot;Nulla vitae elit libero, a pharetra augue.&quot;</span>
    ];

    <span class="kw">blogPosts</span>.<span class="fu">add</span>([
        <span class="kw">new</span> Post({
            <span class="dt">title </span>: <span class="st">&quot;Premier Message&quot;</span>, 
            <span class="dt">message </span>: messages[<span class="dv">0</span>], <span class="dt">date </span>: <span class="kw">new</span> <span class="kw">Date</span>(<span class="dv">2012</span>, <span class="dv">10</span>, <span class="dv">23</span>, <span class="dv">7</span>,<span class="dv">4</span>,<span class="dv">0</span>,<span class="dv">0</span>), 
            <span class="dt">author </span>: <span class="st">&quot;bob&quot;</span>
        }),
        <span class="kw">new</span> Post({
            <span class="dt">title </span>: <span class="st">&quot;Backbone ???&quot;</span>, 
            <span class="dt">message </span>: messages[<span class="dv">1</span>], <span class="dt">date </span>: <span class="kw">new</span> <span class="kw">Date</span>(<span class="dv">2012</span>, <span class="dv">10</span>, <span class="dv">23</span>, <span class="dv">7</span>,<span class="dv">5</span>,<span class="dv">0</span>,<span class="dv">0</span>), 
            <span class="dt">author </span>: <span class="st">&quot;bob&quot;</span>
        }),
        <span class="kw">new</span> Post({
            <span class="dt">title </span>: <span class="st">&quot;Les Modèles&quot;</span>, 
            <span class="dt">message </span>: messages[<span class="dv">2</span>], <span class="dt">date </span>: <span class="kw">new</span> <span class="kw">Date</span>(<span class="dv">2012</span>, <span class="dv">10</span>, <span class="dv">23</span>, <span class="dv">7</span>,<span class="dv">6</span>,<span class="dv">0</span>,<span class="dv">0</span>), 
            <span class="dt">author </span>: <span class="st">&quot;sam&quot;</span>
        }),
        <span class="kw">new</span> Post({
            <span class="dt">title </span>: <span class="st">&quot;Les Vues&quot;</span>, 
            <span class="dt">message </span>: messages[<span class="dv">3</span>], <span class="dt">date </span>: <span class="kw">new</span> <span class="kw">Date</span>(<span class="dv">2012</span>, <span class="dv">10</span>, <span class="dv">23</span>, <span class="dv">7</span>,<span class="dv">7</span>,<span class="dv">0</span>,<span class="dv">0</span>), 
            <span class="dt">author </span>: <span class="st">&quot;sam&quot;</span>
        }),
        <span class="kw">new</span> Post({
            <span class="dt">title </span>: <span class="st">&quot;Les Routes&quot;</span>, 
            <span class="dt">message </span>: messages[<span class="dv">4</span>], <span class="dt">date </span>: <span class="kw">new</span> <span class="kw">Date</span>(<span class="dv">2012</span>, <span class="dv">10</span>, <span class="dv">23</span>, <span class="dv">7</span>,<span class="dv">8</span>,<span class="dv">0</span>,<span class="dv">0</span>), 
            <span class="dt">author </span>: <span class="st">&quot;bob&quot;</span>
        }),
        <span class="kw">new</span> Post({
            <span class="dt">title </span>: <span class="st">&quot;Mais où sont les contrôleurs ?&quot;</span>, 
            <span class="dt">message </span>: messages[<span class="dv">5</span>], <span class="dt">date </span>: <span class="kw">new</span> <span class="kw">Date</span>(<span class="dv">2012</span>, <span class="dv">10</span>, <span class="dv">23</span>, <span class="dv">7</span>,<span class="dv">9</span>,<span class="dv">0</span>,<span class="dv">0</span>), 
            <span class="dt">author </span>: <span class="st">&quot;bob&quot;</span>
        })

    ])</code></pre>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : en javascript, pour les dates, le chiffre 10 correspond à Novembre (faire +1)</p>
</blockquote>
</blockquote>
<p>Nous avons donc maintenant 5 Posts dans notre collection. Pour ne pas avoir à tout re-saisir à chaque fois, sauvegardez vos posts (toujours dans la console du navigateur) :</p>
<p><em>Sauvegarder les modèles en base :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">blogPosts</span>.<span class="fu">each</span>(<span class="kw">function</span>(post){
        <span class="kw">post</span>.<span class="fu">save</span>({},{
            <span class="dt">success </span>:  <span class="kw">function</span> (post) {
                <span class="kw">console</span>.<span class="fu">log</span>(<span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>),<span class="st">&quot; sauvegardé&quot;</span>);
            },
            <span class="dt">error </span>: <span class="kw">function</span> () { <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Oupss&quot;</span>); }
        });

    })</code></pre>
<p>Vous devriez au final obtenir ceci :</p>
<p><img src="RSRC/07_01_VIEWS.png" alt="BB" /><br /></p>
<p>Pour vérifier que la sauvegarde a bien fonctionné, raffraichissez votre page et lancez ce code dans la console du navigateur :</p>
<p><em>Charger la collection avec les modèles sauvegardés en base :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">blogPosts</span>.<span class="fu">all</span>()
        .<span class="fu">fetch</span>({
            <span class="dt">success</span>:<span class="kw">function</span>(result){
                <span class="kw">console</span>.<span class="fu">log</span>(result);
            }
    })</code></pre>
<p>Si tout va bien (il n’y a pas de raison), vous devriez obtenir ceci :</p>
<p><img src="RSRC/07_02_VIEWS.png" alt="BB" /><br /></p>
<p>Ainsi, quoiqu’il se passe, vous disposez de tous vos messages et ne serez plus obligés de les ressaisir pour la suite des exercices. Nous pouvons donc entrer dans le vif du sujet.</p>
<h2 id="ère-vue"><a href="#TOC"><span class="header-section-number">8.2</span> 1ère vue</a></h2>
<p>Un objet Vue dans Backbone (<code>Backbone.View</code>) et généralement composé (au minimum) par convention de :</p>
<ul>
<li>une propriété <code>el</code> : c'est l'élément du DOM (la partie de votre page html à laquelle on rattache l'objet <code>View</code>)</li>
<li>une méthode <code>initialize</code> (déclenchée à l’instanciation de la vue)</li>
<li>une méthode <code>render</code> (chargée d’afficher les données liées à la vue)</li>
</ul>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : Libre à vous de vous faire vos propres bonnes pratiques concernant les responsabilités de l’objet View afin de rendre votre code lisible et maintenable … Vous trouverez toujours quelqu’un pour les discuter mais c’est comme cela que l’on apprend et s’améliore … Et vous pouvez aussi avoir raison :-).</p>
</blockquote>
</blockquote>
<p>Dans notre page <code>index.html</code> nous allons ajouter un tag <code>&lt;div id=&quot;posts_list&quot;&gt;&lt;/div&gt;</code> comme ceci :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;hero-unit&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;h1&gt;</span>Backbone rocks !!!<span class="kw">&lt;/h1&gt;</span>
        <span class="kw">&lt;/div&gt;</span>

        <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;posts_list&quot;</span><span class="kw">&gt;&lt;/div&gt;</span>

    <span class="kw">&lt;/div&gt;</span></code></pre>
<p>Et modifier le code javascript de la manière suivante : entre la définition de la collection et son instanciation, ajoutez le code de notre première vue :</p>
<p><em>1ère vue pour afficher le contenu de la collection :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">PostsListView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
        <span class="dt">el </span>: $(<span class="st">&quot;#posts_list&quot;</span>),
        <span class="dt">initialize </span>: <span class="kw">function</span> (data) {
            <span class="kw">this</span>.<span class="fu">collection</span> = data;
        },
        <span class="dt">render </span>: <span class="kw">function</span> () {
            <span class="kw">var</span> html = <span class="st">&quot;&quot;</span>;
            $(<span class="kw">this</span>.<span class="fu">el</span>).<span class="fu">html</span>(<span class="st">&quot;&quot;</span>); <span class="co">//on vide le div</span>
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">each</span>(<span class="kw">function</span>(model) {

                html += [
                    <span class="ch">&#39;&lt;h1&gt;&#39;</span>+<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>)+<span class="ch">&#39;&lt;/h1&gt;&lt;hr&gt;&#39;</span>,
                    <span class="ch">&#39;&lt;b&gt;par : &#39;</span>+<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;author&quot;</span>)+<span class="ch">&#39;&lt;/b&gt; le : &#39;</span>+<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;date&quot;</span>)+<span class="ch">&#39;&lt;br&gt;&#39;</span>,
                    <span class="ch">&#39;&lt;p&gt;&#39;</span>+<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;message&quot;</span>)+<span class="ch">&#39;&lt;/p&gt;&#39;</span>
                ].<span class="fu">join</span>(<span class="st">&quot;&quot;</span>);

            });

            $(<span class="kw">this</span>.<span class="fu">el</span>).<span class="fu">append</span>(html);

        }
    });</code></pre>
<h3 id="explications-utilisation"><a href="#TOC"><span class="header-section-number">8.2.1</span> Explications &amp; utilisation</a></h3>
<p>Notre vue <code>PostsListView</code> est reliée au tag <code>&lt;div id=&quot;posts_list&quot;&gt;&lt;/div&gt;</code> par la propriété <code>el</code> qui n’est ni plus ni moins un objet <strong>jQuery</strong>. La méthode <code>initialize</code> (qui sera appelée à l’instanciation de la vue), prend en paramètre les données que nous souhaitons afficher, et les affecte à la propriété <code>collection</code> de la vue. La méthode <code>render</code>, vide le contenu du tag <code>&lt;div id=&quot;posts_list&quot;&gt;&lt;/div&gt;</code>, parcourt la collection de données pour construire le code html, et enfin affiche celui-ci par la commande <code>$(this.el).append(html)</code>. Mais utilisons directement notre code, ce sera plus « parlant ».</p>
<p>Sauvegardez, rafraichissez la page et en mode console, passez les étapes qui suivent :</p>
<p><em>1] Chargez les données de la collection :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">blogPosts</span>.<span class="fu">all</span>()
        .<span class="fu">fetch</span>({
            <span class="dt">success</span>:<span class="kw">function</span>(result){
                <span class="kw">console</span>.<span class="fu">log</span>(result);
            }
    })</code></pre>
<p><em>2] Instanciez la vue en lui passant la collection en paramètre :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    postsListView = <span class="kw">new</span> PostsListView(blogPosts)</code></pre>
<p><em>3] Appelez la méthode render de la vue :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsListView</span>.<span class="fu">render</span>()</code></pre>
<p>Et vous obtenez la liste de vos messages :</p>
<p><img src="RSRC/07_03_VIEWS.png" alt="BB" /><br /></p>
<p>Souvenez vous, dans les chapitres précédents nous avions « donné » aux collections la possibilité de faire des requêtes sur les données avant de lancer un <code>fetch</code>. Essayez donc ceci dans la console de votre navigateur :</p>
<p><em>Je ne veux que les posts de l’auteur &quot;Sam&quot; :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">blogPosts</span>.<span class="fu">query</span>(<span class="ch">&#39;{&quot;author&quot; : &quot;sam&quot;}&#39;</span>)
        .<span class="fu">fetch</span>({
            <span class="dt">success</span>:<span class="kw">function</span>(result){
                <span class="kw">console</span>.<span class="fu">log</span>(result);
            }
    })</code></pre>
<p>Puis faite à nouveau un :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">postsListView</span>.<span class="fu">render</span>()</code></pre>
<p>Et là, l’affichage s’actualise automatiquement :</p>
<p><img src="RSRC/07_04_VIEWS.png" alt="BB" /><br /></p>
<h2 id="maintenant-un-peu-de-magie-..."><a href="#TOC"><span class="header-section-number">8.3</span> Maintenant, un peu de magie ...</a></h2>
<h3 id="sabonner-aux-événements"><a href="#TOC"><span class="header-section-number">8.3.1</span> S'abonner aux événements</a></h3>
<p>Modifions une nouvelle fois notre vue en ajoutans le code suivant à la méthode <code>initialize</code> :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">_</span>.<span class="fu">bindAll</span>(<span class="kw">this</span>, <span class="ch">&#39;render&#39;</span>);
    <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;reset&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);</code></pre>
<p>Nous venons d’expliquer que tous les évènement déclarés déclencheront la méthode <code>render</code> de la vue. Et ensuite nous avons expliqué que la méthode <code>reset</code> de la collection déclenchera la méthode <code>render</code> de la vue.</p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : Une collection Backbone déclenche un <code>reset</code> lors de l’appel d’un <code>fetch</code>. La méthode <code>reset</code> vide la collection.</p>
</blockquote>
</blockquote>
<pre><code>//TODO: faire un chapitre à part sur `_.bindAll`</code></pre>
<p>Le code de notre vue doit donc ressembler à ceci :</p>
<p><em>PostListView :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">PostsListView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
        <span class="dt">el </span>: $(<span class="st">&quot;#posts_list&quot;</span>),
        <span class="dt">initialize </span>: <span class="kw">function</span> (data) {
            <span class="kw">this</span>.<span class="fu">collection</span> = data;

            <span class="kw">_</span>.<span class="fu">bindAll</span>(<span class="kw">this</span>, <span class="ch">&#39;render&#39;</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;reset&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);

        },
        <span class="dt">render </span>: <span class="kw">function</span> () {
            <span class="kw">var</span> html = <span class="st">&quot;&quot;</span>;
            $(<span class="kw">this</span>.<span class="fu">el</span>).<span class="fu">html</span>(<span class="st">&quot;&quot;</span>); <span class="co">//on vide le div</span>
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">each</span>(<span class="kw">function</span>(model) {

                html += [
                    <span class="ch">&#39;&lt;h1&gt;&#39;</span>+<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>)+<span class="ch">&#39;&lt;/h1&gt;&lt;hr&gt;&#39;</span>,
                    <span class="ch">&#39;&lt;b&gt;par : &#39;</span>+<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;author&quot;</span>)+<span class="ch">&#39;&lt;/b&gt; le : &#39;</span>+<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;date&quot;</span>)+<span class="ch">&#39;&lt;br&gt;&#39;</span>,
                    <span class="ch">&#39;&lt;p&gt;&#39;</span>+<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;message&quot;</span>)+<span class="ch">&#39;&lt;/p&gt;&#39;</span>
                ].<span class="fu">join</span>(<span class="st">&quot;&quot;</span>);

            });

            $(<span class="kw">this</span>.<span class="fu">el</span>).<span class="fu">append</span>(html);

        }
    });</code></pre>
<p>Sauvegardez ensuite la page, puis retournez dans le navigateur, rafraichissez la page et retournez dans la console du navigateur pour instancier une nouvelle vue :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    postsListView = <span class="kw">new</span> PostsListView(blogPosts)</code></pre>
<p>Puis essayez ceci :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">blogPosts</span>.<span class="fu">all</span>()
        .<span class="fu">fetch</span>({
            <span class="dt">success</span>:<span class="kw">function</span>(result){
                <span class="kw">console</span>.<span class="fu">log</span>(result);
            }
    })</code></pre>
<p>et cela :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">blogPosts</span>.<span class="fu">query</span>(<span class="ch">&#39;{&quot;author&quot; : &quot;sam&quot;}&#39;</span>)
        .<span class="fu">fetch</span>({
            <span class="dt">success</span>:<span class="kw">function</span>(result){
                <span class="kw">console</span>.<span class="fu">log</span>(result);
            }
    })</code></pre>
<p>Vous remarquez que votre vue se met à jour automatiquement à chaque changement, sans avoir à rappeler la méthode render de la vue. Mais il est possible de faire ceci aussi avec les changements sur les modèles.</p>
<h3 id="sabonner-à-dautres-évènements-modèles"><a href="#TOC"><span class="header-section-number">8.3.2</span> S’abonner à d’autres évènements (modèles)</a></h3>
<p>Toujours dans la méthode <code>initialize</code> de la vue, ajoutez le code suivant :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;change&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
    <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;add&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
    <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;remove&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);</code></pre>
<p>Maintenant, si vous changez la valeur d'un attribut d'un modèle, que vous ajoutez ou supprimez un modèle de la collection, la vue sera réactualisée à chaque fois.</p>
<p>Sauvegardez la page, puis retournez dans le navigateur, rafraichissez la page et retournez dans la console du navigateur pour instancier une nouvelle vue et charger les données de la collection :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    postsListView = <span class="kw">new</span> PostsListView(blogPosts)
    <span class="kw">blogPosts</span>.<span class="fu">all</span>()
        .<span class="fu">fetch</span>({
            <span class="dt">success</span>:<span class="kw">function</span>(result){
                <span class="kw">console</span>.<span class="fu">log</span>(result);
            }
    })</code></pre>
<p>Puis changez le titre du 1er post :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">blogPosts</span>.<span class="fu">at</span>(<span class="dv">0</span>).<span class="fu">set</span>(<span class="st">&quot;title&quot;</span>,<span class="st">&quot;BACKBONE ???!!!&quot;</span>)</code></pre>
<p>ou ajoutez un post :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">blogPosts</span>.<span class="fu">add</span>(<span class="kw">new</span> Post({<span class="dt">title</span>:<span class="st">&quot;HELLO&quot;</span>,<span class="dt">message </span>: <span class="st">&quot;salut&quot;</span>, <span class="dt">author </span>: <span class="st">&quot;k33g&quot;</span>}))</code></pre>
<p>ou encore supprimez un post :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">blogPosts</span>.<span class="fu">remove</span>(<span class="kw">blogPosts</span>.<span class="fu">at</span>(<span class="dv">0</span>));</code></pre>
<p>Là encore, votre page s’actualise instantanément.</p>
<h3 id="amélioration-finalisation-du-code"><a href="#TOC"><span class="header-section-number">8.3.3</span> Amélioration &amp; Finalisation du code</a></h3>
<p>Avant de passer à l’utilisation des templates dans les vue, nous allons apporter quelques modifications et améliorer un peu notre code pour nous préparer à la suite.</p>
<p>Dans ses dernières versions, Backbone a hérité d’un raccourcis concernant la propriété <code>el</code> de la vue qui consiste à remplacer (avec pour objectif l’optimisation d’exécution de code) le sélecteur <code>$(this.el)</code> par <code>this.$el</code>.</p>
<p>De plus, vous devez savoir qu’il n’est pas obligatoire de déclarer l’affectation de la collection dans la méthode initialize de la vue, mais que l’on peut faire ceci directement en paramètre du constructeur à l’instanciation de la vue. Comme ceci :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">new</span> PostsListView({<span class="dt">collection </span>: blogPosts})</code></pre>
<p>On pourrait faire de même avec <code>el</code>, et utiliser ceci :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">new</span> PostsListView({<span class="dt">el </span>: $(<span class="st">&quot;#posts_list&quot;</span>), <span class="dt">collection </span>: blogPosts})</code></pre>
<p>En fait tout dépend de vos besoins (et de vos habitudes).</p>
<p>En ce qui nous concerne, modifions le code de notre vue de la manière suivante :</p>
<p><em>PostsListView :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">PostsListView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
        <span class="dt">el </span>: $(<span class="st">&quot;#posts_list&quot;</span>),
        <span class="dt">initialize </span>: <span class="kw">function</span> () {

            <span class="kw">_</span>.<span class="fu">bindAll</span>(<span class="kw">this</span>, <span class="ch">&#39;render&#39;</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;reset&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;change&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;add&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;remove&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);

        },
        <span class="dt">render </span>: <span class="kw">function</span> () {
            <span class="kw">var</span> html = <span class="st">&quot;&quot;</span>;
            <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(<span class="st">&quot;&quot;</span>); <span class="co">//on vide le div</span>
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">each</span>(<span class="kw">function</span>(model) {

                html += [
                    <span class="ch">&#39;&lt;h1&gt;&#39;</span>+<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>)+<span class="ch">&#39;&lt;/h1&gt;&lt;hr&gt;&#39;</span>,
                    <span class="ch">&#39;&lt;b&gt;par : &#39;</span>+<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;author&quot;</span>)+<span class="ch">&#39;&lt;/b&gt; le : &#39;</span>+<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;date&quot;</span>)+<span class="ch">&#39;&lt;br&gt;&#39;</span>,
                    <span class="ch">&#39;&lt;p&gt;&#39;</span>+<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;message&quot;</span>)+<span class="ch">&#39;&lt;/p&gt;&#39;</span>
                ].<span class="fu">join</span>(<span class="st">&quot;&quot;</span>);

            });

            <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">append</span>(html);

        }
    });</code></pre>
<p>Puis à la fin du code javascript, ajoutez le code qui instancie la vue, ainsi que le code qui « charge » la collection (on se souvient que le render de la vue sera déclenché automatiquement une fois le <code>fetch</code> de la collection terminé.) :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">postsListView</span> = <span class="kw">new</span> PostsListView({<span class="dt">collection </span>: blogPosts})

    <span class="kw">blogPosts</span>.<span class="fu">all</span>().<span class="fu">fetch</span>({
        <span class="dt">success</span>:<span class="kw">function</span>(result){
            <span class="kw">console</span>.<span class="fu">log</span>(result);
        }
    });</code></pre>
<p>Le code final du script dans la page devrait ressembler à ceci :</p>
<p><em>Code final :</em></p>
<pre class="sourceCode html"><code class="sourceCode html"><span class="co">&lt;!-- === code applicatif === --&gt;</span>
<span class="kw">&lt;script&gt;</span>
    $(<span class="kw">function</span> (){

        <span class="kw">window</span>.<span class="fu">Post</span> = <span class="kw">Backbone.Model</span>.<span class="fu">extend</span>({
            <span class="dt">urlRoot </span>:<span class="st">&quot;</span>/<span class="st">blogposts&quot;</span>

        });

        <span class="kw">window</span>.<span class="fu">Posts</span> = <span class="kw">Backbone.Collection</span>.<span class="fu">extend</span>({
            <span class="dt">model </span>: Post,
            <span class="dt">all </span>: <span class="kw">function</span> () {
                <span class="kw">this</span>.<span class="fu">url</span> = <span class="st">&quot;</span>/<span class="st">blogposts&quot;</span>;
                <span class="kw">return</span> <span class="kw">this</span>;
            },
            <span class="dt">query </span>: <span class="kw">function</span> (query) {
                <span class="kw">this</span>.<span class="fu">url</span> = <span class="st">&quot;</span>/<span class="st">blogposts</span>/<span class="st">query</span>/<span class="st">&quot;</span>+query;
                <span class="kw">return</span> <span class="kw">this</span>;
            }

        });

        <span class="kw">window</span>.<span class="fu">PostsListView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
            <span class="dt">el </span>: $(<span class="st">&quot;</span>#<span class="st">posts</span>_<span class="st">list&quot;</span>),
            <span class="dt">initialize </span>: <span class="kw">function</span> () {

                <span class="kw">_</span>.<span class="fu">bindAll</span>(<span class="kw">this</span>, <span class="ch">&#39;render&#39;</span>);
                <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;reset&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
                <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;change&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
                <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;add&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
                <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;remove&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);

            },
            <span class="dt">render </span>: <span class="kw">function</span> () {
                <span class="kw">var</span> html = <span class="st">&quot;&quot;</span>;
                <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(<span class="st">&quot;&quot;</span>); <span class="co">//on vide le div</span>
                <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">each</span>(<span class="kw">function</span>(model) {

                    html += [
                      <span class="ch">&#39;</span>&lt;<span class="ch">h1</span>&gt;<span class="ch">&#39;</span>+<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>)+<span class="ch">&#39;</span>&lt;/<span class="ch">h1</span>&gt;&lt;<span class="ch">hr</span>&gt;<span class="ch">&#39;</span>,
                      <span class="ch">&#39;</span>&lt;<span class="ch">b</span>&gt;<span class="ch">par</span> : <span class="ch">&#39;</span>+<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;author&quot;</span>)+<span class="ch">&#39;</span>&lt;/<span class="ch">b</span>&gt; <span class="ch">le</span> : <span class="ch">&#39;</span>+<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;date&quot;</span>)+<span class="ch">&#39;</span>&lt;<span class="ch">br</span>&gt;<span class="ch">&#39;</span>,
                      <span class="ch">&#39;</span>&lt;<span class="ch">p</span>&gt;<span class="ch">&#39;</span>+<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;message&quot;</span>)+<span class="ch">&#39;</span>&lt;/<span class="ch">p</span>&gt;<span class="ch">&#39;</span>
                    ].<span class="fu">join</span>(<span class="st">&quot;&quot;</span>);

                });

                <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">append</span>(html);

            }
        });

        <span class="kw">window</span>.<span class="fu">blogPosts</span> = <span class="kw">new</span> Posts();

        <span class="kw">window</span>.<span class="fu">postsListView</span> = <span class="kw">new</span> PostsListView({<span class="dt">collection </span>: blogPosts})

        <span class="kw">blogPosts</span>.<span class="fu">all</span>().<span class="fu">fetch</span>({
            <span class="dt">success</span>:<span class="kw">function</span>(result){
                 <span class="co">//ça marche </span>!!!
<span class="co">            </span>}
<span class="co">        </span>});

<span class="co">    </span>});


<span class="kw">&lt;/script&gt;</span></code></pre>
<p>Nous avons fait un peu de magie, passons donc à la sorcellerie ;) ...</p>
<h2 id="utilisation-du-templating-...-1ère-fois"><a href="#TOC"><span class="header-section-number">8.4</span> Utilisation du templating ... 1ère fois</a></h2>
<p>Vous vous souvenez ? Je vous avez parlé d'underscore avec les templates ? Eh bien il est temps de les mettre en œuvre.</p>
<h3 id="définition-de-notre-1er-template"><a href="#TOC"><span class="header-section-number">8.4.1</span> Définition de notre 1er template</a></h3>
<p>Dans la partie HTML de notre page, juste avant <code>&lt;div id=&quot;posts_list&quot;&gt;&lt;/div&gt;</code>, ajoutez le code ci-dessous (ce sera notre template) :</p>
<pre class="sourceCode html"><code class="sourceCode html"><span class="co">&lt;!-- template pour les posts --&gt;</span>
<span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/template&quot;</span><span class="ot"> id=</span><span class="st">&quot;posts_list_template&quot;</span><span class="kw">&gt;</span>

    &lt;% <span class="kw">_</span>.<span class="fu">each</span>(posts ,<span class="kw">function</span>(post){ %&gt;
        &lt;h1&gt;&lt;%= <span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>) %&gt;&lt;/h1&gt;&lt;hr&gt;
        &lt;b&gt;<span class="dt">par </span>: &lt;%= <span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;author&quot;</span>) %&gt;&lt;/b&gt; <span class="dt">le </span>: &lt;%= <span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;date&quot;</span>) %&gt;&lt;br&gt;
        &lt;p&gt;&lt;%= <span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;message&quot;</span>) %&gt;&lt;/p&gt;
    &lt;% }); %&gt;

<span class="kw">&lt;/script&gt;</span></code></pre>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : le fait de définir le template à l'intérieur de <code>&lt;script type=&quot;text/template&quot;&gt;&lt;/script&gt;</code> fait que le modèle de template ne sera pas affiché dans la page.</p>
</blockquote>
</blockquote>
<p>En fait (grace à underscore), nous venons de définir le template dont la vue backbone va se servir pour afficher les données. Il faudra lui passer pour cela un <strong>tableau</strong> de posts. Modifions donc notre vue de la façon suivante :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">PostsListView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
        <span class="dt">el </span>: $(<span class="st">&quot;#posts_list&quot;</span>),
        <span class="dt">initialize </span>: <span class="kw">function</span> () {
            <span class="kw">this</span>.<span class="fu">template</span> = <span class="kw">_</span>.<span class="fu">template</span>($(<span class="st">&quot;#posts_list_template&quot;</span>).<span class="fu">html</span>());

            <span class="kw">_</span>.<span class="fu">bindAll</span>(<span class="kw">this</span>, <span class="ch">&#39;render&#39;</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;reset&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;change&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;add&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;remove&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);

        },
        <span class="dt">render </span>: <span class="kw">function</span> () {
            <span class="kw">var</span> renderedContent = <span class="kw">this</span>.<span class="fu">template</span>({<span class="dt">posts </span>: <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">models</span>});

            <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(renderedContent);
        }
    });</code></pre>
<p>Nous avons inséré dans la méthode <code>initialize</code> : <code>this.template = _.template($(&quot;#posts_list_template&quot;).html());</code>, où nous expliquons que la définition du template se trouve dans la zone ayant <code>posts_list_template</code> pour <code>id</code>. Nous avons aussi simplifié grandement le contenu de la méthode render, où nous faisons générer le contenu HTML à partir du template et des données.</p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : notez bien que <code>this.collection.models</code> est un tableau de modèles.</p>
</blockquote>
</blockquote>
<p>Vous pouvez sauvegarder et rafraichir, les résultats sont identiques aux précédent, mais il est beaucoup plus facile de créer et modifier vos templates html.</p>
<p><img src="RSRC/07_05_VIEWS.png" alt="BB" /><br /></p>
<h2 id="sous-vues"><a href="#TOC"><span class="header-section-number">8.5</span> Sous-vue(s)</a></h2>
<p>Il est possible de faire des sous vues pour gérer différentes parties de votre page web. En fait il s’agit de vues encapsulées dans une autre vue, ce qui peut être pratique en termes d’organisation, mais aussi dans les cas où les comportements de chacunes des vues dépendent les uns des autres.</p>
<p>Nous allons donc profiter des possibilités de Twitter Bootstrap pour revoir un peu la mise en page de notre « site » et du même coup mettre en œuvre le concept de sous-vue.</p>
<h3 id="réorganisation-du-code-html"><a href="#TOC"><span class="header-section-number">8.5.1</span> Réorganisation du code html</a></h3>
<p>Modifions notre code html de la manière suivante :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar navbar-fixed-top&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-inner&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;a</span><span class="ot"> class=</span><span class="st">&quot;brand&quot;</span><span class="kw">&gt;</span>Mon Blog<span class="kw">&lt;/a&gt;</span>
            <span class="kw">&lt;/div&gt;</span>
        <span class="kw">&lt;/div&gt;</span>
    <span class="kw">&lt;/div&gt;</span>

    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container-fluid&quot;</span><span class="kw">&gt;</span>

        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;row-fluid&quot;</span><span class="kw">&gt;</span>

            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;span3&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/template&quot;</span><span class="ot"> id=</span><span class="st">&quot;blog_sidebar_template&quot;</span><span class="kw">&gt;</span>
                    &lt;h2&gt;Les <span class="dv">3</span> <span class="dt">derniers </span>:&lt;/h2&gt;
                    &lt;ul&gt;
                    &lt;% <span class="kw">_</span>.<span class="fu">each</span>(posts ,<span class="kw">function</span>(post){ %&gt;
                        &lt;li&gt;&lt;%= <span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>) %&gt;&lt;/li&gt;
                    &lt;% }); %&gt;
                    &lt;/ul&gt;
                <span class="kw">&lt;/script&gt;</span>
                <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;sidebar&quot;</span><span class="ot"> id=</span><span class="st">&quot;blog_sidebar&quot;</span><span class="kw">&gt;</span>
                    <span class="co">&lt;!-- Last 3 posts --&gt;</span>
                <span class="kw">&lt;/div&gt;</span>
            <span class="kw">&lt;/div&gt;</span>

            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;span9&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;hero-unit&quot;</span><span class="kw">&gt;</span>
                    <span class="kw">&lt;h1&gt;</span>Backbone rocks !!!<span class="kw">&lt;/h1&gt;</span>
                <span class="kw">&lt;/div&gt;</span>

                <span class="co">&lt;!-- template pour les posts --&gt;</span>
                <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/template&quot;</span><span class="ot"> id=</span><span class="st">&quot;posts_list_template&quot;</span><span class="kw">&gt;</span>

                    &lt;% <span class="kw">_</span>.<span class="fu">each</span>(posts ,<span class="kw">function</span>(post){ %&gt;
                        &lt;h1&gt;&lt;%= <span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>) %&gt;&lt;/h1&gt;&lt;hr&gt;
                        &lt;b&gt;<span class="dt">par </span>: &lt;%= <span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;author&quot;</span>) %&gt;&lt;/b&gt; <span class="dt">le </span>: &lt;%= <span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;date&quot;</span>) %&gt;&lt;br&gt;
                        &lt;p&gt;&lt;%= <span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;message&quot;</span>) %&gt;&lt;/p&gt;
                    &lt;% }); %&gt;

                <span class="kw">&lt;/script&gt;</span>
                <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;row-fluid&quot;</span><span class="ot"> id=</span><span class="st">&quot;posts_list&quot;</span><span class="kw">&gt;&lt;/div&gt;</span>

            <span class="kw">&lt;/div&gt;</span>


        <span class="kw">&lt;/div&gt;</span>

    <span class="kw">&lt;/div&gt;</span></code></pre>
<blockquote>
<blockquote>
<p><strong>Explications</strong> : nous avons donc 2 templates, un pour afficher les 3 derniers posts (<code>id=&quot;blog_sidebar_template&quot;</code>), un pour afficher tous les posts (<code>id=&quot;posts_list_template&quot;</code>).</p>
</blockquote>
</blockquote>
<h3 id="création-modification-des-vues"><a href="#TOC"><span class="header-section-number">8.5.2</span> Création &amp; Modification des vues</a></h3>
<p>Nous allons créer une vue principale (<code>MainView</code>) qui se chargera de &quot;piloter&quot; 2 sous-vues (<code>SidebarView</code> et <code>PostsListView</code>) :</p>
<p><em>1] Simplifions PostsListView :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">PostsListView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
        <span class="dt">el </span>: $(<span class="st">&quot;#posts_list&quot;</span>),
        <span class="dt">initialize </span>: <span class="kw">function</span> () {
            <span class="kw">this</span>.<span class="fu">template</span> = <span class="kw">_</span>.<span class="fu">template</span>($(<span class="st">&quot;#posts_list_template&quot;</span>).<span class="fu">html</span>());
        },
        <span class="dt">render </span>: <span class="kw">function</span> () {
            <span class="kw">var</span> renderedContent = <span class="kw">this</span>.<span class="fu">template</span>({<span class="dt">posts </span>: <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">models</span>});
            <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(renderedContent);
        }
    });</code></pre>
<p><em>2] Création de SidebarView :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">SidebarView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
         <span class="dt">el </span>: $(<span class="st">&quot;#blog_sidebar&quot;</span>),
        <span class="dt">initialize </span>: <span class="kw">function</span> () {
            <span class="kw">this</span>.<span class="fu">template</span> = <span class="kw">_</span>.<span class="fu">template</span>($(<span class="st">&quot;#blog_sidebar_template&quot;</span>).<span class="fu">html</span>());
        },
        <span class="dt">render </span>: <span class="kw">function</span> () {
            <span class="kw">var</span> renderedContent = <span class="kw">this</span>.<span class="fu">template</span>({<span class="dt">posts </span>: <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">models</span>});
            <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(renderedContent);
        }           
    });</code></pre>
<p><em>3] Création de la vue principale :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">MainView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
        <span class="dt">initialize </span>: <span class="kw">function</span> () {

            <span class="kw">_</span>.<span class="fu">bindAll</span>(<span class="kw">this</span>, <span class="ch">&#39;render&#39;</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;reset&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;change&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;add&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;remove&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);

            <span class="kw">this</span>.<span class="fu">sidebarView</span> = <span class="kw">new</span> SidebarView();
            <span class="kw">this</span>.<span class="fu">postsListView</span> = <span class="kw">new</span> PostsListView({<span class="dt">collection </span>: blogPosts});

        },
        <span class="dt">render </span>: <span class="kw">function</span> () {
            <span class="kw">this</span>.<span class="fu">sidebarView</span>.<span class="fu">collection</span> = <span class="kw">new</span> Posts(<span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">first</span>(<span class="dv">3</span>));
            <span class="kw">this</span>.<span class="fu">sidebarView</span>.<span class="fu">render</span>();
            <span class="kw">this</span>.<span class="fu">postsListView</span>.<span class="fu">render</span>();
        }
    });</code></pre>
<p>C'est donc maintenant la vue <code>MainView</code> qui s'abonne aux changements de la collection et déclenche le rendu des 2 autres vues.</p>
<p>Et enfin instancions la collection ainsi que la vue principale (qui se chargera d’instancier les deux sous-vues). Donc à la place de :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">blogPosts</span> = <span class="kw">new</span> Posts();
    <span class="kw">window</span>.<span class="fu">postsListView</span> = <span class="kw">new</span> PostsListView({<span class="dt">collection </span>: blogPosts})</code></pre>
<p><strong>Nous aurons ceci :</strong></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">blogPosts</span> = <span class="kw">new</span> Posts();
    <span class="kw">window</span>.<span class="fu">mainView</span> = <span class="kw">new</span> MainView({<span class="dt">collection </span>: blogPosts});</code></pre>
<p>Vous pouvez sauvegarder votre code et raffraichir votre page :</p>
<p><img src="RSRC/07_06_VIEWS.png" alt="BB" /><br /></p>
<p>Et si vous faites ceci en mode console :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">blogPosts</span>.<span class="fu">at</span>(<span class="dv">0</span>).<span class="fu">set</span>(<span class="st">&quot;title&quot;</span>,<span class="st">&quot;Bonjour à tous !&quot;</span>)</code></pre>
<p>Vous verrez que les modifications sont bien propagées dans les 2 vues simultanément.</p>
<h3 id="un-dernier-petit-réglage-tri-des-collections"><a href="#TOC"><span class="header-section-number">8.5.3</span> Un dernier petit réglage : tri des collections</a></h3>
<p>Nous souhaitons avant d’aller plus loin trier la collection de posts pour avoir les message en ordre décroissant. Pour cela nous allons créer ce que l’on appelle un <strong>« comparator »</strong> dans la méthode <code>initialize</code> de la vue principale <code>MainView</code> :</p>
<p><em>Trier la collection par ordre décroissant de date :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">comparator</span> = <span class="kw">function</span> (model) {
        <span class="kw">return</span> -(<span class="kw">new</span> <span class="kw">Date</span>(<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;date&quot;</span>)).<span class="fu">getTime</span>());
    }</code></pre>
<p>Donc le code final de MainView sera celui-ci :</p>
<p><em>Vue principale :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">MainView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
        <span class="dt">initialize </span>: <span class="kw">function</span> () {

            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">comparator</span> = <span class="kw">function</span> (model) {
                <span class="kw">return</span> -(<span class="kw">new</span> <span class="kw">Date</span>(<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;date&quot;</span>)).<span class="fu">getTime</span>());
            }

            <span class="kw">_</span>.<span class="fu">bindAll</span>(<span class="kw">this</span>, <span class="ch">&#39;render&#39;</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;reset&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;change&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;add&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;remove&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);

            <span class="kw">this</span>.<span class="fu">sidebarView</span> = <span class="kw">new</span> SidebarView();
            <span class="kw">this</span>.<span class="fu">postsListView</span> = <span class="kw">new</span> PostsListView({<span class="dt">collection </span>: <span class="kw">this</span>.<span class="fu">collection</span>});

        },
        <span class="dt">render </span>: <span class="kw">function</span> () {


            <span class="kw">this</span>.<span class="fu">sidebarView</span>.<span class="fu">collection</span> = <span class="kw">new</span> Posts(<span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">first</span>(<span class="dv">3</span>));
            <span class="kw">this</span>.<span class="fu">sidebarView</span>.<span class="fu">render</span>();
            <span class="kw">this</span>.<span class="fu">postsListView</span>.<span class="fu">render</span>();
        }
    });</code></pre>
<p>Et le rendu dans le navigateur devrait vous donner ceci :</p>
<p><img src="RSRC/07_07_VIEWS.png" alt="BB" /><br /></p>
<pre><code>//TODO : faire un paragraphe sur le comparator dans le chapitre sur les collections</code></pre>
<h2 id="utilisation-dautres-moteurs-de-template"><a href="#TOC"><span class="header-section-number">8.6</span> Utilisation d’autre(s) moteur(s) de template</a></h2>
<p>Vous lirez souvent que Backbone est &quot;framwork agnostic&quot;, donc vous pouvez par exemple l'utiliser avec <strong>zepto</strong>, plutôt que <strong>jQuery</strong> en ce qui concerne la gestion du DOM et des appels Ajax. Il en est de même avec le moteur de template. Rien ne vous oblige à utiliser celui d’<strong>Underscore</strong>. Un des plus utilisé est Mustache.js (<a href="http://mustache.github.com/">http://mustache.github.com/</a>). Vous pouvez récupérer le code ici : <a href="https://github.com/janl/mustache.js/">https://github.com/janl/mustache.js/</a>. En fait, plus précisément, enregistrez le fichier <a href="https://raw.github.com/janl/mustache.js/master/mustache.js">https://raw.github.com/janl/mustache.js/master/mustache.js</a> dans votre répertoire <code>public/libs/vendors</code>. Puis faites y référence dans votre page <code>index.html</code> :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    &lt;script src=<span class="st">&quot;libs/vendors/mustache.js&quot;</span>&gt;&lt;/script&gt;</code></pre>
<p>Et nous allons une fois de plus &quot;casser&quot; notre code html.</p>
<h3 id="redéfinissons-donc-nos-templates"><a href="#TOC"><span class="header-section-number">8.6.1</span> Redéfinissons donc nos templates</a></h3>
<p><em>1] Avant pour la partie concernant la vue <code>SidebarView</code> nous avions ceci :</em></p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/template&quot;</span><span class="ot"> id=</span><span class="st">&quot;blog_sidebar_template&quot;</span><span class="kw">&gt;</span>
        &lt;h2&gt;Les <span class="dv">3</span> <span class="dt">derniers </span>:&lt;/h2&gt;
        &lt;ul&gt;
        &lt;% <span class="kw">_</span>.<span class="fu">each</span>(posts ,<span class="kw">function</span>(post){ %&gt;
                &lt;li&gt;&lt;%= <span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>) %&gt;&lt;/li&gt;
        &lt;% }); %&gt;
        &lt;/ul&gt;
    <span class="kw">&lt;/script&gt;</span></code></pre>
<p><em>2] Que vous allez remplacer par ceci :</em></p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/template&quot;</span><span class="ot"> id=</span><span class="st">&quot;blog_sidebar_template&quot;</span><span class="kw">&gt;</span>
        &lt;h2&gt;Les <span class="dv">3</span> <span class="dt">derniers </span>:&lt;/h2&gt;

        &lt;ul&gt;{{#posts}}
            &lt;li&gt;{{title}}&lt;/li&gt;
        {{/posts}}&lt;/ul&gt;

    <span class="kw">&lt;/script&gt;</span></code></pre>
<p><em>3] En ce qui concerne le template lié à la vue PostsListView, remplacez :</em></p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/template&quot;</span><span class="ot"> id=</span><span class="st">&quot;posts_list_template&quot;</span><span class="kw">&gt;</span>

        &lt;% <span class="kw">_</span>.<span class="fu">each</span>(posts ,<span class="kw">function</span>(post){ %&gt;
            &lt;h1&gt;&lt;%= <span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>) %&gt;&lt;/h1&gt;&lt;hr&gt;
            &lt;b&gt;<span class="dt">par </span>: &lt;%= <span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;author&quot;</span>) %&gt;&lt;/b&gt; <span class="dt">le </span>: &lt;%= <span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;date&quot;</span>) %&gt;&lt;br&gt;
            &lt;p&gt;&lt;%= <span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;message&quot;</span>) %&gt;&lt;/p&gt;
        &lt;% }); %&gt;

    <span class="kw">&lt;/script&gt;</span></code></pre>
<p><em>4] Par :</em></p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/template&quot;</span><span class="ot"> id=</span><span class="st">&quot;posts_list_template&quot;</span><span class="kw">&gt;</span>

        {{#posts}}
            &lt;h1&gt;{{title}}&lt;/h1&gt;
            &lt;b&gt;<span class="dt">par </span>: {{author}}&lt;/b&gt; <span class="dt">le </span>: {{date}}&lt;br&gt;
            &lt;p&gt;{{message}}&lt;/p&gt;
        {{/posts}}

    <span class="kw">&lt;/script&gt;</span></code></pre>
<p>Nous obtenons donc des templates html plus lisibles, utilisable moyennant une petite modification de nos vues :</p>
<p><em>5] Avant (avec le moteur de template d’underscore) :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">PostsListView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
        <span class="dt">el </span>: $(<span class="st">&quot;#posts_list&quot;</span>),
        <span class="dt">initialize </span>: <span class="kw">function</span> () {
            <span class="kw">this</span>.<span class="fu">template</span> = <span class="kw">_</span>.<span class="fu">template</span>($(<span class="st">&quot;#posts_list_template&quot;</span>).<span class="fu">html</span>());
        },
        <span class="dt">render </span>: <span class="kw">function</span> () {
            <span class="kw">var</span> renderedContent = <span class="kw">this</span>.<span class="fu">template</span>({<span class="dt">posts </span>: <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">models</span>});
            <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(renderedContent);
        }
    });

    <span class="kw">window</span>.<span class="fu">SidebarView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
         <span class="dt">el </span>: $(<span class="st">&quot;#blog_sidebar&quot;</span>),
        <span class="dt">initialize </span>: <span class="kw">function</span> () {
            <span class="kw">this</span>.<span class="fu">template</span> = <span class="kw">_</span>.<span class="fu">template</span>($(<span class="st">&quot;#blog_sidebar_template&quot;</span>).<span class="fu">html</span>());
        },
        <span class="dt">render </span>: <span class="kw">function</span> () {
            <span class="kw">var</span> renderedContent = <span class="kw">this</span>.<span class="fu">template</span>({<span class="dt">posts </span>: <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">models</span>});
            <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(renderedContent);
        }           
    });</code></pre>
<p><em>6] Après (en utilisant Mustache) nous aurons ceci :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">PostsListView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
        <span class="dt">el </span>: $(<span class="st">&quot;#posts_list&quot;</span>),
        <span class="dt">initialize </span>: <span class="kw">function</span> () {
            <span class="kw">this</span>.<span class="fu">template</span> = $(<span class="st">&quot;#posts_list_template&quot;</span>).<span class="fu">html</span>();
        },
        <span class="dt">render </span>: <span class="kw">function</span> () {
            <span class="kw">var</span> renderedContent = <span class="kw">Mustache</span>.<span class="fu">to</span>_<span class="fu">html</span>(
                <span class="kw">this</span>.<span class="fu">template</span>, 
                {<span class="dt">posts </span>: <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">toJSON</span>()} 
            );

            <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(renderedContent);
        }
    });

    <span class="kw">window</span>.<span class="fu">SidebarView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
         <span class="dt">el </span>: $(<span class="st">&quot;#blog_sidebar&quot;</span>),
        <span class="dt">initialize </span>: <span class="kw">function</span> () {
            <span class="kw">this</span>.<span class="fu">template</span> = $(<span class="st">&quot;#blog_sidebar_template&quot;</span>).<span class="fu">html</span>();
        },
        <span class="dt">render </span>: <span class="kw">function</span> () {
            <span class="kw">var</span> renderedContent = <span class="kw">Mustache</span>.<span class="fu">to</span>_<span class="fu">html</span>(
                <span class="kw">this</span>.<span class="fu">template</span>, 
                {<span class="dt">posts </span>: <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">toJSON</span>()} 
            );

            <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(renderedContent);
        }           
    });</code></pre>
<p>Vous noterez l'utilisation de <code>this.collection.toJSON()</code> plutôt que <code>this.collection.models</code>. En effet Mustache a besoin d’objets au format JSON, et (cela tombe bien), les collections Backbone dispose d’une méthode d’exportation/mise en forme au format JSON.</p>
<p>Sauvegardez, lancez, il n’y a pas de changement, l'affichages est identique (heureusement), vous avez juste utilisé une autre façon de travailler.</p>
<h2 id="gestion-des-événements-dans-les-vues"><a href="#TOC"><span class="header-section-number">8.7</span> Gestion des événements dans les vues</a></h2>
<p>Les objets de type Backbone.View peuvent aussi gérer les évènements (mouseover, click, etc. …). Nous allons donc profiter de ce paragraphe pour mettre en œuvre un système d’authentification dans notre application, qui utilisera donc cette possibilité. Il est temps de retourner travailler côté serveur quelques instants.</p>
<p>Si vous voulez en savoir plus sur les événements dans les vues Backbone, je vous engage fortement à lire la documentation : <a href="http://backbonejs.org/#View-delegateEvents">http://backbonejs.org/#View-delegateEvents</a>.</p>
<p>Donc ...</p>
<h2 id="authentification-côté-serveur-les-utilisateurs"><a href="#TOC"><span class="header-section-number">8.8</span> Authentification (côté serveur) : les utilisateurs</a></h2>
<blockquote>
<blockquote>
<p><em>Ce paragraphe ne parle pas des vues, mais est nécessaire pour la mise en place des paragraphes suivants.</em></p>
</blockquote>
</blockquote>
<p>Nous aurons besoin d’une liste des utilisateurs connectés (je vous le rappelle, nous sommes côté serveur, donc dans le fichier <code>app.js</code>) que nous représenterons sous la forme d’un tableau de variables (ou d’objets) :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> connectedUsers = [];</code></pre>
<p>Nous aurons besoin d’ajouter des utilisateurs dans notre base de données, donc nous allons nous créer de quoi rajouter au moins une fois quelques utilisateurs pour notre application :</p>
<p><em>Ajouter un utilisateur en base :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">function</span> addUser (user) {
        <span class="kw">users</span>.<span class="fu">save</span>(null,user, <span class="kw">function</span> (err, key){
            <span class="kw">if</span>(err) { 
                <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
            } <span class="kw">else</span> {
                <span class="kw">user</span>.<span class="fu">id</span> = key;
                <span class="kw">console</span>.<span class="fu">log</span>(user);
            }
        });    
    }</code></pre>
<p>Nous appellerons n fois cette fonctions pour ajouter des utilisateurs :</p>
<p><em>Ajouter des utilisateurs :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">function</span> addUsers () {
    addUser({
        <span class="dt">email </span>: <span class="st">&quot;bob@morane.com&quot;</span>,
        <span class="dt">password </span>: <span class="st">&quot;backbone&quot;</span>,
        <span class="dt">isAdmin </span>: <span class="kw">true</span>,
        <span class="dt">firstName </span>: <span class="st">&quot;Bob&quot;</span>,
        <span class="dt">lastName </span>: <span class="st">&quot;Morane&quot;</span>
    });
    addUser({
        <span class="dt">email </span>: <span class="st">&quot;sam@lepirate.com&quot;</span>,
        <span class="dt">password </span>: <span class="st">&quot;underscore&quot;</span>,
        <span class="dt">isAdmin </span>: <span class="kw">false</span>,
        <span class="dt">firstName </span>: <span class="st">&quot;Sam&quot;</span>,
        <span class="dt">lastName </span>: <span class="st">&quot;Le Pirate&quot;</span>
    });

    <span class="co">//etc. ...</span>
}</code></pre>
<p>Et pour déclencher l’ajout des utilisateurs, nous créeons une « route » <code>addusers</code> :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">app</span>.<span class="fu">get</span>(<span class="ch">&#39;/addusers&#39;</span>,<span class="kw">function</span>(req, res){
        addUsers();
        <span class="kw">res</span>.<span class="fu">json</span>({<span class="dt">MESSAGE</span>:<span class="st">&quot;Users added.&quot;</span>});
    });</code></pre>
<p>Qu’il suffira d’appeler comme ceci dans le navigateur : <a href="http://localhost:3000/addusers/">http://localhost:3000/addusers/</a></p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : notez bien que mon système d’authentification est très « léger ». En production, il vous faudrait quelque chose de plus abouti, mais ce n’est pas le propos de cet ouvrage. Nous avions besoin de quelque chose de simple.</p>
</blockquote>
</blockquote>
<h3 id="sauthentifier-se-déconnecter"><a href="#TOC"><span class="header-section-number">8.8.1</span> S’authentifier – Se déconnecter</a></h3>
<p>Nous aurons besoin de nous authentifier. Il nous faut donc d’abord une fonction « utilitaire » qui nous permette de vérifier si l’email de l’utilisateur n’est pas déjà pris (utilisateur déjà connecté sous une autre session) :</p>
<p><em>Vérifier si un utilisateur est déjà connecté :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">function</span> findUserByMail (email) {
        <span class="co">/*</span>
<span class="co">            Permet de vérifier si un utilisateur est déjà loggé</span>
<span class="co">        */</span>
        <span class="kw">return</span> <span class="kw">connectedUsers</span>.<span class="fu">filter</span>(<span class="kw">function</span>(user) {
            <span class="kw">return</span> <span class="kw">user</span>.<span class="fu">email</span> == email;
        })[<span class="dv">0</span>];    
    }</code></pre>
<p>Nous allons donc créer une route <code>authenticate</code> avec le code suivant :</p>
<p><em>Code pour s’authentifier :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">app</span>.<span class="fu">post</span>(<span class="ch">&#39;/authenticate&#39;</span>,<span class="kw">function</span>(req, res){
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;POST authenticate &quot;</span>, <span class="kw">req</span>.<span class="fu">body</span>);
        <span class="co">//Je récupère les information de connexion de l&#39;utilisateur</span>
        <span class="kw">var</span> user = <span class="kw">req</span>.<span class="fu">body</span>;

        <span class="co">//est ce que l&#39;email est déjà utilisé ?</span>
        <span class="kw">if</span>(findUserByMail(<span class="kw">user</span>.<span class="fu">email</span>)) {
            <span class="kw">res</span>.<span class="fu">json</span>({<span class="dt">infos</span>:<span class="st">&quot;Utilisateur déjà connecté&quot;</span>})
        } <span class="kw">else</span> { <span class="co">//si l&#39;email n&#39;est pas utilisé</span>
        <span class="co">//Je cherche l&#39;utilisateur dans la base de données</span>
            <span class="kw">users</span>.<span class="fu">find</span>({<span class="dt">email</span>: <span class="kw">user</span>.<span class="fu">email</span>, <span class="dt">password</span>: <span class="kw">user</span>.<span class="fu">password</span> }, 
              <span class="kw">function</span>(err, results) {
                <span class="kw">if</span>(err) {
                    <span class="kw">res</span>.<span class="fu">json</span>({<span class="dt">error</span>:<span class="st">&quot;Oups, Houson, on a un problème&quot;</span>}); 
                } <span class="kw">else</span> {
                    <span class="co">//J&#39;ai trouvé l&#39;utilisateur</span>
                    <span class="kw">var</span> key = <span class="kw">Object</span>.<span class="fu">keys</span>(results)[<span class="dv">0</span>]
                    ,   authenticatedUser = results[key];

                    <span class="co">//Je rajoute l&#39;id de session à l&#39;objet utilisateur</span>

                    <span class="kw">authenticatedUser</span>.<span class="fu">key</span> = key;
                    <span class="kw">authenticatedUser</span>.<span class="fu">sessionID</span> = <span class="kw">req</span>.<span class="fu">sessionID</span>;

                    <span class="co">//Ajouter l&#39;utilisateur authentifié à la liste des utilisateurs connectés</span>
                    <span class="kw">connectedUsers</span>.<span class="fu">push</span>(authenticatedUser);

                    <span class="co">//Je renvoie au navigateur les informations de l&#39;utilisateur</span>
                    <span class="co">// ... sans le mot de passe bien sûr</span>
                    <span class="kw">res</span>.<span class="fu">json</span>({
                        <span class="dt">email</span>:<span class="kw">authenticatedUser</span>.<span class="fu">email</span>,
                        <span class="dt">firstName </span>: <span class="kw">authenticatedUser</span>.<span class="fu">firstName</span>,
                        <span class="dt">lastName </span>: <span class="kw">authenticatedUser</span>.<span class="fu">lastName</span>,
                        <span class="dt">isAdmin </span>: <span class="kw">authenticatedUser</span>.<span class="fu">isAdmin</span>
                    });
                }
            });   
        }

    });</code></pre>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : La « bienséance » (d’un point de vue architecture) voudrait que ne mette pas tout ce code au niveau de la route mais dans la méthode d’un contrôleur qui serait appelée par la route. Une fois de plus je vais au plus court, mais gardez à l’esprit : toujours un code lisible et maintenable.</p>
</blockquote>
</blockquote>
<p>Il faudra aussi pouvoir se déconnecter. Nous ajoutons donc une route <code>logoff</code> qui nous permettra de déconnecter l’utilisateur.</p>
<p>Nous avons tout d’abord besoin d’une fonction nous permettant de retrouver un utilisateur par son id de session parmi les utilisateurs connectés :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">function</span> findUserBySession (sessionID) {
        <span class="co">/*</span>
<span class="co">            Permet de retrouver un utilisateur par son id de session</span>
<span class="co">        */</span>
        <span class="kw">return</span> <span class="kw">connectedUsers</span>.<span class="fu">filter</span>(<span class="kw">function</span>(user) {
            <span class="kw">return</span> <span class="kw">user</span>.<span class="fu">sessionID</span> == sessionID;
        })[<span class="dv">0</span>];

    }</code></pre>
<p>Que nous allons utiliser ensuite dans notre route <code>logoff</code> :</p>
<p><em>Se déconnecter :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">app</span>.<span class="fu">get</span>(<span class="ch">&#39;/logoff&#39;</span>,<span class="kw">function</span>(req, res){

        <span class="co">//Je recherche l&#39;utilisateur courant parmi les utilisateurs connectés</span>
        <span class="kw">var</span> alreadyAuthenticatedUser = findUserBySession(<span class="kw">req</span>.<span class="fu">sessionID</span>);

        <span class="kw">if</span>(alreadyAuthenticatedUser) {
            <span class="co">//Je l&#39;ai trouvé, je le supprime de la liste des utilisateurs connectés</span>
            <span class="kw">var</span> posInArray = <span class="kw">connectedUsers</span>.<span class="fu">indexOf</span>(alreadyAuthenticatedUser);
            <span class="kw">connectedUsers</span>.<span class="fu">splice</span>(posInArray, <span class="dv">1</span>);
            <span class="kw">res</span>.<span class="fu">json</span>({<span class="dt">state</span>:<span class="st">&quot;disconnected&quot;</span>});
        } <span class="kw">else</span> {
            <span class="kw">res</span>.<span class="fu">json</span>({});
        }

    });</code></pre>
<p>Nous aurons aussi besoin d’un moyen pour savoir (côté client) si un utilisateur est déjà connecté. Donc nous allons créer une route <code>alreadyauthenticated</code> que la page web pourra « appeler » pour vérification (par exemple au rechargement de la page) :</p>
<p><em>Est-ce que je suis déjà authentifié ?</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">app</span>.<span class="fu">get</span>(<span class="ch">&#39;/alreadyauthenticated&#39;</span>,<span class="kw">function</span>(req, res){

        <span class="kw">var</span> alreadyAuthenticatedUser = findUserBySession(<span class="kw">req</span>.<span class="fu">sessionID</span>);

        <span class="co">//Si je suis déjà authentifié, renvoyer les informations utilisateur</span>
        <span class="kw">if</span>(alreadyAuthenticatedUser) {
            <span class="kw">res</span>.<span class="fu">json</span>({
                <span class="dt">email</span>:<span class="kw">alreadyAuthenticatedUser</span>.<span class="fu">email</span>,
                <span class="dt">firstName </span>: <span class="kw">alreadyAuthenticatedUser</span>.<span class="fu">firstName</span>,
                <span class="dt">lastName </span>: <span class="kw">alreadyAuthenticatedUser</span>.<span class="fu">lastName</span>,
                <span class="dt">isAdmin </span>: <span class="kw">alreadyAuthenticatedUser</span>.<span class="fu">isAdmin</span>
            });
        } <span class="kw">else</span> {
            <span class="kw">res</span>.<span class="fu">json</span>({});
        }

    });</code></pre>
<p>Nous somme maintenant prêts à utiliser tout cela côté client. Le code définitif de <code>app.js</code> devrait ressembler à ceci :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="co">/*--------------------------------------------</span>
<span class="co">        Déclaration des librairies</span>
<span class="co">    --------------------------------------------*/</span>
    <span class="kw">var</span> express = require(<span class="ch">&#39;express&#39;</span>)
        , nStore = require(<span class="ch">&#39;nstore&#39;</span>)
        , app = <span class="kw">module</span>.<span class="fu">exports</span> = <span class="kw">express</span>.<span class="fu">createServer</span>();

    nStore = <span class="kw">nStore</span>.<span class="fu">extend</span>(require(<span class="ch">&#39;nstore/query&#39;</span>)());

    <span class="co">/*--------------------------------------------</span>
<span class="co">        Paramétrages de fonctionnement d&#39;Express</span>
<span class="co">    --------------------------------------------*/</span>
    <span class="kw">app</span>.<span class="fu">use</span>(<span class="kw">express</span>.<span class="fu">bodyParser</span>());
    <span class="kw">app</span>.<span class="fu">use</span>(<span class="kw">express</span>.<span class="fu">methodOverride</span>());
    <span class="kw">app</span>.<span class="fu">use</span>(<span class="kw">express</span>.<span class="fu">static</span>(__dirname + <span class="ch">&#39;/public&#39;</span>));
    <span class="kw">app</span>.<span class="fu">use</span>(<span class="kw">express</span>.<span class="fu">cookieParser</span>(<span class="ch">&#39;ilovebackbone&#39;</span>));
    <span class="kw">app</span>.<span class="fu">use</span>(<span class="kw">express</span>.<span class="fu">session</span>({ <span class="dt">secret</span>: <span class="st">&quot;ilovebackbone&quot;</span> }));

    <span class="co">/*--------------------------------------------</span>
<span class="co">        Définition des &quot;bases&quot; posts &amp; users</span>
<span class="co">    --------------------------------------------*/</span>
    <span class="kw">var</span> posts, users;

    posts = <span class="kw">nStore</span>.<span class="fu">new</span>(<span class="st">&quot;blog.db&quot;</span>, <span class="kw">function</span>() {
        users = <span class="kw">nStore</span>.<span class="fu">new</span>(<span class="st">&quot;users.db&quot;</span>, <span class="kw">function</span>() {
            Routes();
            <span class="kw">app</span>.<span class="fu">listen</span>(<span class="dv">3000</span>);
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="ch">&#39;Express app started on port 3000&#39;</span>);

        });
    });


    <span class="co">/*======= Authentification =======*/</span>

    <span class="kw">var</span> connectedUsers = [];

    <span class="kw">function</span> addUser (user) {
        <span class="kw">users</span>.<span class="fu">save</span>(null,user, <span class="kw">function</span> (err, key){
            <span class="kw">if</span>(err) { 
                <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
            } <span class="kw">else</span> {
                <span class="kw">user</span>.<span class="fu">id</span> = key;
                <span class="kw">console</span>.<span class="fu">log</span>(user);
            }
        });    
    }

    <span class="kw">function</span> addUsers () {
        addUser({
            <span class="dt">email </span>: <span class="st">&quot;bob@morane.com&quot;</span>,
            <span class="dt">password </span>: <span class="st">&quot;backbone&quot;</span>,
            <span class="dt">isAdmin </span>: <span class="kw">true</span>,
            <span class="dt">firstName </span>: <span class="st">&quot;Bob&quot;</span>,
            <span class="dt">lastName </span>: <span class="st">&quot;Morane&quot;</span>
        });
        addUser({
            <span class="dt">email </span>: <span class="st">&quot;sam@lepirate.com&quot;</span>,
            <span class="dt">password </span>: <span class="st">&quot;underscore&quot;</span>,
            <span class="dt">isAdmin </span>: <span class="kw">false</span>,
            <span class="dt">firstName </span>: <span class="st">&quot;Sam&quot;</span>,
            <span class="dt">lastName </span>: <span class="st">&quot;Le Pirate&quot;</span>
        });

        <span class="co">//etc. ...</span>
    }

    <span class="kw">function</span> findUserBySession (sessionID) {
        <span class="co">/*</span>
<span class="co">            Permet de retrouver un utilisateur par son id de session</span>
<span class="co">        */</span>
        <span class="kw">return</span> <span class="kw">connectedUsers</span>.<span class="fu">filter</span>(<span class="kw">function</span>(user) {
            <span class="kw">return</span> <span class="kw">user</span>.<span class="fu">sessionID</span> == sessionID;
        })[<span class="dv">0</span>];

    }

    <span class="kw">function</span> findUserByMail (email) {
        <span class="co">/*</span>
<span class="co">            Permet de vérifier si un utilisateur est déjà loggé</span>
<span class="co">        */</span>
        <span class="kw">return</span> <span class="kw">connectedUsers</span>.<span class="fu">filter</span>(<span class="kw">function</span>(user) {
            <span class="kw">return</span> <span class="kw">user</span>.<span class="fu">email</span> == email;
        })[<span class="dv">0</span>];    
    }


    <span class="kw">function</span> Routes() {
        <span class="co">/*======= Routes pour authentification =======*/</span>

        <span class="kw">app</span>.<span class="fu">get</span>(<span class="ch">&#39;/addusers&#39;</span>,<span class="kw">function</span>(req, res){
            addUsers();
            <span class="kw">res</span>.<span class="fu">json</span>({<span class="dt">MESSAGE</span>:<span class="st">&quot;Users added.&quot;</span>});
        });

        <span class="kw">app</span>.<span class="fu">get</span>(<span class="ch">&#39;/alreadyauthenticated&#39;</span>,<span class="kw">function</span>(req, res){

            <span class="kw">var</span> alreadyAuthenticatedUser = findUserBySession(<span class="kw">req</span>.<span class="fu">sessionID</span>);

            <span class="co">/*  Si je suis déjà authentifié, </span>
<span class="co">                renvoyer les informations utilisateur</span>
<span class="co">                sans le mot de passe bien sûr</span>
<span class="co">            */</span>
            <span class="kw">if</span>(alreadyAuthenticatedUser) {
                <span class="kw">res</span>.<span class="fu">json</span>({
                    <span class="dt">email</span>:<span class="kw">alreadyAuthenticatedUser</span>.<span class="fu">email</span>,
                    <span class="dt">firstName </span>: <span class="kw">alreadyAuthenticatedUser</span>.<span class="fu">firstName</span>,
                    <span class="dt">lastName </span>: <span class="kw">alreadyAuthenticatedUser</span>.<span class="fu">lastName</span>,
                    <span class="dt">isAdmin </span>: <span class="kw">alreadyAuthenticatedUser</span>.<span class="fu">isAdmin</span>
                });
            } <span class="kw">else</span> {
                <span class="kw">res</span>.<span class="fu">json</span>({});
            }

        });

        <span class="kw">app</span>.<span class="fu">post</span>(<span class="ch">&#39;/authenticate&#39;</span>,<span class="kw">function</span>(req, res){
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;POST authenticate &quot;</span>, <span class="kw">req</span>.<span class="fu">body</span>);
            <span class="co">//Je récupère les information de connexion de l&#39;utilisateur</span>
            <span class="kw">var</span> user = <span class="kw">req</span>.<span class="fu">body</span>;

            <span class="co">//est ce que l&#39;email est déjà utilisé ?</span>
            <span class="kw">if</span>(findUserByMail(<span class="kw">user</span>.<span class="fu">email</span>)) {
                <span class="kw">res</span>.<span class="fu">json</span>({<span class="dt">infos</span>:<span class="st">&quot;Utilisateur déjà connecté&quot;</span>})
            } <span class="kw">else</span> { <span class="co">//si l&#39;email n&#39;est pas utilisé</span>
            <span class="co">//Je cherche l&#39;utilisateur dans la base de données</span>
                <span class="kw">users</span>.<span class="fu">find</span>({<span class="dt">email</span>: <span class="kw">user</span>.<span class="fu">email</span>, <span class="dt">password</span>: <span class="kw">user</span>.<span class="fu">password</span> }, <span class="kw">function</span>(err, results) {
                    <span class="kw">if</span>(err) {
                        <span class="kw">res</span>.<span class="fu">json</span>({<span class="dt">error</span>:<span class="st">&quot;Oups, Houson, on a un problème&quot;</span>}); 
                    } <span class="kw">else</span> {
                        <span class="co">//J&#39;ai trouvé l&#39;utilisateur</span>
                        <span class="kw">var</span> key = <span class="kw">Object</span>.<span class="fu">keys</span>(results)[<span class="dv">0</span>]
                        ,   authenticatedUser = results[key];

                        <span class="co">//Je rajoute l&#39;id de session à l&#39;objet utilisateur</span>

                        <span class="kw">authenticatedUser</span>.<span class="fu">key</span> = key;
                        <span class="kw">authenticatedUser</span>.<span class="fu">sessionID</span> = <span class="kw">req</span>.<span class="fu">sessionID</span>;

                        <span class="co">//J&#39;ajoute l&#39;utilisateur authentifié à la liste des utilisateurs connectés</span>
                        <span class="kw">connectedUsers</span>.<span class="fu">push</span>(authenticatedUser);

                        <span class="co">//Je renvoie au navigateur les informations de l&#39;utilisateur</span>
                        <span class="co">// ... sans le mot de passe bien sûr</span>
                        <span class="kw">res</span>.<span class="fu">json</span>({
                            <span class="dt">email</span>:<span class="kw">authenticatedUser</span>.<span class="fu">email</span>,
                            <span class="dt">firstName </span>: <span class="kw">authenticatedUser</span>.<span class="fu">firstName</span>,
                            <span class="dt">lastName </span>: <span class="kw">authenticatedUser</span>.<span class="fu">lastName</span>,
                            <span class="dt">isAdmin </span>: <span class="kw">authenticatedUser</span>.<span class="fu">isAdmin</span>
                        });
                    }
                });   
            }

        });

        <span class="kw">app</span>.<span class="fu">get</span>(<span class="ch">&#39;/logoff&#39;</span>,<span class="kw">function</span>(req, res){

            <span class="co">//Je recherche l&#39;utilisateur courant parmi les utilisateurs connectés</span>
            <span class="kw">var</span> alreadyAuthenticatedUser = findUserBySession(<span class="kw">req</span>.<span class="fu">sessionID</span>);

            <span class="kw">if</span>(alreadyAuthenticatedUser) {
                <span class="co">//Je l&#39;ai trouvé, je le supprime de la liste des utilisateurs connectés</span>
                <span class="kw">var</span> posInArray = <span class="kw">connectedUsers</span>.<span class="fu">indexOf</span>(alreadyAuthenticatedUser);
                <span class="kw">connectedUsers</span>.<span class="fu">splice</span>(posInArray, <span class="dv">1</span>);
                <span class="kw">res</span>.<span class="fu">json</span>({<span class="dt">state</span>:<span class="st">&quot;disconnected&quot;</span>});
            } <span class="kw">else</span> {
                <span class="kw">res</span>.<span class="fu">json</span>({});
            }

        });

        <span class="co">/*======= Fin des routes &quot;authentification&quot; =======*/</span>

        <span class="co">/*</span>
<span class="co">            Obtenir la liste de tous les posts lorsque</span>
<span class="co">            l&#39;on appelle http://localhost:3000/blogposts</span>
<span class="co">            en mode GET</span>
<span class="co">        */</span>
        <span class="kw">app</span>.<span class="fu">get</span>(<span class="ch">&#39;/blogposts&#39;</span>,<span class="kw">function</span>(req, res){
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;GET (ALL) : /blogposts&quot;</span>);
            <span class="kw">posts</span>.<span class="fu">all</span>(<span class="kw">function</span>(err, results) {

                <span class="kw">if</span>(err) { 
                    <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
                    <span class="kw">res</span>.<span class="fu">json</span>(err); 
                } <span class="kw">else</span> {
                    <span class="kw">var</span> posts = [];
                    <span class="kw">for</span>(<span class="kw">var</span> key <span class="kw">in</span> results) {
                        <span class="kw">var</span> post = results[key]; <span class="kw">post</span>.<span class="fu">id</span> = key;
                        <span class="kw">posts</span>.<span class="fu">push</span>(post);
                    }
                    <span class="kw">res</span>.<span class="fu">json</span>(posts);
                }
            });

        });

        <span class="co">/*</span>
<span class="co">            Obtenir la liste de tous les posts correspondant à un critère</span>
<span class="co">            lorsque l&#39;on appelle http://localhost:3000/blogposts/ en</span>
<span class="co">            mode GET avec une requête en paramètre</span>
<span class="co">            ex : query : { &quot;title&quot; : &quot;Mon 1er post&quot;} }</span>
<span class="co">        */</span>
        <span class="kw">app</span>.<span class="fu">get</span>(<span class="ch">&#39;/blogposts/:query&#39;</span>,<span class="kw">function</span>(req, res){
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;GET (QUERY) : /blogposts/&quot;</span>+<span class="kw">req.params</span>.<span class="fu">query</span>);

            <span class="kw">posts</span>.<span class="fu">find</span>(<span class="kw">JSON</span>.<span class="fu">parse</span>(<span class="kw">req.params</span>.<span class="fu">query</span>), <span class="kw">function</span>(err, results) {
                <span class="kw">if</span>(err) {
                    <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
                    <span class="kw">res</span>.<span class="fu">json</span>(err); 
                } <span class="kw">else</span> {
                    <span class="kw">var</span> posts = [];
                    <span class="kw">for</span>(<span class="kw">var</span> key <span class="kw">in</span> results) {
                        <span class="kw">var</span> post = results[key]; <span class="kw">post</span>.<span class="fu">id</span> = key;
                        <span class="kw">posts</span>.<span class="fu">push</span>(post);
                    }
                    <span class="kw">res</span>.<span class="fu">json</span>(posts);
                }
            });

        });

        <span class="co">/*</span>
<span class="co">            Retrouver un post par sa clé unique lorsque</span>
<span class="co">            l&#39;on appelle http://localhost:3000/blogpost/identifiant_du_post</span>
<span class="co">            en mode GET</span>
<span class="co">        */</span>

        <span class="kw">app</span>.<span class="fu">get</span>(<span class="ch">&#39;/blogpost/:id&#39;</span>, <span class="kw">function</span>(req, res){
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;GET : /blogpost/&quot;</span>+<span class="kw">req.params</span>.<span class="fu">id</span>);
            <span class="kw">posts</span>.<span class="fu">get</span>(<span class="kw">req.params</span>.<span class="fu">id</span>, <span class="kw">function</span>(err, post, key) {
                <span class="kw">if</span>(err) {
                    <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
                    <span class="kw">res</span>.<span class="fu">json</span>(err);

                } <span class="kw">else</span> {
                    <span class="kw">post</span>.<span class="fu">id</span> = key;
                    <span class="kw">res</span>.<span class="fu">json</span>(post);
                }
            });
        });

        <span class="co">/*</span>
<span class="co">            Créer un nouveau post lorsque</span>
<span class="co">            l&#39;on appelle http://localhost:3000/blogpost</span>
<span class="co">            avec en paramètre le post au format JSON</span>
<span class="co">            en mode POST</span>
<span class="co">        */</span>
        <span class="kw">app</span>.<span class="fu">post</span>(<span class="ch">&#39;/blogpost&#39;</span>,<span class="kw">function</span>(req, res){
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;POST CREATE &quot;</span>, <span class="kw">req</span>.<span class="fu">body</span>);

            <span class="kw">var</span> d = <span class="kw">new</span> <span class="kw">Date</span>(), model = <span class="kw">req</span>.<span class="fu">body</span>;
            <span class="kw">model</span>.<span class="fu">saveDate</span> = (<span class="kw">d</span>.<span class="fu">valueOf</span>());

            <span class="kw">posts</span>.<span class="fu">save</span>(null,model, <span class="kw">function</span> (err, key){
                <span class="kw">if</span>(err) { 
                    <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
                    <span class="kw">res</span>.<span class="fu">json</span>(err); 
                } <span class="kw">else</span> {
                    <span class="kw">model</span>.<span class="fu">id</span> = key;
                    <span class="kw">res</span>.<span class="fu">json</span>(model);
                }
            });
        });


        <span class="co">/*</span>
<span class="co">            Mettre à jour un post lorsque</span>
<span class="co">            l&#39;on appelle http://localhost:3000/blogpost</span>
<span class="co">            avec en paramètre le post au format JSON</span>
<span class="co">            en mode PUT</span>
<span class="co">        */</span>
        <span class="kw">app</span>.<span class="fu">put</span>(<span class="ch">&#39;/blogpost/:id&#39;</span>,<span class="kw">function</span>(req, res){
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;PUT UPDATE&quot;</span>, <span class="kw">req</span>.<span class="fu">body</span>, <span class="kw">req.params</span>.<span class="fu">id</span>);

            <span class="kw">var</span> d = <span class="kw">new</span> <span class="kw">Date</span>(), model = <span class="kw">req</span>.<span class="fu">body</span>;
            <span class="kw">model</span>.<span class="fu">saveDate</span> = (<span class="kw">d</span>.<span class="fu">valueOf</span>());

            <span class="kw">posts</span>.<span class="fu">save</span>(<span class="kw">req.params</span>.<span class="fu">id</span>,model, <span class="kw">function</span> (err, key){
                <span class="kw">if</span>(err) { 
                    <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
                    <span class="kw">res</span>.<span class="fu">json</span>(err); 
                } <span class="kw">else</span> {
                    <span class="kw">res</span>.<span class="fu">json</span>(model);
                }
            });
        });

        <span class="co">/*</span>
<span class="co">            supprimer un post par sa clé unique lorsque</span>
<span class="co">            l&#39;on appelle http://localhost:3000/blogpost/identifiant_du_post</span>
<span class="co">            en mode DELETE</span>
<span class="co">        */</span>
        <span class="kw">app</span>.<span class="fu">delete</span>(<span class="ch">&#39;/blogpost/:id&#39;</span>,<span class="kw">function</span>(req, res){
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;DELETE : /delete/&quot;</span>+<span class="kw">req.params</span>.<span class="fu">id</span>);

            <span class="kw">posts</span>.<span class="fu">remove</span>(<span class="kw">req.params</span>.<span class="fu">id</span>, <span class="kw">function</span>(err){
                <span class="kw">if</span>(err) { 
                    <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
                    <span class="kw">res</span>.<span class="fu">json</span>(err); 
                } <span class="kw">else</span> { 
                    <span class="co">//petit correctif de contournement (bug ds nStore) : </span>
                    <span class="co">//ré-ouvrir la base lorsque la suppression a été faite</span>
                    posts = <span class="kw">nStore</span>.<span class="fu">new</span>(<span class="st">&quot;blog.db&quot;</span>, <span class="kw">function</span>() {
                        <span class="kw">res</span>.<span class="fu">json</span>(<span class="kw">req.params</span>.<span class="fu">id</span>);
                        <span class="co">//Le modèle est vide si on ne trouve rien</span>
                    });
                }
            });
        });

    }</code></pre>
<h2 id="authentification-côté-client"><a href="#TOC"><span class="header-section-number">8.9</span> Authentification (côté client)</a></h2>
<p>Nous repassons enfin au code client et nous allons pouvoir vérifier comment sont gérés les évènements dans une vue en implémentant l’authentification côté client.</p>
<h3 id="formulaire-dauthentification"><a href="#TOC"><span class="header-section-number">8.9.1</span> Formulaire d’authentification</a></h3>
<p>Nous allons donc commencer par créer le template du formulaire d’authentification dans notre page <code>index.html</code> (je choisis de le placer juste après la liste des 3 derniers posts) :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;sidebar&quot;</span><span class="ot"> id=</span><span class="st">&quot;blog_sidebar&quot;</span><span class="kw">&gt;</span>
        <span class="co">&lt;!-- Last 3 posts --&gt;</span>
    <span class="kw">&lt;/div&gt;</span>

    <span class="co">&lt;!-- /*======= Formulaire d&#39;authentification =======*/ --&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/template&quot;</span><span class="ot"> id=</span><span class="st">&quot;blog_login_form_template&quot;</span><span class="kw">&gt;</span>
        &lt;h3&gt;<span class="dt">Login </span>:&lt;/h3&gt;
        &lt;input name=<span class="st">&quot;email&quot;</span> type=<span class="st">&quot;text&quot;</span> placeholder=<span class="st">&quot;email&quot;</span>/&gt;&lt;br&gt;
        &lt;input name=<span class="st">&quot;password&quot;</span> type=<span class="st">&quot;password&quot;</span> placeholder=<span class="st">&quot;password&quot;</span>/&gt;&lt;br&gt;
        &lt;a href=<span class="st">&quot;</span>#<span class="st">&quot;</span> class=<span class="st">&quot;btn</span> <span class="st">btn</span>-<span class="st">primary&quot;</span>&gt;Login&lt;/a&gt; 
        &lt;a href=<span class="st">&quot;</span>#<span class="st">&quot;</span> class=<span class="st">&quot;btn</span> <span class="st">btn</span>-<span class="st">inverse&quot;</span>&gt;Logoff&lt;/a&gt;&lt;br&gt;
        &lt;b&gt;{{message}} {{firstName}} {{lastName}}&lt;/b&gt;

    <span class="kw">&lt;/script&gt;</span>
    <span class="kw">&lt;form</span><span class="ot"> class=</span><span class="st">&quot;container&quot;</span><span class="ot"> id=</span><span class="st">&quot;blog_login_form&quot;</span><span class="kw">&gt;</span>

    <span class="kw">&lt;/form&gt;</span></code></pre>
<h3 id="lobjet-backbone.view-login.view"><a href="#TOC"><span class="header-section-number">8.9.2</span> L’objet Backbone.View : Login.View</a></h3>
<p>Notre composant d’authentification aura 2 zones de saisie (email et mot de passe), un bouton de login, un bouton pour se déconnecter, une zone pour afficher un message (bienvenue, erreur, …). Le composant devra aussi pouvoir vérifier si l’utilisateur est toujours connecté en cas de rafraîchissement de la page.</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="co">/*======= Authentification =======*/</span>
    <span class="kw">window</span>.<span class="fu">LoginView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
        <span class="dt">el </span>: $(<span class="st">&quot;#blog_login_form&quot;</span>),

        <span class="dt">initialize </span>: <span class="kw">function</span> () {
            <span class="kw">var</span> that = <span class="kw">this</span>;
            <span class="kw">this</span>.<span class="fu">template</span> = $(<span class="st">&quot;#blog_login_form_template&quot;</span>).<span class="fu">html</span>();

            <span class="co">//on vérifie si pas déjà authentifié</span>
             $.<span class="fu">ajax</span>({<span class="dt">type</span>:<span class="st">&quot;GET&quot;</span>, <span class="dt">url</span>:<span class="st">&quot;/alreadyauthenticated&quot;</span>,
                <span class="dt">error</span>:<span class="kw">function</span>(err){ <span class="kw">console</span>.<span class="fu">log</span>(err); },
                <span class="dt">success</span>:<span class="kw">function</span>(dataFromServer) { 

                    <span class="kw">if</span>(<span class="kw">dataFromServer</span>.<span class="fu">firstName</span>) {
                        <span class="kw">that</span>.<span class="fu">render</span>(<span class="st">&quot;Bienvenue&quot;</span>,dataFromServer);
                    } <span class="kw">else</span> {
                        <span class="kw">that</span>.<span class="fu">render</span>(<span class="st">&quot;???&quot;</span>,{<span class="dt">firstName</span>:<span class="st">&quot;John&quot;</span>, <span class="dt">lastName</span>:<span class="st">&quot;Doe&quot;</span>});
                    }
                }
            })    

        },

        <span class="dt">render </span>: <span class="kw">function</span> (message, user) {

            <span class="kw">var</span> renderedContent = <span class="kw">Mustache</span>.<span class="fu">to</span>_<span class="fu">html</span>(<span class="kw">this</span>.<span class="fu">template</span>, {
                <span class="dt">message </span>: message,
                <span class="dt">firstName </span>: user ? <span class="dt">user.firstName </span>: <span class="st">&quot;&quot;</span>,
                <span class="dt">lastName </span>: user ? <span class="dt">user.lastName </span>: <span class="st">&quot;&quot;</span>
            });
            <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(renderedContent);  
        }

    });

    <span class="kw">window</span>.<span class="fu">loginView</span> = <span class="kw">new</span> LoginView();
    <span class="co">/*======= Fin authentification =======*/</span></code></pre>
<p>A l’initialisation (<code>initialize</code>) la vue va vérifier si l’utilisateur en cours est déjà authentifié (par exemple vous vous êtes signé, mais vous avez rafraîchi la page), en appelant la route <code>/alreadyauthenticated</code>, si l’utilisateur est déjà authentifié, la méthode <code>render</code> de la vue est appelée avec un message de bienvenue et les informations de l’utilisateur ( <code>that.render(&quot;Bienvenue&quot;,dataFromServer);</code> ) dans le cas contraire la méthode <code>render</code> est aussi appelée mais avec un message signifiant que l’utilisateur n’est pas connecté ( <code>that.render(&quot;???&quot;,{firstName:&quot;John&quot;, lastName:&quot;Doe&quot;});</code> ).</p>
<h3 id="ajoutons-une-gestion-des-évènements"><a href="#TOC"><span class="header-section-number">8.9.3</span> Ajoutons une gestion des évènements</a></h3>
<p>Une propriété de l’objet <code>Backbone.View</code> permet de gérer les évènements spécifiques à la vue. Si vous vous souvenez, notre template de formulaire ressemble à ceci :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="co">&lt;!-- /*======= Formulaire d&#39;authentification =======*/ --&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/template&quot;</span><span class="ot"> id=</span><span class="st">&quot;blog_login_form_template&quot;</span><span class="kw">&gt;</span>
        &lt;h3&gt;<span class="dt">Login </span>:&lt;/h3&gt;
        &lt;input name=<span class="st">&quot;email&quot;</span> type=<span class="st">&quot;text&quot;</span> placeholder=<span class="st">&quot;email&quot;</span>/&gt;&lt;br&gt;
        &lt;input name=<span class="st">&quot;password&quot;</span> type=<span class="st">&quot;password&quot;</span> placeholder=<span class="st">&quot;password&quot;</span>/&gt;&lt;br&gt;
        &lt;a href=<span class="st">&quot;</span>#<span class="st">&quot;</span> class=<span class="st">&quot;btn</span> <span class="st">btn</span>-<span class="st">primary&quot;</span>&gt;Login&lt;/a&gt; 
        &lt;a href=<span class="st">&quot;</span>#<span class="st">&quot;</span> class=<span class="st">&quot;btn</span> <span class="st">btn</span>-<span class="st">inverse&quot;</span>&gt;Logoff&lt;/a&gt;&lt;br&gt;
        &lt;b&gt;{{message}} {{firstName}} {{lastName}}&lt;/b&gt;
    <span class="kw">&lt;/script&gt;</span></code></pre>
<p>Je souhaite pouvoir déclencher des évènements lorsque je clique sur les boutons du formulaire. Pour cela il suffit d’ajouter à l’objet <code>Backbone.View</code> la propriété events :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="dt">events </span>: {
        <span class="st">&quot;click  .btn-primary&quot;</span>  : <span class="st">&quot;onClickBtnLogin&quot;</span>,
        <span class="st">&quot;click  .btn-inverse&quot;</span>  : <span class="st">&quot;onClickBtnLogoff&quot;</span>
    },</code></pre>
<p>En fait je demande à mon objet <code>Backbone.View</code> d’intercepter tous les évènements de type click sur les éléments html (de la vue considérée) dont la classe <code>css</code> est <code>.btn-primary</code> ou <code>.btn-inverse</code> et de déclencher respectivement les méthodes <code>onClickBtnLogin</code> ou <code>onClickBtnLogoff</code>.</p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : nous aurions très bien pu affecter des id aux boutons :</p>
</blockquote>
</blockquote>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;#&quot;</span><span class="ot"> id=</span><span class="st">&quot;btnLogIn&quot;</span><span class="ot"> class=</span><span class="st">&quot;btn btn-primary&quot;</span><span class="kw">&gt;</span>Login<span class="kw">&lt;/a&gt;</span> 
    <span class="kw">&lt;a</span><span class="ot"> href=</span><span class="st">&quot;#&quot;</span><span class="ot"> id=</span><span class="st">&quot;btnLogOff&quot;</span><span class="ot"> class=</span><span class="st">&quot;btn btn-inverse&quot;</span><span class="kw">&gt;</span>Logoff<span class="kw">&lt;/a&gt;&lt;br&gt;</span></code></pre>
<p>et relier les évènements aux ids :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="dt">events </span>: {
        <span class="st">&quot;click  #btnLogIn&quot;</span>  : <span class="st">&quot;onClickBtnLogin&quot;</span>,
        <span class="st">&quot;click  #btnLogOff&quot;</span>  : <span class="st">&quot;onClickBtnLogoff&quot;</span>
    },</code></pre>
<p>Il ne nous reste plus qu’à écrire les méthodes <code>onClickBtnLogin</code> ou <code>onClickBtnLogoff</code> au sein de notre objet de type <code>Backbone.View</code> qui vont respectivement appeler les routes que nous avions définies précédement :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="dt">onClickBtnLogin </span>: <span class="kw">function</span> (domEvent) {

        <span class="kw">var</span> fields = $(<span class="st">&quot;#blog_login_form :input&quot;</span>)
        ,   that = <span class="kw">this</span>;

        $.<span class="fu">ajax</span>({
            <span class="dt">type</span>:<span class="st">&quot;POST&quot;</span>,
            <span class="dt">url</span>:<span class="st">&quot;/authenticate&quot;</span>,
            <span class="dt">data </span>: { <span class="dt">email </span>: fields[<span class="dv">0</span>].<span class="fu">value</span>, <span class="dt">password </span>: fields[<span class="dv">1</span>].<span class="fu">value</span> } ,
            <span class="dt">dataType </span>: <span class="ch">&#39;json&#39;</span>,
            <span class="dt">error</span>:<span class="kw">function</span>(err){ <span class="kw">console</span>.<span class="fu">log</span>(err); },
            <span class="dt">success</span>:<span class="kw">function</span>(dataFromServer) { 

                <span class="kw">if</span>(<span class="kw">dataFromServer</span>.<span class="fu">infos</span>) {
                    <span class="kw">that</span>.<span class="fu">render</span>(<span class="kw">dataFromServer</span>.<span class="fu">infos</span>);
                } <span class="kw">else</span> {
                    <span class="kw">if</span>(<span class="kw">dataFromServer</span>.<span class="fu">error</span>) {
                        <span class="kw">that</span>.<span class="fu">render</span>(<span class="kw">dataFromServer</span>.<span class="fu">error</span>);
                    } <span class="kw">else</span> {
                        <span class="kw">that</span>.<span class="fu">render</span>(<span class="st">&quot;Bienvenue&quot;</span>,dataFromServer);
                    }
                }

            }
        });                  
    },
    <span class="dt">onClickBtnLogoff </span>: <span class="kw">function</span>() {

        <span class="kw">var</span> that = <span class="kw">this</span>;
        $.<span class="fu">ajax</span>({<span class="dt">type</span>:<span class="st">&quot;GET&quot;</span>, <span class="dt">url</span>:<span class="st">&quot;/logoff&quot;</span>,
            <span class="dt">error</span>:<span class="kw">function</span>(err){ <span class="kw">console</span>.<span class="fu">log</span>(err); },
            <span class="dt">success</span>:<span class="kw">function</span>(dataFromServer) { 
                <span class="kw">console</span>.<span class="fu">log</span>(dataFromServer); 
                <span class="kw">that</span>.<span class="fu">render</span>(<span class="st">&quot;???&quot;</span>,{<span class="dt">firstName</span>:<span class="st">&quot;John&quot;</span>, <span class="dt">lastName</span>:<span class="st">&quot;Doe&quot;</span>});
            }
        })
    }</code></pre>
<h3 id="vérification"><a href="#TOC"><span class="header-section-number">8.9.4</span> Vérification</a></h3>
<p>Si vous avez bien suivi, nous devons avoir au moins 2 utilisateurs en base de données :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">function</span> addUsers () {
        addUser({
            <span class="dt">email </span>: <span class="st">&quot;bob@morane.com&quot;</span>,
            <span class="dt">password </span>: <span class="st">&quot;backbone&quot;</span>,
            <span class="dt">isAdmin </span>: <span class="kw">true</span>,
            <span class="dt">firstName </span>: <span class="st">&quot;Bob&quot;</span>,
            <span class="dt">lastName </span>: <span class="st">&quot;Morane&quot;</span>
        });
        addUser({
            <span class="dt">email </span>: <span class="st">&quot;sam@lepirate.com&quot;</span>,
            <span class="dt">password </span>: <span class="st">&quot;underscore&quot;</span>,
            <span class="dt">isAdmin </span>: <span class="kw">false</span>,
            <span class="dt">firstName </span>: <span class="st">&quot;Sam&quot;</span>,
            <span class="dt">lastName </span>: <span class="st">&quot;Le Pirate&quot;</span>
        });

        <span class="co">//etc. ...</span>
    }</code></pre>
<p>Lançons donc notre page web :</p>
<p><img src="RSRC/07_08_VIEWS.png" alt="BB" /><br /></p>
<p>Authentifiez vous en tapant n’importe quoi :</p>
<p><img src="RSRC/07_09_VIEWS.png" alt="BB" /><br /></p>
<p>Vous obtenez le message <strong>&quot;Ouups loupé !!!&quot;</strong></p>
<p>Authentifiez vous en utilisant un des utilisateurs existant :</p>
<p><img src="RSRC/07_10_VIEWS.png" alt="BB" /><br /></p>
<p>Vous obtenez un message de bienvenue.</p>
<p>Vous pouvez essayer de raffraîchir la page, vous restez connecté.</p>
<p>Si vous ouvrez un autre navigateur (une autre marque de navigateur pour être sûr de ne pas partager la session), vous vous apercevez qu’il ne considère pas que vous êtes authentifié :</p>
<p><img src="RSRC/07_11_VIEWS.png" alt="BB" /><br /></p>
<p>Essayez de vous connecter avec un utilisateur déjà loggé sur une autre session :</p>
<p><img src="RSRC/07_12_VIEWS.png" alt="BB" /><br /></p>
<p>Vous obtenez le message <strong>&quot;Utilisateur déjà connecté&quot;</strong></p>
<p>Vous disposez maintenant de suffisament d'élément pour jouer avec les vues. Nous allons pouvoir passer au composant <code>Backbone.Router</code>. Nous reviendrons ensuite sur la sécurisation de notre application dans le chapitre sur l'organisation du code.</p>
<h1 id="le-routeur"><a href="#TOC"><span class="header-section-number">9</span> Le Routeur</a></h1>
<blockquote>
<p><em>Sommaire</em></p>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li><em>Modifier (un peu) la vue principale</em></li>
<li><em>Ajouter un template</em></li>
<li><em>&quot;Maîtriser&quot; les urls</em></li>
</ul>
</blockquote>
</blockquote>
<blockquote>
<p><em>Parmi les composants principaux de Backbone, il y a le Routeur (<code>Backbone.Router</code>), qui n’est pas obligatoire pour construire une application Backbone, mais qui néanmoins est très pratique. Son rôle principal est de déclencher des actions en fonction de l’url saisie dans votre navigateur, ou des liens cliqués.</em></p>
</blockquote>
<p>Dans une SPA (Single Page Application), la barre d’url est un composant à part entière de votre application. C’est une partie à laquelle l’utilisateur accède facilement, vous ne pouvez donc pas l’ignorer, et votre application devra pouvoir réagir en fonction des actions de l’utilisateur. Nous allons donc mettre en œuvre <code>Backbone.Router</code> pour pouvoir « réagir » aux changements d’url. Nous allons transformer notre vue d’affichages de posts, pour qu’elle n’affiche plus le détail des messages, mais à la place un lien qui lorsqu’il sera clické affichera le détail du message. Nous verrons qu’ensuite cette méthode nous permettra d’accéder directement à partir de la barre de l’url à des fonctionnalités de notre application.</p>
<h2 id="modifions-notre-vue"><a href="#TOC"><span class="header-section-number">9.1</span> Modifions notre vue</a></h2>
<p>Dans la page index.html, modifions le template « posts_list_template » afin qu’il n’affiche plus le contenu du post (<code>{{message}}</code>). A la place nous ajoutons un lien dont l’url sera post-fixée de l’id du post (<code>#post/{{id}}</code>) :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/template&quot;</span><span class="ot"> id=</span><span class="st">&quot;posts_list_template&quot;</span><span class="kw">&gt;</span>

        {{#posts}}
            &lt;h2&gt;{{title}}&lt;/h2&gt;
            &lt;b&gt;<span class="dt">par </span>: {{author}}&lt;/b&gt; <span class="dt">le </span>: {{date}}
            &lt;a href=<span class="st">&quot;</span>#<span class="st">post</span>/{{<span class="st">id</span>}}<span class="st">&quot;</span>&gt;Lire ...&lt;/a&gt;

        {{/posts}}

    <span class="kw">&lt;/script&gt;</span></code></pre>
<p>Ensuite nous ajoutons un nouveau template (pour voir le détail du post) qui sera utilisé lorsque nous cliquerons sur le lien « Lire … », avec un lien (<code>#/</code>) qui déclenchera l’affichage de l’ensemble de la liste des posts :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/template&quot;</span><span class="ot"> id=</span><span class="st">&quot;post_details_template&quot;</span><span class="kw">&gt;</span>
            &lt;h2&gt;{{<span class="kw">post</span>.<span class="fu">title</span>}}&lt;/h2&gt;
            &lt;b&gt;<span class="dt">par </span>: {{<span class="kw">post</span>.<span class="fu">author</span>}}&lt;/b&gt; <span class="dt">le </span>: {{<span class="kw">post</span>.<span class="fu">date</span>}}
            &lt;p&gt;{{<span class="kw">post</span>.<span class="fu">message</span>}}&lt;/p&gt;

            &lt;a href=<span class="st">&quot;</span>#/<span class="st">&quot;</span>&gt;Tous les messages&lt;/a&gt;
    <span class="kw">&lt;/script&gt;</span></code></pre>
<p>Nous créons ensuite un nouvel objet de type <code>Backbone.View</code> qui sera « chargé » d’afficher le détail du message du post, à partir du nouveau template (<code>#post_details_template</code>), en lieu et place de la liste des posts (<code>#posts_list</code>) :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">PostView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
        <span class="dt">el </span>: $(<span class="st">&quot;#posts_list&quot;</span>),
        <span class="dt">initialize </span>: <span class="kw">function</span> () {
            <span class="kw">this</span>.<span class="fu">template</span> = $(<span class="st">&quot;#post_details_template&quot;</span>).<span class="fu">html</span>();
        },
        <span class="dt">render </span>: <span class="kw">function</span> (post) {               
            <span class="kw">var</span> renderedContent = <span class="kw">Mustache</span>.<span class="fu">to</span>_<span class="fu">html</span>(<span class="kw">this</span>.<span class="fu">template</span>, {<span class="dt">post </span>: <span class="kw">post</span>.<span class="fu">toJSON</span>()} );
            <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(renderedContent);
        }

    });

    <span class="kw">window</span>.<span class="fu">postView</span> = <span class="kw">new</span> PostView();</code></pre>
<h2 id="création-du-routeur"><a href="#TOC"><span class="header-section-number">9.2</span> Création du routeur</a></h2>
<p>Nous pouvons maintenant créer notre routeur. La propriété importante du routeur est <code>routes</code>. Dans notre exemple (juste en dessous), je lui ai affecté trois routes :</p>
<ul>
<li><code>post/:id_post</code> : lorsque le click sur un lien de type <code>&lt;a href=&quot;#post/{{id}}&quot;&gt;Lire ...&lt;/a&gt;</code> la méthode <code>displayPost</code> du routeur sera appelée avec l’id du post en paramètre</li>
<li><code>hello</code>, qui appellera la méthode <code>hello</code> si par exemple on saisit <code>http://localhost:3000/#hello</code> dans la barre d’url du navigateur (notez le “#”, nous y reviendrons plus tard)</li>
<li>et enfin <code>*path</code> qui appellera la méthode <code>root</code> pour toute autre url comme <code>#/</code>, <code>/</code>, …</li>
</ul>
<p>Le code qui sert à récupérer la liste des posts en provenance du serveur est déplacé dans la méthode <code>root</code> du routeur :</p>
<p><em>Le routeur de notre application de blog :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">window</span>.<span class="fu">RoutesManager</span> = <span class="kw">Backbone.Router</span>.<span class="fu">extend</span>({
        <span class="dt">routes </span>: {
            <span class="st">&quot;post/:id_post&quot;</span> : <span class="st">&quot;displayPost&quot;</span>,
            <span class="st">&quot;hello&quot;</span> : <span class="st">&quot;hello&quot;</span>,
            <span class="st">&quot;*path&quot;</span> : <span class="st">&quot;root&quot;</span>
        },
        <span class="dt">root </span>: <span class="kw">function</span> () {
            <span class="kw">blogPosts</span>.<span class="fu">all</span>().<span class="fu">fetch</span>({
                <span class="dt">success</span>:<span class="kw">function</span>(result){
                    <span class="co">//ça marche !!!</span>
                }
            });
        },

        <span class="dt">hello </span>: <span class="kw">function</span> () {
            $(<span class="st">&quot;.hero-unit &gt; h1&quot;</span>).<span class="fu">html</span>(<span class="st">&quot;Hello World !!!&quot;</span>);
        },

        <span class="dt">displayPost </span>: <span class="kw">function</span> (id_post) {

            <span class="kw">var</span> tmp = <span class="kw">new</span> Post({<span class="dt">id</span>:id_post});

            <span class="kw">tmp</span>.<span class="fu">fetch</span>({
                <span class="dt">success </span>: <span class="kw">function</span>(result) {
                    <span class="kw">postView</span>.<span class="fu">render</span>(result);
                }
            });   
        }
    });

    <span class="kw">window</span>.<span class="fu">router</span> = <span class="kw">new</span> RoutesManager();

    <span class="kw">Backbone.history</span>.<span class="fu">start</span>();</code></pre>
<pre><code>//TODO: faire un § sur Backbone.history.start({pushState: true}); </code></pre>
<p>Sauvegardez le tout, rafraichissez la page, et testez :</p>
<p><img src="RSRC/08_01_routeur.png" alt="BB" /><br /></p>
<p>Si vous cliquez sur un des liens « Lire … », la liste des posts disparaît au profit du message relatif au post sélectionné :</p>
<p><img src="RSRC/08_02_routeur.png" alt="BB" /><br /></p>
<blockquote>
<blockquote>
<p><strong>Remarque IMPORTANTE</strong> : Du coup il est maintenant possible de bookmarquer les urls des posts pour pointer directement dessus.</p>
</blockquote>
</blockquote>
<p>Maintenant, essayer aussi de taper l’url directement dans la barre d’url : <code>http://localhost:3000/#hello</code>. Et là, le titre de notre blog change. Donc l’url peut bien déclencher directement des actions javascript. Vous pouvez donc réagir, prévenir, … toute modification de l’url (comme le retour à la page précédente) pour déclencher l’action nécessaire (par exemple la sauvegarde des données en cours).</p>
<p><img src="RSRC/08_03_routeur.png" alt="BB" /><br /></p>
<p>Voilà. C'est un peu court pour le Routeur, mais cela devrait suffire pour le moment. Maintenant il est temps d'organiser notre code &quot;comme les vrais&quot; avant que notre projet devienne un sac de nouille.</p>
<h1 id="organiser-son-code"><a href="#TOC"><span class="header-section-number">10</span> Organiser son code</a></h1>
<blockquote>
<p><em>Sommaire</em></p>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li><em>Namespaces &amp; Modules, à l'ancienne</em></li>
<li><em>&quot;Loader&quot; javascript, comme les vrais</em></li>
</ul>
</blockquote>
</blockquote>
<blockquote>
<p><em>Notre application (côté client) tient dans une seule page. Elle mélange du code HTML et du code Javascript, et cela dans un seul fichier commence à devenir difficilement lisible, difficilement modifiable et donc difficilement maintenable. J’aimerais ajouter la possibilité d’ajouter ou de modifier des posts, mais … Faisons d’abord le ménage et rangeons notre code..</em></p>
</blockquote>
<p>Il y a de nombreuses querelles de chapelle autour du sujet de l’organisation du code (des façons de le faire), et je vous avoue que je n’ai pas encore fait complètement mon choix, mais l’essentiel est de produire quelque chose qui fonctionne (correctement) et que vous pourrez facilement faire évoluer. Je vais donc vous présenter 2 méthodes, la méthode « à l’ancienne » qui a le mérite de fonctionner, d’être rapide, et la méthode « hype » pour les champions qui est intéressante à connaître tout particulièrement dans le cadre de gros projets.</p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : pour la méthode &quot;hype&quot;, j'utilise le(s) outil(s) (yepnope) que je préfère, il est tout à fait possible de suivre le principe décrit avec d'autres comme require.js et d'autres ... Je n'ai pas la science infuse, je me sens plus à l'aise avec YepNope ... c'est tout, et tant que ça marche ;) ...</p>
</blockquote>
</blockquote>
<h2 id="a-lancienne"><a href="#TOC"><span class="header-section-number">10.1</span> &quot;A l'ancienne&quot;</a></h2>
<h3 id="namespace"><a href="#TOC"><span class="header-section-number">10.1.1</span> Namespace</a></h3>
<p>Créer une application Backbone, c’est écrire des modèles, des vues, des templates, etc. … Et une des bonnes pratiques pour parvenir à garder ceci bien organisé et d’utiliser le <strong>namespacing</strong> (comme en .Net, Java, …) de la façon suivante :</p>
<p><em>Namespace Blog :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Blog = {
        <span class="dt">Models </span>: {},
        <span class="dt">Collections </span>: {},
        <span class="dt">Views </span>: {},
        <span class="dt">Router </span>: {}
    }</code></pre>
<p>Vous enregistrez ceci dans un fichier <code>Blog.js</code>, que vous pensez à référencer dans votre page html :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;Blog.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></code></pre>
<p>Ainsi par la suite vous pourrez déclarer et faire référence à vos composants de la manière suivante :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">Blog.Models</span>.<span class="fu">Post</span> = <span class="kw">Backbone.Model</span>.<span class="fu">extend</span>({
        <span class="co">//...</span>
    });

    <span class="kw">Blog.Collections</span>.<span class="fu">Posts</span> = <span class="kw">Backbone.Collection</span>.<span class="fu">extend</span>({
        <span class="co">//...</span>
    });
    <span class="kw">Blog.Views</span>.<span class="fu">PostForm</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
        <span class="co">//...</span>
    });

    <span class="co">//etc…</span></code></pre>
<p>Puis les utiliser comme ceci :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> myPost = <span class="kw">new</span> <span class="kw">Blog.Models</span>.<span class="fu">Post</span>();
    <span class="kw">var</span> posts = <span class="kw">new</span> <span class="kw">Blog.Collections</span>.<span class="fu">Posts</span>();
    <span class="kw">var</span> postForm = <span class="kw">new</span> <span class="kw">Blog.Views</span>.<span class="fu">PostForm</span>();</code></pre>
<p>Du coup, à la lecture du code, on voit tout de suite que <code>myPost</code> est un modèle, <code>posts</code> une collection et <code>postForm</code> une vue.</p>
<p>Cela va donc permettre de créer d’autres fichiers javascript spécifiques à chacun de vos composants, par exemple un fichier <code>post.js</code> avec le code de votre modèle <code>post</code> <em>(en général j’y ajoute aussi la collection correspondante)</em>, puis autant de fichiers javascript que de vues. Cela va augmenter le nombre de vos fichiers, mais à chaque modification vous n’aurez à vous concentrer que sur une seule portion de code.</p>
<p>Puis vous pouvez aussi organiser vos fichiers javascript dans des répertoires. Voici comment je procède :</p>
<p><img src="RSRC/09_01_ORGA.png" alt="BB" /><br /> Je crée un répertoire <code>libs/vendors</code> pour tous les scripts « qui ne sont pas de moi » (jquery, backbone, etc. …), puis je range mes modèles dans un répertoire <code>models</code>, mes vues dans un répertoire <code>views</code>. Au même endroit que ma page <code>index.html</code>, je positionne le fichier <code>routes.js</code>(mon routeur) ainsi que le fichier <code>Blog.js</code> qui contient mes <strong>« namspaces »</strong>, et enfin je déclare tout ceci dans ma page <code>index.html</code>:</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="co">&lt;!-- === Frameworks === --&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/jquery-1.7.2.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/underscore.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/backbone.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/mustache.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>

    <span class="co">&lt;!-- === code applicatif === --&gt;</span>

    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;Blog.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;models/Post.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span> <span class="co">&lt;!-- Models &amp; Collection --&gt;</span>

    <span class="co">&lt;!-- Backbone Views --&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;views/SidebarView.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span> 
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;views/PostsListView.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span> 
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;views/MainView.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;views/LoginView.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span> 
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;views/PostView.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span> 

    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;routes.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></code></pre>
<p>Pour ensuite écrire mon code javascript de « lancement », clairement simplifié par rapport à ce que nous avons fait jusqu’ici :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;script&gt;</span>
        $(<span class="kw">function</span> (){

            <span class="kw">window</span>.<span class="fu">blogPosts</span> = <span class="kw">new</span> <span class="kw">Blog.Collections</span>.<span class="fu">Posts</span>();

            <span class="kw">window</span>.<span class="fu">mainView</span> = <span class="kw">new</span> <span class="kw">Blog.Views</span>.<span class="fu">MainView</span>({<span class="dt">collection </span>: blogPosts});

            <span class="co">/*</span>======= Authentification =======<span class="co">*/</span>
            <span class="kw">window</span>.<span class="fu">loginView</span> = <span class="kw">new</span> <span class="kw">Blog.Views</span>.<span class="fu">LoginView</span>();
            <span class="co">/*</span>======= Fin authentification =======<span class="co">*/</span>

            <span class="kw">window</span>.<span class="fu">postView</span> = <span class="kw">new</span> <span class="kw">Blog.Views</span>.<span class="fu">PostView</span>();


            <span class="kw">window</span>.<span class="fu">router</span> = <span class="kw">new</span> <span class="kw">Blog.Router</span>.<span class="fu">RoutesManager</span>({<span class="dt">collection</span>:blogPosts});
            <span class="kw">Backbone.history</span>.<span class="fu">start</span>();

        });
    <span class="kw">&lt;/script&gt;</span></code></pre>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : Vous n’êtes pas obligés de faire comme moi, adaptez selon vos goûts ou les normes imposées sur les projets. Et n’hésitez pas à me contacter pour me donner des astuces pour améliorer mon organisation de code.</p>
</blockquote>
</blockquote>
<h3 id="modules"><a href="#TOC"><span class="header-section-number">10.1.2</span> Modules</a></h3>
<p>J’aime bien combiner la notion de module à la notion de namespace, ce qui permet d’associer à notre namespace une notion de variable ou de fonctions privées, mais aussi de créer un système de plugin. Je vous montre avec le code, ce sera plus « parlant » :</p>
<p>Avant nous avions donc ceci :</p>
<p><em>Namespace Blog :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Blog = {
        <span class="dt">Models </span>: {},
        <span class="dt">Collections </span>: {},
        <span class="dt">Views </span>: {},
        <span class="dt">Router </span>: {}
    }</code></pre>
<p>Que nous allons changer par ceci :</p>
<p><em>Module+Namespace :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Blog = (<span class="kw">function</span> () {
        <span class="kw">var</span> blog = {};

        <span class="kw">blog</span>.<span class="fu">Models</span> = {};
        <span class="kw">blog</span>.<span class="fu">Collections</span> = {};
        <span class="kw">blog</span>.<span class="fu">Views</span> = {};
        <span class="kw">blog</span>.<span class="fu">Router</span> = {};

        <span class="kw">return</span> blog;
    }());</code></pre>
<p>Cela signifie que seul la variable <code>blog</code> sera exposée par l’entremise de la variable <code>Blog</code>. Tout ce qui est entre <code>(function () {</code> et <code>}());</code> sera exécuté. A l’intérieur de cette closure vous pouvez coder des variables et des méthodes privées.</p>
<p>Ensuite vous allez pouvoir déclarer des « plug-ins » à votre module de la manière suivante (par exemple):</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Blog = (<span class="kw">function</span> (blog) {

        <span class="kw">blog.Models</span>.<span class="fu">Post</span> = <span class="kw">Backbone.Model</span>.<span class="fu">extend</span>({
            <span class="dt">urlRoot </span>:<span class="st">&quot;/blogposts&quot;</span>

        });

        <span class="kw">blog.Collections</span>.<span class="fu">Posts</span> = <span class="kw">Backbone.Collection</span>.<span class="fu">extend</span>({
            <span class="dt">model </span>: <span class="kw">blog.Models</span>.<span class="fu">Post</span>,
            <span class="dt">all </span>: <span class="kw">function</span> () {
                <span class="kw">this</span>.<span class="fu">url</span> = <span class="st">&quot;/blogposts&quot;</span>;
                <span class="kw">return</span> <span class="kw">this</span>;
            },
            <span class="dt">query </span>: <span class="kw">function</span> (query) {
                <span class="kw">this</span>.<span class="fu">url</span> = <span class="st">&quot;/blogposts/query/&quot;</span>+query;
                <span class="kw">return</span> <span class="kw">this</span>;
            }

        });    

        <span class="kw">return</span> blog;
    }(Blog));</code></pre>
<h3 id="au-final-nous-aurons-..."><a href="#TOC"><span class="header-section-number">10.1.3</span> Au final, nous aurons ...</a></h3>
<p>Avec les principes décrits plus haut, nous allons donc pouvoir &quot;découper&quot; notre code afin de bien tout ordonner, et nous obtiendrons les fichiers suivants :</p>
<p><em>Blog.js :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Blog = (<span class="kw">function</span> () {
        <span class="kw">var</span> blog = {};

        <span class="kw">blog</span>.<span class="fu">Models</span> = {};
        <span class="kw">blog</span>.<span class="fu">Collections</span> = {};
        <span class="kw">blog</span>.<span class="fu">Views</span> = {};
        <span class="kw">blog</span>.<span class="fu">Router</span> = {};

        <span class="kw">return</span> blog;
    }());</code></pre>
<p><em>routes.js :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Blog = (<span class="kw">function</span> (blog) {

        <span class="kw">blog.Router</span>.<span class="fu">RoutesManager</span> = <span class="kw">Backbone.Router</span>.<span class="fu">extend</span>({
            <span class="dt">initialize </span>: <span class="kw">function</span>(args) {
                <span class="kw">this</span>.<span class="fu">collection</span> = <span class="kw">args</span>.<span class="fu">collection</span>;
            },
            <span class="dt">routes </span>: {
                <span class="st">&quot;post/:id_post&quot;</span> : <span class="st">&quot;displayPost&quot;</span>,
                <span class="st">&quot;hello&quot;</span> : <span class="st">&quot;hello&quot;</span>,
                <span class="st">&quot;*path&quot;</span> : <span class="st">&quot;root&quot;</span>
            },
            <span class="dt">root </span>: <span class="kw">function</span> () {
                <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">all</span>().<span class="fu">fetch</span>({
                    <span class="dt">success</span>:<span class="kw">function</span>(result){
                        <span class="co">//ça marche !!!</span>
                    }
                });
            },

            <span class="dt">hello </span>: <span class="kw">function</span> () {
                $(<span class="st">&quot;.hero-unit &gt; h1&quot;</span>).<span class="fu">html</span>(<span class="st">&quot;Hello World !!!&quot;</span>);
            },

            <span class="dt">displayPost </span>: <span class="kw">function</span> (id_post) {

                <span class="kw">var</span> tmp = <span class="kw">new</span> <span class="kw">blog.Models</span>.<span class="fu">Post</span>({<span class="dt">id</span>:id_post});

                <span class="kw">tmp</span>.<span class="fu">fetch</span>({
                    <span class="dt">success </span>: <span class="kw">function</span>(result) {
                        <span class="kw">postView</span>.<span class="fu">render</span>(result);
                    }
                });   
            }
        });

        <span class="kw">return</span> blog;
    }(Blog));</code></pre>
<p><em>models/post.js :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Blog = (<span class="kw">function</span> (blog) {

        <span class="kw">blog.Models</span>.<span class="fu">Post</span> = <span class="kw">Backbone.Model</span>.<span class="fu">extend</span>({
            <span class="dt">urlRoot </span>:<span class="st">&quot;/blogposts&quot;</span>
        });

        <span class="kw">blog.Collections</span>.<span class="fu">Posts</span> = <span class="kw">Backbone.Collection</span>.<span class="fu">extend</span>({
            <span class="dt">model </span>: <span class="kw">blog.Models</span>.<span class="fu">Post</span>,
            <span class="dt">all </span>: <span class="kw">function</span> () {
                <span class="kw">this</span>.<span class="fu">url</span> = <span class="st">&quot;/blogposts&quot;</span>;
                <span class="kw">return</span> <span class="kw">this</span>;
            },
            <span class="dt">query </span>: <span class="kw">function</span> (query) {
                <span class="kw">this</span>.<span class="fu">url</span> = <span class="st">&quot;/blogposts/query/&quot;</span>+query;
                <span class="kw">return</span> <span class="kw">this</span>;
            }
        });    

        <span class="kw">return</span> blog;
    }(Blog));</code></pre>
<p><em>views/SidebarView.js :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Blog = (<span class="kw">function</span> (blog) {

        <span class="kw">blog.Views</span>.<span class="fu">SidebarView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
             <span class="dt">el </span>: $(<span class="st">&quot;#blog_sidebar&quot;</span>),
            <span class="dt">initialize </span>: <span class="kw">function</span> () {
                <span class="kw">this</span>.<span class="fu">template</span> = $(<span class="st">&quot;#blog_sidebar_template&quot;</span>).<span class="fu">html</span>();
            },
            <span class="dt">render </span>: <span class="kw">function</span> () {
                <span class="kw">var</span> renderedContent = <span class="kw">Mustache</span>.<span class="fu">to</span>_<span class="fu">html</span>(<span class="kw">this</span>.<span class="fu">template</span>, 
                    {<span class="dt">posts </span>: <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">toJSON</span>()} 
                );

                <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(renderedContent);
            }
        });

        <span class="kw">return</span> blog;
    }(Blog));</code></pre>
<p><em>views/PostsListViews.js :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Blog = (<span class="kw">function</span> (blog) {

        <span class="kw">blog.Views</span>.<span class="fu">PostsListView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
            <span class="dt">el </span>: $(<span class="st">&quot;#posts_list&quot;</span>),
            <span class="dt">initialize </span>: <span class="kw">function</span> () {
                <span class="kw">this</span>.<span class="fu">template</span> = $(<span class="st">&quot;#posts_list_template&quot;</span>).<span class="fu">html</span>();
            },
            <span class="dt">render </span>: <span class="kw">function</span> () {
                <span class="kw">var</span> renderedContent = <span class="kw">Mustache</span>.<span class="fu">to</span>_<span class="fu">html</span>(<span class="kw">this</span>.<span class="fu">template</span>, 
                    {<span class="dt">posts </span>: <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">toJSON</span>()} 
                );

                <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(renderedContent);
            }
        });

        <span class="kw">return</span> blog;
    }(Blog));</code></pre>
<p><em>views/MainView.js :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Blog = (<span class="kw">function</span> (blog) {

        <span class="kw">blog.Views</span>.<span class="fu">MainView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
            <span class="dt">initialize </span>: <span class="kw">function</span> () {

                <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">comparator</span> = <span class="kw">function</span> (model) {
                    <span class="kw">return</span> -(<span class="kw">new</span> <span class="kw">Date</span>(<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;date&quot;</span>)).<span class="fu">getTime</span>());
                }

                <span class="kw">_</span>.<span class="fu">bindAll</span>(<span class="kw">this</span>, <span class="ch">&#39;render&#39;</span>);
                <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;reset&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
                <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;change&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
                <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;add&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);
                <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">bind</span>(<span class="ch">&#39;remove&#39;</span>, <span class="kw">this</span>.<span class="fu">render</span>);

                <span class="kw">this</span>.<span class="fu">sidebarView</span> = <span class="kw">new</span> <span class="kw">blog.Views</span>.<span class="fu">SidebarView</span>();
                <span class="kw">this</span>.<span class="fu">postsListView</span> = <span class="kw">new</span> <span class="kw">blog.Views</span>.<span class="fu">PostsListView</span>({
                    <span class="dt">collection </span>: <span class="kw">this</span>.<span class="fu">collection</span>
                });

            },
            <span class="dt">render </span>: <span class="kw">function</span> () {

                <span class="co">//this.collection.models = this.collection.models.reverse();</span>
                <span class="kw">this</span>.<span class="fu">sidebarView</span>.<span class="fu">collection</span> = 
                    <span class="kw">new</span> <span class="kw">blog.Collections</span>.<span class="fu">Posts</span>(<span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">first</span>(<span class="dv">3</span>));
                <span class="kw">this</span>.<span class="fu">sidebarView</span>.<span class="fu">render</span>();
                <span class="kw">this</span>.<span class="fu">postsListView</span>.<span class="fu">render</span>();
            }
        });

        <span class="kw">return</span> blog;
    }(Blog));</code></pre>
<p><em>views/LoginView.js :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Blog = (<span class="kw">function</span> (blog) {

        <span class="kw">blog.Views</span>.<span class="fu">LoginView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
            <span class="dt">el </span>: $(<span class="st">&quot;#blog_login_form&quot;</span>),

            <span class="dt">initialize </span>: <span class="kw">function</span> () {
                <span class="kw">var</span> that = <span class="kw">this</span>;
                <span class="kw">this</span>.<span class="fu">template</span> = $(<span class="st">&quot;#blog_login_form_template&quot;</span>).<span class="fu">html</span>();

                <span class="co">//on vérifie si pas déjà authentifié</span>
                 $.<span class="fu">ajax</span>({<span class="dt">type</span>:<span class="st">&quot;GET&quot;</span>, <span class="dt">url</span>:<span class="st">&quot;/alreadyauthenticated&quot;</span>,
                    <span class="dt">error</span>:<span class="kw">function</span>(err){ <span class="kw">console</span>.<span class="fu">log</span>(err); },
                    <span class="dt">success</span>:<span class="kw">function</span>(dataFromServer) { 

                        <span class="kw">if</span>(<span class="kw">dataFromServer</span>.<span class="fu">firstName</span>) {
                            <span class="kw">that</span>.<span class="fu">render</span>(<span class="st">&quot;Bienvenue&quot;</span>,dataFromServer);
                        } <span class="kw">else</span> {
                            <span class="kw">that</span>.<span class="fu">render</span>(<span class="st">&quot;???&quot;</span>,{<span class="dt">firstName</span>:<span class="st">&quot;John&quot;</span>, <span class="dt">lastName</span>:<span class="st">&quot;Doe&quot;</span>});
                        }
                    }
                })    

            },

            <span class="dt">render </span>: <span class="kw">function</span> (message, user) {

                <span class="kw">var</span> renderedContent = <span class="kw">Mustache</span>.<span class="fu">to</span>_<span class="fu">html</span>(<span class="kw">this</span>.<span class="fu">template</span>, {
                    <span class="dt">message </span>: message,
                    <span class="dt">firstName </span>: user ? <span class="dt">user.firstName </span>: <span class="st">&quot;&quot;</span>,
                    <span class="dt">lastName </span>: user ? <span class="dt">user.lastName </span>: <span class="st">&quot;&quot;</span>
                });
                <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(renderedContent);  
            },
            <span class="dt">events </span>: {
                <span class="st">&quot;click  .btn-primary&quot;</span>  : <span class="st">&quot;onClickBtnLogin&quot;</span>,
                <span class="st">&quot;click  .btn-inverse&quot;</span>  : <span class="st">&quot;onClickBtnLogoff&quot;</span>
            },
            <span class="dt">onClickBtnLogin </span>: <span class="kw">function</span> (domEvent) {

                <span class="kw">var</span> fields = $(<span class="st">&quot;#blog_login_form :input&quot;</span>)
                ,   that = <span class="kw">this</span>;

                $.<span class="fu">ajax</span>({
                    <span class="dt">type</span>:<span class="st">&quot;POST&quot;</span>,
                    <span class="dt">url</span>:<span class="st">&quot;/authenticate&quot;</span>,
                    <span class="dt">data </span>: { <span class="dt">email </span>: fields[<span class="dv">0</span>].<span class="fu">value</span>, <span class="dt">password </span>: fields[<span class="dv">1</span>].<span class="fu">value</span> } ,
                    <span class="dt">dataType </span>: <span class="ch">&#39;json&#39;</span>,
                    <span class="dt">error</span>:<span class="kw">function</span>(err){ <span class="kw">console</span>.<span class="fu">log</span>(err); },
                    <span class="dt">success</span>:<span class="kw">function</span>(dataFromServer) { 

                        <span class="kw">if</span>(<span class="kw">dataFromServer</span>.<span class="fu">infos</span>) {
                            <span class="kw">that</span>.<span class="fu">render</span>(<span class="kw">dataFromServer</span>.<span class="fu">infos</span>);
                        } <span class="kw">else</span> {
                            <span class="kw">if</span>(<span class="kw">dataFromServer</span>.<span class="fu">error</span>) {
                                <span class="kw">that</span>.<span class="fu">render</span>(<span class="kw">dataFromServer</span>.<span class="fu">error</span>);
                            } <span class="kw">else</span> {
                                <span class="kw">that</span>.<span class="fu">render</span>(<span class="st">&quot;Bienvenue&quot;</span>,dataFromServer);
                            }
                        }

                    }
                });                  
            },
            <span class="dt">onClickBtnLogoff </span>: <span class="kw">function</span>() {

                <span class="kw">var</span> that = <span class="kw">this</span>;
                $.<span class="fu">ajax</span>({<span class="dt">type</span>:<span class="st">&quot;GET&quot;</span>, <span class="dt">url</span>:<span class="st">&quot;/logoff&quot;</span>,
                    <span class="dt">error</span>:<span class="kw">function</span>(err){ <span class="kw">console</span>.<span class="fu">log</span>(err); },
                    <span class="dt">success</span>:<span class="kw">function</span>(dataFromServer) { 
                        <span class="kw">console</span>.<span class="fu">log</span>(dataFromServer); 
                        <span class="kw">that</span>.<span class="fu">render</span>(<span class="st">&quot;???&quot;</span>,{<span class="dt">firstName</span>:<span class="st">&quot;John&quot;</span>, <span class="dt">lastName</span>:<span class="st">&quot;Doe&quot;</span>});
                    }
                })
            }

        });

        <span class="kw">return</span> blog;
    }(Blog));</code></pre>
<p><em>views/PostView.js :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Blog = (<span class="kw">function</span> (blog) {

        <span class="kw">blog.Views</span>.<span class="fu">PostView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
            <span class="dt">el </span>: $(<span class="st">&quot;#posts_list&quot;</span>),
            <span class="dt">initialize </span>: <span class="kw">function</span> () {
                <span class="kw">this</span>.<span class="fu">template</span> = $(<span class="st">&quot;#post_details_template&quot;</span>).<span class="fu">html</span>();
            },
            <span class="dt">render </span>: <span class="kw">function</span> (post) {               
                <span class="kw">var</span> renderedContent = <span class="kw">Mustache</span>.<span class="fu">to</span>_<span class="fu">html</span>(<span class="kw">this</span>.<span class="fu">template</span>, 
                    {<span class="dt">post </span>: <span class="kw">post</span>.<span class="fu">toJSON</span>()} 
                );

                <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(renderedContent);
            }
        });

        <span class="kw">return</span> blog;
    }(Blog));</code></pre>
<p>... Sauvegardez tout ça et essayez, normalement cela devrait fonctionner et vous verrez qu'à l'usage, le code en devient plus lisible. Mais passons donc à la 2ème méthode.</p>
<h2 id="méthode-hype-comme-les-vrais"><a href="#TOC"><span class="header-section-number">10.2</span> Méthode “hype”, comme les vrais</a></h2>
<p>Plus les fichiers javascript se multiplient, plus la gestion des <code>&lt;script src=”…”&gt;</code> devient pénible, sans compter que dans certains cas il est nécessaire de gérer l’ordre d’inclusion, que l’on aimerait pouvoir déclencher un traitement uniquement lorsque l’on est sûr que notre script est chargé, etc. …</p>
<p>Pour répondre à ces types de problématiques, il existe ce que l’on appelle des “loaders” (chargeurs) de script, tels :</p>
<ul>
<li>Require.js (probalement le plus connu et le plus utilisé) <a href="http://requirejs.org/">http://requirejs.org/</a></li>
<li>Head.js <a href="http://headjs.com/">http://headjs.com/</a></li>
<li>YepNope <a href="http://yepnopejs.com/">http://yepnopejs.com/</a> d'Alex Sexton</li>
<li>Etc. ...</li>
</ul>
<p>Il y a beaucoup de débats autour des « javascript resources loaders », « est-ce bien ou mal ? » « Cela ralentit le chargement de la page web », « c’est génial il faut généraliser son utilisation » , ... Mon propos n’est pas de participer au débat mais de vous montrer « rapidement » de quelle façon on peut les utiliser. (Cependant si votre application est simple, cela ne vaut pas la peine d’en utiliser, si ce n’est à titre éducatif ou pour le plaisir).</p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : si vous souhaitez creuser le sujet je vous engage à lire « Non-onload-blocking async JS » de Stoyan Stefanov : <a href="http://www.phpied.com/non-onload-blocking-async-js/">http://www.phpied.com/non-onload-blocking-async-js/</a>.</p>
</blockquote>
</blockquote>
<p>En ce qui nous concerne, j’ai choisi <strong>YepNope</strong> parce que nettement plus simple (plus léger aussi) que Require.js et développé par Alex Sexton, ce qui est un gage de qualité (excellent développeur javascript et qui prend le temps de répondre à vos questions, ce qui n’est pas négligeable).</p>
<h3 id="préparation"><a href="#TOC"><span class="header-section-number">10.2.1</span> Préparation</a></h3>
<p>Commencez par télécharger la dernière version de YepNope ici :</p>
<ul>
<li><a href="https://github.com/SlexAxton/yepnope.js/archives/master">https://github.com/SlexAxton/yepnope.js/archives/master</a></li>
</ul>
<p>Puis, dézipper et copier ensuite le fichier <code>yepnope.js</code> ou sa version minifiée (dans mon cas j’ai utilisé la version 1.5.4) dans le répertoire <code>public/libs/vendors</code> de votre application.</p>
<p>Nous allons maitenant supprimer toutes les références de script que nous avions dans la page index.html :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="co">&lt;!-- === Frameworks === --&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/jquery-1.7.2.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/underscore.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/backbone.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/mustache.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>

    <span class="co">&lt;!-- === code applicatif === --&gt;</span>

    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;Blog.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;models/Post.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span> <span class="co">&lt;!-- Models &amp; Collection --&gt;</span>

    <span class="co">&lt;!-- Backbone Views --&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;views/SidebarView.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span> 
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;views/PostsListView.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span> 
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;views/MainView.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;views/LoginView.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span> 
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;views/PostView.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span> 

    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;routes.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></code></pre>
<p>Et nous écrivons ceci à la place :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/yepnope.1.5.4-min.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;main.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span></code></pre>
<p>Et c’est donc dans le script <code>main.js</code> que nous allons procéder au chargement de nos différents scripts de la manière suivante :</p>
<p><em>1ère utilisation de yepnope :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    yepnope({
        <span class="dt">load</span>: {
            <span class="dt">jquery              </span>: <span class="ch">&#39;libs/vendors/jquery-1.7.2.js&#39;</span>,
            <span class="dt">underscore          </span>: <span class="ch">&#39;libs/vendors/underscore.js&#39;</span>,
            <span class="dt">backbone            </span>: <span class="ch">&#39;libs/vendors/backbone.js&#39;</span>,
            <span class="dt">mustache            </span>: <span class="ch">&#39;libs/vendors/mustache.js&#39;</span>,

            <span class="co">//NameSpace</span>
            <span class="dt">blog                </span>: <span class="ch">&#39;Blog.js&#39;</span>,

            <span class="co">//Models</span>
            <span class="dt">posts               </span>: <span class="ch">&#39;models/post.js&#39;</span>,

            <span class="co">//Controllers</span>
            <span class="dt">sidebarview         </span>: <span class="ch">&#39;views/SidebarView.js&#39;</span>,
            <span class="dt">postslistviews      </span>: <span class="ch">&#39;views/PostsListView.js&#39;</span>,
            <span class="dt">mainview            </span>: <span class="ch">&#39;views/MainView.js&#39;</span>,
            <span class="dt">loginview           </span>: <span class="ch">&#39;views/LoginView.js&#39;</span>,
            <span class="dt">postview            </span>: <span class="ch">&#39;views/PostView.js&#39;</span>,

            <span class="co">//Routes</span>
            <span class="dt">routes              </span>: <span class="ch">&#39;routes.js&#39;</span>

        },

        <span class="dt">callback </span>: {
            <span class="st">&quot;routes&quot;</span> : <span class="kw">function</span> () {
                <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;routes loaded ...&quot;</span>);          
            }
        },
        <span class="dt">complete </span>: <span class="kw">function</span> () {
            <span class="co">//...</span>
        }
    });</code></pre>
<p>Vous l’aurez compris, le paramètre <code>load</code> sert à définir les scripts à charger. Vous notez aussi que l’on peut donner un alias à chacun des scripts (sinon YepNope le fera automatiquement à partir du nom du fichier javascript), alias que l’on peut ensuite utiliser dans le paramètre <code>callback</code> pour déclencher un traitement une fois que le script est inclus dans la page (dans notre exemple c’est au moment de l’inclusion du fichier <code>routes.js</code>).</p>
<p>Et enfin, il y a aussi le paramètre <code>complete</code> qui permet de lancer un traitement une fois tous les scripts inclus.</p>
<p>Nous allons donc déplacer le javascript restant dans notre page à l’intérieur de complete, pour finalement obtenir ceci :</p>
<p><em>Code définitif :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    yepnope({
        <span class="dt">load</span>: {
            <span class="dt">jquery              </span>: <span class="ch">&#39;libs/vendors/jquery-1.7.2.js&#39;</span>,
            <span class="dt">underscore          </span>: <span class="ch">&#39;libs/vendors/underscore.js&#39;</span>,
            <span class="dt">backbone            </span>: <span class="ch">&#39;libs/vendors/backbone.js&#39;</span>,
            <span class="dt">mustache            </span>: <span class="ch">&#39;libs/vendors/mustache.js&#39;</span>,

            <span class="co">//NameSpace</span>
            <span class="dt">blog                </span>: <span class="ch">&#39;Blog.js&#39;</span>,

            <span class="co">//Models</span>
            <span class="dt">posts               </span>: <span class="ch">&#39;models/post.js&#39;</span>,

            <span class="co">//Controllers</span>
            <span class="dt">sidebarview         </span>: <span class="ch">&#39;views/SidebarView.js&#39;</span>,
            <span class="dt">postslistviews      </span>: <span class="ch">&#39;views/PostsListView.js&#39;</span>,
            <span class="dt">mainview            </span>: <span class="ch">&#39;views/MainView.js&#39;</span>,
            <span class="dt">loginview           </span>: <span class="ch">&#39;views/LoginView.js&#39;</span>,
            <span class="dt">postview            </span>: <span class="ch">&#39;views/PostView.js&#39;</span>,

            <span class="co">//Routes</span>
            <span class="dt">routes              </span>: <span class="ch">&#39;routes.js&#39;</span>

        },

        <span class="dt">callback </span>: {
            <span class="st">&quot;routes&quot;</span> : <span class="kw">function</span> () {
                <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;routes loaded ...&quot;</span>);          
            }
        },
        <span class="dt">complete </span>: <span class="kw">function</span> () {
            $(<span class="kw">function</span> (){

                <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Lauching application ...&quot;</span>);

                <span class="kw">window</span>.<span class="fu">blogPosts</span> = <span class="kw">new</span> <span class="kw">Blog.Collections</span>.<span class="fu">Posts</span>();

                <span class="kw">window</span>.<span class="fu">mainView</span> = <span class="kw">new</span> <span class="kw">Blog.Views</span>.<span class="fu">MainView</span>({<span class="dt">collection </span>: blogPosts});

                <span class="co">/*======= Authentification =======*/</span>
                <span class="kw">window</span>.<span class="fu">loginView</span> = <span class="kw">new</span> <span class="kw">Blog.Views</span>.<span class="fu">LoginView</span>();
                <span class="co">/*======= Fin authentification =======*/</span>

                <span class="kw">window</span>.<span class="fu">postView</span> = <span class="kw">new</span> <span class="kw">Blog.Views</span>.<span class="fu">PostView</span>();

                <span class="kw">window</span>.<span class="fu">router</span> = <span class="kw">new</span> <span class="kw">Blog.Router</span>.<span class="fu">RoutesManager</span>({<span class="dt">collection</span>:blogPosts});

                <span class="kw">Backbone.history</span>.<span class="fu">start</span>();

            });  
        }
    });</code></pre>
<p>Et voilà ! Vous disposez maintenant d’un code structuré, d’un outil de chargement de script facile à utiliser et modifier : désactivation ou changement provisoire de librairie pour tests par exemple mais aussi chargement conditionnel de script en fonction du contexte, … Je ne vous ai dévoilé qu’une infime partie de YepNope qui en dépit de sa taille est très puissant. Lisez la documentation, vous verrez …</p>
<p>Maintenant que notre projet est &quot;propre&quot;, nous allons dans le chapitre suivant en profiter pour sécuriser un peu plus notre application.</p>
<h1 id="securisation"><a href="#TOC"><span class="header-section-number">11</span> Securisation</a></h1>
<blockquote>
<p><em>Sommaire</em></p>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li><em>Un (tout) petit écran d'administration</em></li>
<li><em>Une &quot;vraie&quot; sécurisation des routes côté serveur</em></li>
</ul>
</blockquote>
</blockquote>
<blockquote>
<p><em>Profitons-en pour terminer (presque) notre application et la sécuriser. Je dis “presque”, car il y aura toujours des fonctionnalités à ajouter, des contrôles de saisie à faire, des codes à optimiser (vous verrez dans ce qui va suivre que ma façon d’accéder au DOM n’est pas forcément la plus élégante à défaut d’être la plus lisible), la gestion des commentaires, refaire l’authentification ...</em></p>
</blockquote>
<p>Je souhaite cependant pouvoir modifier et ajouter des messages (post). C’est un exercice pour démontrer l’utilité de l’organisation du code en modules pour mieux s’y retrouver.</p>
<h2 id="il-nous-faut-un-écran-dadministration"><a href="#TOC"><span class="header-section-number">11.1</span> Il nous faut un &quot;écran d’administration&quot;</a></h2>
<p>Je retourne donc dans le code html de ma page <code>index.html</code>. Ajoutons ceci juste après le “grand titre” de notre blog :</p>
<p><em>Template de l’écran d’administration :</em></p>
<pre class="sourceCode html"><code class="sourceCode html"><span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;span9&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;hero-unit&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;h1&gt;</span>Backbone rocks !!!<span class="kw">&lt;/h1&gt;</span>
    <span class="kw">&lt;/div&gt;</span>

    <span class="co">&lt;!--- Admin ---&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/template&quot;</span><span class="ot"> id=</span><span class="st">&quot;admin_template&quot;</span><span class="kw">&gt;</span>
        &lt;hr&gt;
        &lt;h3&gt;Administration du Blog&lt;/h3&gt;
        &lt;hr&gt;
        &lt;select id=<span class="st">&quot;post</span>_<span class="st">choice&quot;</span>&gt;{{#posts}}
            &lt;option value=<span class="st">&quot;</span>{{<span class="st">id</span>}}<span class="st">&quot;</span>&gt;{{title}}&lt;/option&gt;
        {{/posts}}&lt;/select&gt;
        &lt;a href=<span class="st">&quot;</span>#<span class="st">&quot;</span> id=<span class="st">&quot;btn</span>_<span class="st">update&quot;</span> class=<span class="st">&quot;btn</span> <span class="st">btn</span>-<span class="st">primary&quot;</span>&gt;Modifier Post&lt;/a&gt;
        &lt;a href=<span class="st">&quot;</span>#<span class="st">&quot;</span> id=<span class="st">&quot;btn</span>_<span class="st">create&quot;</span> class=<span class="st">&quot;btn</span> <span class="st">btn</span>-<span class="st">primary&quot;</span>&gt;Ré-initialiser / Ajouter Post&lt;/a&gt;
        &lt;hr&gt;
            <span class="dt">id </span>: &lt;span name=<span class="st">&quot;id&quot;</span>&gt;&lt;/span&gt;&lt;br&gt;
            &lt;input name=<span class="st">&quot;author&quot;</span> type=<span class="st">&quot;text&quot;</span> placeholder=<span class="st">&quot;author&quot;</span>/&gt;&lt;br&gt;
            &lt;input name=<span class="st">&quot;title&quot;</span> type=<span class="st">&quot;text&quot;</span> placeholder=<span class="st">&quot;title&quot;</span>/&gt;&lt;br&gt;
            &lt;textarea name=<span class="st">&quot;message&quot;</span> placeholder=<span class="st">&quot;message&quot;</span>&gt;&lt;/textarea&gt;&lt;br&gt;
            &lt;a href=<span class="st">&quot;</span>#<span class="st">&quot;</span> id=<span class="st">&quot;btn</span>_<span class="st">send&quot;</span> class=<span class="st">&quot;btn</span> <span class="st">btn</span>-<span class="st">primary&quot;</span>&gt;Sauvegarder&lt;/a&gt;
        &lt;hr&gt;
    <span class="kw">&lt;/script&gt;</span>

    <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;admin&quot;</span><span class="kw">&gt;</span>

    <span class="kw">&lt;/div&gt;</span>
    <span class="co">&lt;!--- End of Admin ---&gt;</span></code></pre>
<p>J’aurais donc un écran qui va ressembler à ceci :</p>
<p><img src="RSRC/10_01_ORGA.png" alt="BB" /><br /></p>
<p>Pour gérer cet écran je vais avoir besoin d’un objet de type <code>Backbone.View</code>, que nous allons créer dans le répertoire <code>/views</code> sous le nom d’<code>AdminView.js</code>. Avant de “coder” <code>AdminView</code>, nous allons le déclarer et l’instancier dans <code>main.js</code> :</p>
<p><em>main.js : :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">yepnope({
    <span class="dt">load</span>: {
        <span class="dt">jquery              </span>: <span class="ch">&#39;libs/vendors/jquery-1.7.2.js&#39;</span>,
        <span class="dt">underscore          </span>: <span class="ch">&#39;libs/vendors/underscore.js&#39;</span>,
        <span class="dt">backbone            </span>: <span class="ch">&#39;libs/vendors/backbone.js&#39;</span>,
        <span class="dt">mustache            </span>: <span class="ch">&#39;libs/vendors/mustache.js&#39;</span>,

        <span class="co">//NameSpace</span>
        <span class="dt">blog                </span>: <span class="ch">&#39;Blog.js&#39;</span>,

        <span class="co">//Models</span>
        <span class="dt">posts               </span>: <span class="ch">&#39;models/post.js&#39;</span>,

        <span class="co">//Controllers</span>
        <span class="dt">sidebarview         </span>: <span class="ch">&#39;views/SidebarView.js&#39;</span>,
        <span class="dt">postslistviews      </span>: <span class="ch">&#39;views/PostsListView.js&#39;</span>,
        <span class="dt">mainview            </span>: <span class="ch">&#39;views/MainView.js&#39;</span>,
        <span class="dt">loginview           </span>: <span class="ch">&#39;views/LoginView.js&#39;</span>,
        <span class="dt">postview            </span>: <span class="ch">&#39;views/PostView.js&#39;</span>,

        <span class="co">//--- ADMINVIEW---</span>
        <span class="dt">adminview           </span>: <span class="ch">&#39;views/AdminView.js&#39;</span>,

        <span class="co">//Routes</span>
        <span class="dt">routes              </span>: <span class="ch">&#39;routes.js&#39;</span> 
    },

    <span class="dt">callback </span>: {
        <span class="st">&quot;routes&quot;</span> : <span class="kw">function</span> () {
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;routes loaded ...&quot;</span>);          
        }
    },
    <span class="dt">complete </span>: <span class="kw">function</span> () {
        $(<span class="kw">function</span> (){
            <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Lauching application ...&quot;</span>);

            <span class="kw">window</span>.<span class="fu">blogPosts</span> = <span class="kw">new</span> <span class="kw">Blog.Collections</span>.<span class="fu">Posts</span>();

            <span class="kw">window</span>.<span class="fu">mainView</span> = <span class="kw">new</span> <span class="kw">Blog.Views</span>.<span class="fu">MainView</span>({<span class="dt">collection </span>: blogPosts});

            <span class="co">/*======= Admin =======*/</span>
            <span class="kw">window</span>.<span class="fu">adminView</span> = <span class="kw">new</span> <span class="kw">Blog.Views</span>.<span class="fu">AdminView</span>({<span class="dt">collection </span>: blogPosts});
            <span class="co">/*======= Fin Admin =======*/</span>

            <span class="co">/*======= Authentification =======*/</span>
            <span class="kw">window</span>.<span class="fu">loginView</span> = <span class="kw">new</span> <span class="kw">Blog.Views</span>.<span class="fu">LoginView</span>({<span class="dt">adminView </span>: adminView});
            <span class="co">/*======= Fin authentification =======*/</span>

            <span class="kw">window</span>.<span class="fu">postView</span> = <span class="kw">new</span> <span class="kw">Blog.Views</span>.<span class="fu">PostView</span>();

            <span class="kw">window</span>.<span class="fu">router</span> = <span class="kw">new</span> <span class="kw">Blog.Router</span>.<span class="fu">RoutesManager</span>({<span class="dt">collection</span>:blogPosts});
            <span class="co">//Backbone.history.start({pushState: true}); </span>
            <span class="kw">Backbone.history</span>.<span class="fu">start</span>();

        });  
    }
});</code></pre>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : Je passe la vue adminView à la vue loginView pour que cette dernière puisse déclencher le rendue de la première si nécessaire.</p>
</blockquote>
</blockquote>
<h3 id="création-dadminview"><a href="#TOC"><span class="header-section-number">11.1.1</span> Création d'AdminView</a></h3>
<p>Alors il n'y a pas grand chose à expliquer (c'est dans le code)</p>
<p><em>AdminView.js :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> Blog = (<span class="kw">function</span> (blog) {

    <span class="kw">blog.Views</span>.<span class="fu">AdminView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
        <span class="dt">el </span>: $(<span class="st">&quot;#admin&quot;</span>),
        <span class="dt">initialize </span>: <span class="kw">function</span> () {
            <span class="kw">this</span>.<span class="fu">template</span> = $(<span class="st">&quot;#admin_template&quot;</span>).<span class="fu">html</span>();
            <span class="co">//je prévois de trier ma collection</span>
            <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">comparator</span> = <span class="kw">function</span> (model) {
                <span class="kw">return</span> -(<span class="kw">new</span> <span class="kw">Date</span>(<span class="kw">model</span>.<span class="fu">get</span>(<span class="st">&quot;date&quot;</span>)).<span class="fu">getTime</span>());
            }
        },
        <span class="dt">render </span>: <span class="kw">function</span> () {
            <span class="kw">var</span> renderedContent = <span class="kw">Mustache</span>.<span class="fu">to</span>_<span class="fu">html</span>(<span class="kw">this</span>.<span class="fu">template</span>, 
                {<span class="dt">posts </span>: <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">toJSON</span>() } );
            <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(renderedContent);
        },
        <span class="dt">events </span>: {
            <span class="st">&quot;click  #btn_update&quot;</span>  : <span class="st">&quot;onClickBtnUpdate&quot;</span>,
            <span class="st">&quot;click  #btn_create&quot;</span>  : <span class="st">&quot;onClickBtnCreate&quot;</span>,
            <span class="st">&quot;click  #btn_send&quot;</span> : <span class="st">&quot;sendPost&quot;</span>
        },

        <span class="dt">onClickBtnUpdate </span>: <span class="kw">function</span> () {
            <span class="kw">var</span> selectedId = $(<span class="st">&quot;#post_choice&quot;</span>).<span class="fu">val</span>()
            ,   post = <span class="kw">this</span>.<span class="fu">collection</span>.<span class="fu">get</span>(selectedId);

            <span class="co">//Je récupère les informations du post et les affiche</span>
            $(<span class="st">&quot;#admin &gt; [name=&#39;id&#39;]&quot;</span>).<span class="fu">html</span>(<span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;id&quot;</span>));
            $(<span class="st">&quot;#admin &gt; [name=&#39;author&#39;]&quot;</span>).<span class="fu">val</span>(<span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;author&quot;</span>));
            $(<span class="st">&quot;#admin &gt; [name=&#39;title&#39;]&quot;</span>).<span class="fu">val</span>(<span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;title&quot;</span>));
            $(<span class="st">&quot;#admin &gt; [name=&#39;message&#39;]&quot;</span>).<span class="fu">val</span>(<span class="kw">post</span>.<span class="fu">get</span>(<span class="st">&quot;message&quot;</span>));

        },
        <span class="dt">onClickBtnCreate </span>: <span class="kw">function</span> () {
            <span class="co">//je ré-initialise les zones de saisie</span>
            $(<span class="st">&quot;#admin &gt; [name=&#39;id&#39;]&quot;</span>).<span class="fu">html</span>(<span class="st">&quot;&quot;</span>);
            $(<span class="st">&quot;#admin &gt; [name=&#39;author&#39;]&quot;</span>).<span class="fu">val</span>(<span class="st">&quot;&quot;</span>);
            $(<span class="st">&quot;#admin &gt; [name=&#39;title&#39;]&quot;</span>).<span class="fu">val</span>(<span class="st">&quot;&quot;</span>);
            $(<span class="st">&quot;#admin &gt; [name=&#39;message&#39;]&quot;</span>).<span class="fu">val</span>(<span class="st">&quot;&quot;</span>);
        },
        <span class="dt">sendPost </span>: <span class="kw">function</span> () { <span class="co">//Sauvegarde</span>
            <span class="kw">var</span> that  = <span class="kw">this</span> <span class="co">//pour conserver le contexte</span>
            ,   id = $(<span class="st">&quot;#admin &gt; [name=&#39;id&#39;]&quot;</span>).<span class="fu">html</span>()
            ,   post;

            <span class="kw">if</span>(id===<span class="st">&quot;&quot;</span>) { <span class="co">//si l&#39;id est vide c&#39;est une création</span>
                post = <span class="kw">new</span> <span class="kw">Blog.Models</span>.<span class="fu">Post</span>();
            } <span class="kw">else</span> { <span class="co">//l&#39;id n&#39;est pas vide c&#39;est une mise à jour</span>
                post = <span class="kw">new</span> <span class="kw">Blog.Models</span>.<span class="fu">Post</span>({
                    <span class="dt">id</span>:$(<span class="st">&quot;#admin &gt; [name=&#39;id&#39;]&quot;</span>).<span class="fu">html</span>()
                });
            }

            <span class="kw">post</span>.<span class="fu">save</span>({
                    <span class="dt">author </span>: $(<span class="st">&quot;#admin &gt; [name=&#39;author&#39;]&quot;</span>).<span class="fu">val</span>(),
                    <span class="dt">title </span>: $(<span class="st">&quot;#admin &gt; [name=&#39;title&#39;]&quot;</span>).<span class="fu">val</span>(),
                    <span class="dt">message </span>: $(<span class="st">&quot;#admin &gt; [name=&#39;message&#39;]&quot;</span>).<span class="fu">val</span>(),
                    <span class="dt">date </span>: <span class="kw">new</span> <span class="kw">Date</span>()
                },{
                <span class="dt">success</span>:<span class="kw">function</span> () {
                    <span class="co">//Si la transaction côté serveur a fonctionné</span>

                    <span class="co">//je recharge ma collection</span>
                    <span class="kw">that.collection</span>.<span class="fu">fetch</span>({
                        <span class="dt">success</span>:<span class="kw">function</span>() {
                            <span class="co">//mise à jour de la vue admin</span>
                            <span class="kw">that</span>.<span class="fu">render</span>();
                            <span class="co">//La vue principale se re-mettra à jour</span>
                            <span class="co">//automatiquement, car elle est &quot;abonnée&quot;</span>
                            <span class="co">//aux changement de la collection</span>
                        }
                    });
                },
                <span class="dt">error </span>: <span class="kw">function</span> () {}
            });
        }
    });
    <span class="kw">return</span> blog;
}(Blog));</code></pre>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : je n’abonne pas la vue aux changement de la collection pour pouvoir maîtriser le moment où je déclenche la méthode render() de celle-ci.</p>
</blockquote>
</blockquote>
<h3 id="modification-de-loginview"><a href="#TOC"><span class="header-section-number">11.1.2</span> Modification de LoginView</a></h3>
<p>Nous allons modifier <code>LoginView.js</code> pour prendre en compte l’ajout de notre fonctionnalité d’administration. Tout d’abord modifions le template associé :</p>
<p><em>Template du formulaire de login :</em></p>
<pre class="sourceCode html"><code class="sourceCode html"><span class="co">&lt;!-- /*======= Formulaire d&#39;authentification =======*/ --&gt;</span>
<span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/template&quot;</span><span class="ot"> id=</span><span class="st">&quot;blog_login_form_template&quot;</span><span class="kw">&gt;</span>
    &lt;h3&gt;<span class="dt">Login </span>:&lt;/h3&gt;
    &lt;input name=<span class="st">&quot;email&quot;</span> type=<span class="st">&quot;text&quot;</span> placeholder=<span class="st">&quot;email&quot;</span>/&gt;&lt;br&gt;
    &lt;input name=<span class="st">&quot;password&quot;</span> type=<span class="st">&quot;password&quot;</span> placeholder=<span class="st">&quot;password&quot;</span>/&gt;&lt;br&gt;
    &lt;a href=<span class="st">&quot;</span>#<span class="st">&quot;</span> class=<span class="st">&quot;btn</span> <span class="st">btn</span>-<span class="st">primary&quot;</span>&gt;Login&lt;/a&gt; 
    &lt;a href=<span class="st">&quot;</span>#<span class="st">&quot;</span> class=<span class="st">&quot;btn</span> <span class="st">btn</span>-<span class="st">inverse&quot;</span>&gt;Logoff&lt;/a&gt;&lt;br&gt;
    &lt;b&gt;{{message}} {{firstName}} {{lastName}} &lt;/b&gt;
    &lt;br&gt;&lt;a id=<span class="st">&quot;adminbtn&quot;</span> href=<span class="st">&quot;</span>#<span class="st">&quot;</span>&gt;{{adminLinkLabel}}&lt;/a&gt;

<span class="kw">&lt;/script&gt;</span>
<span class="kw">&lt;form</span><span class="ot"> class=</span><span class="st">&quot;container&quot;</span><span class="ot"> id=</span><span class="st">&quot;blog_login_form&quot;</span><span class="kw">&gt;</span>

<span class="kw">&lt;/form&gt;</span>
<span class="co">&lt;!-- /*======= Fin du formulaire=======*/ --&gt;</span></code></pre>
<p>Puis modifions le code de LoginView.js :</p>
<p><em>LoginView.js :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript"><span class="kw">var</span> Blog = (<span class="kw">function</span> (blog) {

    <span class="kw">blog.Views</span>.<span class="fu">LoginView</span> = <span class="kw">Backbone.View</span>.<span class="fu">extend</span>({
        <span class="dt">el </span>: $(<span class="st">&quot;#blog_login_form&quot;</span>),

        <span class="dt">initialize </span>: <span class="kw">function</span> (args) {
            <span class="kw">var</span> that = <span class="kw">this</span>;

            <span class="kw">this</span>.<span class="fu">adminView</span> = <span class="kw">args</span>.<span class="fu">adminView</span>;

            <span class="kw">this</span>.<span class="fu">template</span> = $(<span class="st">&quot;#blog_login_form_template&quot;</span>).<span class="fu">html</span>();

            <span class="co">//on vérifie si pas déjà authentifié</span>
             $.<span class="fu">ajax</span>({<span class="dt">type</span>:<span class="st">&quot;GET&quot;</span>, <span class="dt">url</span>:<span class="st">&quot;/alreadyauthenticated&quot;</span>,
                <span class="dt">error</span>:<span class="kw">function</span>(err){ <span class="kw">console</span>.<span class="fu">log</span>(err); },
                <span class="dt">success</span>:<span class="kw">function</span>(dataFromServer) { 

                    <span class="kw">if</span>(<span class="kw">dataFromServer</span>.<span class="fu">firstName</span>) {

                        <span class="kw">that</span>.<span class="fu">render</span>(<span class="st">&quot;Bienvenue&quot;</span>,dataFromServer);

                    } <span class="kw">else</span> {
                        <span class="kw">that</span>.<span class="fu">render</span>(<span class="st">&quot;???&quot;</span>,{<span class="dt">firstName</span>:<span class="st">&quot;John&quot;</span>, <span class="dt">lastName</span>:<span class="st">&quot;Doe&quot;</span>});
                    }
                }
            })
        },
        <span class="dt">render </span>: <span class="kw">function</span> (message, user) {

            <span class="kw">var</span> renderedContent = <span class="kw">Mustache</span>.<span class="fu">to</span>_<span class="fu">html</span>(<span class="kw">this</span>.<span class="fu">template</span>, {
                <span class="dt">message </span>: message,
                <span class="dt">firstName </span>: user ? <span class="dt">user.firstName </span>: <span class="st">&quot;&quot;</span>,
                <span class="dt">lastName </span>: user ? <span class="dt">user.lastName </span>: <span class="st">&quot;&quot;</span>,
                <span class="dt">adminLinkLabel </span>: user ? <span class="kw">user</span>.<span class="fu">isAdmin</span> ? <span class="st">&quot;Administration&quot;</span> : <span class="st">&quot;&quot;</span> :<span class="st">&quot;&quot;</span>
            });
            <span class="kw">this</span>.$<span class="fu">el</span>.<span class="fu">html</span>(renderedContent);  
        },
        <span class="dt">events </span>: {
            <span class="st">&quot;click  .btn-primary&quot;</span>  : <span class="st">&quot;onClickBtnLogin&quot;</span>,
            <span class="st">&quot;click  .btn-inverse&quot;</span>  : <span class="st">&quot;onClickBtnLogoff&quot;</span>,
            <span class="st">&quot;click #adminbtn&quot;</span> : <span class="st">&quot;displayAdminPanel&quot;</span>
        },

        <span class="dt">displayAdminPanel </span>: <span class="kw">function</span>(){
            <span class="co">//this.adminView.render();</span>
        },

        <span class="dt">onClickBtnLogin </span>: <span class="kw">function</span> (domEvent) {
        <span class="co">//code non affiché pour des raisons de mise en page</span>
         <span class="co">//ne pas modifier</span>
        },
        <span class="dt">onClickBtnLogoff </span>: <span class="kw">function</span>() {
        <span class="co">//code non affiché pour des raisons de mise en page</span>
         <span class="co">//ne pas modifier</span>
        }

    });
    <span class="kw">return</span> blog;
}(Blog));</code></pre>
<p>Maintenant que nous avons fait nos modifications côté client, allons sécuriser les actions côté serveur.</p>
<h2 id="sécurisation-côté-serveur"><a href="#TOC"><span class="header-section-number">11.2</span> Sécurisation côté serveur</a></h2>
<p>Vous pouvez tester les modifications dès maintenant, cela va fonctionner, mais il est de bon ton de sécuriser côté serveur les actions de création, modification, suppression, etc. …</p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : La gestion des session avec express.js ainsi que la sécurisation des routes peut être prise en compte de manière plus « professionnel ». Gardez à l’esprit que les exemples donnés le sont à titre « didactique » et que certains points sont perfectibles.</p>
</blockquote>
</blockquote>
<p>Nous allons retourner dans le code de <code>app.js</code> (vous vous souvenez : notre application express.js) et créer une fonction qui permet de vérifier si l’utilisateur est connecté et est administrateur et cette fonction servira à sécuriser les routes :</p>
<h3 id="sécurisation-des-routes"><a href="#TOC"><span class="header-section-number">11.2.1</span> Sécurisation des routes</a></h3>
<p>Notre fonction vérifie si l'utilisateur connecté est un administrateur, si c'est le cas, elle passe la main à la fonction &quot;callback&quot; que j'ai appelée <code>next</code> sinon elle génère une erreur.</p>
<p><em>Fonction haveToBeAdmin :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    haveToBeAdmin = <span class="kw">function</span> (req, res, next) {
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;NEEDS ADMIN RIGHTS&quot;</span>);
        <span class="kw">if</span>(findUserBySession(<span class="kw">req</span>.<span class="fu">sessionID</span>)){
            <span class="kw">if</span> (findUserBySession(<span class="kw">req</span>.<span class="fu">sessionID</span>).<span class="fu">isAdmin</span>==<span class="kw">true</span>) {
                next();
            } <span class="kw">else</span> {
                <span class="kw">throw</span> <span class="st">&quot;You have to be administrator&quot;</span>;
            }          
        } <span class="kw">else</span> {
            <span class="kw">throw</span> <span class="st">&quot;You have to be connected&quot;</span>;    
        }
    }</code></pre>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : Si la condition est vérifiée, la fonction <code>next()</code> est appelée, elle correspond au traitement de la route sécurisée.</p>
</blockquote>
</blockquote>
<p>Et sécurisons ensuite nos routes de la manière suivante :</p>
<p><em>Ajout :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">app</span>.<span class="fu">post</span>(<span class="ch">&#39;/blogposts&#39;</span>, [haveToBeAdmin], <span class="kw">function</span>(req, res, next){
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;POST CREATE &quot;</span>, <span class="kw">req</span>.<span class="fu">body</span>);

        <span class="kw">var</span> d = <span class="kw">new</span> <span class="kw">Date</span>(), model = <span class="kw">req</span>.<span class="fu">body</span>;
        <span class="kw">model</span>.<span class="fu">saveDate</span> = (<span class="kw">d</span>.<span class="fu">valueOf</span>());

        <span class="kw">posts</span>.<span class="fu">save</span>(null,model, <span class="kw">function</span> (err, key){
            <span class="kw">if</span>(err) { 
                <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
                <span class="kw">res</span>.<span class="fu">json</span>(err); 
            } <span class="kw">else</span> {
                <span class="kw">model</span>.<span class="fu">id</span> = key;
                <span class="kw">res</span>.<span class="fu">json</span>(model);
            }
        });
    });</code></pre>
<blockquote>
<blockquote>
<p><strong>Remarque &quot;au passage&quot;</strong> : vous remarquez le passage du paramètre <code>[haveToBeAdmin]</code>, le contenu de <code>app.post</code> ne sera exécuté que si <code>haveToBeAdmin</code> &quot;déclenche&quot; <code>next</code>.</p>
</blockquote>
</blockquote>
<p>De la même façon pour la mise à jour et la suppression :</p>
<p><em>Mise à jour :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">app</span>.<span class="fu">put</span>(<span class="ch">&#39;/blogposts/:id&#39;</span>, [haveToBeAdmin],<span class="kw">function</span>(req, res, next){
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;PUT UPDATE&quot;</span>, <span class="kw">req</span>.<span class="fu">body</span>, <span class="kw">req.params</span>.<span class="fu">id</span>);

        <span class="kw">var</span> d = <span class="kw">new</span> <span class="kw">Date</span>(), model = <span class="kw">req</span>.<span class="fu">body</span>;
        <span class="kw">model</span>.<span class="fu">saveDate</span> = (<span class="kw">d</span>.<span class="fu">valueOf</span>());

        <span class="kw">posts</span>.<span class="fu">save</span>(<span class="kw">req.params</span>.<span class="fu">id</span>,model, <span class="kw">function</span> (err, key){
            <span class="kw">if</span>(err) { 
                <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
                <span class="kw">res</span>.<span class="fu">json</span>(err); 
            } <span class="kw">else</span> {
                <span class="kw">res</span>.<span class="fu">json</span>(model);
            }
        });
    });</code></pre>
<p><em>Suppression :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">app</span>.<span class="fu">delete</span>(<span class="ch">&#39;/blogposts/:id&#39;</span>, [haveToBeAdmin], <span class="kw">function</span>(req, res, next){
        <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;DELETE : /delete/&quot;</span>+<span class="kw">req.params</span>.<span class="fu">id</span>);

        <span class="kw">posts</span>.<span class="fu">remove</span>(<span class="kw">req.params</span>.<span class="fu">id</span>, <span class="kw">function</span>(err){
            <span class="kw">if</span>(err) { 
                <span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;Erreur : &quot;</span>,err);
                <span class="kw">res</span>.<span class="fu">json</span>(err); 
            } <span class="kw">else</span> { 
                <span class="co">//petit correctif de contournement (bug ds nStore) : </span>
                <span class="co">//ré-ouvrir la base lorsque la suppression a été faite</span>
                posts = <span class="kw">nStore</span>.<span class="fu">new</span>(<span class="st">&quot;blog.db&quot;</span>, <span class="kw">function</span>() {
                    <span class="kw">res</span>.<span class="fu">json</span>(<span class="kw">req.params</span>.<span class="fu">id</span>);
                    <span class="co">//Le modèle est vide si on ne trouve rien</span>
                });
            }
        });
    });</code></pre>
<h3 id="eh-bien-testons-maintenant"><a href="#TOC"><span class="header-section-number">11.2.2</span> Eh bien testons, maintenant</a></h3>
<ul>
<li>Relancez l’application côté serveur.</li>
<li>Ouvrez le navigateur et connectez vous au blog sans vous authentifier.</li>
<li>Ouvrez la console du navigateur et saisissez ceci : <code>adminView.render()</code>.</li>
</ul>
<p>Cela va faire apparaître l’écran d’administration alors que vous n’êtes pas administrateur (vous faites une tentativve de hacking sur vous même) !</p>
<p>Sélectionnez un Post dans la liste, et cliquez sur “modifer Post” pour charger le formulaire :</p>
<p><img src="RSRC/10_02_ORGA.png" alt="BB" /><br /></p>
<p>Saissez quelques modifications, cliquez sur le bouton “Sauvegarder” . Vous obtiendrez un message d’erreur dans la console :</p>
<p><img src="RSRC/10_03_ORGA.png" alt="BB" /><br /></p>
<p>A vous de gérer les message côté client (avec le callback “error” lors du <code>save()</code>) Et côté serveur cela vous affiche que vous devez être connecté :</p>
<p><img src="RSRC/10_04_ORGA.png" alt="BB" /><br /></p>
<p>Donc notre blog est bien &quot;sécurisé&quot;. Maintenant rafraichissez votre page et connectez vous en tant qu’administrateur. Vous obtiendrez un lien “Administration” au niveau du message de bienvenue qui vous permettra de déclencher l’affichage de l’écran d’administration :</p>
<p><img src="RSRC/10_05_ORGA.png" alt="BB" /><br /></p>
<p>Faites quelques modifications, et sauvegardez les modifications :</p>
<p><img src="RSRC/10_06_ORGA.png" alt="BB" /><br /></p>
<p>Vous pouvez ensuite vérifiez qu’elles ont bien été prises en compte :</p>
<p><img src="RSRC/10_07_ORGA.png" alt="BB" /><br /></p>
<p>Voilà. Notre application est &quot;terminée&quot;. Je sais il faut le dire vite ;) mais vous avez une base, que vous pouvez faire évoluer (il faudrait ajouter les commentaires par exemple) ou améliorer, ou mieux, cassez tout et faites votre propre application avec votre &quot;propre style&quot;.</p>
<p>Par contre, l'ouvrage n'est pas fini, j'ai encore 2,3 petites choses dont j'aimerais vous parlez.</p>
<h1 id="backbone.sync"><a href="#TOC"><span class="header-section-number">12</span> Backbone.sync()</a></h1>
<pre><code>//TODO: je n&#39;ai encore rien &quot;gratté&quot; à ce sujet (viendra probablement en dernier)</code></pre>
<h1 id="backbone-3-coffeescript"><a href="#TOC"><span class="header-section-number">13</span> Backbone &lt;3 Coffeescript</a></h1>
<blockquote>
<p><em>Sommaire</em></p>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li><em>Coffeescript</em></li>
<li><em>On s'outille</em></li>
<li><em>Traduction</em></li>
</ul>
</blockquote>
</blockquote>
<blockquote>
<p><em>Depuis longtemps, les développeurs “serveur” ont de nombreux a priori vis-à-vis de Javascript : un modèle objet “particulier” difficile à comprendre après des années de programmation orientée classes, un système d’héritage par prototype générant beaucoup d’effets de bord s’il n’est pas maîtrisé (sans compter la maintenabilité du code) et justement pas de classes en javascript, ce qui rend difficile l’organisation du code (toujours d’un point de vue approche “classique”).</em></p>
</blockquote>
<p>L’arrivée de CoffeeScript tend aujourd’hui à gommer ces problématiques et tout particulièrement par l’introduction d’un système de classes qui prend en charge (pour/à la place du développeur) toutes les problématiques liées au modèle objet Javascript, garantissant ainsi la réduction de l’apparition de bugs dus à la méconnaissance de javascript. Gardez cependant une chose à l’esprit : Coffeescript, cela reste du Javascript, mais avec une manière différente de l’écrire, plus simple, plus efficace et (à mon avis) avec moins d’erreurs. Coffeescript, vous aidera aussi à comprendre et mieux écrire le Javascript.</p>
<h2 id="coffeescript-quest-ce-que-cest"><a href="#TOC"><span class="header-section-number">13.1</span> Coffeescript qu’est-ce que c’est ?</a></h2>
<p>Coffeescript est un langage de script qui ressemble beaucoup au Python. Il a été créé par Jeremy Ashkenas, vous savez, le brillant développeur aussi à l’origine de frameworks connus tels Backbone.js et Underscore.js. Coffeescript, c’est aussi un “Transpiler” Javascript. C’est-à-dire, qu’au lieu de compiler pour obtenir un binaire, on “compile” le code Coffeescript en Javascript directement exécutable dans un navigateur (ou côté serveur avec Node.js). Classiquement, le transpiler Coffeescript s’exécute sous Node.js, mais vous pouvez très bien l’utiliser en mode “run-time” et insérer du code Coffeescript directement (inline) dans vos pages HTML. C’est moins performant, mais cela peut être utile pour debugger. L’objet de ce chapitre n’est pas de vous apprendre Coffeescript, mais de vous le présenter rapidement et vous montrer à quoi pourrait ressembler le code de la partie cliente de notre blog traduite en Coffeescript. Vous trouverez les informations complémentaire ici : <a href="http://coffeescript.org/">http://coffeescript.org/</a>.</p>
<h2 id="un-code-plus-lisible"><a href="#TOC"><span class="header-section-number">13.2</span> Un code plus lisible ?</a></h2>
<p>Donc, selon moi (et d’autres), Coffeescript permet de simplifier le javascript, générer du javascript « propre » et apporte des évolutions de langage qui vont simplifier et rendre le code plus lisible. Nous allons tenter de voir ça par le biais de quelques exemples.</p>
<h3 id="les-fonctions"><a href="#TOC"><span class="header-section-number">13.2.1</span> Les fonctions</a></h3>
<p>Le terme <code>function</code> disparaît au profit d’une « flèche » ! <code>return</code> disparaît complètement !!! (par défaut c'est la dernière ligne qui fait office de return) et les parenthèses ne sont pas partout obligatoires (ce qui facilite l’écriture de DSL) ... Et plus de point-virgule.</p>
<p><em>Fonction d’addition en javascript :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">function</span> addition (a,b) {
        <span class="kw">return</span> a+b
    }

    <span class="co">//Utilisation :</span>

    <span class="kw">var</span> c = addition(<span class="dv">45</span>, <span class="dv">12</span>)</code></pre>
<p>Deviendra :</p>
<p><em>Fonction d’addition en Coffeescript :</em></p>
<pre class="sourceCode python"><code class="sourceCode python">    addition = (a,b)-&gt;
        a+b

    <span class="co">#Utilisation :</span>

    c = addition <span class="dv">45</span>, <span class="dv">12</span></code></pre>
<h3 id="interopérabilité"><a href="#TOC"><span class="header-section-number">13.2.2</span> Interopérabilité</a></h3>
<p>Coffeescript reste compatible avec les librairies existantes (pas besoin de ré-écrire jQuery ... ouf !)</p>
<p><em>Attendre le chargement de la page pour lancer les commandes :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    $(<span class="kw">function</span>() {
        some() ;
        init() ;
        calls() ;
    }) ;</code></pre>
<p><em>La même chose en Coffeescript :</em></p>
<pre class="sourceCode python"><code class="sourceCode python">    $ -&gt;
        some()
        init()
        calls()</code></pre>
<h3 id="interpolation-et-chaînes-de-caractères"><a href="#TOC"><span class="header-section-number">13.2.3</span> Interpolation et Chaînes de caractères</a></h3>
<p>Imaginons un objet bob :</p>
<p><em>En Javascript :</em></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> bob = {
        <span class="dt">firstName </span>: <span class="st">&quot;Bob&quot;</span>,
        <span class="dt">lastName </span>: <span class="st">&quot;Morane&quot;</span>,
        <span class="dt">sayHello </span>: <span class="kw">function</span>() { <span class="kw">return</span> <span class="st">&quot;Hello !&quot;</span>}
    }</code></pre>
<p>Nous voulons afficher un message à partir des propriétés de Bob, aujourd’hui nous faisons comme ceci :</p>
<p><em>En Javascript :</em></p>
<pre class="sourceCode python"><code class="sourceCode python">    console.log(
        <span class="st">&quot;Firstname : &quot;</span> + bob.firstName + 
        <span class="st">&quot; Lastname : &quot;</span> + bob.lastName + 
        <span class="st">&quot;Hello : &quot;</span> + 
        bob.sayHello()
    ) ;</code></pre>
<p>Coffeescript introduit des nouveaux concepts à propos des chaînes de caractères et particulièrement <code>#{variable}</code> qui permet d’insérer la valeur de variable dans une chaîne. Nous aurons donc ceci :</p>
<p><em>Version Coffeescript :</em></p>
<pre class="sourceCode python"><code class="sourceCode python">    bob = 
        firstName : <span class="st">&quot;Bob&quot;</span>
        lastName : <span class="st">&quot;Morane&quot;</span>
        sayHello : -&gt;
            <span class="st">&quot;Hello !&quot;</span>

    console.log <span class="st">&quot;</span>
<span class="st">        Firstname : #{bob.firstName}</span>
<span class="st">        Lastname : #{bob.lastName}</span>
<span class="st">        Hello : #{bob.sayHello()}</span>
<span class="st">    &quot;</span></code></pre>
<blockquote>
<blockquote>
<p><strong>Remarquez au passage</strong>, la possibilité d’écrire vos chaînes de caractères sur plusieurs lignes (dans ce cas les saut de lignes ne sont pas pris en comptes, pour les prendre en comptes utilisez des triples « doubles-quotes » : &quot;&quot;&quot;)</p>
</blockquote>
</blockquote>
<h3 id="jouez-un-peu-avec-les-tableaux"><a href="#TOC"><span class="header-section-number">13.2.4</span> Jouez un peu avec les tableaux</a></h3>
<p>Nous avons le tableau suivant (en Coffeescript) :</p>
<p><em>Copains :</em></p>
<pre class="sourceCode python"><code class="sourceCode python">    copains = [
        { nom : <span class="st">&quot;Bob&quot;</span>, age : <span class="dv">30</span> }
        { nom : <span class="st">&quot;Sam&quot;</span>, age : <span class="dv">50</span> }
        { nom : <span class="st">&quot;John&quot;</span>, age : <span class="dv">20</span> }
    ]</code></pre>
<p>Nous voudrions obtenir tous les copains de moins de 50 ans :</p>
<p><em>Jeunes copains :</em></p>
<pre class="sourceCode python"><code class="sourceCode python">    Result = (copain <span class="kw">for</span> copain in copains when copain.age &lt; <span class="dv">50</span>)</code></pre>
<h2 id="et-enfin-et-surtout-les-classes"><a href="#TOC"><span class="header-section-number">13.3</span> Et enfin (et surtout ?) les classes</a></h2>
<p>Maintenant, grâce à Coffeescript, nous pouvons écrire des classes. Il faut aussi savoir ceci : le mot clé <code>this</code> devient <code>@</code>, les « champs » (propriétés) de la classes sont déclarés dans le constructeur. Mais un exemple est souvent plus parlant que trop d’explications :</p>
<h3 id="notre-1ère-classe"><a href="#TOC"><span class="header-section-number">13.3.1</span> Notre 1ère classe</a></h3>
<p><em>Classe “Human” :</em></p>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> Human
        constructor : (firstName, lastName) -&gt;
            <span class="co">#fields : @ = this</span>
            @firstName = firstName
            @lastName = lastName

        <span class="co">#method</span>
        hello : -&gt;
            console.log <span class="st">&quot;Hello #{@firstName} #{@lastName}&quot;</span>

    <span class="co">#Utilisation</span>
    Bob = new Human <span class="st">&quot;Bob&quot;</span>, <span class="st">&quot;Morane&quot;</span>

    Bob.hello()</code></pre>
<h3 id="propriétés-valeurs-par-défaut"><a href="#TOC"><span class="header-section-number">13.3.2</span> Propriétés &amp; valeurs par défaut</a></h3>
<p>Vous pouvez aller encore plus vite et déclarer vos propriétés et leur valeur par défaut directement en paramètres du constructeur.</p>
<p><em>Classe “Human”, autre version, même résultats :</em></p>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> Human
        constructor : (@firstName = <span class="st">&quot;John&quot;</span>, @lastName = <span class="st">&quot;Doe&quot;</span>) -&gt;
        hello : -&gt;
                console.log <span class="st">&quot;Hello #{@firstName} #{@lastName}&quot;</span></code></pre>
<h3 id="comme-en-java-composition-association-encapsulation"><a href="#TOC"><span class="header-section-number">13.3.3</span> Comme en Java : Composition, Association, Encapsulation</a></h3>
<p>La notion de classe apportée par Coffeescript (même s’il existe en javascript, comme nous avons pu le voir par exemple avec le modèle objet de Backbone) permet facilement de mettre en œuvre les différents concepts habituels en programmation « orientée classes » et plus facilement encore décliner les « design patterns ».</p>
<p><em>Composition de classes :</em></p>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> Dog
        constructor:(@name)-&gt;

    <span class="kw">class</span> Human
        constructor:(@first, @last, @dog)-&gt;

    Bob = new Human <span class="st">&quot;Bob&quot;</span>, <span class="st">&quot;Morane&quot;</span>, new Dog <span class="st">&quot;Wolf&quot;</span>
    console.log <span class="st">&quot;Le chien de Bob s&#39;appelle #{Bob.dog.name}&quot;</span></code></pre>
<p><em>Encapsulation de classes :</em></p>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> Human
        <span class="kw">class</span> Hand
            constructor:(@whichOne)-&gt;

        constructor:(@first, @last)-&gt;
            @leftHand = new Hand <span class="st">&quot;left&quot;</span>
            @rightHand = new Hand <span class="st">&quot;right&quot;</span>

    console.log JSON.stringify new Human <span class="st">&quot;Bob&quot;</span>, <span class="st">&quot;Morane&quot;</span></code></pre>
<h3 id="comme-en-java-les-membres-statiques"><a href="#TOC"><span class="header-section-number">13.3.4</span> Comme en Java : les membres statiques</a></h3>
<p>La définition/déclaration de membres statiques se fait pour les propriétés en dehors du constructeur cette fois-ci et pré-fixées par <code>@</code>, les méthodes statiques « commencent » elles aussi par <code>@</code> :</p>
<p><em>Toujours et encore notre classe « Human » :</em></p>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> Human
        @counter : <span class="dv">0</span> <span class="co">#static property</span>

        constructor : (@firstName, @lastName) -&gt;
            Human.counter += <span class="dv">1</span>

        <span class="co">#static method</span>
        @howMany : -&gt;
            Human.counter

    Bob = new Human <span class="st">&quot;Bob&quot;</span>, <span class="st">&quot;Morane&quot;</span>
    console.log <span class="st">&quot;Human.counter #{Human.howMany()}&quot;</span></code></pre>
<h3 id="mais-aussi-comme-en-java-lhéritage"><a href="#TOC"><span class="header-section-number">13.3.5</span> Mais aussi (comme en Java) : l’héritage !</a></h3>
<p>Coffeescript introduit le mot clé <code>extends</code> pour permettre à une classe d’hériter d’une autre classe, et cela s’utilise de façon très intuitive :</p>
<p><em>Un humain, et un super héros qui hérite d’humain … :</em></p>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> Human
        constructor : (@firstName, @lastName) -&gt;

        hello : -&gt;
            <span class="st">&quot;Hello #{@firstName} #{@lastName}&quot;</span>

    <span class="kw">class</span> Superhero extends Human
        constructor : (@firstName, @lastName, @name) -&gt;

        hello : -&gt;
            <span class="dt">super</span> + <span class="st">&quot; known as #{@name}&quot;</span>

    SuperMan = new Superhero <span class="st">&quot;Clark&quot;</span>, <span class="st">&quot;Kent&quot;</span>, <span class="st">&quot;SuperMan&quot;</span>
    console.log SuperMan.hello()</code></pre>
<blockquote>
<blockquote>
<p><strong>Notez au passage</strong> l’apparition du mot-clé super qui permet « d’appeler » la méthode du « parent ».</p>
</blockquote>
</blockquote>
<p>Une première conclusion s’impose : Maintenant vous pouvez faire du javascript « orienté classes » tout en conservant les possibilités actuelles de javascript.</p>
<h2 id="jaime-je-naime-pas"><a href="#TOC"><span class="header-section-number">13.4</span> J’aime / Je n’aime pas</a></h2>
<p>Coffeescript fait beaucoup de bruit dans la communauté javascript, mais aussi du côtés des développeurs java, .Net, etc. ... Il a été assez bien adopté par les développeurs Ruby car il a une syntaxe assez proche.</p>
<p>Ce qui plaît beaucoup, plus particulièrement aux développeurs « non javascript », c’est le concept de classes, mais les développeurs javascript « puristes » ne voient pas l’intérêt d’utiliser des classes, les concepts objet de javascript apparaîssant largement suffisants.</p>
<blockquote>
<blockquote>
<p>Personnellement, si l’aspect classe doit contribuer à l’adoption de javascript, laissons les classes ! Il y a encore trop de développeurs rebutés par javascript pour de fausses raisons. Ce n’est probablement pas pour rien si le concept de classe apparaît dans la future version de javascript ES6.</p>
</blockquote>
</blockquote>
<p>Ce qui plaît beaucoup moins, et là les développeurs javascripts et java se rejoignent, c’est l’abscence de points virgule, d’accolades, et la notion d’indentation « significative » comme en python, rendant le code difficilement lisible s’il est trop long.</p>
<blockquote>
<blockquote>
<p>D’autres vous diront que la simplification du code grâce à Coffeescript contribue à sa lisibilité. Comme quoi, les goûts et les couleurs ...</p>
</blockquote>
</blockquote>
<p>Le plus gros défaut de Coffeescript, reste la difficulté à debbuger du code coffeescript, l’impossibilité de l’utiliser directement dans la console du navigateur. Cependant le projet <strong>Source Map</strong> devrait régler ce type de problème à l’avenir (et pour d’autres transpilers aussi) : <a href="http://www.coffeescriptlove.com/2012/04/source-maps-for-coffeescript.html">http://www.coffeescriptlove.com/2012/04/source-maps-for-coffeescript.html</a>.</p>
<p>On pourrait ensuite se demander, mais que va devenir Coffeescript dans le futur avec l’apparition de la nouvelle version de javascript ? Je vous répondrais, qu’avant que cette version soit déployée sur tous les postes de travail (donc que tout le monde dispose d’un navigateur de dernière génération) il va se passer plusieurs années et que Coffeescript génère du code javascript qui fonctionne sur la majorité des navigateurs existants.</p>
<p>Brendan Heich (le papa de javascript) a officiellement donné sa bénédiction « publique » à Coffeescript, nul doute que Jeremy Ashkenas ne fasse évoluer Coffeescript en fonction des spécifications javascript pour garder une compatibilté ascendante et descendante. Pour rappel, en début de page du site de Coffeescript, il est écrit : <strong>« The golden rule of CoffeeScript is: &quot;It's just JavaScript&quot; »</strong>.</p>
<blockquote>
<blockquote>
<p>Pour ma part, je pense que c’est un excellent outil d’apprentissage (il génère du code javascript « propre ») mais sur un projet de réalisation professionnel, il est à réserver aux « gurus » qui maîtrise déjà javascript.</p>
</blockquote>
</blockquote>
<p>Attention, un challenger de poids vient de naître dans le monde des transpilers javascript : <strong>TypeScript</strong>, porté par Microsoft, développé entre autre par le papa de l’ancêtre du Turbo Pascal mais aussi du C# et qui tend à gommer une grande partie des défauts reprochés à Coffeescript. Cela fera l’objet d’un prochain chapitre, mais avant cela, passons à la ré-écriture de notre Blog en Coffeescript.</p>
<h2 id="ré-écriture-de-notre-blog-soutiller"><a href="#TOC"><span class="header-section-number">13.5</span> Ré-écriture de notre blog ?! S'outiller</a></h2>
<p>Avant toute chose, sauvegardez votre arborescence applicative à un autre emplacement pour pouvoir la réutiliser.</p>
<h3 id="installation-de-coffeescript"><a href="#TOC"><span class="header-section-number">13.5.1</span> Installation de Coffeescript</a></h3>
<p>L’installation de Coffeescript est très simple, elle s’effectue en mode commande avec npm (installé en même temps que Node.js) :</p>
<pre><code>npm install –g coffee-script</code></pre>
<blockquote>
<blockquote>
<p><strong>Remarque :</strong> pour les utilisateurs sous OSX, vous devez normalement utiliser la commande <code>sudo npm install –g coffee-script</code></p>
</blockquote>
</blockquote>
<p>A partir de maintenant, vous pouvez compiler/transpiler du code Coffeescript en javascript avec la commande suivante :</p>
<pre><code>coffee –compile Human.coffee</code></pre>
<p>qui produira un fichier javascript <code>Human.js</code>.</p>
<p>Pour plus d’informations : <a href="http://jashkenas.github.com/coffee-script/#usage">http://jashkenas.github.com/coffee-script/#usage</a>.</p>
<h3 id="industrialisation-de-la-transpilation"><a href="#TOC"><span class="header-section-number">13.5.2</span> “Industrialisation” de la transpilation</a></h3>
<p>Nous avons donc décidé de re-écrire la partie javascript cliente de notre blog. Pour cela dans le répertoire de notre application, créez un répertoire <code>public.coffee</code> avec un sous-répertoire <code>models</code> et un sous répertoire <code>views</code>. Ce répertoire et ces deux sous-répertoires contiendrons les fichiers source coffeescript (que vous pouvez d’ores et déjà créer “vides” dans les répertoires correspondants) :</p>
<pre><code>public.coffee\
              |-models\
              |        |-post.coffee
              |-views\
              |       |-AdminView.coffee
              |       |-LoginView.coffee
              |       |-MainView.coffee
              |       |-PostsListView.coffee
              |       |-PostView.coffee
              |       |-SidebarView.coffee
              |       
              |-Blog.coffee
              |-main.coffee
              |-routes.coffee</code></pre>
<p>Le “but du jeu” étant de transpiler tous les fichiers <code>.coffee</code> en fichier javascript <code>.js</code> dans le répertoire <code>public</code> (et ses sous-répertoire). Faire ceci “à la main” en prenant les fichiers un par un peut devenir très rapidement fastidieux. Mais heureusement, l’installation de Coffeescript inclut un système simple de “build” qui s’appelle <strong>Cake</strong>, qui est capable d’effectuer des tâches simples décrites dans un fichier <code>Cakefile</code>. Plus d’information ici : <a href="http://jashkenas.github.com/coffee-script/#cake">http://jashkenas.github.com/coffee-script/#cake</a>.</p>
<p>Donc à la racine de votre application, créez un fichier <code>Cakefile</code> avec le contenu suivant :</p>
<p><em>Cakefile :</em></p>
<pre class="sourceCode python"><code class="sourceCode python">    fs = require <span class="st">&#39;fs&#39;</span>
    {<span class="kw">print</span>} = require <span class="st">&#39;util&#39;</span>
    {spawn} = require <span class="st">&#39;child_process&#39;</span>

    build = (callback) -&gt;
        coffee = spawn <span class="st">&#39;coffee&#39;</span>, [<span class="st">&#39;-c&#39;</span>, <span class="st">&#39;-o&#39;</span>, <span class="st">&#39;public&#39;</span>, <span class="st">&#39;public.coffee&#39;</span>] 
        coffee.stderr.on <span class="st">&#39;data&#39;</span>, (data) -&gt;
            process.stderr.write data.toString()
        coffee.stdout.on <span class="st">&#39;data&#39;</span>, (data) -&gt; 
            <span class="kw">print</span> data.toString()
        coffee.on <span class="st">&#39;exit&#39;</span>, (code) -&gt; 
            callback?() <span class="kw">if</span> code is <span class="dv">0</span>

    task <span class="st">&#39;build&#39;</span>, <span class="st">&#39;Build public/ from public.coffee/&#39;</span>, -&gt; 
        build()</code></pre>
<p>En fait nous expliquons à Cake que nous souhaitons transpiler en javascript tous les fichiers du répertoire source <code>public.coffee</code> vers le répertoire cible <code>public</code>. Et pour cela, il suffira, dans un terminal (ou une console) de lancer la commande : <code>cake build</code> (à la racine de notre application, là où est situé le fichier <code>Cakefile</code>).</p>
<h2 id="ré-écriture-traductions"><a href="#TOC"><span class="header-section-number">13.6</span> Ré-écriture / Traductions</a></h2>
<p>Alors, l’objectif n’est pas d’apprendre Coffeescript (cela pourrait donner lieu à un ouvrage entier), mais de montrer comment il est possible d’écrire notre blog “autrement”, donc je vous livre ici la traduction en Coffeescript (pas forcément dans les règles de l’art) qui fonctionnera et assortie de quelques remarques.</p>
<h3 id="blog.coffee"><a href="#TOC"><span class="header-section-number">13.6.1</span> Blog.coffee</a></h3>
<pre class="sourceCode python"><code class="sourceCode python">    window.Blog = 
      Models : {}
      Collections : {}
      Views : {}
      Router : {}</code></pre>
<h3 id="main.coffee"><a href="#TOC"><span class="header-section-number">13.6.2</span> main.coffee</a></h3>
<pre class="sourceCode python"><code class="sourceCode python">    yepnope
      load:
        jquery: <span class="st">&quot;libs/vendors/jquery-1.7.2.js&quot;</span>
        underscore: <span class="st">&quot;libs/vendors/underscore.js&quot;</span>
        backbone: <span class="st">&quot;libs/vendors/backbone.js&quot;</span>
        mustache: <span class="st">&quot;libs/vendors/mustache.js&quot;</span>

        <span class="co">#NameSpace</span>
        blog: <span class="st">&quot;Blog.js&quot;</span>

        <span class="co">#Models</span>
        posts: <span class="st">&quot;models/post.js&quot;</span>

        <span class="co">#Controllers</span>
        sidebarview: <span class="st">&quot;views/SidebarView.js&quot;</span>
        postslistviews: <span class="st">&quot;views/PostsListView.js&quot;</span>
        mainview: <span class="st">&quot;views/MainView.js&quot;</span>
        loginview: <span class="st">&quot;views/LoginView.js&quot;</span>
        postview: <span class="st">&quot;views/PostView.js&quot;</span>
        adminview: <span class="st">&quot;views/AdminView.js&quot;</span>

        <span class="co">#Routes</span>
        routes: <span class="st">&quot;routes.js&quot;</span>

      callback:
        routes: -&gt;
          console.log <span class="st">&quot;routes loaded ...&quot;</span>

      complete: -&gt;
        $ -&gt;
          console.log <span class="st">&quot;Lauching application ...&quot;</span>
          window.blogPosts = new Blog.Collections.Posts()
          window.mainView = new Blog.Views.MainView(collection: blogPosts)

          <span class="co">#======= Admin =======</span>
          window.adminView = new Blog.Views.AdminView(collection: blogPosts)


          <span class="co">#======= Authentification =======</span>
          window.loginView = new Blog.Views.LoginView(adminView: adminView)

          window.postView = new Blog.Views.PostView()
          window.router = new Blog.Router.RoutesManager(collection: blogPosts)

          Backbone.history.start()</code></pre>
<h3 id="post.coffee"><a href="#TOC"><span class="header-section-number">13.6.3</span> post.coffee</a></h3>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> Blog.Models.Post extends Backbone.Model
      urlRoot:<span class="st">&quot;/blogposts&quot;</span>

    <span class="kw">class</span> Blog.Collections.Posts extends Backbone.Collection

      model: Blog.Models.Post

      <span class="dt">all</span>: -&gt;
        @url = <span class="st">&quot;/blogposts&quot;</span>
        @

      query: (query) -&gt;
        @url = <span class="st">&quot;/blogposts/query/&quot;</span> + query
        @    </code></pre>
<h3 id="adminview.coffee"><a href="#TOC"><span class="header-section-number">13.6.4</span> AdminView.coffee</a></h3>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> Blog.Views.AdminView extends Backbone.View
      el: $ <span class="st">&quot;#admin&quot;</span>
      initialize: -&gt;
        @template = $(<span class="st">&quot;#admin_template&quot;</span>).html()

        <span class="co">#je prévois de trier ma collection</span>
        @collection.comparator = (model) -&gt;
          -(new Date(model.get(<span class="st">&quot;date&quot;</span>)).getTime())

      render: -&gt;
        renderedContent = Mustache.to_html(@template,
          posts: @collection.toJSON()
        )
        @$el.html renderedContent

      events:
        <span class="st">&quot;click  #btn_update&quot;</span>: <span class="st">&quot;onClickBtnUpdate&quot;</span>
        <span class="st">&quot;click  #btn_create&quot;</span>: <span class="st">&quot;onClickBtnCreate&quot;</span>
        <span class="st">&quot;click  #btn_send&quot;</span>: <span class="st">&quot;sendPost&quot;</span>

      onClickBtnUpdate: -&gt;
        selectedId = $(<span class="st">&quot;#post_choice&quot;</span>).val()
        post = @collection.get(selectedId)

        <span class="co">#Je récupère les informations du post et les affiche</span>
        $(<span class="st">&quot;#admin &gt; [name=&#39;id&#39;]&quot;</span>).html post.get(<span class="st">&quot;id&quot;</span>)
        $(<span class="st">&quot;#admin &gt; [name=&#39;author&#39;]&quot;</span>).val post.get(<span class="st">&quot;author&quot;</span>)
        $(<span class="st">&quot;#admin &gt; [name=&#39;title&#39;]&quot;</span>).val post.get(<span class="st">&quot;title&quot;</span>)
        $(<span class="st">&quot;#admin &gt; [name=&#39;message&#39;]&quot;</span>).val post.get(<span class="st">&quot;message&quot;</span>)

      onClickBtnCreate: -&gt;

        <span class="co">#je ré-initialise les zones de saisie</span>
        $(<span class="st">&quot;#admin &gt; [name=&#39;id&#39;]&quot;</span>).html <span class="st">&quot;&quot;</span>
        $(<span class="st">&quot;#admin &gt; [name=&#39;author&#39;]&quot;</span>).val <span class="st">&quot;&quot;</span>
        $(<span class="st">&quot;#admin &gt; [name=&#39;title&#39;]&quot;</span>).val <span class="st">&quot;&quot;</span>
        $(<span class="st">&quot;#admin &gt; [name=&#39;message&#39;]&quot;</span>).val <span class="st">&quot;&quot;</span>

      sendPost: -&gt; <span class="co">#Sauvegarde</span>
        <span class="co">#that = this #pour conserver le contexte</span>
        <span class="dt">id</span> = $(<span class="st">&quot;#admin &gt; [name=&#39;id&#39;]&quot;</span>).html()
        post = undefined
        <span class="kw">if</span> <span class="dt">id</span> is <span class="st">&quot;&quot;</span> <span class="co">#si l&#39;id est vide c&#39;est une création</span>
          post = new Blog.Models.Post()
        <span class="kw">else</span> <span class="co">#l&#39;id n&#39;est pas vide c&#39;est une mise à jour</span>
          post = new Blog.Models.Post(<span class="dt">id</span>: $(<span class="st">&quot;#admin &gt; [name=&#39;id&#39;]&quot;</span>).html())
        post.save
          author: $(<span class="st">&quot;#admin &gt; [name=&#39;author&#39;]&quot;</span>).val()
          title: $(<span class="st">&quot;#admin &gt; [name=&#39;title&#39;]&quot;</span>).val()
          message: $(<span class="st">&quot;#admin &gt; [name=&#39;message&#39;]&quot;</span>).val()
          date: new Date()
        ,
          success: -&gt;

            <span class="co">#Si la transaction côté serveur a fonctionné</span>

            <span class="co">#je recharge ma collection</span>
            @collection.fetch success: =&gt;

              <span class="co">#mise à jour de la vue admin</span>
              @render()



          <span class="co">#La vue principale se re-mettra à jour</span>
          <span class="co">#automatiquement, car elle est &quot;abonnée&quot;</span>
          <span class="co">#aux changement de la collection</span>
          error: -&gt;</code></pre>
<pre><code>//TODO : parler de fat arrow =&gt;</code></pre>
<h3 id="loginview.coffee"><a href="#TOC"><span class="header-section-number">13.6.5</span> LoginView.coffee</a></h3>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> Blog.Views.LoginView extends Backbone.View
      el: $ <span class="st">&quot;#blog_login_form&quot;</span>
      initialize: (args) -&gt;
        that = this
        @adminView = args.adminView
        @template = $(<span class="st">&quot;#blog_login_form_template&quot;</span>).html()

        <span class="co">#on vérifie si pas déjà authentifié</span>
        $.ajax
          <span class="dt">type</span>: <span class="st">&quot;GET&quot;</span>
          url: <span class="st">&quot;/alreadyauthenticated&quot;</span>
          error: (err) -&gt;
            console.log err

          success: (dataFromServer) -&gt;
            <span class="kw">if</span> dataFromServer.firstName
              that.render <span class="st">&quot;Bienvenue&quot;</span>, dataFromServer
            <span class="kw">else</span>
              that.render <span class="st">&quot;???&quot;</span>,
                firstName: <span class="st">&quot;John&quot;</span>
                lastName: <span class="st">&quot;Doe&quot;</span>



      render: (message, user) -&gt;
        renderedContent = Mustache.to_html(@template,
          message: message
          firstName: (<span class="kw">if</span> user then user.firstName <span class="kw">else</span> <span class="st">&quot;&quot;</span>)
          lastName: (<span class="kw">if</span> user then user.lastName <span class="kw">else</span> <span class="st">&quot;&quot;</span>)

          <span class="co">#adminLink : user.isAdmin ? &#39;#/admin&#39; : &quot;&quot;,</span>
          adminLinkLabel: 
            (<span class="kw">if</span> user then (<span class="kw">if</span> user.isAdmin then <span class="st">&quot;Administration&quot;</span> <span class="kw">else</span> <span class="st">&quot;&quot;</span>) <span class="kw">else</span> <span class="st">&quot;&quot;</span>)
        )
        @$el.html renderedContent

      events:
        <span class="st">&quot;click  .btn-primary&quot;</span>: <span class="st">&quot;onClickBtnLogin&quot;</span>
        <span class="st">&quot;click  .btn-inverse&quot;</span>: <span class="st">&quot;onClickBtnLogoff&quot;</span>
        <span class="st">&quot;click #adminbtn&quot;</span>: <span class="st">&quot;displayAdminPanel&quot;</span>

      displayAdminPanel: -&gt;
        @adminView.render()

      onClickBtnLogin: (domEvent) -&gt;
        fields = $(<span class="st">&quot;#blog_login_form :input&quot;</span>)
        <span class="co">#that = this</span>
        $.ajax
          <span class="dt">type</span>: <span class="st">&quot;POST&quot;</span>
          url: <span class="st">&quot;/authenticate&quot;</span>
          data:
            email: fields[<span class="dv">0</span>].value
            password: fields[<span class="dv">1</span>].value

          dataType: <span class="st">&quot;json&quot;</span>
          error: (err) -&gt;
            console.log err

          success: (dataFromServer) =&gt;
            <span class="kw">if</span> dataFromServer.infos
              @render dataFromServer.infos
            <span class="kw">else</span>
              <span class="kw">if</span> dataFromServer.error
                @render dataFromServer.error
              <span class="kw">else</span>
                @render <span class="st">&quot;Bienvenue&quot;</span>, dataFromServer


      onClickBtnLogoff: =&gt;
        <span class="co">#that = this</span>
        $.ajax
          <span class="dt">type</span>: <span class="st">&quot;GET&quot;</span>
          url: <span class="st">&quot;/logoff&quot;</span>
          error: (err) -&gt;
            console.log err

          success: (dataFromServer) -&gt;
            console.log dataFromServer
            @render <span class="st">&quot;???&quot;</span>,
              firstName: <span class="st">&quot;John&quot;</span>
              lastName: <span class="st">&quot;Doe&quot;</span>   </code></pre>
<h3 id="postslistview.coffee"><a href="#TOC"><span class="header-section-number">13.6.6</span> PostsListView.coffee</a></h3>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> Blog.Views.PostsListView extends Backbone.View
      el: $ <span class="st">&quot;#posts_list&quot;</span>
      initialize: -&gt;
        @template = $(<span class="st">&quot;#posts_list_template&quot;</span>).html()

      render: -&gt;
        renderedContent = Mustache.to_html(@template,
          posts: @collection.toJSON()
        )
        @$el.html renderedContent</code></pre>
<h3 id="postview.coffee"><a href="#TOC"><span class="header-section-number">13.6.7</span> PostView.coffee</a></h3>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> Blog.Views.PostView extends Backbone.View
      el: $ <span class="st">&quot;#posts_list&quot;</span>
      initialize: -&gt;
        @template = $(<span class="st">&quot;#post_details_template&quot;</span>).html()

      render: (post) -&gt;
        renderedContent = Mustache.to_html(@template,
          post: post.toJSON()
        )
        @$el.html renderedContent</code></pre>
<h3 id="sidebarview.coffee"><a href="#TOC"><span class="header-section-number">13.6.8</span> SidebarView.coffee</a></h3>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> Blog.Views.SidebarView extends Backbone.View
      el: $ <span class="st">&quot;#blog_sidebar&quot;</span>
      initialize: -&gt;
        @template = $(<span class="st">&quot;#blog_sidebar_template&quot;</span>).html()

      render: -&gt;
        renderedContent = Mustache.to_html(@template,
          posts: @collection.toJSON()
        )
        @$el.html renderedContent</code></pre>
<h3 id="mainview.coffee"><a href="#TOC"><span class="header-section-number">13.6.9</span> MainView.coffee</a></h3>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> Blog.Views.MainView extends Backbone.View
      initialize: -&gt;
        @collection.comparator = (model) -&gt;
          -(new Date(model.get(<span class="st">&quot;date&quot;</span>)).getTime())

        _.bindAll this, <span class="st">&quot;render&quot;</span>
        @collection.bind <span class="st">&quot;reset&quot;</span>, @render
        @collection.bind <span class="st">&quot;change&quot;</span>, @render
        @collection.bind <span class="st">&quot;add&quot;</span>, @render
        @collection.bind <span class="st">&quot;remove&quot;</span>, @render
        @sidebarView = new Blog.Views.SidebarView()
        @postsListView = new Blog.Views.PostsListView(collection: @collection)

      render: -&gt;

        @sidebarView.collection = new Blog.Collections.Posts(@collection.first(<span class="dv">3</span>))
        @sidebarView.render()
        @postsListView.render()</code></pre>
<h3 id="routes.coffee"><a href="#TOC"><span class="header-section-number">13.6.10</span> routes.coffee</a></h3>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> Blog.Router.RoutesManager extends Backbone.Router
      initialize: (args) -&gt;
        @collection = args.collection

      routes:
        <span class="st">&quot;post/:id_post&quot;</span>: <span class="st">&quot;displayPost&quot;</span>
        hello: <span class="st">&quot;hello&quot;</span>
        <span class="st">&quot;*path&quot;</span>: <span class="st">&quot;root&quot;</span>

      root: -&gt;
        @collection.<span class="dt">all</span>().fetch success: (result) -&gt;

          <span class="co">#ça marche !!!</span>
          console.log <span class="st">&quot;fetching collection&quot;</span>, result


      hello: -&gt;
        $(<span class="st">&quot;.hero-unit &gt; h1&quot;</span>).html <span class="st">&quot;Hello World !!!&quot;</span>

      displayPost: (id_post) -&gt;
        tmp = new Blog.Models.Post(<span class="dt">id</span>: id_post)
        tmp.fetch success: (result) -&gt;
          postView.render result</code></pre>
<p>Ouf, c'est fini.</p>
<h3 id="transpilons"><a href="#TOC"><span class="header-section-number">13.6.11</span> Transpilons</a></h3>
<p>Si vous lancez la commande : <code>cake build</code> vous obtiendrez de nouveau fichiers javascript dans le répertoire public. Relancez votre application, vous noterez qu’elle fonctionne comme avant.</p>
<h3 id="conclusions"><a href="#TOC"><span class="header-section-number">13.6.12</span> Conclusion(s)</a></h3>
<p>Les conclusions sont très personnelles. J'aime beaucoup le principe de &quot;classe&quot; et je le trouve très utile pour organiser son code, tout particulièrement en ce qui concerne les modèles et les collections. Au passage, vous avez du remarquer que le modèle objet de Backbone se marie parfaitement avec celui de Coffeescript (on peut hériter directement d'un Backbone.Model par exemple). C'est normal, les 2 outils sont codés par le même auteur.</p>
<p>Ce que j'aime aussi, c'est les possibilités des chaînes de caractères.</p>
<p>Par contre, je trouve que pour des portions de code très longue, on perd en visibilité (cf. <code>AdminView</code> ou <code>LoginView</code>) (mais ça n'engage que moi).</p>
<p>Cependant, je ne peux m'empêcher d'aimer ce &quot;petit&quot; langage et les concepts qu'il apporte.</p>
<p>... A vous de voir ;)</p>
<h1 id="autres-frameworks-mvc"><a href="#TOC"><span class="header-section-number">14</span> Autres Frameworks MVC</a></h1>
<blockquote>
<p><em>Sommaire</em></p>
</blockquote>
<blockquote>
<blockquote>
<ul>
<li><em>CanJS</em></li>
<li><em>Spine</em></li>
<li><em>Knockout</em></li>
<li><em>Les autres ...</em></li>
</ul>
</blockquote>
</blockquote>
<blockquote>
<p><em>Il faut aller voir ailleurs !!! Backbone peut ne pas correspondre à vos attentes, à votre façon de coder, ... Je vous engage à tester d'autres frameworks.</em></p>
</blockquote>
<blockquote>
<p><em>Il existe aujourd’hui de TRES nombreux frameworks MVC en javascript “côté navigateur”. Certains fournissent beaucoup plus de services que Backbone, d’autres vont même plus loin, puisqu’ils vont jusqu’à fournir un framework associé côté serveur (en javascript avec du nodejs). Ils sont plus ou moins complexes, plus ou moins bien documentés.</em></p>
</blockquote>
<p>L'objectif de ce chapitre n'est pas de faire un cours sur tous les frameworks javascript existants (chacun mériterait un ouvrage), mais de lever un coin de voile sur eux, et montrer que chacun possède ses spécificités. J'en ai sélectionné 2, sur un seul critère de sélection (qui me tient à coeur) : <strong>LA SIMPLICITE</strong> (après la notion de simplicité d'un dev à l'autre, est relative ...), il faut que le framework soit simple à mettre en oeuvre, sans pour autant être obligé de le connaître par coeur avant de pouvoir l'utiliser. Autrement dit, si au bout d’un quart d’heure de lecture, vous avez compris les principes de bases, le framework que vous étudiez est susceptible d’être facilement compréhensible par le reste de votre équipe (par exemple) et donc vous ne devriez pas avoir de frein à l’adoption. Si au bout d’une demi-heure, vous n’êtes pas arrivé à l’installé correctement, vous pouvez commencer à avoir des doutes (c’est une méthode très personnelle, si elle ne garantit pas les fonctionnalités du framework, elle vous assure au moins sa simplicité). La qualité de la documentation peut avoir un impact fort dans vos choix.</p>
<h2 id="canjs"><a href="#TOC"><span class="header-section-number">14.1</span> CanJS</a></h2>
<p><a href="http://canjs.us">http://canjs.us</a></p>
<p><strong>CanJS</strong> n'est pas le plus léger des frameworks, mais son approche est très intéressante et relativement intuitive, tout particulièrement pour des développeurs &quot;backend&quot;. D'un point de vue objet, on retrouve dès le départ le concept de méthode statique dans le modèle, et c'est la &quot;pseudo classe&quot; modèle qui se chargera de &quot;ramener&quot; un modèle, mais aussi la liste des modèles (alors que dans Backbone, c'est un objet à part : la collection qui s’en charge). Mais un exemple sera tout de suite beaucoup plus parlant :</p>
<p><strong>Définition d’un modèle :</strong></p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Post = <span class="kw">can</span>.<span class="fu">Model</span>({
      <span class="dt">findAll </span>: <span class="ch">&#39;GET /blogposts&#39;</span>,
      <span class="dt">findOne </span>: <span class="ch">&#39;GET /blogposts/{id}&#39;</span>,
      <span class="dt">create  </span>: <span class="ch">&#39;POST /blogposts&#39;</span>,
      <span class="dt">update  </span>: <span class="ch">&#39;PUT /blogposts/{id}&#39;</span>,
      <span class="dt">destroy </span>: <span class="ch">&#39;DELETE /blogposts/{id}&#39;</span>
    }, {});</code></pre>
<p>Ensuite si je souhaite “récupérer” du serveur un modèle particulier par son id :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">Blog.Post</span>.<span class="fu">findOne</span>({<span class="dt">id</span>:<span class="st">&quot;2o03macl&quot;</span>},<span class="kw">function</span>(post){<span class="kw">console</span>.<span class="fu">log</span>(post);})</code></pre>
<p>Puis, si je veux tous les modèles :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">Blog.Post</span>.<span class="fu">findAll</span>({}, <span class="kw">function</span>(posts){ <span class="kw">console</span>.<span class="fu">log</span>(posts);});</code></pre>
<p>... qui me retournera un tableau de modèles.</p>
<p>Vous remarquerez que l'on définit toutes les routes au niveau du modèle, et non pas une seule url comme dans Backbone.</p>
<p>Question templating, <strong>CanJS</strong> embarque son propre langage de template qui ressemble fortement à celui d'Underscore (mais rien ne vous empêche d'utiliser autre chose). Côté &quot;DOM&quot;, <strong>CanJS</strong> sait travailler avec jQuery, Zepto, Dojo, Mootools et YUI, à vous de faire votre choix et de télécharger la version adaptée.</p>
<h3 id="mise-en-oeuvre-rapide"><a href="#TOC"><span class="header-section-number">14.1.1</span> Mise en oeuvre rapide</a></h3>
<p>Pour notre exemple, j’ai utilisez la version de CanJS adaptée pour jQuery, que vous pouvez télécharger ici : <a href="https://github.com/downloads/jupiterjs/canjs/can.jquery-1.0.7.js">https://github.com/downloads/jupiterjs/canjs/can.jquery-1.0.7.js</a> et que vous copierez ensuite dans <code>public/libs/vendors</code> (nous utilisons notre application pour pouvoir se connecter à la partie serveur).</p>
<p>Dans notre répertoire public (à la racine), créez une page <code>index.canjs.html</code> avec le code suivant :</p>
<p><em>Index.canjs.html :</em></p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
    <span class="kw">&lt;html&gt;</span>
    <span class="kw">&lt;head&gt;</span>
        <span class="kw">&lt;meta</span><span class="ot"> http-equiv=</span><span class="st">&quot;Content-Type&quot;</span><span class="ot"> content=</span><span class="st">&quot;text/html; charset=utf-8&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;title&gt;</span>CanJS<span class="kw">&lt;/title&gt;</span>
        <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">&quot;libs/vendors/bootstrap/css/bootstrap.css&quot;</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;style&gt;</span>
            body <span class="kw">{</span>
                <span class="kw">padding-top:</span> <span class="dt">60px</span><span class="kw">;</span>
                <span class="kw">padding-bottom:</span> <span class="dt">40px</span><span class="kw">;</span>
            <span class="kw">}</span>
        <span class="kw">&lt;/style&gt;</span>
        <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">&quot;libs/vendors/bootstrap/css/bootstrap-responsive.css&quot;</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;/head&gt;</span>

    <span class="kw">&lt;body&gt;</span>

        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar navbar-fixed-top&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-inner&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;</span>
                    <span class="kw">&lt;a</span><span class="ot"> class=</span><span class="st">&quot;brand&quot;</span><span class="kw">&gt;</span>Mon Blog avec CanJS<span class="kw">&lt;/a&gt;</span>
                <span class="kw">&lt;/div&gt;</span>
            <span class="kw">&lt;/div&gt;</span>
        <span class="kw">&lt;/div&gt;</span>

        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container-fluid&quot;</span><span class="kw">&gt;</span>

            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;row-fluid&quot;</span><span class="kw">&gt;</span>

                <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/ejs&quot;</span><span class="ot"> id=</span><span class="st">&quot;myposts_template&quot;</span><span class="kw">&gt;</span>
                  &lt;% <span class="kw">for</span>( <span class="kw">var</span> i = <span class="dv">0</span>; i &lt; <span class="kw">this</span>.<span class="fu">length</span>; i++ ) { %&gt;
                    &lt;li&gt;
                        &lt;b&gt;&lt;%= <span class="kw">this</span>[i].<span class="fu">title</span> %&gt;&lt;/b&gt;
                        &lt;br&gt;
                        &lt;p&gt;&lt;%= <span class="kw">this</span>[i].<span class="fu">message</span> %&gt;&lt;/p&gt;
                        &lt;hr&gt;
                    &lt;/li&gt;
                  &lt;% } %&gt;
                <span class="kw">&lt;/script&gt;</span>

                <span class="kw">&lt;ul</span><span class="ot"> id=</span><span class="st">&quot;myposts&quot;</span><span class="kw">&gt;&lt;/ul&gt;</span>

            <span class="kw">&lt;/div&gt;</span>

        <span class="kw">&lt;/div&gt;</span>

    <span class="kw">&lt;/body&gt;</span>

    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/yepnope.1.5.4-min.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>

    <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/javascript&quot;</span><span class="kw">&gt;</span>
    yepnope({
        <span class="dt">load</span>: {
            <span class="dt">jquery              </span>: <span class="ch">&#39;libs</span>/<span class="ch">vendors</span>/<span class="ch">jquery</span>-1.7.2.<span class="ch">js&#39;</span>,
            <span class="dt">canjs               </span>: <span class="ch">&#39;libs</span>/<span class="ch">vendors</span>/<span class="ch">can</span>.<span class="ch">jquery</span>-1.0.7.<span class="ch">js&#39;</span>
        },

        <span class="dt">complete </span>: <span class="kw">function</span> () {
            $(<span class="kw">function</span> (){

                <span class="kw">window</span>.<span class="fu">Blog</span> = {}

                <span class="kw">Blog</span>.<span class="fu">Post</span> = <span class="kw">can</span>.<span class="fu">Model</span>({
                  <span class="dt">findAll </span>: <span class="ch">&#39;GET</span> /<span class="ch">blogposts&#39;</span>,
                  <span class="dt">findOne </span>: <span class="ch">&#39;GET</span> /<span class="ch">blogposts</span>/{<span class="ch">id</span>}<span class="ch">&#39;</span>,
                  <span class="dt">create  </span>: <span class="ch">&#39;POST</span> /<span class="ch">blogposts&#39;</span>,
                  <span class="dt">update  </span>: <span class="ch">&#39;PUT</span> /<span class="ch">blogposts</span>/{<span class="ch">id</span>}<span class="ch">&#39;</span>,
                  <span class="dt">destroy </span>: <span class="ch">&#39;DELETE</span> /<span class="ch">blogposts</span>/{<span class="ch">id</span>}<span class="ch">&#39;</span>
                }, {});

                <span class="kw">Blog.Post</span>.<span class="fu">findAll</span>({}, <span class="kw">function</span>(posts){ 
                    $(<span class="ch">&#39;</span>#<span class="ch">myposts&#39;</span>).<span class="fu">html</span>(<span class="kw">can</span>.<span class="fu">view</span>( <span class="ch">&#39;myposts</span>_<span class="ch">template&#39;</span>, posts ))
                });
            });  
        }
    });

    <span class="kw">&lt;/script&gt;</span>
    <span class="kw">&lt;/html&gt;</span></code></pre>
<p>Nous avons conservé le mécanisme de chargement de yepnope et jQuery, donc une fois le chargement de la page terminé, nous avons défini notre modèle avec les routes nécessaires pour accéder aux services de données, puis nous exécutons un <code>findAll</code> pour obtenir la liste des posts sur le serveur et l’affichons dans la page une fois les données récupérées grâce à l’objet <code>can.view</code>.</p>
<p>Vous n’avez plus qu’à enregistrer et relancer votre application et ouvrir l’url :</p>
<p><code>http://localhost:3000/index.canjs.html</code> dans votre navigateur, pour obtenir la liste des posts :</p>
<p><img src="RSRC/13_01_MVC.png" alt="BB" /><br /></p>
<h3 id="conclusion-sur-canjs"><a href="#TOC"><span class="header-section-number">14.1.2</span> Conclusion sur CanJS</a></h3>
<p>Je trouve CanJS facile d'accès. Il propose de nombreux plug-ins et apparaît très complet. Pour le moment, le projet semble actif. D'un point de vue code, il n'a pas la concision de Backbone, il y a beaucoup plus de chose, mais il propose aussi beaucoup plus de services “clés en main”. Un autre avantage non négligeable est la documentation qui est claire, bien faite et facile d'accès.</p>
<blockquote>
<blockquote>
<p><strong>Remarque</strong> : Si vous avez un doute sur la pertinence de votre choix, je vous conseille d’aller faire un tour sur <a href="https://github.com/addyosmani/todomvc">https://github.com/addyosmani/todomvc</a>, où Addy Osmani, un googler réputé et spécialiste entre autre de Backbone maintient (avec d’autres développeurs) des exemples de “TODO list” MVC javascript pour chacun des frameworks MVC (ou pas complètement MVC d’ailleurs) du moment. Si le framework que vous étudiez est dans la liste, il y a des chances que ce ne soit pas un mauvais choix, de plus vous disposerez d’un exemple de code (dans les règles de l’art) pour commencer.</p>
</blockquote>
</blockquote>
<h2 id="spine"><a href="#TOC"><span class="header-section-number">14.2</span> Spine</a></h2>
<p><a href="http://spinejs.com/">http://spinejs.com/</a></p>
<p><strong>Spine</strong> est très très inspiré de Backbone avec les spécificités suivantes (entre autres) :</p>
<ul>
<li>il est écrit en Coffeescript (mais vous pouvez bien sûr l'utiliser en pur javascript)</li>
<li>Spine propose des Contrôleurs ! ... qui ne sont ni plus ni moins l'équivalent des Backbones.Views</li>
<li>... et considère que les vues sont représentée par les templates. A ce sujet Spine propose tout un mécanisme évolué mais nous n'utiliserons que Mustache de la même façon qu'avec Backbone.</li>
</ul>
<p>Spine peut s'installer avec <strong>npm</strong> (node package manager) et ainsi proposer des outils supplémentaires permettant de générer un squelette de projet, de gérer les dépendances, ... Mais pour notre exemple, nous allons le faire &quot;à l'ancienne&quot;, l'objectif étant de ne modifier en rien la stack serveur existante. Vous pouvez donc vous préparer un environnement identique à celui du chapitre sur Coffeescript ave un répertoire <code>public.coffee</code> pour votre code coffeescript et n’oubliez pas le fichier de build <code>Cakefile</code>.</p>
<p>Un modèle Spine se décrit de la manière suivante :</p>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> window.Post extends Spine.Model
      @configure <span class="st">&quot;Post&quot;</span>, <span class="st">&quot;title&quot;</span>, <span class="st">&quot;message&quot;</span>, <span class="st">&quot;author&quot;</span>
      @extend Spine.Model.Ajax
      @url: <span class="st">&quot;/blogposts&quot;</span></code></pre>
<p>la ligne <code>@configure &quot;Post&quot;, &quot;title&quot;, &quot;message&quot;, &quot;author&quot;</code> définit le nom du modèle et de ses propriétés, ce qui permettra de faire référence ensuite à celles-ci de la façon suivante : <code>@title, @message, @author</code>, comme ceci par exemple, si nous ajoutons une méthode <code>toString()</code> à notre modèle :</p>
<p><em>Utilisation des “propriétés” :</em></p>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> Post extends Spine.Model
      @configure <span class="st">&quot;Post&quot;</span>, <span class="st">&quot;title&quot;</span>, <span class="st">&quot;message&quot;</span>, <span class="st">&quot;author&quot;</span>
      @extend Spine.Model.Ajax
      @url: <span class="st">&quot;/blogposts&quot;</span>

      toString:()-&gt;
        <span class="st">&quot;#{@title} : #{@message} / #{@author}&quot;</span></code></pre>
<p>Vous remarquerez que l'on ne définit qu'une seule url. Par contre le système de getter et de setter de Backbone disparaît (à vous de les écrire).</p>
<p>En ce qui concerne le contrôleur, il prend la forme suivante :</p>
<p><em>Contrôleur spine :</em></p>
<pre class="sourceCode python"><code class="sourceCode python">    <span class="kw">class</span> Blog extends Spine.Controller

      constructor:()-&gt;
        <span class="dt">super</span>

      render:()-&gt;</code></pre>
<h3 id="mise-en-oeuvre-rapide-1"><a href="#TOC"><span class="header-section-number">14.2.1</span> Mise en oeuvre rapide</a></h3>
<p>Téléchargez la distribution <a href="http://spinejs.com/pages/download">http://spinejs.com/pages/download</a>, dézippez et copiez les fichiers suivants dans <code>public/libs/vendors</code> :</p>
<ul>
<li>spine.js</li>
<li>ajax.js</li>
<li>list.js</li>
<li>local.js</li>
<li>manager.js</li>
<li>relation.js</li>
<li>route.js</li>
</ul>
<p>Cette fois-ci, nous allons utiliser 2 fichiers : une page <code>index.spine.html</code> qui affichera nos données et un fichier de script coffeescript <code>main.spine.coffee</code> qui contiendra notre code applicatif.</p>
<p>A nouveau, dans notre répertoire <code>public</code> (à la racine), créez une page <code>index.spine.html</code> avec le code suivant :</p>
<p><em>Index.spine.html :</em></p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
    <span class="kw">&lt;html&gt;</span>
    <span class="kw">&lt;head&gt;</span>
        <span class="kw">&lt;meta</span><span class="ot"> http-equiv=</span><span class="st">&quot;Content-Type&quot;</span><span class="ot"> content=</span><span class="st">&quot;text/html; charset=utf-8&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;title&gt;</span>Spine<span class="kw">&lt;/title&gt;</span>
        <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">&quot;libs/vendors/bootstrap/css/bootstrap.css&quot;</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;style&gt;</span>
            body <span class="kw">{</span>
                <span class="kw">padding-top:</span> <span class="dt">60px</span><span class="kw">;</span>
                <span class="kw">padding-bottom:</span> <span class="dt">40px</span><span class="kw">;</span>
            <span class="kw">}</span>
        <span class="kw">&lt;/style&gt;</span>
        <span class="kw">&lt;link</span><span class="ot"> href=</span><span class="st">&quot;libs/vendors/bootstrap/css/bootstrap-responsive.css&quot;</span><span class="ot"> rel=</span><span class="st">&quot;stylesheet&quot;</span><span class="kw">&gt;</span>
    <span class="kw">&lt;/head&gt;</span>

    <span class="kw">&lt;body&gt;</span>

        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar navbar-fixed-top&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;navbar-inner&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container&quot;</span><span class="kw">&gt;</span>
                    <span class="kw">&lt;a</span><span class="ot"> class=</span><span class="st">&quot;brand&quot;</span><span class="kw">&gt;</span>Mon Blog avec Spine<span class="kw">&lt;/a&gt;</span>
                <span class="kw">&lt;/div&gt;</span>
            <span class="kw">&lt;/div&gt;</span>
        <span class="kw">&lt;/div&gt;</span>

        <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;container-fluid&quot;</span><span class="kw">&gt;</span>

            <span class="kw">&lt;div</span><span class="ot"> class=</span><span class="st">&quot;row-fluid&quot;</span><span class="kw">&gt;</span>

                <span class="kw">&lt;script</span><span class="ot"> type=</span><span class="st">&quot;text/template&quot;</span><span class="ot"> id=</span><span class="st">&quot;myposts_template&quot;</span><span class="kw">&gt;</span>
                    {{#posts}}
                        &lt;li&gt;
                            &lt;b&gt;{{title}}&lt;/b&gt;&lt;br&gt;
                            &lt;p&gt;{{message}}&lt;/p&gt;
                            &lt;hr&gt;
                        &lt;/li&gt;
                    {{/posts}}
                <span class="kw">&lt;/script&gt;</span>

                <span class="kw">&lt;ul</span><span class="ot"> id=</span><span class="st">&quot;myposts&quot;</span><span class="kw">&gt;&lt;/ul&gt;</span>

            <span class="kw">&lt;/div&gt;</span>

        <span class="kw">&lt;/div&gt;</span>

    <span class="kw">&lt;/body&gt;</span>

    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;libs/vendors/yepnope.1.5.4-min.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;main.spine.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>

    <span class="kw">&lt;/html&gt;</span></code></pre>
<p>et enfin dans le répertoire <code>public.coffee</code>, créez un fichier <code>main.spine.coffee</code> avec le code ci-dessous :</p>
<p><em>main.spine.coffee :</em></p>
<pre class="sourceCode python"><code class="sourceCode python">yepnope
  load:
    jquery  : <span class="st">&quot;libs/vendors/jquery-1.7.2.js&quot;</span>
    mustache: <span class="st">&quot;libs/vendors/mustache.js&quot;</span>
    spine   : <span class="st">&quot;libs/vendors/spine.js&quot;</span>
    ajax    : <span class="st">&quot;libs/vendors/ajax.js&quot;</span>
    <span class="dt">list</span>    : <span class="st">&quot;libs/vendors/list.js&quot;</span>
    local   : <span class="st">&quot;libs/vendors/local.js&quot;</span>
    manager : <span class="st">&quot;libs/vendors/manager.js&quot;</span>
    relation: <span class="st">&quot;libs/vendors/relation.js&quot;</span>
    route   : <span class="st">&quot;libs/vendors/route.js&quot;</span>

  complete: -&gt;
    $ -&gt;

      <span class="kw">class</span> Post extends Spine.Model
        @configure <span class="st">&quot;Post&quot;</span>, <span class="st">&quot;title&quot;</span>, <span class="st">&quot;message&quot;</span>, <span class="st">&quot;author&quot;</span>
        @extend Spine.Model.Ajax
        @url: <span class="st">&quot;/blogposts&quot;</span>

        toString:()-&gt;
          <span class="st">&quot;#{@title} : #{@message} / #{@author}&quot;</span>


      <span class="kw">class</span> Blog extends Spine.Controller

        constructor:()-&gt;
          <span class="dt">super</span>
          @posts = []
          @template = $(<span class="st">&quot;#myposts_template&quot;</span>).html()
          @el = $ <span class="st">&quot;ul&quot;</span>

          <span class="co"># on s&#39;abonne au &quot;rafraîchissement&quot; de la liste des posts</span>
          <span class="co"># lorsque la liste est rafraîchie, on affiche la liste (méthode render)</span>
          Post.bind <span class="st">&#39;refresh&#39;</span>, =&gt; 
            @posts = Post.<span class="dt">all</span>()
            @render()

          <span class="co"># on charge les posts à partir du serveur</span>
          <span class="co"># cela va déclencher l&#39;évènement &quot;refresh&quot;</span>
          Post.fetch()

        render:()-&gt;
          @el.html Mustache.to_html(@template,
            posts: @posts
          )

      window.myBlog = new Blog()</code></pre>
<p>Maintenant positionnez vous au même endroit que le fichier <code>Cakefile</code>, lancez la commande cake <code>build</code>, lancez votre application serveur si ce n'est pas déjà fait et connectez vous, comme pour CanJS, vous obtiendrez à nouveau la même liste des posts dans votre navigateur :</p>
<p><img src="RSRC/13_02_MVC.png" alt="BB" /><br /></p>
<h3 id="conclusion-sur-spine"><a href="#TOC"><span class="header-section-number">14.2.2</span> Conclusion sur Spine</a></h3>
<p>Spine est moins simple que Backbone, mais s'en inspire énormément tout en restant facile d'accès (je fais abstraction de Coffeescript en faisant cette remarque). Il est possible d'utiliser Spine directement en javascript, mais le “style” de code ne prend vraiment de l'intérêt que dans un “mode Coffeescript” grace à la notion de classe. De la même façon que CanJS, Spine apporte plus de services “clés en main” que Backbone, comme par exemple la gestion du localstorage. Spine propose aussi un volet “développement mobile” : <a href="http://spinejs.com/mobile/index">http://spinejs.com/mobile/index</a>. Si vous n’êtes pas effrayé par Coffeescript, c’est un framework à suivre et à adopter.</p>
<p>Globalement, ce qui m'a intéressé tant dans CanJS que dans Spine, c'est leur simplicité de mise en oeuvre. Il est possible en quelques minutes d'écrire quelques premières lignes opérationnelles, ce qui n'est pas forcément le cas avec d'autres frameworks beaucoup plus (ou trop?) complets.</p>
<h2 id="knockout"><a href="#TOC"><span class="header-section-number">14.3</span> Knockout</a></h2>
<p>Knockout <a href="http://knockoutjs.com">http://knockoutjs.com</a>, l'OVNI de l’équipe, on ne parle plus de MVC mais du pattern “Model-View-View Model”, très très orienté IHM, puisqu'il renforce le lien entre les données et l'IHM, c'est un peu déroutant (mais où est donc encore passé le contrôleur !?), mais cela permet de réaliser des interfaces très réactives en fonction des changements et évolutions des données.</p>
<p>En ce qui concerne <strong>Knockout</strong>, nous n'allons pas repartir de nos exemples précédents, car ce qui caractérise <strong>Knockout</strong>, c'est son système de <strong>&quot;binding&quot;</strong> qui &quot;frise&quot; le <strong>&quot;magique&quot;</strong> : vos actions sur les modèles sont directement impactées sur les vues (le DOM HTML) et inversement vos actions sur le DOM (saisie dans une zone de texte par exemple) sont directement reflétées sur les modèles. Le concept de modèle en tant que tel (comme dans Backbone par exemple) n'existe pas, donc à vous de les écrire, mais <strong>Knockout</strong> apporte les outils nécessaires pour &quot;faire&quot; des <strong>&quot;propriétés observables&quot;</strong> et des <strong>&quot;tableaux observables&quot;</strong> qui seront ensuite &quot;liés&quot; aux vues qui ne sont ni plus ni moins que votre code html.</p>
<p>Donc vous l'aurez compris, <strong>Knockout</strong> met en oeuvre le pattern <strong>Observer</strong> :</p>
<p><a href="http://en.wikipedia.org/wiki/Observer_pattern">http://en.wikipedia.org/wiki/Observer_pattern</a></p>
<p>Ou encore mieux, la version &quot;javascript&quot; par Addy Osmani :</p>
<p><a href="http://addyosmani.com/resources/essentialjsdesignpatterns/book/#observerpatternjavascript">http://addyosmani.com/resources/essentialjsdesignpatterns/book/#observerpatternjavascript</a>.</p>
<h3 id="mise-en-oeuvre-très-très-rapide-...-mais-suffisante"><a href="#TOC"><span class="header-section-number">14.3.1</span> Mise en oeuvre très très rapide ... Mais suffisante</a></h3>
<p>Récupérez donc la librairie Knockout.js par ici :</p>
<p><a href="http://cloud.github.com/downloads/SteveSanderson/knockout/knockout-2.2.0.js">http://cloud.github.com/downloads/SteveSanderson/knockout/knockout-2.2.0.js</a></p>
<p>Puis copiez la dans un répertoire, dans lequel vous allez créer une page <code>index.html</code> avec la structure suivante :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
    <span class="kw">&lt;html&gt;</span>
    <span class="kw">&lt;head&gt;</span>
        <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;knockout-2.2.0.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;/head&gt;</span>
    <span class="kw">&lt;body&gt;</span>

        <span class="kw">&lt;h1&gt;</span>Tuto KnockOut<span class="kw">&lt;/h1&gt;</span>
        <span class="co">&lt;!-- ICI VIENDRONT LES VUES --&gt;</span>
    <span class="kw">&lt;/body&gt;</span>
    <span class="kw">&lt;script&gt;</span>
        <span class="co">/*</span> ICI VIENDRA NOTRE CODE <span class="co">*/</span>
    <span class="kw">&lt;/script&gt;</span>
    <span class="kw">&lt;/html&gt;</span></code></pre>
<h3 id="un-modèle-selon-knockout"><a href="#TOC"><span class="header-section-number">14.3.2</span> Un modèle selon Knockout</a></h3>
<p>Avec <strong>Knockout</strong>, pour définir qu'une propriété est &quot;observable&quot;, on utilise la méthode :</p>
<pre><code>ko.observable(nom_de_la_propriété)</code></pre>
<p>Définissons donc notre 1er modèle :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Message = <span class="kw">function</span> (from, subject, body) {
        <span class="kw">this</span>.<span class="fu">from</span> = <span class="kw">ko</span>.<span class="fu">observable</span>(from);
        <span class="kw">this</span>.<span class="fu">subject</span> = <span class="kw">ko</span>.<span class="fu">observable</span>(subject);
        <span class="kw">this</span>.<span class="fu">body</span> = <span class="kw">ko</span>.<span class="fu">observable</span>(body);

        <span class="co">//je m&#39;abonne aux modification de from</span>
        <span class="kw">this</span>.<span class="fu">from</span>.<span class="fu">subscribe</span>(<span class="kw">function</span>(value){<span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;value : &quot;</span>, value);});
    }</code></pre>
<p>Toute propriété &quot;observable&quot; du modèle <code>Message</code> va ensuite s'utiliser de la manière suivante (pour instancier, faites un <code>myMessage = new Message(&quot;Bob&quot;, &quot;Important&quot;, &quot;Hello World !&quot;)</code>):</p>
<ul>
<li>changer la valeur de <code>from</code> : <code>myMessage.from(&quot;Bob Morane&quot;)</code></li>
<li>obtenir la valeur de <code>from</code> : <code>myMessage.from()</code></li>
<li><p>s'abonner aux changements de valeur de <code>from</code> :</p>
<p><code>this.from.subscribe(function(value){ //do something ... })</code></p></li>
</ul>
<p>Simple, non ?</p>
<h3 id="collections-1"><a href="#TOC"><span class="header-section-number">14.3.3</span> Collections ?</a></h3>
<p>La notion de collection de Backbone n'existe plus, nous travaillons simplement avec des tableaux (<code>Array</code>). Je souhaite donc un tablea u &quot;observable&quot; de messages, je vais procéder comme ceci (en utilisant <code>ko.observableArray</code>):</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">var</span> Messages = <span class="kw">ko</span>.<span class="fu">observableArray</span>([
        <span class="kw">new</span> Message(<span class="st">&quot;John Doe&quot;</span>, <span class="st">&quot;First Message&quot;</span>, <span class="st">&quot;Hello World&quot;</span>),
        <span class="kw">new</span> Message(<span class="st">&quot;Bob Morane&quot;</span>, <span class="st">&quot;hello&quot;</span>, <span class="st">&quot;hello world&quot;</span>),
        <span class="kw">new</span> Message(<span class="st">&quot;Sam Le Pirate&quot;</span>, <span class="st">&quot;Salut&quot;</span>, <span class="st">&quot;Salut à Tous&quot;</span>)
    ]);</code></pre>
<p>Donc encore plus simple que pour les modèles !!! <em>(donc j'ai un tableau observable de modèles observables ...)</em></p>
<h3 id="attachons-notre-modèle-à-des-vues"><a href="#TOC"><span class="header-section-number">14.3.4</span> Attachons notre modèle à des vues !</a></h3>
<p>Imaginons, que j'ai une portion de mon code html qui est dédiée à affiché un message bien précis :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;messageView&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;span</span><span class="ot"> data-bind=</span><span class="st">&quot;text: from&quot;</span><span class="kw">&gt;&lt;/span&gt;</span>
        <span class="kw">&lt;span</span><span class="ot"> data-bind=</span><span class="st">&quot;text: subject&quot;</span><span class="kw">&gt;&lt;/span&gt;</span>
        <span class="kw">&lt;span</span><span class="ot"> data-bind=</span><span class="st">&quot;text: body&quot;</span><span class="kw">&gt;&lt;/span&gt;</span>
    <span class="kw">&lt;/div&gt;</span></code></pre>
<p>Le code javascript pour attacher le message à <code>messageView</code> sera le suivant :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    msg = <span class="kw">new</span> Message(<span class="st">&quot;bob&quot;</span>, <span class="st">&quot;hello&quot;</span>, <span class="st">&quot;hello world&quot;</span>);

    <span class="kw">ko</span>.<span class="fu">applyBindings</span>(msg, <span class="kw">document</span>.<span class="fu">querySelector</span>(<span class="st">&quot;#messageView&quot;</span>));</code></pre>
<blockquote>
<blockquote>
<p>Le lien sera fait avec les attributs html <code>data-bind</code>. Toute modification de notre modèle sera reflétée instantanément dans le code html (mais nous y reviendrons plus tard dans la démonstration).</p>
</blockquote>
</blockquote>
<p>De la même façon, si je souhaite faire un formulaire de saisie lié à mon message :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;form&gt;</span>
        <span class="kw">&lt;input</span><span class="ot"> data-bind=</span><span class="st">&quot;value: from&quot;</span><span class="kw">/&gt;</span> <span class="kw">&lt;input</span><span class="ot"> data-bind=</span><span class="st">&quot;value: subject&quot;</span><span class="kw">/&gt;</span>
    <span class="kw">&lt;/form&gt;</span></code></pre>
<blockquote>
<blockquote>
<p>Notez cette fois <code>data-bind=&quot;value: from&quot;</code> au lieu de <code>data-bind=&quot;text: from&quot;</code>, <code>value</code> exprime le &quot;binding à double sens&quot; (là aussi nous y reviendrons plus tard).</p>
</blockquote>
</blockquote>
<p>Et le code javascript pour attacher le message au formulaire sera le suivant :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">ko</span>.<span class="fu">applyBindings</span>(msg, <span class="kw">document</span>.<span class="fu">querySelector</span>(<span class="st">&quot;form&quot;</span>));</code></pre>
<blockquote>
<blockquote>
<p>Au fait, l'utilisation de jQuery n'est pas obligatoire (mais tellement pratique), avec jQuery, à la place de <code>document.querySelector(&quot;selector&quot;)</code> nous aurions donc <code>$(&quot;selector&quot;)</code>.</p>
</blockquote>
</blockquote>
<blockquote>
<blockquote>
<p><strong>Pas d'objet vue !</strong> La vue est entièrement représentée par les bouts de code HTML.</p>
</blockquote>
</blockquote>
<h3 id="attachons-note-liste-de-messages-à-une-vue"><a href="#TOC"><span class="header-section-number">14.3.5</span> Attachons note liste de messages à une vue</a></h3>
<p>En ce qui concerne notre tableau &quot;observable&quot;, cela reste aussi simple :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;messagesList&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;table&gt;</span>
            <span class="kw">&lt;thead&gt;</span>
                <span class="kw">&lt;tr&gt;&lt;th&gt;</span>From<span class="kw">&lt;/th&gt;&lt;th&gt;</span>Subject<span class="kw">&lt;/th&gt;&lt;th&gt;</span>Body<span class="kw">&lt;/th&gt;&lt;/tr&gt;</span>
            <span class="kw">&lt;/thead&gt;</span>
            <span class="kw">&lt;tbody</span><span class="ot"> data-bind=</span><span class="st">&quot;foreach: messages&quot;</span><span class="kw">&gt;</span>
                <span class="kw">&lt;tr&gt;</span>
                    <span class="kw">&lt;td</span><span class="ot"> data-bind=</span><span class="st">&quot;text: from&quot;</span><span class="kw">&gt;&lt;/td&gt;</span>
                    <span class="kw">&lt;td</span><span class="ot"> data-bind=</span><span class="st">&quot;text: subject&quot;</span><span class="kw">&gt;&lt;/td&gt;</span>
                    <span class="kw">&lt;td</span><span class="ot"> data-bind=</span><span class="st">&quot;text: body&quot;</span><span class="kw">&gt;&lt;/td&gt;</span>
                <span class="kw">&lt;/tr&gt;</span>
            <span class="kw">&lt;/tbody&gt;</span>
        <span class="kw">&lt;/table&gt;</span>        
    <span class="kw">&lt;/div&gt;</span></code></pre>
<p>Pour exprimer à <strong>Knockout</strong> que l'on veut afficher une liste d'éléments, on utilise l'attribut <code>data-bind=&quot;foreach: messages&quot;</code>. Et en javascript, nous devrons écrire ceci :</p>
<pre class="sourceCode javascript"><code class="sourceCode javascript">    <span class="kw">ko</span>.<span class="fu">applyBindings</span>({<span class="dt">messages</span>:Messages}, <span class="kw">document</span>.<span class="fu">querySelector</span>(<span class="st">&quot;#messagesList&quot;</span>));</code></pre>
<p>Donc, toujours aussi simple !!!</p>
<h3 id="code-définitif-de-notre-page-index.html"><a href="#TOC"><span class="header-section-number">14.3.6</span> Code définitif de notre page index.html</a></h3>
<p>Avant de &quot;lancer&quot; notre page, vérifions que le code ressemble à ceci :</p>
<pre class="sourceCode html"><code class="sourceCode html">    <span class="dt">&lt;!DOCTYPE </span>html<span class="dt">&gt;</span>
    <span class="kw">&lt;html&gt;</span>
    <span class="kw">&lt;head&gt;</span>
        <span class="kw">&lt;meta</span><span class="ot"> http-equiv=</span><span class="st">&quot;Content-Type&quot;</span><span class="ot"> content=</span><span class="st">&quot;text/html; charset=utf-8&quot;</span><span class="kw">&gt;</span>
        <span class="kw">&lt;script</span><span class="ot"> src=</span><span class="st">&quot;knockout-2.2.0.js&quot;</span><span class="kw">&gt;&lt;/script&gt;</span>
    <span class="kw">&lt;/head&gt;</span>
    <span class="kw">&lt;body&gt;</span>

        <span class="kw">&lt;h1&gt;</span>Tuto KnockOut<span class="kw">&lt;/h1&gt;</span>

        <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;messageView&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;span</span><span class="ot"> data-bind=</span><span class="st">&quot;text: from&quot;</span><span class="kw">&gt;&lt;/span&gt;</span>
            <span class="kw">&lt;span</span><span class="ot"> data-bind=</span><span class="st">&quot;text: subject&quot;</span><span class="kw">&gt;&lt;/span&gt;</span>
            <span class="kw">&lt;span</span><span class="ot"> data-bind=</span><span class="st">&quot;text: body&quot;</span><span class="kw">&gt;&lt;/span&gt;</span>
        <span class="kw">&lt;/div&gt;</span>
        <span class="kw">&lt;hr&gt;</span>
        <span class="kw">&lt;div</span><span class="ot"> id=</span><span class="st">&quot;messagesList&quot;</span><span class="kw">&gt;</span>
            <span class="kw">&lt;table&gt;</span>
                <span class="kw">&lt;thead&gt;</span>
                    <span class="kw">&lt;tr&gt;&lt;th&gt;</span>From<span class="kw">&lt;/th&gt;&lt;th&gt;</span>Subject<span class="kw">&lt;/th&gt;&lt;th&gt;</span>Body<span class="kw">&lt;/th&gt;&lt;/tr&gt;</span>
                <span class="kw">&lt;/thead&gt;</span>
                <span class="kw">&lt;tbody</span><span class="ot"> data-bind=</span><span class="st">&quot;foreach: messages&quot;</span><span class="kw">&gt;</span>
                    <span class="kw">&lt;tr&gt;</span>
                        <span class="kw">&lt;td</span><span class="ot"> data-bind=</span><span class="st">&quot;text: from&quot;</span><span class="kw">&gt;&lt;/td&gt;</span>
                        <span class="kw">&lt;td</span><span class="ot"> data-bind=</span><span class="st">&quot;text: subject&quot;</span><span class="kw">&gt;&lt;/td&gt;</span>
                        <span class="kw">&lt;td</span><span class="ot"> data-bind=</span><span class="st">&quot;text: body&quot;</span><span class="kw">&gt;&lt;/td&gt;</span>
                    <span class="kw">&lt;/tr&gt;</span>
                <span class="kw">&lt;/tbody&gt;</span>
            <span class="kw">&lt;/table&gt;</span>        
        <span class="kw">&lt;/div&gt;</span>
        <span class="kw">&lt;hr&gt;</span>
        <span class="kw">&lt;form&gt;</span>
            <span class="kw">&lt;input</span><span class="ot"> data-bind=</span><span class="st">&quot;value: from&quot;</span><span class="kw">/&gt;&lt;input</span><span class="ot"> data-bind=</span><span class="st">&quot;value: subject&quot;</span><span class="kw">/&gt;</span>
        <span class="kw">&lt;/form&gt;</span>


    <span class="kw">&lt;/body&gt;</span>
    <span class="kw">&lt;script&gt;</span>

        <span class="kw">var</span> Message = <span class="kw">function</span> (from, subject, body) {
            <span class="kw">this</span>.<span class="fu">from</span> = <span class="kw">ko</span>.<span class="fu">observable</span>(from);
            <span class="kw">this</span>.<span class="fu">subject</span> = <span class="kw">ko</span>.<span class="fu">observable</span>(subject);
            <span class="kw">this</span>.<span class="fu">body</span> = <span class="kw">ko</span>.<span class="fu">observable</span>(body);

            <span class="kw">this</span>.<span class="fu">from</span>.<span class="fu">subscribe</span>(<span class="kw">function</span>(value){<span class="kw">console</span>.<span class="fu">log</span>(<span class="st">&quot;value</span> : <span class="st">&quot;</span>, value);});
        }

        <span class="kw">var</span> Messages = <span class="kw">ko</span>.<span class="fu">observableArray</span>([
            <span class="kw">new</span> Message(<span class="st">&quot;John</span> <span class="st">Doe&quot;</span>, <span class="st">&quot;First</span> <span class="st">Message&quot;</span>, <span class="st">&quot;Hello</span> <span class="st">World&quot;</span>),
            <span class="kw">new</span> Message(<span class="st">&quot;Bob</span> <span class="st">Morane&quot;</span>, <span class="st">&quot;hello&quot;</span>, <span class="st">&quot;hello</span> <span class="st">world&quot;</span>),
            <span class="kw">new</span> Message(<span class="st">&quot;Sam</span> <span class="st">Le</span> <span class="st">Pirate&quot;</span>, <span class="st">&quot;Salut&quot;</span>, <span class="st">&quot;Salut</span> <span class="st">à</span> <span class="st">Tous&quot;</span>)
        ]);

        msg = <span class="kw">new</span> Message(<span class="st">&quot;bob&quot;</span>, <span class="st">&quot;hello&quot;</span>, <span class="st">&quot;hello</span> <span class="st">world&quot;</span>);

        <span class="kw">ko</span>.<span class="fu">applyBindings</span>(msg, <span class="kw">document</span>.<span class="fu">querySelector</span>(<span class="st">&quot;</span>#<span class="st">messageView&quot;</span>));

        <span class="kw">ko</span>.<span class="fu">applyBindings</span>(msg, <span class="kw">document</span>.<span class="fu">querySelector</span>(<span class="st">&quot;form&quot;</span>));

        <span class="kw">ko</span>.<span class="fu">applyBindings</span>({<span class="dt">messages</span>:Messages}, <span class="kw">document</span>.<span class="fu">querySelector</span>(<span class="st">&quot;</span>#<span class="st">messagesList&quot;</span>));

    <span class="kw">&lt;/script&gt;</span>
    <span class="kw">&lt;/html&gt;</span></code></pre>
<h3 id="démonstration"><a href="#TOC"><span class="header-section-number">14.3.7</span> Démonstration !!!</a></h3>
<p>Ouvrez votre page dans votre navigateur préféré (Chrome donc ;)) et ouvrez aussi la console du navigateur. Vous pouvez donc noter que le lien entre les données et la page s'effectue bien :</p>
<p><img src="RSRC/13_03_MVC.png" alt="BB" /><br /></p>
<p>Ensuite dans la console, tapez ceci : <code>msg.from(&quot;BOBBY&quot;).subject(&quot;Hello You !!!&quot;)</code> et validez. Vous vous apercevez que les modifications sont prises en compte automatiquement aussi bien dans la première ligne d'affichage du message que dans le formulaire de saisie. Notez au passage la possibilité &quot;jqueryesque&quot; (chaînée) de mise à jour des propriétés :</p>
<p><img src="RSRC/13_04_MVC.png" alt="BB" /><br /></p>
<p>Maintenant, si vous saisissez <code>Bob</code> dans la zone de saisie, vous pouvez vérifier que les changements sont bien répercutés dans les 2 sens :</p>
<p><img src="RSRC/13_05_MVC.png" alt="BB" /><br /></p>
<p>Ensuite, ajoutons notre message <code>msg</code> à la liste des messages <code>Messages</code> en saisissant ceci dans la console : <code>Messages.push(msg)</code>. Vous voyez que la liste des messages se met directement à jour :</p>
<p><img src="RSRC/13_06_MVC.png" alt="BB" /><br /></p>
<p>Et enfin, si vous modifiez les données dans les zones de saisie, vous pouvez voir que tout se met à jour même la liste des messages :</p>
<p><img src="RSRC/13_07_MVC.png" alt="BB" /><br /></p>
<h3 id="conclusion-1"><a href="#TOC"><span class="header-section-number">14.3.8</span> Conclusion</a></h3>
<p>&quot;Je ne sais pas vous&quot;, mais je trouve <strong>Knockout</strong> particulièrement intéressant :). Si vous souhaitez aller plus loin, faites un tour dans la documentation et tout particulièrement ceci :</p>
<ul>
<li><p>Pour les interaction avec le serveur (ajax &amp; jQuery) :</p>
<p><a href="http://knockoutjs.com/documentation/json-data.html">http://knockoutjs.com/documentation/json-data.html</a></p></li>
<li><p>Mapping des données :</p>
<p><a href="http://knockoutjs.com/documentation/plugins-mapping.html">http://knockoutjs.com/documentation/plugins-mapping.html</a></p></li>
</ul>
<p>Et si vous rêvez de combiner Backbone et Knockout, à voir : <strong>Knockback</strong> :</p>
<p><a href="http://kmalakoff.github.com/knockback/">http://kmalakoff.github.com/knockback/</a></p>
<p>qui fera certainement l'objet d'un chapitre de cet &quot;ouvrage&quot;.</p>
<h2 id="encore-dautres-frameworks-mvc-javascript"><a href="#TOC"><span class="header-section-number">14.4</span> Encore d’autres frameworks MVC (javascript)</a></h2>
<p>ils sont nombreux, mais les &quot;ténors&quot; connus, reconnus et utilisés sont les suivants :</p>
<ul>
<li><strong>Ember.js</strong> <a href="http://emberjs.com">http://emberjs.com</a> : le concurrent direct “officiel” de Backbone, très très complet, puissant, mais avec une dépendance forte avec le moteur de template Handelbar (un Mustache survitaminé), à suivre de très près. Il est cependant dommage que la gestion des modèles ne soit pas encore en mode stable (c'est un module à part), mais le modèle objet d’Ember.js est évolué, plus strict que celui de Backbone, donc à mon sens plus contraignant, mais cela peut en rassurer d'autres, car il propose un cadre “plus normatif” et permet donc de “forcer” à respecter les normes de développement sur un projet.</li>
<li><strong>AngularJS</strong> <a href="http://angularjs.org">http://angularjs.org</a> : le framework pour Webapp de Google, mais pas complètement MVC (les modèles de sont pas traités) qui met essentiellement l'accent sur le binding des données avec le DOM</li>
<li><strong>JavaScriptMVC</strong> <a href="http://javascriptmvc.com">http://javascriptmvc.com</a> : intéressant (peut-être un des plus anciens), car il essaye de coller le plus possible à ce que des développeurs java connaissent de MVC, mais la mécanique de mise en oeuvre est un peu lourde. Cependant le code est très lisible.</li>
</ul>
<p>Vous trouverez aussi des frameworks javascript MVC “Client et Serveur”, tels :</p>
<ul>
<li><strong>Batman</strong> <a href="http://batmanjs.org/">http://batmanjs.org/</a> : plutôt destiné aux développeurs Coffeescript. Il fournit son propre serveur mais peut être utilisé avec d’autres technologies serveur notamment le Ruby ou même “seul” dans le navigateur. Je trouve la documentation insuffisante, vous êtes parfois obligés d’aller dans le code du framework pour en comprendre le fonctionnement.</li>
<li><strong>Matador</strong> <a href="http://obvious.github.com/matador">http://obvious.github.com/matador</a> : celui-ci est essentiellement un framework MVC côté serveur en javascript s’appuyant sur express, il servirait donc plutôt à, par exemple, re-écrire la partie serveur de notre blog. Mais il est intéressant de voir de quelle manière il utilise des frameworks javascript initialement développés pour le navigateur, côté serveur, tel le modèle objet Klass (https://github.com/ded/klass).</li>
<li><strong>Chaplin</strong> <a href="https://github.com/chaplinjs/chaplin">https://github.com/chaplinjs/chaplin</a> : qui est une architecture complète autour de Backbone, une fois de plus “programmable” en coffeescript.</li>
<li>et beaucoup d'autres ...</li>
</ul>
<h2 id="conclusion-2"><a href="#TOC"><span class="header-section-number">14.5</span> Conclusion</a></h2>
<p>L’éco-système des framworks MVC javascript est vaste et il est difficile de faire un choix. L'important est de vous faire votre propre avis, d'utiliser les outils avec vous êtes le plus à l'aise, mais tout en étant sûr que vous avez chosi un framework largement utilisé par d'autres, avec une communauté active. Un dernier petit conseil : le plus souvent les frameworks javascript affiche leur repository sur GitHub (“the place to be”), alors tout le monde peut y être (j’y suis), mais c’est un 1er critère, ensuite un des gros avantage de Github, c’est que vous pouvez voir facilement l’activité autour du framework :</p>
<ul>
<li>Qui sont les contributeurs (et à quels autres projets il participent) ?</li>
<li>Depuis combien de temps le code n’a pas été mis à jour ?</li>
<li>Combien de personnes sont abonnées au projet ?</li>
<li>Combien de personnes ont “forké” le projet (dupliqué pour modifications et propositions de modifications, on parle de “pull request”) ?</li>
<li>Dans le bug tracker, quelle est la qualité des réponses ?</li>
<li>…</li>
</ul>
<blockquote>
<blockquote>
<p>Par exemple pour Backbone, plus de 10 000 “abonnés”, plus de 1 700 “forks”, c’est peu de dire que mon “jouet préféré” suscite de l’intérêt. Vous pouvez même comparer par rapport à d’autres frameworks java connus pour vous faire une idée. Ayez donc ce réflexe pour tout framework que vous souhaitez utiliser, cela peut vous éviter quelques soucis.</p>
</blockquote>
</blockquote>
<h1 id="backbone-et-typescript"><a href="#TOC"><span class="header-section-number">15</span> Backbone et Typescript</a></h1>
<pre><code>//TODO: 
Où nous parlerons de Typescript et de sa cohabitation avec Backbone</code></pre>
<h1 id="ressources-backbone"><a href="#TOC"><span class="header-section-number">16</span> Ressources Backbone</a></h1>
<pre><code>//TODO : une liste à faire vivre des ressources intéressantes concernant Backbone</code></pre>
<h1 id="resthub-backbone-stack"><a href="#TOC"><span class="header-section-number">17</span> RestHub Backbone Stack</a></h1>
<pre><code>//TODO : ou comment organiser son code de manière professionnelle</code></pre>
</body>
</html>
